<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona - AlphaGames30</title>
    <style>
        :root { --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --green: #00a854; --gold: #ffd700; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: Roboto, Arial, sans-serif; overflow-x: hidden; padding-bottom: 60px; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; height: 56px; background: var(--header); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        .logo { font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; }
        .logo::before { content: '‚ñ∂'; color: var(--red); font-size: 24px; margin-right: 5px; }
        .search-box { display: flex; flex: 1; max-width: 500px; margin: 0 10px; }
        .search-box input { width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 8px 15px; border-radius: 40px 0 0 40px; border-right: none; }
        .search-box button { background: #222; border: 1px solid #333; border-left: none; padding: 0 20px; border-radius: 0 40px 40px 0; cursor: pointer; color: var(--sec-text); }
        .header-btns button { background: none; border: none; color: white; font-size: 20px; margin-left: 10px; cursor: pointer; }
        .btn-login { border: 1px solid var(--blue) !important; color: var(--blue) !important; font-size: 14px !important; padding: 5px 10px; border-radius: 20px; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        /* LAYOUT */
        .container { display: flex; height: calc(100vh - 56px); }
        .sidebar { width: 220px; background: var(--bg); padding: 10px; overflow-y: auto; flex-shrink: 0; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .nav-item { padding: 10px; border-radius: 10px; cursor: pointer; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: background 0.2s; font-size: 14px; }
        .nav-item:hover { background: var(--hover); }
        .content { flex: 1; padding: 20px; overflow-y: auto; }

        /* SUBSCRIPTIONS BAR (Mobile & Desktop) */
        .subs-list-desktop { margin-top: 10px; }
        .sub-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 10px; cursor: pointer; }
        .sub-item:hover { background: var(--hover); }
        .sub-item img { width: 24px; height: 24px; border-radius: 50%; }
        
        .mobile-subs-bar { display: none; overflow-x: auto; white-space: nowrap; padding: 10px; background: #0f0f0f; border-bottom: 1px solid #222; gap: 15px; }
        .mobile-sub-item { display: inline-flex; flex-direction: column; align-items: center; width: 60px; cursor: pointer; }
        .mobile-sub-item img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--header); }
        .mobile-sub-item span { font-size: 10px; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin-top: 4px; color: #aaa; }

        /* GRIDS & CARDS */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .video-card { cursor: pointer; transition: transform 0.2s; }
        .video-card:hover { transform: scale(1.02); }
        .thumb-container { position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; background: #333; }
        .thumb { width: 100%; height: 100%; object-fit: cover; }
        .badge-live { position: absolute; bottom: 5px; right: 5px; background: rgba(200, 0, 0, 0.9); color: white; padding: 2px 6px; font-size: 10px; border-radius: 4px; font-weight: bold; }
        
        .shorts-grid { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .short-card { flex-shrink: 0; width: 160px; height: 300px; cursor: pointer; border-radius: 12px; overflow: hidden; background: #333; position: relative; }
        .short-card img { width: 100%; height: 100%; object-fit: cover; }

        /* PLAYER & COMMENTS */
        .player-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 500; overflow-y: auto; padding-bottom: 50px; }
        .player-content { width: 95%; max-width: 1100px; margin: 20px auto; }
        .video-wrapper { width: 100%; aspect-ratio: 16/9; background: #000; }
        .short-player-wrapper { width: 100%; max-width: 400px; aspect-ratio: 9/16; background: #000; margin: 0 auto; position: relative; }
        video { width: 100%; height: 100%; }
        
        .comment-section { background: #1a1a1a; padding: 20px; border-radius: 12px; margin-top: 20px; }
        .comment-row { display: flex; gap: 10px; margin-bottom: 15px; position: relative; }
        .comment-actions { display: flex; gap: 10px; margin-top: 5px; font-size: 12px; color: #aaa; align-items: center; }
        .creator-badge { background: #333; color: var(--sec-text); font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .pinned-badge { font-size: 11px; color: var(--sec-text); display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .action-icon { cursor: pointer; transition: color 0.2s; }
        .action-icon:hover { color: white; }
        .heart-active { color: var(--red); }

        /* BUTTONS & UI */
        .action-pill { background: #272727; color: white; border: none; padding: 6px 12px; border-radius: 18px; font-size: 13px; cursor: pointer; }
        .action-pill:hover { background: #3a3a3a; }
        .btn-blue { width: 100%; padding: 12px; background: var(--blue); color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-red { background: var(--red); color: white; }
        .btn-green { background: var(--green); color: white; }
        
        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 600; display: flex; justify-content: center; align-items: flex-start; overflow-y: auto; padding-top: 50px; padding-bottom: 20px; box-sizing: border-box; }
        .modal-box { background: #212121; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; margin: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; background: #121212; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; }

        /* PROFILE */
        .banner { width: 100%; height: 200px; background: #333; object-fit: cover; }
        .profile-head { display: flex; align-items: flex-end; gap: 20px; padding: 0 20px; margin-top: -40px; }
        .avatar-big { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--bg); background: #555; object-fit: cover; }
        .profile-tabs { display: flex; border-bottom: 1px solid #333; margin: 20px; }
        .profile-tab { padding: 10px 20px; cursor: pointer; color: #aaa; border-bottom: 2px solid transparent; }
        .profile-tab.active { color: white; border-bottom-color: white; }

        /* POSTS */
        .post-card { background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .post-actions { border-top: 1px solid #333; margin-top: 10px; padding-top: 10px; display: flex; gap: 20px; }
        .post-comments { margin-top: 10px; padding-top: 10px; display: none; }

        /* RESPONSIVE */
        @media(max-width: 768px) { 
            .sidebar { display: none; } 
            .mobile-nav { display: flex !important; } 
            .mobile-subs-bar { display: flex; }
            .search-box { display: none; } 
            .profile-head { flex-direction: column; align-items: center; text-align: center; margin-top: -60px; }
        }
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #0f0f0f; border-top: 1px solid #222; justify-content: space-around; align-items: center; z-index: 1000; }
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #aaa; cursor: pointer; }
        
        #notificationToast { position: fixed; top: 60px; right: 20px; background: #333; padding: 15px; border-radius: 8px; z-index: 999; display: none; }
        #adminFloatButton { position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; background: var(--red); color: white; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: none; z-index: 50; }
        .avatar-small { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="app.goHome()"><span>Visiona</span></div>
        <div class="search-box"><input type="text" id="searchInput" placeholder="Rechercher..."><button onclick="app.search()">üîç</button></div>
        <div class="header-btns">
            <button onclick="app.openUpload()">‚ûï</button>
            <button id="loginBtn" class="btn-login" onclick="app.toggleAccountMenu()">üë§ Se connecter</button>
        </div>
    </header>

    <div id="accountMenu" style="display:none; position:absolute; right:10px; top:60px; background:#282828; padding:15px; border-radius:10px; z-index:1000; min-width: 150px;">
        <div id="menuUserName" style="font-weight:bold; margin-bottom:10px; border-bottom: 1px solid #333; padding-bottom: 10px;"></div>
        <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma Cha√Æne</div>
        <div class="nav-item" onclick="app.openCreditsModal()">üìú Cr√©dits</div>
        <div id="adminLink" class="nav-item" onclick="app.goAdminPanel()" style="display:none;">üîë Admin</div>
        <div class="nav-item" onclick="app.doLogout()">üö™ D√©connexion</div>
    </div>

    <div id="notificationToast" onclick="app.handleNotificationClick()"><p style="margin:0; font-weight:bold;">Nouvelle notif !</p><span id="notificationMessage"></span></div>

    <div id="mobileSubsBar" class="mobile-subs-bar"></div>

    <div class="container">
        <nav class="sidebar">
            <div class="nav-item" onclick="app.goHome()">üè† Accueil</div>
            <div class="nav-item" onclick="app.goShorts()">‚ö° Zapp</div>
            <div class="nav-item" onclick="app.goSubs()">üì∫ Suivis</div>
            <hr style="border-color: #333; width: 100%;">
            <h4 style="padding: 0 10px; margin: 10px 0; color: #aaa; font-size: 12px;">ABONNEMENTS</h4>
            <div id="sidebarSubs" class="subs-list-desktop"></div>
            <div style="margin-top: auto; padding: 10px; font-size: 11px; color: #555;">Visiona ¬© 2024</div>
        </nav>

        <main class="content">
            <div id="mainTitle"></div>
            
            <div id="homeFilters" style="display:none; gap:10px; margin-bottom:20px; overflow-x:auto;">
                <button class="action-pill active" onclick="app.filterHome('all')">Tout</button>
                <button class="action-pill" onclick="app.filterHome('stream')">En Direct / Rediff</button>
                <button class="action-pill" onclick="app.filterHome('video')">Vid√©os</button>
            </div>

            <div id="videoGrid" class="video-grid" style="display:none;"></div>
            <div id="shortsGrid" class="shorts-grid" style="display:none;"></div>
            <div id="statsView" class="stats-view" style="display:none;">
                <h2>üìä Mes Statistiques</h2>
                <div id="statsContent" style="background:#1a1a1a; padding:20px; border-radius:10px;"></div>
            </div>

            <div id="profileView" class="profile-view" style="display:none;">
                <img class="banner" id="pBanner" src="">
                <div class="profile-head">
                    <img id="profileAvatar" src="" class="avatar-big">
                    <div>
                        <h1 id="pName" style="margin:0;">Nom</h1>
                        <p id="pStats" style="color:var(--sec-text); margin:5px 0;"></p>
                        <p id="pBio" style="color:#aaa;"></p>
                        <div id="profileActions" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <div class="profile-tabs">
                    <div class="profile-tab active" id="tabContent" onclick="app.showProfileTab('content')">Vid√©os & Zapp</div>
                    <div class="profile-tab" id="tabStreams" onclick="app.showProfileTab('streams')">Lives</div>
                    <div class="profile-tab" id="tabPosts" onclick="app.showProfileTab('posts')">Publications</div>
                    <div class="profile-tab" id="tabAbout" onclick="app.showProfileTab('about')">√Ä Propos</div>
                </div>
                <div id="pContent" class="video-grid" style="padding: 20px;"></div>
                <div id="pStreams" class="video-grid" style="padding: 20px; display:none;"></div>
                <div id="pPosts" style="padding: 20px; display: none;"></div>
                <div id="pAbout" style="padding: 20px; display: none;">
                    <h3 style="margin-top:0;">Description</h3><p id="pAboutBio"></p>
                    <h3 style="margin-top:20px;">Stats</h3><p id="pAboutStats"></p>
                </div>
            </div>

            <div id="adminPanel" class="admin-view" style="display:none;">
                <h2>üîë Administration</h2>
                <button class="action-pill" onclick="app.openAddCreditModal()">‚ûï Ajouter un cr√©dit</button>
                <h3 style="margin-top:20px;">Gestion Cr√©dits</h3>
                <div id="adminCreditsList"></div>
                <h3 style="margin-top:30px;">Gestion des Vid√©os</h3>
                <div id="adminVideoList"></div>
            </div>
        </main>
    </div>

    <div class="mobile-nav">
        <div class="mobile-nav-item" onclick="app.goHome()"><span>üè†</span>Accueil</div>
        <div class="mobile-nav-item" onclick="app.goShorts()"><span>‚ö°</span>Zapp</div>
        <div class="mobile-nav-item" onclick="app.goHistory()"><span>üïí</span>Historique</div>
        <div class="mobile-nav-item" onclick="app.goStats()"><span>üìä</span>Stats</div>
        <div class="mobile-nav-item" onclick="app.goMyProfile()"><span>üë§</span>Moi</div>
    </div>

    <button id="adminFloatButton" onclick="app.openBroadcastModal()">üì¢</button>

    <div id="modalUploadChoice" class="modal">
        <div class="modal-box">
            <h2>Cr√©er</h2>
            <button class="btn-blue" style="margin-top:10px;" onclick="app.openUpload('video')">üé¨ Vid√©o / Zapp / Live</button>
            <button class="btn-blue" style="margin-top:10px; background:#444;" onclick="app.openUpload('post')">üìù Publication (Post)</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="modalUpload" class="modal">
        <div class="modal-box">
            <h2>Publier Vid√©o/Live</h2>
            <p id="uploadStatus" style="color: var(--blue); font-size:14px; text-align:center;"></p>
            <input type="text" id="upTitle" placeholder="Titre">
            <select id="upType"><option value="normal">Vid√©o Classique</option><option value="stream">üî¥ Rediffusion Live</option></select>
            <label style="color:#aaa; font-size:12px;">Fichier Vid√©o (.mp4)</label>
            <input type="file" id="upVideoFile" accept="video/*">
            <label style="color:#aaa; font-size:12px;">Miniature</label>
            <input type="file" id="upThumbFile" accept="image/*">
            <button class="btn-blue" id="publishBtn" onclick="app.publish()">PUBLIER</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="modalNewPost" class="modal">
        <div class="modal-box">
            <h2>Nouveau Post</h2>
            <p id="postUploadStatus" style="color: var(--blue); font-size:14px; text-align:center;"></p>
            <textarea id="postContent" placeholder="Exprimez-vous..." rows="4"></textarea>
            <label style="color:#aaa; font-size:12px;">Image (Optionnel)</label>
            <input type="file" id="postImageFile" accept="image/*">
            <button class="btn-blue" id="publishPostBtn" onclick="app.publishPost()">POSTER</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="modalCredits" class="modal">
        <div class="modal-box" style="text-align:center;">
            <h2 style="color:var(--gold);">üèÜ Cr√©dits & Remerciements</h2>
            <div id="creditsList" style="margin:20px 0; font-size:18px; line-height:1.6;"></div>
            <button class="action-pill" onclick="app.closeModals()">Fermer</button>
        </div>
    </div>

    <div id="modalLoginEmail" class="modal"><div class="modal-box"><h2>Connexion</h2><input type="email" id="logEmail" placeholder="Email"><button class="btn-blue" onclick="app.loginStep(1)">Suivant</button></div></div>
    <div id="modalLoginRegister" class="modal"><div class="modal-box"><h2>Cr√©er profil</h2><input type="text" id="logNewName" placeholder="Nom"><input type="password" id="logNewPass" placeholder="Mot de passe"><button class="btn-blue" onclick="app.loginStep(2)">C'est parti</button></div></div>
    <div id="modalLoginPass" class="modal"><div class="modal-box"><h2>Mot de passe</h2><input type="password" id="logPass" placeholder="Mot de passe"><button class="btn-blue" onclick="app.loginStep(3)">Entrer</button></div></div>
    
    <div id="playerModal" class="player-overlay">
        <div style="padding: 15px;"><button class="action-pill" onclick="app.closePlayer()">‚úï Fermer</button></div>
        <div class="player-content">
            <div id="videoContainer" class="video-wrapper">
                <video id="mainVideoPlayer" controls autoplay></video>
                <div id="shortNav" class="short-nav" style="display:none; position:absolute; top:50%; width:100%; justify-content:space-between;">
                    <button onclick="app.prevShort()">‚óÄ</button><button onclick="app.nextShort()">‚ñ∂</button>
                </div>
            </div>
            <h2 id="playerTitle" style="margin-bottom:5px;"></h2>
            <p id="playerMeta" style="color:var(--sec-text); font-size:14px; margin-top:0;"></p>
            <div id="playerActions" style="display:flex; gap:15px; align-items:center;"></div>
            <div class="comment-section">
                <h4 id="commentCount">Commentaires</h4>
                <div class="comment-input-area" style="display:flex; gap:10px;">
                    <img src="" id="userCommentAvatar" class="avatar-small">
                    <input type="text" id="newCommentInput" placeholder="Ajouter un commentaire...">
                    <button class="action-pill" onclick="app.addComment()">Envoyer</button>
                </div>
                <div id="commentList" style="margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <div id="modalEditProfile" class="modal">
        <div class="modal-box">
            <h2>Modifier Profil</h2>
            <p id="profileUploadStatus"></p>
            <input type="text" id="editName" placeholder="Nom">
            <textarea id="editBio" placeholder="Bio"></textarea>
            <label>Avatar</label><input type="file" id="editPPFile">
            <label>Banni√®re</label><input type="file" id="editBannerFile">
            <button class="btn-blue" onclick="app.saveProfile()">Sauvegarder</button>
            <button class="action-pill" onclick="app.closeModals()" style="width:100%; margin-top:10px;">Annuler</button>
        </div>
    </div>

    <script>
        // CONFIG
        const WORKER_PROXY_URL = "https://mytubeupload.edonis-imbert.workers.dev/"; 
        const CLOUDINARY_CLOUD_NAME = "dvbsmh8qq"; 
        const CLOUDINARY_UPLOAD_PRESET = "mytube_upload"; 
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json"; 
        const GIST_FILE_NAME = "video.json"; 
        const PRIMARY_ADMIN_EMAIL = "edonis.imbert@gmail.com"; 
        const VIEW_COOLDOWN_MS = 60 * 60 * 1000; 

        // CREDITS DE BASE
        const DEFAULT_CREDITS = ["Alastor best", "Lolonagol", "Totorito", "UNC_Alpha_caracal"];

        let localUserCreds = JSON.parse(localStorage.getItem('mt_user_creds')) || {};

        const app = {
            data: {
                user: JSON.parse(localStorage.getItem('mt_user')), 
                videos: [],
                users: {}, 
                admins: [PRIMARY_ADMIN_EMAIL], 
                bannedEmails: [], 
                announcement: null, 
                credits: [], // Liste dynamique des cr√©dits
                votes: JSON.parse(localStorage.getItem('mt_votes')) || {},
                subs: JSON.parse(localStorage.getItem('mt_subs')) || {}, 
                history: JSON.parse(localStorage.getItem('mt_history')) || [], 
                lastViewTimes: JSON.parse(localStorage.getItem('mt_last_views')) || {},
                stats: JSON.parse(localStorage.getItem('mt_stats')) || { timeSpentSeconds: 0 },
            },
            currentPlayingVideoId: null,
            currentProfileAuthor: null, 
            currentShortsList: [], 
            currentShortIndex: -1,

            init: async function() {
                if (Array.isArray(this.data.subs)) { // Migration old data
                    const newSubs = {}; this.data.subs.forEach(author => newSubs[author] = 1); this.data.subs = newSubs; this.saveLocal();
                }
                await this.loadData();
                
                // Si pas de cr√©dits dans le Gist, on met ceux par d√©faut
                if (!this.data.credits || this.data.credits.length === 0) {
                    this.data.credits = DEFAULT_CREDITS;
                }

                if (this.data.user && this.data.bannedEmails.includes(this.data.user.email)) {
                    alert("Compte banni."); this.doLogout(); return;
                }

                this.updateAuthUI();
                this.renderSubsSidebar();
                this.goHome(true); // true = randomize
                if (this.isAdmin()) document.getElementById('adminFloatButton').style.display = 'flex';
                
                // Auto save stats time
                setInterval(() => { this.data.stats.timeSpentSeconds += 60; this.saveLocal(); }, 60000); 
            },

            loadData: async function() {
                try {
                    const res = await fetch(GIST_URL + "?t=" + Date.now()); 
                    const json = await res.json();
                    this.data.videos = json.videos || [];
                    this.data.users = json.users || {};
                    this.data.admins = json.admins || [PRIMARY_ADMIN_EMAIL];
                    this.data.bannedEmails = json.bannedEmails || []; 
                    this.data.credits = json.credits || DEFAULT_CREDITS;
                    this.data.announcement = json.announcement || null; 
                } catch(e) { console.error("Load Error", e); }
            },

            saveGist: async function() {
                const content = { 
                    videos: this.data.videos, users: this.data.users, admins: this.data.admins,
                    bannedEmails: this.data.bannedEmails, announcement: this.data.announcement, credits: this.data.credits
                };
                try {
                    await fetch(WORKER_PROXY_URL, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: { [GIST_FILE_NAME]: { content: JSON.stringify(content, null, 2) } } })
                    });
                } catch(e) { console.error("Save Error", e); }
            },

            saveLocal: function() {
                localStorage.setItem('mt_user', JSON.stringify(this.data.user));
                localStorage.setItem('mt_subs', JSON.stringify(this.data.subs));
                localStorage.setItem('mt_votes', JSON.stringify(this.data.votes));
                localStorage.setItem('mt_history', JSON.stringify(this.data.history)); 
                localStorage.setItem('mt_stats', JSON.stringify(this.data.stats));
            },

            // --- NAVIGATION ---
            
            hideAll: function() { 
                ['videoGrid', 'shortsGrid', 'profileView', 'adminPanel', 'statsView', 'homeFilters'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.style.display = 'none';
                });
            },

            goHome: function(randomize = false) {
                this.closePlayer(); this.hideAll();
                document.getElementById('videoGrid').style.display = 'grid';
                document.getElementById('homeFilters').style.display = 'flex';
                document.getElementById('mainTitle').innerHTML = "<h2>Accueil</h2>";
                
                let list = this.data.videos.filter(v => !v.isShort);
                if (randomize) {
                    list = list.sort(() => 0.5 - Math.random()); // M√©lange al√©atoire
                }
                this.render(list);
            },

            filterHome: function(type) {
                document.querySelectorAll('#homeFilters .action-pill').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                
                let list = this.data.videos.filter(v => !v.isShort);
                if (type === 'stream') list = list.filter(v => v.isStream);
                if (type === 'video') list = list.filter(v => !v.isStream);
                
                this.render(list.sort(() => 0.5 - Math.random())); // Toujours random
            },

            goShorts: function() {
                this.closePlayer(); this.hideAll();
                document.getElementById('shortsGrid').style.display = 'flex';
                document.getElementById('mainTitle').innerHTML = "<h2>‚ö° Zapp</h2>";
                const shorts = this.data.videos.filter(v => v.isShort).sort(() => 0.5 - Math.random());
                document.getElementById('shortsGrid').innerHTML = shorts.map((v, i) => `
                    <div class="short-card" onclick="app.openShortsPlayer(${v.id}, [${shorts.map(s => s.id)}], ${i})">
                        <img src="${v.thumb}">
                        <div style="position: absolute; bottom:0; left:0; width:100%; padding:10px; background:linear-gradient(to top, rgba(0,0,0,0.8), transparent); color:white;">
                            <h3 style="margin:0; font-size:14px;">${v.title}</h3>
                            <p style="margin:0; font-size:12px; color:#ccc;">${v.author}</p>
                        </div>
                    </div>
                `).join('');
            },

            goSubs: function() { 
                if(!this.data.user) return this.openLogin(); 
                this.hideAll(); 
                document.getElementById('videoGrid').style.display = 'grid'; 
                document.getElementById('mainTitle').innerHTML = "<h2>Mes suivis</h2>"; 
                const subAuthors = Object.keys(this.data.subs);
                // Tri par date pour les suivis (pas de random)
                const list = this.data.videos.filter(x => subAuthors.includes(x.author)).sort((a,b) => b.id - a.id);
                this.render(list); 
            },

            // --- RENDU & UI ---

            render: function(list, target = 'videoGrid') {
                const el = document.getElementById(target);
                if (list.length === 0) { el.innerHTML = "<p style='color:#aaa; padding:20px;'>Rien √† afficher.</p>"; return; }
                el.innerHTML = list.map(v => `
                    <div class="video-card" onclick="app.openVideoOverlay(${v.id}, ${v.isShort})">
                        <div class="thumb-container">
                            <img src="${v.thumb}" class="thumb">
                            ${v.isStream ? '<span class="badge-live">LIVE / REDIFF</span>' : ''}
                        </div>
                        <div style="padding-top: 8px;">
                            <h3 style="margin:0 0 4px 0; font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${v.title}</h3>
                            <p style="margin:0; font-size:14px; color:var(--sec-text);" onclick="event.stopPropagation(); app.viewProfile('${v.author}')">${v.author}</p>
                            <p style="margin:0; font-size:12px; color:var(--sec-text);">${v.views || 0} vues ‚Ä¢ ${this.timeAgo(v.id)}</p>
                        </div>
                    </div>
                `).join('');
            },

            renderSubsSidebar: function() {
                if (!this.data.user) return;
                const subs = Object.keys(this.data.subs);
                const html = subs.map(name => `
                    <div class="${window.innerWidth > 768 ? 'sub-item' : 'mobile-sub-item'}" onclick="app.viewProfile('${name}')">
                        <img src="${this.getAvatar(name)}">
                        <span>${name}</span>
                    </div>
                `).join('');
                document.getElementById('sidebarSubs').innerHTML = html;
                document.getElementById('mobileSubsBar').innerHTML = html; // Barre mobile
            },

            getAvatar: function(name) {
                // PP par d√©faut : Premi√®re lettre avec fond couleur
                if (this.data.users[name]?.avatar) return this.data.users[name].avatar;
                return `https://ui-avatars.com/api/?name=${name}&background=random&color=fff&size=128`;
            },

            // --- PROFILS & POSTS ---

            viewProfile: function(authorName) {
                this.closePlayer(); this.hideAll();
                this.currentProfileAuthor = authorName;
                document.getElementById('profileView').style.display = 'block';
                
                const profile = this.data.users[authorName] || { name: authorName, bio: "Aucune description.", avatar: "", banner: "", posts: [] };
                const videos = this.data.videos.filter(x => x.author === authorName);
                const streams = videos.filter(v => v.isStream);
                const classicVideos = videos.filter(v => !v.isStream && !v.isShort);
                const followers = Object.keys(profile.followers || {}).length;

                document.getElementById('pBanner').src = profile.banner || '';
                document.getElementById('profileAvatar').src = this.getAvatar(authorName);
                document.getElementById('pName').innerText = profile.name;
                document.getElementById('pStats').innerText = `${followers} abonn√©s ‚Ä¢ ${videos.length} vid√©os`;
                
                // Bouton abonnement
                const actions = document.getElementById('profileActions');
                if (this.data.user && this.data.user.name === authorName) {
                    actions.innerHTML = `<button class="action-pill btn-blue" onclick="app.openEditProfile()">Modifier ma cha√Æne</button>`;
                } else if (this.data.user) {
                    actions.innerHTML = this.getSubscriptionButton(authorName);
                } else { actions.innerHTML = ''; }

                // About tab info
                document.getElementById('pAboutBio').innerText = profile.bio;
                document.getElementById('pAboutStats').innerHTML = `Vues totales: ${videos.reduce((a,b)=>a+(b.views||0),0)}`;

                // Render Content
                this.render(classicVideos, 'pContent');
                this.render(streams, 'pStreams');
                this.renderPosts(profile.posts || [], 'pPosts', authorName);
                
                this.showProfileTab('content');
            },

            showProfileTab: function(tab) {
                ['Content', 'Streams', 'Posts', 'About'].forEach(t => {
                    document.getElementById('tab'+t).classList.remove('active');
                    document.getElementById('p'+t).style.display = 'none';
                });
                document.getElementById('tab'+(tab.charAt(0).toUpperCase() + tab.slice(1))).classList.add('active');
                document.getElementById('p'+(tab.charAt(0).toUpperCase() + tab.slice(1))).style.display = (tab === 'content' || tab === 'streams') ? 'grid' : 'block';
            },

            renderPosts: function(posts, target, authorName) {
                const el = document.getElementById(target);
                if (!posts || posts.length === 0) { el.innerHTML = "<p style='color:#aaa'>Aucune publication.</p>"; return; }
                
                // Rendu des posts avec boutons Like/Commentaire
                el.innerHTML = posts.map((post, idx) => {
                    const isLiked = post.likes && post.likes[this.data.user?.name];
                    const likeCount = post.likes ? Object.keys(post.likes).length : 0;
                    const commentCount = post.comments ? post.comments.length : 0;
                    
                    return `
                    <div class="post-card">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <img src="${this.getAvatar(authorName)}" class="avatar-small">
                            <div><h4 style="margin:0;">${authorName}</h4><span style="font-size:12px; color:#aaa;">${this.timeAgo(post.time)}</span></div>
                        </div>
                        <p style="white-space: pre-wrap;">${post.content}</p>
                        ${post.image ? `<img src="${post.image}" style="width:100%; max-height:400px; object-fit:contain; border-radius:8px;">` : ''}
                        
                        <div class="post-actions">
                            <button class="action-pill ${isLiked ? 'liked' : ''}" onclick="app.togglePostLike('${authorName}', ${idx})">üëç ${likeCount}</button>
                            <button class="action-pill" onclick="app.togglePostComments('${authorName}', ${idx})">üí¨ ${commentCount}</button>
                        </div>
                        
                        <div id="postComments-${authorName}-${idx}" class="post-comments">
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <input type="text" id="inputPostComment-${authorName}-${idx}" placeholder="Votre commentaire...">
                                <button class="action-pill" onclick="app.addPostComment('${authorName}', ${idx})">Envoyer</button>
                            </div>
                            <div id="listPostComments-${authorName}-${idx}">
                                ${post.comments ? post.comments.map(c => `<div style="font-size:13px; margin-bottom:5px;"><b>${c.user}</b>: ${c.text}</div>`).join('') : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },

            // --- INTERACTIONS POSTS ---

            togglePostLike: async function(authorName, idx) {
                if (!this.data.user) return app.openLogin();
                const user = this.data.users[authorName];
                const post = user.posts[idx];
                post.likes = post.likes || {};
                
                if (post.likes[this.data.user.name]) delete post.likes[this.data.user.name];
                else post.likes[this.data.user.name] = 1;
                
                await this.saveGist();
                this.viewProfile(authorName); // Refresh
                this.showProfileTab('posts');
            },

            togglePostComments: function(authorName, idx) {
                const el = document.getElementById(`postComments-${authorName}-${idx}`);
                el.style.display = el.style.display === 'block' ? 'none' : 'block';
            },

            addPostComment: async function(authorName, idx) {
                if (!this.data.user) return app.openLogin();
                const input = document.getElementById(`inputPostComment-${authorName}-${idx}`);
                const text = input.value.trim();
                if (!text) return;
                
                const user = this.data.users[authorName];
                user.posts[idx].comments = user.posts[idx].comments || [];
                user.posts[idx].comments.push({ user: this.data.user.name, text: text, time: Date.now() });
                
                await this.saveGist();
                this.viewProfile(authorName);
                this.showProfileTab('posts');
            },

            // --- UPLOAD ---

            openUpload: function(type='choice') {
                if(!this.data.user) return this.openLogin();
                this.closeModals();
                if(type === 'video') document.getElementById('modalUpload').style.display = 'flex';
                else if(type === 'post') document.getElementById('modalNewPost').style.display = 'flex';
                else document.getElementById('modalUploadChoice').style.display = 'flex';
            },

            publish: async function() {
                const title = document.getElementById('upTitle').value;
                const type = document.getElementById('upType').value; // 'normal' ou 'stream'
                const videoFile = document.getElementById('upVideoFile').files[0];
                const thumbFile = document.getElementById('upThumbFile').files[0];
                
                if(!title || !videoFile || !thumbFile) return alert("Tout remplir svp");
                document.getElementById('publishBtn').disabled = true; document.getElementById('uploadStatus').innerText = "Upload en cours...";

                try {
                    const thumb = await this.uploadCloudinary(thumbFile, 'image');
                    const video = await this.uploadCloudinary(videoFile, 'video');
                    
                    // Detecter Short si < 60s et vertical (simplifi√© ici par dimensions)
                    const vidEl = document.createElement('video'); vidEl.src = video;
                    await new Promise(r => vidEl.onloadedmetadata = r);
                    const isShort = (vidEl.videoHeight > vidEl.videoWidth) && type !== 'stream';

                    const newVid = {
                        id: Date.now(), title, url: video, thumb, author: this.data.user.name,
                        likes: 0, dislikes: 0, views: 0, 
                        isShort: isShort, isStream: (type === 'stream'), comments: []
                    };
                    this.data.videos.unshift(newVid);
                    await this.saveGist();
                    this.closeModals(); this.goHome();
                } catch(e) { console.error(e); alert("Erreur upload"); }
                document.getElementById('publishBtn').disabled = false;
            },

            publishPost: async function() {
                const txt = document.getElementById('postContent').value;
                const imgFile = document.getElementById('postImageFile').files[0];
                if (!txt && !imgFile) return alert("Vide ?");
                
                let imgUrl = "";
                if (imgFile) imgUrl = await this.uploadCloudinary(imgFile, 'image');

                const newPost = { id: Date.now(), content: txt, image: imgUrl, time: Date.now(), comments: [], likes: {} };
                const user = this.data.users[this.data.user.name];
                user.posts = user.posts || [];
                user.posts.unshift(newPost);
                
                await this.saveGist();
                this.closeModals();
                this.viewProfile(this.data.user.name);
                this.showProfileTab('posts');
            },

            // --- COMMENTAIRES VIDEO (CR√âATEUR) ---

            renderComments: function(video) {
                const list = document.getElementById('commentList');
                const count = document.getElementById('commentCount');
                if (!video.comments || video.comments.length === 0) {
                    count.innerText = "Commentaires (0)"; list.innerHTML = "<p style='color:#aaa'>Aucun commentaire.</p>"; return;
                }
                
                // Trier: √âpingl√©s d'abord, puis r√©cents
                const sorted = [...video.comments].sort((a,b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0) || b.time - a.time);

                count.innerText = `Commentaires (${sorted.length})`;
                list.innerHTML = sorted.map((c, i) => {
                    const isAuthor = this.data.user && this.data.user.name === video.author;
                    const realIndex = video.comments.findIndex(x => x.time === c.time && x.user === c.user); // Find index in original array

                    return `
                    <div class="comment-row">
                        <img src="${this.getAvatar(c.user)}" class="avatar-small">
                        <div style="flex:1;">
                            ${c.pinned ? '<div class="pinned-badge">üìå √âpingl√© par le cr√©ateur</div>' : ''}
                            <p style="margin:0; font-size:13px;"><b>${c.user}</b> <span style="color:#aaa; font-size:11px;">${this.timeAgo(c.time)}</span></p>
                            <p style="margin:4px 0;">${c.text}</p>
                            
                            <div class="comment-actions">
                                ${isAuthor ? `<span class="action-icon" onclick="app.togglePinComment(${video.id}, ${realIndex})">${c.pinned ? 'D√©tacher' : '√âpingler'}</span>` : ''}
                                <span class="action-icon ${c.hearted ? 'heart-active' : ''}" onclick="${isAuthor ? `app.toggleHeartComment(${video.id}, ${realIndex})` : ''}">
                                    ${c.hearted ? '‚ù§Ô∏è Aim√© par l\'auteur' : (isAuthor ? '‚ô° Aimer' : '')}
                                </span>
                            </div>
                        </div>
                        ${c.hearted && !isAuthor ? '<div title="Aim√© par le cr√©ateur">‚ù§Ô∏è</div>' : ''}
                    </div>
                `}).join('');
                document.getElementById('userCommentAvatar').src = this.getAvatar(this.data.user?.name);
            },

            togglePinComment: async function(vidId, idx) {
                const v = this.data.videos.find(x => x.id == vidId);
                // Unpin others if pinning new one (Youtube style usually allows one pinned)
                v.comments.forEach((c, i) => { if (i !== idx) c.pinned = false; });
                v.comments[idx].pinned = !v.comments[idx].pinned;
                await this.saveGist(); this.renderComments(v);
            },

            toggleHeartComment: async function(vidId, idx) {
                const v = this.data.videos.find(x => x.id == vidId);
                v.comments[idx].hearted = !v.comments[idx].hearted;
                await this.saveGist(); this.renderComments(v);
            },

            addComment: async function() {
                if(!this.data.user) return this.openLogin();
                const txt = document.getElementById('newCommentInput').value.trim();
                if(!txt) return;
                const v = this.data.videos.find(x => x.id == this.currentPlayingVideoId);
                v.comments.unshift({ user: this.data.user.name, text: txt, time: Date.now() });
                document.getElementById('newCommentInput').value = '';
                await this.saveGist(); this.renderComments(v);
            },

            // --- CREDITS ---
            openCreditsModal: function() { document.getElementById('modalCredits').style.display='flex'; this.renderCredits(); },
            renderCredits: function() {
                document.getElementById('creditsList').innerHTML = this.data.credits.map(c => `<div>‚≠ê ${c}</div>`).join('');
                document.getElementById('adminCreditsList').innerHTML = this.data.credits.map(c => `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; background:#222; padding:5px;">
                        ${c} <button class="btn-red" style="padding:2px 5px;" onclick="app.removeCredit('${c}')">X</button>
                    </div>`).join('');
            },
            
            // --- ADMIN ---
            openAddCreditModal: async function() {
                const name = prompt("Nom √† ajouter aux cr√©dits ?");
                if (name) { this.data.credits.push(name); await this.saveGist(); this.renderCredits(); }
            },
            removeCredit: async function(name) {
                if(!confirm("Supprimer ?")) return;
                this.data.credits = this.data.credits.filter(c => c !== name);
                await this.saveGist(); this.renderCredits();
            },

            // --- UTILS ---
            uploadCloudinary: function(file, type) {
                return new Promise((resolve, reject) => {
                    const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${type}/upload`, { method:'POST', body:fd })
                    .then(r => r.json()).then(d => resolve(d.secure_url)).catch(reject);
                });
            },
            timeAgo: function(ts) {
                const s = Math.floor((Date.now()-ts)/1000);
                if(s<60) return "√† l'instant"; if(s<3600) return Math.floor(s/60)+" min";
                if(s<86400) return Math.floor(s/3600)+" h"; return Math.floor(s/86400)+" j";
            },
            isAdmin: function() { return this.data.user && this.data.admins.includes(this.data.user.email); },
            
            // -- AUTH & MODALS --
            openLogin: function() { document.getElementById('modalLoginEmail').style.display='flex'; },
            closeModals: function() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); },
            closePlayer: function() { document.getElementById('playerModal').style.display='none'; document.getElementById('mainVideoPlayer').pause(); },
            
            toggleSub: async function(author) {
                if(!this.data.user) return this.openLogin();
                const myName = this.data.user.name;
                const authorProfile = this.data.users[author]; authorProfile.followers = authorProfile.followers || {};
                
                const level = this.data.subs[author] || 0;
                // Cycle: 0 -> 1 -> 2 -> 3 -> 0
                const next = (level + 1) > 3 ? 0 : level + 1;
                
                if (next === 0) { delete this.data.subs[author]; delete authorProfile.followers[myName]; }
                else { this.data.subs[author] = next; authorProfile.followers[myName] = next; }
                
                await this.saveGist(); this.saveLocal();
                this.viewProfile(author); this.renderSubsSidebar();
            },
            getSubscriptionButton: function(author) {
                const lvl = this.data.subs[author] || 0;
                const txt = lvl === 0 ? "S'abonner" : (lvl===1 ? "‚úÖ Abonn√©" : (lvl===2 ? "üîî Suivi+" : "üîîüîî Suivi++"));
                const style = lvl === 0 ? "btn-red" : "followed";
                return `<button class="action-pill ${style}" onclick="app.toggleSub('${author}')">${txt}</button>`;
            },
            loginStep: async function(s) { /* Login logic standard shortened for space */
                const email = document.getElementById('logEmail').value.toLowerCase();
                if(s==1) {
                    if(this.data.bannedEmails.includes(email)) return alert("Banni");
                    this.closeModals();
                    if(localUserCreds[email]) { document.getElementById('modalLoginPass').style.display='flex'; }
                    else { document.getElementById('modalLoginRegister').style.display='flex'; }
                } else if(s==2) {
                    const name = document.getElementById('logNewName').value; const pass = document.getElementById('logNewPass').value;
                    localUserCreds[email] = {email, name, pass}; localStorage.setItem('mt_user_creds', JSON.stringify(localUserCreds));
                    this.data.users[name] = { name, email, bio:"Nouveau", posts:[], followers:{} };
                    this.data.user = localUserCreds[email]; await this.saveGist(); this.saveLocal(); location.reload();
                } else if(s==3) {
                    const pass = document.getElementById('logPass').value;
                    if(localUserCreds[email].pass === pass) { this.data.user = localUserCreds[email]; this.saveLocal(); location.reload(); }
                    else alert("Erreur pass");
                }
            },
            doLogout: function() { localStorage.clear(); location.reload(); },
            updateAuthUI: function() {
                const b = document.getElementById('loginBtn');
                if(this.data.user) { b.innerText = this.data.user.name; document.getElementById('menuUserName').innerText = this.data.user.name; }
            },
            toggleAccountMenu: function() { const m=document.getElementById('accountMenu'); m.style.display = m.style.display==='none'?'block':'none'; },
            
            // --- PLAYER ---
            openVideoOverlay: async function(id, isShort) {
                const v = this.data.videos.find(x => x.id == id); if(!v) return;
                this.currentPlayingVideoId = id;
                document.getElementById('playerModal').style.display='block';
                const p = document.getElementById('mainVideoPlayer'); p.src = v.url; p.play();
                document.getElementById('playerTitle').innerText = v.title;
                
                // Player interactions
                const vote = this.data.votes[id] || 0;
                const btnSub = (this.data.user && this.data.user.name !== v.author) ? this.getSubscriptionButton(v.author).replace("onclick=\"app.toggleSub", "onclick=\"app.closePlayer(); app.toggleSub") : '';
                document.getElementById('playerActions').innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="app.closePlayer(); app.viewProfile('${v.author}')">
                        <img src="${this.getAvatar(v.author)}" class="avatar-small"><b>${v.author}</b>
                    </div>
                    ${btnSub}
                    <button class="action-pill ${vote===1?'liked':''}" onclick="app.toggleVote(${id}, 'like')">üëç ${v.likes||0}</button>
                    <button class="action-pill ${vote===-1?'disliked':''}" onclick="app.toggleVote(${id}, 'dislike')">üëé ${v.dislikes||0}</button>
                `;
                this.renderComments(v);
                
                // Views logic
                const now = Date.now();
                if (!this.data.lastViewTimes[id] || (now - this.data.lastViewTimes[id] > VIEW_COOLDOWN_MS)) {
                    v.views = (v.views||0)+1; this.data.lastViewTimes[id]=now; await this.saveGist();
                }
                this.data.history = [id, ...this.data.history.filter(x=>x!==id)].slice(0,50); this.saveLocal();
            },
            toggleVote: async function(id, type) {
                if(!this.data.user) return this.openLogin();
                const v = this.data.videos.find(x => x.id == id);
                const old = this.data.votes[id] || 0;
                v.likes = v.likes||0; v.dislikes = v.dislikes||0;
                if(type==='like') {
                    if(old===1) { v.likes--; this.data.votes[id]=0; }
                    else { if(old===-1) v.dislikes--; v.likes++; this.data.votes[id]=1; }
                } else {
                    if(old===-1) { v.dislikes--; this.data.votes[id]=0; }
                    else { if(old===1) v.likes--; v.dislikes++; this.data.votes[id]=-1; }
                }
                await this.saveGist(); this.saveLocal(); this.openVideoOverlay(id); // refresh UI
            }
        };

        app.init();
    </script>
</body>
</html>
