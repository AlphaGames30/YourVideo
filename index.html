<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona V23 - Ultimate Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --header: #0a0a0a;
            --sidebar: #0a0a0a;
            --card: #121212;
            --text: #ffffff;
            --sec-text: #aaaaaa;
            --accent: #6e45e2;
            --accent-glow: rgba(110, 69, 226, 0.3);
            --red: #ff3e3e;
            --border: #1f1f1f;
            --gold: #ffd700;
        }

        * { box-sizing: border-box; transition: all 0.2s ease-out; }
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: 'Inter', sans-serif; overflow: hidden; 
        }

        /* --- SCROLLBAR CUSTOM --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- HEADER --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; height: 75px; background: var(--header);
            position: sticky; top: 0; z-index: 2000; border-bottom: 1px solid var(--border);
        }

        .v-logo {
            display: flex; align-items: center; gap: 15px; cursor: pointer;
            font-size: 26px; font-weight: 800; letter-spacing: -1px;
        }
        .v-icon {
            width: 42px; height: 42px; background: linear-gradient(135deg, var(--accent), #4facfe);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 900; transform: rotate(-5deg);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .search-area {
            flex: 1; max-width: 600px; display: flex; align-items: center;
            background: #000; border: 1px solid var(--border); border-radius: 30px;
            padding: 5px 5px 5px 20px; margin: 0 50px;
        }
        .search-area input {
            flex: 1; background: transparent; border: none; color: white;
            outline: none; font-size: 15px;
        }
        .search-area button {
            background: var(--accent); border: none; color: white;
            padding: 8px 20px; border-radius: 20px; cursor: pointer;
        }

        /* --- LAYOUT --- */
        .app-container { display: flex; height: calc(100vh - 75px); }

        .sidebar {
            width: 280px; background: var(--sidebar); border-right: 1px solid var(--border);
            padding: 20px; overflow-y: auto; flex-shrink: 0;
        }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg); }

        /* --- NAVIGATION --- */
        .nav-group { margin-bottom: 30px; }
        .nav-label { font-size: 11px; color: var(--sec-text); font-weight: 800; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        
        .nav-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 15px;
            border-radius: 12px; cursor: pointer; color: var(--sec-text);
            margin-bottom: 4px; font-weight: 500;
        }
        .nav-item:hover { background: var(--card); color: white; }
        .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 15px var(--accent-glow); }
        .nav-item svg { width: 20px; height: 20px; }

        /* --- GRID & CARDS --- */
        .video-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px;
        }

        @media (max-width: 1400px) { .video-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1000px) { .video-grid { grid-template-columns: repeat(2, 1fr); } }

        .v-card { cursor: pointer; position: relative; }
        .v-thumb {
            width: 100%; aspect-ratio: 16/9; border-radius: 18px;
            background: #1a1a1a; overflow: hidden; position: relative;
            border: 1px solid var(--border);
        }
        .v-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .v-card:hover .v-thumb img { transform: scale(1.05); }

        .v-info { display: flex; gap: 12px; margin-top: 15px; }
        .v-avatar {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border);
            background: var(--card); flex-shrink: 0; object-fit: cover;
        }
        .v-meta h4 { margin: 0 0 5px 0; font-size: 15px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .v-meta p { margin: 0; font-size: 13px; color: var(--sec-text); }

        .badge-live {
            position: absolute; top: 12px; left: 12px; background: var(--red);
            padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* --- PROFIL PAGE --- */
        .profile-header {
            background: linear-gradient(to bottom, #1a1a1a, var(--bg));
            padding: 50px; border-radius: 30px; margin-bottom: 30px; border: 1px solid var(--border);
        }
        .profile-tabs {
            display: flex; gap: 40px; border-bottom: 1px solid var(--border); margin-bottom: 25px;
        }
        .p-tab {
            padding: 15px 0; cursor: pointer; color: var(--sec-text); font-weight: 600;
            position: relative;
        }
        .p-tab.active { color: var(--accent); }
        .p-tab.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; width: 100%;
            height: 3px; background: var(--accent); border-radius: 3px;
        }

        /* --- PLAYER OVERLAY --- */
        #playerOverlay {
            display: none; position: fixed; inset: 0; background: #000; z-index: 5000;
            overflow-y: auto; padding-bottom: 100px;
        }
        .player-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .video-box {
            width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 24px;
            overflow: hidden; border: 1px solid #222; position: relative;
        }
        .video-box video, .video-box canvas { width: 100%; height: 100%; }

        /* --- MODALS --- */
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 6000; align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        .modal-body {
            background: var(--header); padding: 40px; border-radius: 30px;
            width: 90%; max-width: 550px; border: 1px solid var(--border);
        }
        input, select, textarea {
            width: 100%; padding: 15px; margin: 12px 0; background: #000;
            border: 1px solid var(--border); color: white; border-radius: 12px; outline: none;
        }
        .btn-prime {
            background: var(--accent); color: white; border: none; padding: 15px;
            border-radius: 12px; width: 100%; font-weight: 700; cursor: pointer;
        }

        /* --- TIER BADGES --- */
        .tier { font-size: 10px; padding: 3px 8px; border-radius: 5px; margin-left: 8px; font-weight: 900; }
        .tier-standard { background: #333; }
        .tier-premium { background: var(--accent); }
        .tier-vip { background: var(--gold); color: #000; }
    </style>
</head>
<body>

    <header>
        <div class="v-logo" onclick="app.nav('home')">
            <div class="v-icon">V</div> VISIONA
        </div>
        <div class="search-area">
            <input type="text" id="searchInput" placeholder="Rechercher sur Visiona...">
            <button onclick="app.search()">Rechercher</button>
        </div>
        <div id="userHeader" style="display:flex; align-items:center; gap:20px;"></div>
    </header>

    <div class="app-container">
        <aside class="sidebar">
            <div class="nav-group">
                <div class="nav-label">Menu</div>
                <div class="nav-item active" id="menu-home" onclick="app.nav('home')">üè† Accueil</div>
                <div id="menu-mychannel" class="nav-item" onclick="app.goMyProfile()">üë§ Ma Cha√Æne</div>
                <div class="nav-item" id="menu-zapps" onclick="app.nav('zapps')">‚ö° Zapps</div>
                <div class="nav-item" id="menu-lives" onclick="app.nav('lives')">üî¥ Directs</div>
            </div>

            <div class="nav-group">
                <div class="nav-label">Biblioth√®que</div>
                <div class="nav-item" onclick="app.nav('history')">üïí Historique</div>
                <div class="nav-item" onclick="app.nav('stats')">üìä Statistiques</div>
                <div class="nav-item" onclick="app.nav('community')">üì∞ Communaut√©</div>
            </div>

            <div class="nav-group">
                <div class="nav-label">Abonnements</div>
                <div id="sideAbonnements"></div>
            </div>

            <div id="adminLink" style="display:none;" class="nav-group">
                <div class="nav-label">Propri√©taire</div>
                <div class="nav-item" onclick="app.nav('admin')" style="color:var(--gold);">üîë Administration</div>
            </div>
        </aside>

        <main class="main-content">
            <div id="view-home">
                <h2 style="margin-bottom:25px;">Recommandations</h2>
                <div id="grid-home" class="video-grid"></div>
            </div>

            <div id="view-profile" style="display:none;">
                <div id="profile-render"></div>
            </div>

            <div id="view-history" style="display:none;">
                <h2 style="margin-bottom:25px;">üïí Historique de lecture</h2>
                <div id="grid-history" class="video-grid"></div>
            </div>

            <div id="view-alt" style="display:none;"></div>
        </main>
    </div>

    <div id="playerOverlay">
        <div class="player-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn-prime" style="width:auto; padding:10px 30px;" onclick="app.closePlayer()">‚úï FERMER LE LECTEUR</button>
            </div>
            
            <div class="video-box">
                <video id="mainVid" controls autoplay></video>
                <canvas id="liveCanvas" style="display:none;"></canvas>
            </div>

            <div style="margin-top:25px;">
                <h1 id="p-title" style="font-size:24px; margin-bottom:10px;"></h1>
                <div id="p-meta" style="color:var(--sec-text); font-size:14px; margin-bottom:20px;"></div>
                
                <div id="p-author-bar" style="display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:20px; border-radius:20px; border:1px solid var(--border);">
                    </div>

                <div style="margin-top:40px;">
                    <h3>Commentaires</h3>
                    <div style="display:flex; gap:15px; margin-bottom:30px;">
                        <input type="text" id="comInput" placeholder="Exprimer votre avis..." style="margin:0;">
                        <button class="btn-prime" style="width:150px;" onclick="app.postComment()">Publier</button>
                    </div>
                    <div id="comList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalUpload" class="modal">
        <div class="modal-body">
            <h2 style="margin-top:0;">Cr√©er un contenu</h2>
            <select id="upType" onchange="app.uiToggleUp()">
                <option value="video">Vid√©o Longue (16:9)</option>
                <option value="zapp">‚ö° Zapp (9:16)</option>
                <option value="post">üì∞ Publication Texte</option>
                <option value="live">üî¥ Lancer un Direct</option>
            </select>
            
            <input type="text" id="upTitle" placeholder="Titre ou texte de la publication">
            
            <div id="upFileGroup">
                <div style="font-size:12px; color:var(--sec-text); margin-bottom:5px;">Fichier Vid√©o :</div>
                <input type="file" id="upVideoFile" accept="video/*">
                <div style="font-size:12px; color:var(--sec-text); margin-bottom:5px;">Miniature (Optionnel) :</div>
                <input type="file" id="upThumbFile" accept="image/*">
            </div>

            <div id="liveStatus" style="display:none; background:#000; padding:15px; border-radius:10px; border:1px solid var(--red); color:var(--red); font-size:13px; text-align:center;">
                La cam√©ra sera activ√©e d√®s la publication.
            </div>

            <div id="upProgress" style="color:var(--accent); font-weight:bold; font-size:13px; margin-top:10px;"></div>
            
            <button id="btnSubmitUp" class="btn-prime" style="margin-top:20px;" onclick="app.publish()">METTRE EN LIGNE</button>
            <button onclick="app.closeModals()" style="background:none; border:none; color:var(--sec-text); width:100%; margin-top:15px; cursor:pointer;">Annuler</button>
        </div>
    </div>

    <div id="modalSub" class="modal">
        <div class="modal-body">
            <h2 id="subTargetName">S'abonner</h2>
            <p style="color:var(--sec-text);">Choisissez le niveau d'acc√®s pour soutenir ce cr√©ateur :</p>
            <button onclick="app.confirmSub('Standard')" class="btn-prime" style="background:#333; margin-bottom:10px;">STANDARD (Acc√®s gratuit)</button>
            <button onclick="app.confirmSub('Premium')" class="btn-prime" style="background:var(--accent); margin-bottom:10px;">PREMIUM (Badge de soutien)</button>
            <button onclick="app.confirmSub('VIP')" class="btn-prime" style="background:var(--gold); color:#000;">VIP (Badge exclusif)</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            CLOUD: "https://api.cloudinary.com/v1_1/dvbsmh8qq/upload",
            GIST: "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json",
            WORKER: "https://mytubeupload.edonis-imbert.workers.dev/",
            PRESET: "mytube_upload"
        };

        const liveBus = new BroadcastChannel('visiona_v23_core');

        const app = {
            data: {
                user: JSON.parse(localStorage.getItem('vi_user')),
                videos: [], users: {}, posts: [],
                subs: JSON.parse(localStorage.getItem('vi_subs')) || [], // {name, tier}
                history: JSON.parse(localStorage.getItem('vi_history')) || [],
                viewLog: JSON.parse(localStorage.getItem('vi_viewlog')) || {}
            },
            activeVid: null,
            
            // --- INITIALISATION ---
            init: async function() {
                console.log("Visiona Engine V23 Starting...");
                await this.fetchData();
                this.renderUI();
                this.nav('home');
                this.listenToLive();
            },

            fetchData: async function() {
                try {
                    const r = await fetch(CONFIG.GIST + "?t=" + Date.now());
                    const j = await r.json();
                    this.data.videos = j.videos || [];
                    this.data.users = j.users || {};
                    this.data.posts = j.posts || [];
                } catch(e) { console.error("Database Error", e); }
            },

            saveData: async function() {
                const payload = { videos: this.data.videos, users: this.data.users, posts: this.data.posts };
                await fetch(CONFIG.WORKER, {
                    method: 'PATCH',
                    body: JSON.stringify({ files: {"video.json": {content: JSON.stringify(payload, null, 2)}}})
                });
            },

            // --- NAVIGATION ---
            nav: function(page) {
                const views = ['view-home', 'view-profile', 'view-history', 'view-alt'];
                views.forEach(v => document.getElementById(v).style.display = 'none');
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));

                if(page === 'home') {
                    document.getElementById('view-home').style.display = 'block';
                    document.getElementById('menu-home').classList.add('active');
                    this.renderHome();
                } else if(page === 'history') {
                    document.getElementById('view-history').style.display = 'block';
                    this.renderHistory();
                } else {
                    document.getElementById('view-alt').style.display = 'block';
                }
            },

            // --- RENDUS ---
            renderHome: function() {
                const grid = document.getElementById('grid-home');
                // Al√©atoire :
                let shuf = [...this.data.videos.filter(v => !v.isShort && !v.isStream)];
                shuf.sort(() => Math.random() - 0.5);
                this.drawGrid(shuf, grid);
            },

            renderHistory: function() {
                const grid = document.getElementById('grid-history');
                const vids = this.data.history.map(id => this.data.videos.find(v => v.id == id)).filter(v => v);
                this.drawGrid(vids, grid);
            },

            drawGrid: function(list, container) {
                container.innerHTML = list.map(v => `
                    <div class="v-card" onclick="app.openPlayer('${v.id}')">
                        <div class="v-thumb">
                            <img src="${v.thumb || 'https://via.placeholder.com/400x225/111/fff?text=Visiona'}">
                            ${v.isStream ? '<div class="badge-live">DIRECT</div>' : ''}
                        </div>
                        <div class="v-info">
                            ${this.getAvatar(v.author)}
                            <div class="v-meta">
                                <h4>${v.title}</h4>
                                <p>${v.author} ‚Ä¢ ${v.views || 0} vues</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            getAvatar: function(name, size = 40) {
                const u = this.data.users[name];
                const src = u?.avatar ? u.avatar : `https://ui-avatars.com/api/?name=${name}&background=6e45e2&color=fff`;
                return `<img src="${src}" class="v-avatar" style="width:${size}px; height:${size}px;" onclick="event.stopPropagation(); app.goProfile('${name}')">`;
            },

            // --- PAGE PROFIL DYNAMIQUE ---
            goProfile: function(name) {
                this.nav('profile');
                const view = document.getElementById('view-profile');
                view.style.display = 'block';
                
                const uVids = this.data.videos.filter(v => v.author === name);
                const subCount = this.data.subs.filter(s => s.name === name).length;

                document.getElementById('profile-render').innerHTML = `
                    <div class="profile-header">
                        <div style="display:flex; align-items:center; gap:30px;">
                            ${this.getAvatar(name, 100)}
                            <div>
                                <h1 style="margin:0; font-size:32px;">${name}</h1>
                                <p style="color:var(--sec-text); margin-top:5px;">@${name.toLowerCase()} ‚Ä¢ ${subCount} abonn√©s ‚Ä¢ ${uVids.length} vid√©os</p>
                            </div>
                        </div>
                    </div>
                    <div class="profile-tabs">
                        <div class="p-tab active" onclick="app.switchTab(this, '${name}', 'v')">VID√âOS</div>
                        <div class="p-tab" onclick="app.switchTab(this, '${name}', 'z')">ZAPPS</div>
                        <div class="p-tab" onclick="app.switchTab(this, '${name}', 's')">DIRECTS</div>
                        <div class="p-tab" onclick="app.switchTab(this, '${name}', 'p')">PUBLICATIONS</div>
                    </div>
                    <div id="profile-grid" class="video-grid"></div>
                `;
                this.switchTab(null, name, 'v');
            },

            switchTab: function(el, name, type) {
                if(el) {
                    document.querySelectorAll('.p-tab').forEach(t => t.classList.remove('active'));
                    el.classList.add('active');
                }
                const grid = document.getElementById('profile-grid');
                const vids = this.data.videos.filter(v => v.author === name);

                if(type === 'v') this.drawGrid(vids.filter(v => !v.isShort && !v.isStream), grid);
                if(type === 'z') this.drawGrid(vids.filter(v => v.isShort), grid);
                if(type === 's') this.drawGrid(vids.filter(v => v.isStream), grid);
                if(type === 'p') {
                    grid.innerHTML = this.data.posts.filter(p => p.author === name).map(p => `
                        <div style="background:var(--card); padding:30px; border-radius:20px; grid-column: span 4; border:1px solid var(--border);">
                            <p style="font-size:16px; line-height:1.6;">${p.text}</p>
                            <div style="font-size:12px; color:var(--sec-text); margin-top:15px;">Publi√© le ${p.date || 'R√©cemment'}</div>
                        </div>
                    `).join('');
                }
            },

            // --- LECTEUR & VUES ---
            openPlayer: function(id) {
                const v = this.data.videos.find(x => x.id == id);
                this.activeVid = v;

                // LOGIQUE VUES + COOLDOWN
                const now = Date.now();
                if(!this.data.viewLog[id] || (now - this.data.viewLog[id] > 3600000)) {
                    v.views = (v.views || 0) + 1;
                    this.data.viewLog[id] = now;
                    localStorage.setItem('vi_viewlog', JSON.stringify(this.data.viewLog));
                    this.saveData(); // Sauvegarde persistante
                }

                // HISTORIQUE
                this.data.history = [id, ...this.data.history.filter(x => x != id)].slice(0, 50);
                localStorage.setItem('vi_history', JSON.stringify(this.data.history));

                document.getElementById('playerOverlay').style.display = 'block';
                document.getElementById('p-title').innerText = v.title;
                document.getElementById('p-meta').innerText = `${v.views} vues ‚Ä¢ ${v.date || 'Aujourd\'hui'}`;
                
                const vidEl = document.getElementById('mainVid');
                if(v.isStream) {
                    vidEl.style.display = 'none'; document.getElementById('liveCanvas').style.display = 'block';
                } else {
                    vidEl.style.display = 'block'; document.getElementById('liveCanvas').style.display = 'none';
                    vidEl.src = v.url;
                }

                this.renderPlayerBar();
                this.renderComments();
            },

            renderPlayerBar: function() {
                const sub = this.data.subs.find(s => s.name === this.activeVid.author);
                document.getElementById('p-author-bar').innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px; cursor:pointer;" onclick="app.closePlayer(); app.goProfile('${this.activeVid.author}')">
                        ${this.getAvatar(this.activeVid.author, 50)}
                        <div>
                            <div style="font-weight:bold; font-size:18px;">${this.activeVid.author}</div>
                            ${sub ? `<span class="tier tier-${sub.tier.toLowerCase()}">${sub.tier}</span>` : ''}
                        </div>
                    </div>
                    <button class="btn-prime" style="width:auto; padding:12px 30px;" onclick="app.openSubModal('${this.activeVid.author}')">
                        ${sub ? 'ABONN√â ‚úÖ' : 'S\'ABONNER'}
                    </button>
                `;
            },

            // --- PUBLICATION & CLOUDINARY ---
            uiToggleUp: function() {
                const t = document.getElementById('upType').value;
                document.getElementById('upFileGroup').style.display = (t === 'post' || t === 'live') ? 'none' : 'block';
                document.getElementById('liveStatus').style.display = (t === 'live') ? 'block' : 'none';
            },

            publish: async function() {
                const type = document.getElementById('upType').value;
                const title = document.getElementById('upTitle').value;
                if(!title) return alert("Veuillez saisir un titre.");

                const btn = document.getElementById('btnSubmitUp');
                const prog = document.getElementById('upProgress');
                btn.disabled = true; prog.innerText = "‚è≥ Connexion √† Cloudinary...";

                try {
                    let vUrl = "", tUrl = "https://via.placeholder.com/800x450/111/fff?text=Visiona";
                    
                    if(type === 'video' || type === 'zapp') {
                        const vFile = document.getElementById('upVideoFile').files[0];
                        const tFile = document.getElementById('upThumbFile').files[0];
                        if(!vFile) throw "Fichier vid√©o manquant.";
                        
                        vUrl = await this.uploadCloud(vFile, 'video');
                        if(tFile) tUrl = await this.uploadCloud(tFile, 'image');
                    }

                    if(type === 'post') {
                        this.data.posts.unshift({ author: this.data.user.name, text: title, date: new Date().toLocaleDateString() });
                    } else if(type === 'live') {
                        const streamId = "live_" + Date.now();
                        this.data.videos.unshift({ id: streamId, title, author: this.data.user.name, isStream: true, views: 0, date: "EN DIRECT" });
                        this.startStreamBroadcast(streamId);
                    } else {
                        this.data.videos.unshift({
                            id: Date.now(), title, author: this.data.user.name,
                            url: vUrl, thumb: tUrl, isShort: (type === 'zapp'), views: 0, date: new Date().toLocaleDateString()
                        });
                    }

                    await this.saveData();
                    location.reload();
                } catch(e) { alert(e); btn.disabled = false; prog.innerText = ""; }
            },

            uploadCloud: async function(file, rType) {
                const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', CONFIG.PRESET);
                const res = await fetch(CONFIG.CLOUD.replace('upload', rType+'/upload'), { method: 'POST', body: fd });
                const json = await res.json();
                return json.secure_url;
            },

            // --- STREAMING TEMPS REEL ---
            startStreamBroadcast: async function(sid) {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');
                cvs.width = 640; cvs.height = 360;
                
                const vid = document.createElement('video');
                vid.srcObject = stream;
                vid.play();

                setInterval(() => {
                    ctx.drawImage(vid, 0, 0, 640, 360);
                    liveBus.postMessage({ id: sid, frame: cvs.toDataURL('image/jpeg', 0.5) });
                }, 100);
            },

            listenToLive: function() {
                liveBus.onmessage = (e) => {
                    if(this.activeVid?.id === e.data.id) {
                        const canvas = document.getElementById('liveCanvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        img.src = e.data.frame;
                    }
                };
            },

            // --- GESTION UTILISATEUR ---
            renderUI: function() {
                const h = document.getElementById('userHeader');
                if(this.data.user) {
                    h.innerHTML = `
                        <button onclick="app.openModal('modalUpload')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">‚äï</button>
                        ${this.getAvatar(this.data.user.name, 45)}
                    `;
                    if(this.data.user.email === "edonis.imbert@gmail.com") document.getElementById('adminLink').style.display = 'block';
                    document.getElementById('menu-mychannel').style.display = 'flex';
                } else {
                    h.innerHTML = `<button class="btn-prime" style="width:auto; padding:8px 20px;" onclick="app.login()">Connexion</button>`;
                    document.getElementById('menu-mychannel').style.display = 'none';
                }

                document.getElementById('sideAbonnements').innerHTML = this.data.subs.map(s => `
                    <div class="nav-item" onclick="app.goProfile('${s.name}')">
                        ${this.getAvatar(s.name, 24)} <span>${s.name}</span> <span class="tier tier-${s.tier.toLowerCase()}">${s.tier[0]}</span>
                    </div>
                `).join('');
            },

            login: function() {
                const p = prompt("Choisissez un pseudo :");
                if(p) {
                    this.data.user = { name: p, email: p+"@visiona.com" };
                    localStorage.setItem('vi_user', JSON.stringify(this.data.user));
                    location.reload();
                }
            },

            openSubModal: function(name) {
                this.pendingSub = name;
                document.getElementById('subTargetName').innerText = "S'abonner √† " + name;
                this.openModal('modalSub');
            },

            confirmSub: function(tier) {
                this.data.subs = this.data.subs.filter(x => x.name !== this.pendingSub);
                this.data.subs.push({ name: this.pendingSub, tier: tier });
                localStorage.setItem('vi_subs', JSON.stringify(this.data.subs));
                this.saveData();
                location.reload();
            },

            goMyProfile: function() { if(this.data.user) this.goProfile(this.data.user.name); },
            openModal: function(id) { document.getElementById(id).style.display = 'flex'; },
            closeModals: function() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); },
            closePlayer: function() { document.getElementById('playerOverlay').style.display = 'none'; document.getElementById('mainVid').pause(); }
        };

        app.init();
    </script>
</body>
</html>
