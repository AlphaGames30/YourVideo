<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona V18 - AlphaGames30 & Edonis</title>
    <style>
        :root { 
            --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; 
            --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --gold: #ffd700;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: Roboto, Arial, sans-serif; overflow-x: hidden; }
        
        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; height: 56px; background: var(--header); position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #222; }
        .logo { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 20px; font-weight: bold; }
        .logo-play { background: var(--red); color: white; padding: 5px 10px; border-radius: 8px; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        
        .search-box { display: flex; flex: 1; max-width: 600px; margin: 0 20px; }
        .search-box input { width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 10px 15px; border-radius: 40px 0 0 40px; outline: none; }
        .search-box button { background: #222; border: 1px solid #333; padding: 0 20px; border-radius: 0 40px 40px 0; cursor: pointer; color: white; }

        /* --- SIDEBAR --- */
        .container { display: flex; height: calc(100vh - 56px); }
        .sidebar { width: 240px; background: var(--bg); padding: 12px; overflow-y: auto; flex-shrink: 0; border-right: 1px solid #222; }
        .nav-item { padding: 10px 12px; border-radius: 10px; cursor: pointer; margin-bottom: 4px; display: flex; align-items: center; gap: 15px; transition: 0.2s; font-size: 14px; }
        .nav-item:hover { background: var(--hover); }
        .nav-active { background: var(--hover); font-weight: bold; border-left: 3px solid var(--red); }
        
        /* --- CONTENT --- */
        .content { flex: 1; padding: 24px; overflow-y: auto; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        /* --- ZAPP (SHORTS) --- */
        .zapp-container { display: flex; flex-direction: column; align-items: center; gap: 20px; overflow-y: auto; height: 100%; scroll-snap-type: y mandatory; }
        .zapp-card { width: 340px; height: 600px; background: #000; border-radius: 15px; position: relative; scroll-snap-align: start; flex-shrink: 0; }
        .zapp-card video { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; }

        /* --- COMMENTAIRES (STYLE INDEX 13) --- */
        .comment-item { display: flex; gap: 12px; margin-bottom: 20px; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background: #444; flex-shrink: 0; }
        .comment-header { font-weight: bold; font-size: 13px; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
        .heart-badge { display: flex; align-items: center; gap: 5px; background: #1e1e1e; padding: 3px 8px; border-radius: 12px; border: 1px solid #333; font-size: 11px; margin-top: 5px; width: fit-content; }
        .heart-badge img { width: 16px; height: 16px; border-radius: 50%; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: #212121; padding: 25px; border-radius: 15px; width: 95%; max-width: 500px; border: 1px solid #333; }
        .modal-box input, .modal-box select, .modal-box textarea { width: 100%; padding: 12px; margin: 10px 0; background: #121212; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }

        .btn-blue { background: var(--blue); color: #000; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-red { background: var(--red); color: #fff; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        
        #accountMenu { display: none; position: fixed; right: 20px; top: 60px; background: #282828; border: 1px solid #444; border-radius: 12px; z-index: 1500; min-width: 220px; }
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <header>
        <div class="logo" onclick="app.goHome()">
            <div id="logoIcon" class="logo-play">‚ñ∂</div>
            <span>Visiona</span>
        </div>
        <div class="search-box">
            <input type="text" id="searchInp" placeholder="Rechercher une vid√©o...">
            <button onclick="app.search()">üîç</button>
        </div>
        <div id="authArea" style="display:flex; align-items:center; gap:15px;"></div>
    </header>

    <div id="accountMenu">
        <div id="menuUser" style="padding:15px; border-bottom:1px solid #444; font-weight:bold; color:var(--blue);"></div>
        <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma Cha√Æne</div>
        <div class="nav-item" onclick="app.doLogout()" style="color:var(--red);">üö™ D√©connexion</div>
    </div>

    <div class="container">
        <nav class="sidebar">
            <div class="nav-item nav-active" id="navHome" onclick="app.goHome()">üè† Accueil</div>
            <div class="nav-item" id="navShorts" onclick="app.goShorts()">‚ö° Zapp</div>
            <div class="nav-item" id="navStreams" onclick="app.goStreams()">üî¥ En Direct</div>
            <div class="nav-item" id="navPosts" onclick="app.goCommunity()">üì∞ Publications</div>
            <hr>
            <div class="nav-item" id="navHistory" onclick="app.goHistory()">üïí Historique</div>
            <div class="nav-item" id="navStats" onclick="app.goStats()">üìä Statistiques</div>
            <div class="nav-item" id="navCredits" onclick="app.goCredits()">üí≥ Cr√©dits</div>
            <hr>
            <div style="font-size:12px; color:var(--sec-text); padding:0 12px 8px;">ABONNEMENTS</div>
            <div id="sidebarSubs"></div>
            <hr>
            <div id="adminArea" style="display:none;">
                <div class="nav-item" style="color:var(--gold);" onclick="app.goAdmin()">üîë Administration</div>
            </div>
        </nav>

        <main class="content">
            <div id="mainGrid" class="video-grid"></div>
            <div id="zappGrid" class="zapp-container" style="display:none;"></div>
            <div id="communityView" style="display:none;"></div>
            <div id="historyView" style="display:none;"></div>
            <div id="statsView" style="display:none;"></div>
            <div id="creditsView" style="display:none;"></div>
        </main>
    </div>

    <div id="playerModal" class="modal" style="background:#000; align-items: flex-start; overflow-y: auto;">
        <div style="width:100%; max-width:1200px; margin: 0 auto; padding-top: 20px;">
            <button class="btn-blue" onclick="app.closePlayer()" style="margin-bottom:10px;">‚úï Retour</button>
            <div style="position:relative; width:100%; aspect-ratio:16/9; background:#000;">
                <video id="mainVid" controls autoplay style="width:100%; height:100%;"></video>
                <canvas id="liveCanvas" style="position:absolute; top:0; left:0; width:100%; height:100%; display:none;"></canvas>
            </div>
            <div id="playerDetails" style="padding:20px 0;">
                <h2 id="pTitle"></h2>
                <p id="pMeta" style="color:var(--sec-text);"></p>
                <div id="pAuthorRow" style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:15px;"></div>
                <div id="pComments" style="margin-top:30px;">
                    <h3>Commentaires</h3>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <input type="text" id="comInp" placeholder="Ajouter un commentaire..." style="flex:1; background:none; border:none; border-bottom:1px solid #444; color:white; outline:none;">
                        <button class="btn-blue" onclick="app.postComment()">Publier</button>
                    </div>
                    <div id="comList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalCreate" class="modal">
        <div class="modal-box">
            <h2>Que souhaitez-vous cr√©er ?</h2>
            <button class="btn-blue" style="width:100%; margin-bottom:10px;" onclick="app.prepUpload('video')">üé¨ Vid√©o Standard</button>
            <button class="btn-blue" style="width:100%; margin-bottom:10px; background:var(--gold); color:#000;" onclick="app.prepUpload('zapp')">‚ö° Zapp (Format Court)</button>
            <button class="btn-red" style="width:100%; margin-bottom:10px;" onclick="app.prepStream()">üî¥ Lancer un Stream</button>
            <button class="btn-blue" style="width:100%; background:#444;" onclick="app.prepPost()">üì∞ Publication</button>
            <button onclick="app.closeModals()" style="width:100%; background:none; border:none; color:var(--sec-text); margin-top:15px; cursor:pointer;">Annuler</button>
        </div>
    </div>

    <div id="modalUpload" class="modal">
        <div class="modal-box">
            <h2 id="upTypeTitle">Mise en ligne</h2>
            <input type="text" id="upTitle" placeholder="Titre de la vid√©o">
            <label>Fichier vid√©o :</label> <input type="file" id="upFileVid" accept="video/*">
            <label>Miniature (Image) :</label> <input type="file" id="upFileThumb" accept="image/*">
            <div id="upProgress" style="display:none; color:var(--blue); font-size:12px; margin:10px 0;">Chargement vers le cloud...</div>
            <button id="btnDoUpload" class="btn-blue" style="width:100%;" onclick="app.startUpload()">PUBLIER MAINTENANT</button>
        </div>
    </div>

    <script>
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dvbsmh8qq/upload";
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
        const WORKER_URL = "https://mytubeupload.edonis-imbert.workers.dev/";
        const streamBus = new BroadcastChannel('visiona_live_v18');

        const app = {
            data: {
                user: JSON.parse(localStorage.getItem('mt_user')),
                videos: [], users: {}, posts: [], credits: [],
                subs: JSON.parse(localStorage.getItem('mt_subs')) || [],
                history: JSON.parse(localStorage.getItem('mt_history')) || [],
                viewLog: JSON.parse(localStorage.getItem('mt_view_log')) || {}
            },
            currentType: 'video',
            activeVid: null,

            init: async function() {
                this.checkEasterEgg();
                await this.load();
                this.updateUI();
                this.goHome();
                this.listenToStreams();
            },

            checkEasterEgg: function() {
                if(Math.random() < 0.001) {
                    document.getElementById('logoIcon').innerText = 'üéÖ';
                    // Activer Neige ici
                }
            },

            load: async function() {
                try {
                    const r = await fetch(GIST_URL + "?t=" + Date.now());
                    const j = await r.json();
                    this.data.videos = j.videos || [];
                    this.data.users = j.users || {};
                    this.data.posts = j.posts || [];
                    this.data.credits = j.credits || ["AlphaGames30", "Edonis Imbert"];
                } catch(e) { console.error("Data error", e); }
            },

            save: async function() {
                const content = { videos: this.data.videos, users: this.data.users, posts: this.data.posts, credits: this.data.credits };
                await fetch(WORKER_URL, { method: 'PATCH', body: JSON.stringify({ files: {"video.json": {content: JSON.stringify(content, null, 2)}}}) });
            },

            // --- NAVIGATION ---
            hideAll: function() {
                ['mainGrid', 'zappGrid', 'communityView', 'historyView', 'statsView', 'creditsView'].forEach(id => document.getElementById(id).style.display = 'none');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
                document.getElementById('accountMenu').style.display = 'none';
            },

            goHome: function() {
                this.hideAll(); document.getElementById('navHome').classList.add('nav-active');
                const g = document.getElementById('mainGrid'); g.style.display = 'grid';
                this.renderVids(this.data.videos.filter(v => !v.isShort && !v.isStream), g);
            },

            goShorts: function() {
                this.hideAll(); document.getElementById('navShorts').classList.add('nav-active');
                const g = document.getElementById('zappGrid'); g.style.display = 'flex';
                g.innerHTML = this.data.videos.filter(v => v.isShort).map(v => `
                    <div class="zapp-card">
                        <video src="${v.url}" loop autoplay muted onclick="this.paused ? this.play() : this.pause()"></video>
                        <div style="position:absolute; bottom:20px; left:20px; text-shadow:0 2px 4px #000;">
                            <h3>${v.title}</h3>
                            <p>@${v.author}</p>
                        </div>
                    </div>
                `).join('');
            },

            goHistory: function() {
                this.hideAll(); document.getElementById('navHistory').classList.add('nav-active');
                const g = document.getElementById('historyView'); g.style.display = 'block';
                const histVids = this.data.history.map(id => this.data.videos.find(v => v.id == id)).filter(v => v);
                g.innerHTML = `<h2>üïí Votre historique</h2><div class="video-grid"></div>`;
                this.renderVids(histVids, g.querySelector('.video-grid'));
            },

            goCredits: function() {
                this.hideAll(); document.getElementById('creditsView').style.display = 'block';
                document.getElementById('creditsView').innerHTML = `<h2>üí≥ √âquipe Visiona</h2><div style="background:#1a1a1a; padding:20px; border-radius:15px;">
                ${this.data.credits.map(c => `<div style="padding:10px; border-bottom:1px solid #333;">‚ú® ${c}</div>`).join('')}</div>`;
            },

            // --- PLAYER & VIEWS ---
            openPlayer: function(id) {
                const v = this.data.videos.find(x => x.id == id);
                this.activeVid = v;
                
                // Cooldown Vues (1h)
                const now = Date.now();
                if(!this.data.viewLog[id] || (now - this.data.viewLog[id] > 3600000)) {
                    v.views = (v.views || 0) + 1;
                    this.data.viewLog[id] = now;
                    localStorage.setItem('mt_view_log', JSON.stringify(this.data.viewLog));
                    this.save();
                }

                this.data.history = [id, ...this.data.history.filter(x => x != id)].slice(0, 50);
                localStorage.setItem('mt_history', JSON.stringify(this.data.history));

                document.getElementById('playerModal').style.display = 'block';
                document.getElementById('pTitle').innerText = v.title;
                document.getElementById('pMeta').innerText = `${v.views} vues ‚Ä¢ Mis en ligne le ${v.date || 'r√©cemment'}`;
                
                const vid = document.getElementById('mainVid');
                vid.src = v.url || "";
                vid.style.display = v.isStream ? 'none' : 'block';
                document.getElementById('liveCanvas').style.display = v.isStream ? 'block' : 'none';

                this.renderPlayerMeta();
                this.renderComments();
            },

            renderPlayerMeta: function() {
                const isSub = this.data.subs.includes(this.activeVid.author);
                document.getElementById('pAuthorRow').innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px;">
                        ${this.getAvatar(this.activeVid.author)}
                        <div><b>${this.activeVid.author}</b></div>
                    </div>
                    <button class="${isSub ? 'btn-blue' : 'btn-red'}" onclick="app.toggleSub('${this.activeVid.author}')">
                        ${isSub ? '‚úÖ ABONN√â' : 'S\'ABONNER'}
                    </button>
                `;
            },

            // --- UPLOAD LOGIC ---
            prepUpload: function(type) {
                this.currentType = type;
                this.closeModals();
                document.getElementById('upTypeTitle').innerText = type === 'zapp' ? "Publier un Zapp" : "Publier une Vid√©o";
                document.getElementById('modalUpload').style.display = 'flex';
            },

            startUpload: async function() {
                const title = document.getElementById('upTitle').value;
                const vFile = document.getElementById('upFileVid').files[0];
                const tFile = document.getElementById('upFileThumb').files[0];

                if(!title || !vFile) return alert("Titre et vid√©o requis !");
                
                const btn = document.getElementById('btnDoUpload');
                btn.disabled = true;
                document.getElementById('upProgress').style.display = 'block';

                try {
                    const vUrl = await this.uploadToCloud(vFile, 'video');
                    const tUrl = tFile ? await this.uploadToCloud(tFile, 'image') : "https://via.placeholder.com/480x270/222/fff?text=Visiona";
                    
                    const newVid = {
                        id: Date.now(),
                        title,
                        author: this.data.user.name,
                        url: vUrl,
                        thumb: tUrl,
                        isShort: this.currentType === 'zapp',
                        views: 0,
                        date: new Date().toLocaleDateString(),
                        comments: []
                    };

                    this.data.videos.unshift(newVid);
                    await this.save();
                    location.reload();
                } catch(e) { alert("Erreur d'envoi"); btn.disabled = false; }
            },

            uploadToCloud: async function(file, resourceType) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'mytube_upload');
                const resp = await fetch(`https://api.cloudinary.com/v1_1/dvbsmh8qq/${resourceType}/upload`, { method: 'POST', body: formData });
                const json = await resp.json();
                return json.secure_url;
            },

            // --- SOCIAL ---
            postComment: function() {
                const txt = document.getElementById('comInp').value;
                if(!txt || !this.data.user) return;
                if(!this.activeVid.comments) this.activeVid.comments = [];
                this.activeVid.comments.push({ id: Date.now(), author: this.data.user.name, text: txt, heart: false });
                document.getElementById('comInp').value = "";
                this.renderComments();
                this.save();
            },

            renderComments: function() {
                const isOwner = this.data.user?.name === this.activeVid.author;
                document.getElementById('comList').innerHTML = (this.activeVid.comments || []).map(c => `
                    <div class="comment-item">
                        ${this.getAvatar(c.author)}
                        <div style="flex:1;">
                            <div class="comment-header">${c.author}</div>
                            <div style="font-size:14px;">${c.text}</div>
                            ${c.heart ? `<div class="heart-badge">${this.getAvatar(this.activeVid.author)} ‚ù§Ô∏è</div>` : ''}
                            ${isOwner ? `<button onclick="app.giveHeart(${c.id})" style="background:none; border:none; color:var(--sec-text); font-size:10px; cursor:pointer;">C≈ìur</button>` : ''}
                        </div>
                    </div>
                `).join('');
            },

            giveHeart: function(id) {
                const c = this.activeVid.comments.find(x => x.id === id);
                c.heart = !c.heart;
                this.renderComments();
                this.save();
            },

            toggleSub: function(name) {
                if(this.data.subs.includes(name)) this.data.subs = this.data.subs.filter(x => x !== name);
                else this.data.subs.push(name);
                localStorage.setItem('mt_subs', JSON.stringify(this.data.subs));
                this.updateUI();
                this.renderPlayerMeta();
            },

            // --- UI TOOLS ---
            renderVids: function(list, el) {
                el.innerHTML = list.map(v => `
                    <div style="cursor:pointer;" onclick="app.openPlayer('${v.id}')">
                        <img src="${v.thumb}" style="width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:12px; background:#222;">
                        <div style="display:flex; gap:12px; margin-top:10px;">
                            ${this.getAvatar(v.author)}
                            <div>
                                <h4 style="margin:0; font-size:15px; line-height:1.2;">${v.title}</h4>
                                <p style="color:var(--sec-text); font-size:12px; margin:5px 0;">${v.author} ‚Ä¢ ${v.views} vues</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            getAvatar: function(name) {
                const u = this.data.users[name];
                if(u && u.avatar) return `<img src="${u.avatar}" class="comment-avatar">`;
                return `<div class="comment-avatar" style="display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; background:var(--red);">${name.charAt(0).toUpperCase()}</div>`;
            },

            updateUI: function() {
                const area = document.getElementById('authArea');
                if(this.data.user) {
                    area.innerHTML = `
                        <button onclick="app.openCreate()" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">‚ûï</button>
                        <div onclick="app.toggleMenu()" style="cursor:pointer;">${this.getAvatar(this.data.user.name)}</div>
                    `;
                    document.getElementById('menuUser').innerText = this.data.user.name;
                    if(this.data.user.email === "edonis.imbert@gmail.com") document.getElementById('adminArea').style.display='block';
                } else {
                    area.innerHTML = `<button class="btn-blue" onclick="app.doLogin()">Connexion</button>`;
                }

                document.getElementById('sidebarSubs').innerHTML = this.data.subs.map(s => `
                    <div class="nav-item" onclick="app.viewProfile('${s}')">
                        ${this.getAvatar(s)} <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${s}</span>
                    </div>
                `).join('');
            },

            openCreate: function() { document.getElementById('modalCreate').style.display = 'flex'; },
            toggleMenu: function() { const m = document.getElementById('accountMenu'); m.style.display = (m.style.display === 'block' ? 'none' : 'block'); },
            closeModals: function() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); },
            closePlayer: function() { document.getElementById('playerModal').style.display='none'; document.getElementById('mainVid').pause(); },
            doLogin: function() { 
                const p = prompt("Pseudo ?"); 
                if(p) { 
                    this.data.user = {name: p, email: p+"@user.com"}; 
                    localStorage.setItem('mt_user', JSON.stringify(this.data.user));
                    location.reload(); 
                } 
            },
            doLogout: function() { localStorage.removeItem('mt_user'); location.reload(); },

            listenToStreams: function() {
                streamBus.onmessage = (e) => {
                    if(this.activeVid?.id === e.data.id) {
                        const cvs = document.getElementById('liveCanvas');
                        const ctx = cvs.getContext('2d');
                        const img = new Image();
                        img.onload = () => ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                        img.src = e.data.frame;
                    }
                };
            }
        };

        app.init();
    </script>
</body>
</html>
