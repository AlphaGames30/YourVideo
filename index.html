<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona Titan - Ultimate Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- 1. VARIABLES --- */
        :root {
            --bg: #0f0f0f; --header: #0f0f0f; --sidebar: #0f0f0f; --hover: #272727;
            --text: #fff; --text-sec: #aaa; --border: #333;
            --blue: #3ea6ff; --red: #ff0000; --gold: #ffd700; --green: #2ba640;
            --sidebar-w: 240px; --header-h: 56px;
        }

        /* Th√®mes Easter Eggs */
        body.christmas { --bg: #0b1d0e; --header: #1a0505; --blue: #0f0; --red: #f00; background-image: url('https://www.transparenttextures.com/patterns/snow.png'); }
        body.matrix { --bg: #000; --text: #0f0; --text-sec: #080; font-family: 'Courier New', monospace; }
        
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; overflow-x: hidden; }
        
        /* HEADER */
        header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-h); background: var(--header); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 2000; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: bold; font-size: 20px; user-select: none; }
        .logo span { color: var(--red); font-size: 24px; }
        .search-bar { flex: 1; max-width: 600px; margin: 0 20px; display: flex; }
        .search-bar input { width: 100%; background: #121212; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 40px 0 0 40px; }
        .search-bar button { background: #222; border: 1px solid var(--border); border-left: none; color: white; padding: 0 20px; border-radius: 0 40px 40px 0; cursor: pointer; }
        
        .actions { display: flex; gap: 15px; align-items: center; }
        .icon-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }

        /* SIDEBAR */
        .sidebar { position: fixed; top: var(--header-h); bottom: 0; left: 0; width: var(--sidebar-w); background: var(--sidebar); overflow-y: auto; padding: 10px; border-right: 1px solid var(--border); z-index: 1000; }
        .nav-item { display: flex; align-items: center; gap: 20px; padding: 10px; border-radius: 10px; cursor: pointer; margin-bottom: 2px; }
        .nav-item:hover, .nav-item.active { background: var(--hover); font-weight: bold; }
        hr { border: 0; border-top: 1px solid var(--border); margin: 10px 0; }

        /* MAIN */
        .main { margin-left: var(--sidebar-w); margin-top: var(--header-h); padding: 24px; min-height: 100vh; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        /* CARD VIDEO */
        .card { cursor: pointer; transition: 0.2s; } .card:hover { transform: scale(1.02); }
        .thumb { position: relative; width: 100%; aspect-ratio: 16/9; background: #222; border-radius: 12px; overflow: hidden; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .duration { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.8); padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .live-badge { position: absolute; top: 5px; left: 5px; background: var(--red); padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        
        .info { display: flex; gap: 12px; margin-top: 10px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #333; flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; font-weight: bold; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        /* ZAPP */
        .zapp-container { height: calc(100vh - 80px); overflow-y: scroll; scroll-snap-type: y mandatory; max-width: 450px; margin: 0 auto; }
        .zapp-container::-webkit-scrollbar { display: none; }
        .zapp-item { height: 100%; scroll-snap-align: start; position: relative; background: #000; border-radius: 15px; margin-bottom: 20px; overflow: hidden; display: flex; justify-content: center; }
        .zapp-video { height: 100%; width: 100%; object-fit: cover; }
        .zapp-ui { position: absolute; right: 10px; bottom: 80px; display: flex; flex-direction: column; gap: 20px; align-items: center; text-shadow: 1px 1px 2px black; }
        .z-btn { background: rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(5px); }

        /* UI ELEMENTS */
        .btn { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .btn-blue { background: var(--blue); color: black; }
        .btn-red { background: var(--red); color: white; }
        .input { width: 100%; background: #121212; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        
        /* MODALES */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
        .modal-box { background: #212121; padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        
        /* PLAYER & LIVE */
        #player-overlay { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 4000; overflow-y: auto; padding: 20px; }
        .player-layout { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 350px; gap: 24px; }
        
        #live-studio { display: none; position: fixed; inset: 0; background: #000; z-index: 4500; grid-template-columns: 1fr 300px; }
        .chat-box { background: #1a1a1a; border-left: 1px solid var(--border); display: flex; flex-direction: column; height: 100vh; }
        .chat-feed { flex: 1; padding: 10px; overflow-y: auto; font-size: 13px; }

        /* ADMIN & PROFIL */
        .admin-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); background: #1a1a1a; align-items: center; }
        .pp-big { width: 120px; height: 120px; border-radius: 50%; border: 5px solid var(--bg); background: #222; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .pp-big img { width: 100%; height: 100%; object-fit: cover; }

        @media(max-width: 900px) { .sidebar { display: none; } .main { margin-left: 0; } .player-layout { grid-template-columns: 1fr; } #live-studio { grid-template-columns: 1fr; grid-template-rows: 1fr 200px; } }
    </style>
</head>
<body>
    <div id="modal-auth" class="modal">
    <div class="modal-box" style="text-align:center;">
        <h2 style="color:var(--blue);">Connexion Titan</h2>
        <input id="auth-user" class="input" placeholder="Pseudo (Admin: Edonis)">
        <button class="btn btn-blue" onclick="app.auth.login()">SE CONNECTER</button>
        <button class="btn" style="background:none; color:#888;" onclick="app.ui.closeModals()">Fermer</button>
    </div>
</div>

<div id="modal-upload" class="modal">
    <div class="modal-box">
        <h2>Cr√©er</h2>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn btn-blue" style="flex:1;" onclick="app.ui.tab('up')">IMPORTER</button>
            <button class="btn btn-red" style="flex:1;" onclick="app.ui.tab('live')">DIRECT</button>
        </div>
        
        <div id="tab-up">
            <input id="up-title" class="input" placeholder="Titre">
            <textarea id="up-desc" class="input" placeholder="Description"></textarea>
            <label>Vid√©o: <input type="file" id="up-file" class="input" accept="video/*"></label>
            <label>Miniature: <input type="file" id="up-thumb" class="input" accept="image/*"></label>
            <label><input type="checkbox" id="up-short"> C'est un Zapp (Short)</label>
            <button class="btn btn-blue" style="width:100%; margin-top:15px;" onclick="app.upload.process()">METTRE EN LIGNE</button>
        </div>

        <div id="tab-live" style="display:none;">
            <input id="live-title" class="input" placeholder="Titre du Live">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gray" onclick="app.live.init('cam')">üì∑ Cam√©ra</button>
                <button class="btn btn-gray" onclick="app.live.init('screen')">üíª √âcran</button>
            </div>
            <video id="pre-live" autoplay muted style="width:100%; background:black; margin-top:10px; border-radius:8px;"></video>
            <button class="btn btn-red" style="width:100%; margin-top:10px;" onclick="app.live.go()">LANCER LE DIRECT</button>
        </div>
        <button class="btn" style="width:100%; background:#333;" onclick="app.ui.closeModals()">Annuler</button>
    </div>
</div>

<div id="modal-custom" class="modal">
    <div class="modal-box">
        <h2>Modifier Profil</h2>
        <label>Avatar: <input type="file" id="cust-pp" class="input" accept="image/*"></label>
        <label>Banni√®re: <input type="file" id="cust-banner" class="input" accept="image/*"></label>
        <label>Bio: <textarea id="cust-bio" class="input"></textarea></label>
        <button class="btn btn-blue" onclick="app.profile.save()">ENREGISTRER</button>
        <button class="btn" onclick="app.ui.closeModals()">Fermer</button>
    </div>
</div>

<header>
    <div class="logo" onclick="app.eggs.clickLogo()"><span>‚ñ∂</span> Visiona Titan</div>
    <div class="search-bar">
        <input type="text" id="search-input" placeholder="Rechercher..." onkeyup="if(event.key==='Enter') app.search()">
        <button onclick="app.search()">üîç</button>
    </div>
    <div class="actions">
        <button class="icon-btn" onclick="app.ui.openModal('modal-upload')">üìπ</button>
        <div id="auth-area"></div>
    </div>
</header>

<div id="user-menu" style="display:none; position:fixed; right:10px; top:60px; background:#222; width:200px; padding:10px; border-radius:10px; z-index:4500; border:1px solid #444;">
    <div class="nav-item" onclick="app.nav('profile')">üë§ Ma Cha√Æne</div>
    <div class="nav-item" onclick="app.nav('stats')">üìä Studio</div>
    <div id="admin-link" class="nav-item" style="display:none; color:var(--gold);" onclick="app.nav('admin')">üõ°Ô∏è Admin</div>
    <div class="nav-item" onclick="app.auth.logout()" style="color:var(--red);">üö™ D√©connexion</div>
</div>

<nav class="sidebar">
    <div class="nav-item active" id="btn-home" onclick="app.nav('home', this)">üè† Accueil</div>
    <div class="nav-item" id="btn-zapp" onclick="app.nav('zapp', this)">‚ö° Zapps</div>
    <div class="nav-item" id="btn-subs" onclick="app.nav('subs', this)">üì∫ Abonnements</div>
    <hr>
    <div class="nav-item" onclick="app.nav('history')">üïí Historique</div>
    <div class="nav-item" onclick="app.nav('community')">üìù Communaut√©</div>
    <div class="nav-item" onclick="app.nav('thanks')">üíé Panth√©on</div>
    <hr>
    <div id="sidebar-subs" style="font-size:13px; color:#aaa;"></div>
</nav>

<main class="main">
    <section id="view-home">
        <div id="announce-box"></div>
        <div class="grid" id="home-grid"></div>
    </section>

    <section id="view-zapp" style="display:none;">
        <div class="zapp-container" id="zapp-feed"></div>
    </section>

    <section id="view-subs" style="display:none;"><div class="grid" id="subs-grid"></div></section>
    <section id="view-history" style="display:none;"><div class="grid" id="history-grid"></div></section>
    
    <section id="view-community" style="display:none;">
        <div id="post-input"></div>
        <div id="posts-feed" style="margin-top:20px;"></div>
    </section>

    <section id="view-thanks" style="display:none;">
        <h1 style="color:var(--gold); text-align:center;">Panth√©on</h1>
        <div class="grid" id="thanks-grid"></div>
    </section>

    <section id="view-admin" style="display:none;">
        <h1 style="color:var(--red);">Admin Panel (Edonis)</h1>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <div style="background:#222; padding:15px; border-radius:10px;">
                <h3>Annonce</h3>
                <textarea id="adm-ann" class="input"></textarea>
                <button class="btn btn-blue" onclick="app.admin.postAnn()">Publier</button>
            </div>
            <div style="background:#222; padding:15px; border-radius:10px;">
                <h3>Panth√©on</h3>
                <input id="adm-thx" class="input" placeholder="Nom">
                <button class="btn btn-blue" onclick="app.admin.addThx()">Ajouter</button>
            </div>
        </div>
        <div id="adm-vids"></div>
    </section>

    <section id="view-profile" style="display:none;">
        <div id="prof-banner" class="banner"></div>
        <div style="display:flex; gap:20px; align-items:center; padding:0 30px; margin-top:-40px;">
            <div id="prof-pp" class="pp-big"></div>
            <div><h1 id="prof-name">Nom</h1><p id="prof-subs">0 abonn√©s</p></div>
            <div style="margin-left:auto;"><button id="prof-btn" class="btn" onclick="app.profile.action()">ACTION</button></div>
        </div>
        <div style="display:flex; border-bottom:1px solid #333; margin-top:20px;">
            <div class="nav-item active" onclick="app.profile.tab('videos')">VID√âOS</div>
            <div class="nav-item" onclick="app.profile.tab('zapps')">ZAPPS</div>
            <div class="nav-item" onclick="app.profile.tab('posts')">POSTS</div>
            <div class="nav-item" onclick="app.profile.tab('about')">√Ä PROPOS</div>
        </div>
        <div id="prof-content" class="grid" style="margin-top:20px;"></div>
    </section>

    <section id="view-stats" style="display:none;">
        <div class="grid" style="grid-template-columns:repeat(3,1fr);">
            <div style="background:#222; padding:20px; text-align:center;"><h1 id="st-views" style="color:var(--blue)">0</h1>Vues</div>
            <div style="background:#222; padding:20px; text-align:center;"><h1 id="st-subs" style="color:var(--gold)">0</h1>Abonn√©s</div>
            <div style="background:#222; padding:20px; text-align:center;"><h1 id="st-likes" style="color:var(--green)">0</h1>J'aime</div>
        </div>
    </section>
</main>

<div id="live-studio">
    <div style="position:relative; background:#000; display:flex; justify-content:center;">
        <video id="live-monitor" autoplay muted style="max-width:100%; max-height:100%;"></video>
        <div style="position:absolute; top:20px; left:20px; background:red; padding:5px 10px; font-weight:bold;">EN DIRECT</div>
        <button class="btn btn-red" style="position:absolute; bottom:20px;" onclick="app.live.stop()">ARR√äTER</button>
    </div>
    <div class="chat-box">
        <div style="padding:10px; border-bottom:1px solid #333;">Tchat Direct</div>
        <div id="live-chat" class="chat-feed"></div>
        <div style="padding:10px;"><input id="live-input" class="input" placeholder="Message..." onkeyup="if(event.key==='Enter') app.live.send()"></div>
    </div>
</div>

<div id="player-overlay">
    <div class="player-layout">
        <div>
            <button onclick="app.player.close()" class="btn" style="background:none;">‚úï Fermer</button>
            <div style="width:100%; aspect-ratio:16/9; background:#000; margin-top:10px;">
                <video id="main-player" controls autoplay style="width:100%; height:100%;"></video>
            </div>
            <h1 id="p-title">Titre</h1>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; gap:10px; cursor:pointer;" onclick="app.navToAuthor()">
                    <div id="p-pp" class="avatar"></div>
                    <div><b id="p-author">Auteur</b><div id="p-subs" style="font-size:12px;"></div></div>
                </div>
                <button id="p-sub-btn" class="btn btn-red" onclick="app.social.subPlayer()">S'ABONNER</button>
                <button class="btn btn-blue" onclick="app.social.vote()">üëç <span id="p-likes">0</span></button>
            </div>
            <div style="background:#222; padding:15px; margin-top:15px;"><p id="p-desc"></p></div>
            <div style="margin-top:20px;">
                <input id="com-input" class="input" placeholder="Commentaire..."><button class="btn btn-blue" onclick="app.social.comment()">Envoyer</button>
                <div id="com-list" style="margin-top:15px;"></div>
            </div>
        </div>
        <div id="reco-list"></div>
    </div>
</div>
    <script>
/* TITAN ENGINE v7 - FINAL FIX */
const app = {
    data: {
        videos: [],
        users: { "Edonis": { pp:"", banner:"", bio:"Admin Supr√™me", subs:[], followers:[], role:"admin" } },
        posts: [], annonces: ["Bienvenue sur Visiona Titan !"], thanks: ["Edonis"]
    },
    user: null, activeVid: null, stream: null, eggC: 0,

    init: function() {
        // Chargement base de donn√©es
        const db = localStorage.getItem('titan_db_v7');
        if(db) this.data = JSON.parse(db);
        else this.seed(); // G√©n√®re des donn√©es si vide

        this.user = localStorage.getItem('titan_user');
        this.auth.updateUI();
        this.nav('home');
        document.addEventListener('keydown', (e)=>{if(e.key==='Control')document.body.classList.toggle('matrix')});
    },

    seed: function() {
        // Donn√©es de base pour √©viter l'√©cran blanc
        this.data.videos = [
            { id:1, title:"Bienvenue !", author:"Edonis", url:"https://www.w3schools.com/html/mov_bbb.mp4", thumb:"https://via.placeholder.com/640x360", views:100, likes:10, isShort:false, date:Date.now(), comments:[], voters:[] }
        ];
        this.save();
    },

    save: function() {
        localStorage.setItem('titan_db_v7', JSON.stringify(this.data));
        this.auth.updateUI();
    },

    // --- NAVIGATION ---
    nav: function(p, el) {
        document.querySelectorAll('section').forEach(s=>s.style.display='none');
        document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
        const t = document.getElementById('view-'+p);
        if(t) t.style.display='block';
        if(el) el.classList.add('active');
        document.getElementById('user-menu').style.display='none';
        document.getElementById('player-overlay').style.display='none';
        if(this.activeVid) document.getElementById('main-player').pause();

        if(p==='home') this.renderHome();
        if(p==='zapp') this.renderZapp();
        if(p==='subs') this.renderSubs();
        if(p==='history') this.renderHist();
        if(p==='posts') this.renderPosts();
        if(p==='thanks') this.renderThanks();
        if(p==='admin') this.admin.render();
        if(p==='stats') this.renderStats();
        if(p==='profile') this.profile.load(this.user);
        window.scrollTo(0,0);
    },

    // --- RENDU ---
    renderHome: function() {
        const v = this.data.videos.filter(x=>!x.isShort).sort((a,b)=>b.date-a.date);
        document.getElementById('announce-box').innerHTML = this.data.annonces.map(a=>`<div style="background:var(--blue); color:black; padding:10px; border-radius:5px; margin-bottom:15px;">üì¢ ${a}</div>`).join('');
        document.getElementById('home-grid').innerHTML = v.map(x=>this.card(x)).join('');
    },
    renderZapp: function() {
        const v = this.data.videos.filter(x=>x.isShort);
        document.getElementById('zapp-feed').innerHTML = v.map(x=>`
            <div class="zapp-item">
                <video class="zapp-video" src="${x.url}" loop onclick="this.paused?this.play():this.pause()"></video>
                <div class="zapp-ui">
                    <div class="z-btn" onclick="app.player.load(${x.id})">‚ù§Ô∏è ${x.likes}</div>
                    <div class="z-btn" onclick="app.goProfile('${x.author}')">üë§</div>
                </div>
            </div>`).join('');
    },
    renderSubs: function() {
        if(!this.user) return document.getElementById('subs-grid').innerHTML="<p>Connectez-vous.</p>";
        const s = this.data.users[this.user].subs;
        const v = this.data.videos.filter(x=>s.includes(x.author) && !x.isShort);
        document.getElementById('subs-grid').innerHTML = v.map(x=>this.card(x)).join('');
    },
    renderHist: function() {
        const h = JSON.parse(localStorage.getItem('titan_h')||"[]");
        const v = h.map(id=>this.data.videos.find(x=>x.id==id)).filter(x=>x);
        document.getElementById('history-grid').innerHTML = v.map(x=>this.card(x)).join('');
    },
    renderPosts: function() {
        const pf = document.getElementById('posts-feed');
        let h = "";
        if(this.user) h+=`<div style="background:#222; padding:15px; border-radius:10px;"><textarea id="pf-txt" class="input" placeholder="Message..."></textarea><button class="btn btn-blue" onclick="app.addPost()">Publier</button></div>`;
        h += this.data.posts.map(p=>`<div style="background:#222; padding:15px; margin-top:10px; border-radius:10px;"><b>${p.author}</b>: ${p.text}</div>`).join('');
        pf.innerHTML = h;
    },
    renderThanks: function() {
        document.getElementById('thanks-grid').innerHTML = this.data.thanks.map(t=>`<div style="background:#222; padding:20px; border:1px solid gold; border-radius:10px; text-align:center;">üèÜ ${t}</div>`).join('');
    },
    renderStats: function() {
        if(!this.user) return;
        const u = this.data.users[this.user];
        const v = this.data.videos.filter(x=>x.author===this.user);
        document.getElementById('st-views').innerText = v.reduce((a,b)=>a+b.views,0);
        document.getElementById('st-subs').innerText = u.followers.length;
        document.getElementById('st-likes').innerText = v.reduce((a,b)=>a+b.likes,0);
    },
    card: function(v) {
        return `<div class="card" onclick="app.player.load(${v.id})"><div class="thumb"><img src="${v.thumb}">${v.isLive?'<div class="live-badge">LIVE</div>':`<div class="duration">${v.dur}</div>`}</div><div class="info">${this.utils.av(v.author)}<div><div style="font-weight:bold;">${v.title}</div><div style="font-size:12px; color:#aaa;">${v.author} ‚Ä¢ ${v.views} vues</div></div></div></div>`;
    },

    // --- PLAYER ---
    player: {
        load: function(id) {
            const v = app.data.videos.find(x=>x.id==id);
            app.activeVid = v;
            // Cooldown Vue 1h
            const now = Date.now();
            if(!v.viewers) v.viewers={};
            if(!app.user || !v.viewers[app.user] || (now-v.viewers[app.user]>3600000)) {
                v.views++; if(app.user) v.viewers[app.user]=now; app.save();
            }
            // Historique
            let h = JSON.parse(localStorage.getItem('titan_h')||"[]");
            if(!h.includes(id)) h.unshift(id);
            localStorage.setItem('titan_h', JSON.stringify(h));

            const p = document.getElementById('player-overlay');
            const vid = document.getElementById('main-player');
            p.style.display='block';
            
            if(v.isLive && v.streamRef) vid.srcObject = v.streamRef;
            else { vid.srcObject=null; vid.src = v.url; }

            document.getElementById('p-title').innerText = v.title;
            document.getElementById('p-author').innerText = v.author;
            document.getElementById('p-subs').innerText = app.data.users[v.author].followers.length+" abonn√©s";
            document.getElementById('p-pp').innerHTML = app.utils.av(v.author);
            document.getElementById('p-likes').innerText = v.likes;
            document.getElementById('p-desc').innerText = v.desc || "";
            app.social.updBtn();
            app.social.renderComs();
            
            // Reco
            const r = app.data.videos.filter(x=>!x.isShort && x.id!=id).slice(0,5);
            document.getElementById('reco-list').innerHTML = r.map(x=>`<div style="display:flex; gap:10px; margin-bottom:10px; cursor:pointer;" onclick="app.player.load(${x.id})"><img src="${x.thumb}" style="width:120px; border-radius:5px;"><div><b>${x.title}</b><div style="font-size:12px; color:#aaa;">${x.author}</div></div></div>`).join('');
        },
        close: function() { document.getElementById('player-overlay').style.display='none'; document.getElementById('main-player').pause(); }
    },

    // --- UPLOAD ---
    upload: {
        process: function() {
            if(!app.user) return app.ui.openModal('modal-auth');
            const f = document.getElementById('up-file').files[0];
            const t = document.getElementById('up-title').value;
            if(!f || !t) return alert("Fichier manquant");
            const r = new FileReader();
            r.onload = (e) => {
                const u = e.target.result; // DataURL
                const vid = document.createElement('video'); vid.src=u;
                vid.onloadedmetadata = () => {
                    const d = Math.floor(vid.duration);
                    const ds = `${Math.floor(d/60)}:${d%60<10?'0'+(d%60):d%60}`;
                    const th = document.getElementById('up-thumb').files[0];
                    if(th) {
                        const rt = new FileReader();
                        rt.onload=(ev)=>app.upload.fin(t,u,ev.target.result,ds);
                        rt.readAsDataURL(th);
                    } else app.upload.fin(t,u,"https://via.placeholder.com/640x360",ds);
                };
            };
            r.readAsDataURL(f);
        },
        fin: function(t,u,th,d) {
            app.data.videos.unshift({
                id:Date.now(), title:t, desc:document.getElementById('up-desc').value,
                author:app.user, url:u, thumb:th, dur:d, views:0, likes:0, date:Date.now(),
                isShort:document.getElementById('up-short').checked, comments:[], voters:[]
            });
            app.save(); app.ui.closeModals(); app.nav('home');
        }
    },

    // --- LIVE ---
    live: {
        init: async function(m) {
            try {
                if(m==='cam') app.stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                else app.stream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
                document.getElementById('pre-live').srcObject = app.stream;
            } catch(e){alert(e);}
        },
        go: function() {
            if(!app.stream) return;
            const t = document.getElementById('live-title').value;
            app.data.videos.unshift({
                id:Date.now(), title:"üî¥ "+t, author:app.user, isLive:true, streamRef:app.stream,
                thumb:"", views:0, likes:0, date:Date.now(), comments:[]
            });
            document.getElementById('live-studio').style.display='grid';
            document.getElementById('live-monitor').srcObject = app.stream;
            app.save(); app.ui.closeModals();
        },
        stop: function() {
            app.stream.getTracks().forEach(x=>x.stop());
            document.getElementById('live-studio').style.display='none';
            app.nav('home');
        },
        send: function() {
            const i = document.getElementById('live-input');
            document.getElementById('live-chat').innerHTML += `<div class="chat-msg"><b>${app.user}:</b> ${i.value}</div>`;
            i.value="";
        }
    },

    // --- SOCIAL ---
    social: {
        vote: function() {
            if(!app.user) return app.ui.openModal('modal-auth');
            const v = app.activeVid;
            if(!v.voters) v.voters=[];
            if(v.voters.includes(app.user)) return alert("D√©j√† vot√©");
            v.likes++; v.voters.push(app.user); app.save();
            document.getElementById('p-likes').innerText = v.likes;
        },
        subPlayer: function() { app.social.doSub(app.activeVid.author); app.social.updBtn(); },
        toggleSubscribe: function() { const t=document.getElementById('prof-name').innerText; app.social.doSub(t); app.profile.load(t); },
        doSub: function(t) {
            if(!app.user) return app.ui.openModal('modal-auth');
            if(t===app.user) return alert("Impossible");
            const me=app.data.users[app.user]; const them=app.data.users[t];
            if(me.subs.includes(t)) {
                me.subs=me.subs.filter(x=>x!==t); them.followers=them.followers.filter(x=>x!==app.user);
            } else { me.subs.push(t); them.followers.push(app.user); }
            app.save(); app.auth.updSide();
        },
        updBtn: function() {
            const t=app.activeVid.author;
            const sub=app.data.users[app.user]?.subs.includes(t);
            const b=document.getElementById('p-sub-btn');
            b.innerText=sub?"ABONN√â":"S'ABONNER"; b.className=sub?"btn btn-gray":"btn btn-red";
        },
        comment: function() {
            const t = document.getElementById('com-input').value;
            if(!t) return;
            app.activeVid.comments.unshift({a:app.user, t:t, d:Date.now()});
            app.save(); this.renderComs(); document.getElementById('com-input').value="";
        },
        renderComs: function() {
            document.getElementById('com-list').innerHTML = (app.activeVid.comments||[]).map(c=>`<div style="margin-bottom:10px;"><b>${c.a}</b>: ${c.t}</div>`).join('');
        }
    },

    // --- PROFIL ---
    profile: {
        load: function(u) {
            if(!app.data.users[u]) app.data.users[u]={pp:"",banner:"",bio:"Nouveau",subs:[],followers:[]};
            const usr = app.data.users[u];
            document.getElementById('prof-name').innerText=u;
            document.getElementById('prof-subs').innerText=usr.followers.length+" abonn√©s";
            document.getElementById('prof-pp').innerHTML=app.utils.av(u,120);
            if(usr.banner) document.getElementById('prof-banner').style.backgroundImage = `url(${usr.banner})`;
            
            const me=u===app.user;
            const btn=document.getElementById('prof-btn');
            if(me) { btn.innerText="EDITER"; btn.onclick=()=>app.ui.openModal('modal-custom'); btn.className="btn btn-blue"; }
            else { 
                const sub=app.data.users[app.user]?.subs.includes(u);
                btn.innerText=sub?"ABONN√â":"S'ABONNER"; btn.className=sub?"btn btn-gray":"btn btn-red";
                btn.onclick=()=>app.social.toggleSubscribe();
            }
            this.tab('videos');
        },
        save: function() {
            const pp=document.getElementById('cust-pp').files[0];
            const bn=document.getElementById('cust-banner').files[0];
            const u=app.data.users[app.user];
            u.bio=document.getElementById('cust-bio').value;
            const end=()=>{app.save(); app.ui.closeModals(); app.profile.load(app.user); app.auth.updateUI();};
            const r1=new FileReader();
            if(pp) { r1.onload=(e)=>{u.pp=e.target.result; if(bn) loadBn(); else end();}; r1.readAsDataURL(pp); }
            else if(bn) loadBn(); else end();
            function loadBn() { const r2=new FileReader(); r2.onload=(e)=>{u.banner=e.target.result; end();}; r2.readAsDataURL(bn); }
        },
        tab: function(t) {
            const u=document.getElementById('prof-name').innerText;
            const c=document.getElementById('prof-content');
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); event.target.classList.add('active');
            if(t==='videos') c.innerHTML = app.data.videos.filter(v=>v.author===u && !v.isShort).map(v=>app.card(v)).join('');
            if(t==='zapps') c.innerHTML = app.data.videos.filter(v=>v.author===u && v.isShort).map(v=>app.card(v)).join('');
            if(t==='posts') c.innerHTML = app.data.posts.filter(p=>p.author===u).map(p=>`<div style="background:#222; padding:10px; margin-bottom:10px;">${p.text}</div>`).join('');
            if(t==='about') c.innerHTML = `<div style="padding:20px;">${app.data.users[u].bio}</div>`;
        },
        action: function() { /* G√©r√© dans load() */ }
    },

    // --- ADMIN ---
    admin: {
        render: function() {
            const t = document.getElementById('adm-vids');
            t.innerHTML = app.data.videos.map(v=>`<div class="admin-row"><span>${v.title}</span><button class="btn btn-red" onclick="app.admin.del(${v.id})">SUPPR</button></div>`).join('');
        },
        del: function(id) {
            if(confirm('Supprimer ?')) { app.data.videos = app.data.videos.filter(v=>v.id!=id); app.save(); this.render(); }
        },
        postAnn: function() { app.data.annonces.unshift(document.getElementById('adm-ann').value); app.save(); alert("Publi√©"); },
        addThx: function() { app.data.thanks.push(document.getElementById('adm-thx').value); app.save(); alert("Ajout√©"); }
    },

    // --- AUTH ---
    auth: {
        login: function() {
            const u=document.getElementById('auth-user').value;
            if(!u) return;
            if(!app.data.users[u]) app.data.users[u]={pp:"",banner:"",bio:"Nouveau",subs:[],followers:[],role:"user"};
            app.user=u; localStorage.setItem('titan_user',u);
            app.ui.closeModals(); app.init();
        },
        logout: function() { localStorage.removeItem('titan_user'); location.reload(); },
        updateUI: function() {
            const a=document.getElementById('auth-area');
            if(app.user) {
                a.innerHTML=`<div onclick="document.getElementById('user-menu').style.display='block'">${app.utils.av(app.user,36)}</div>`;
                document.getElementById('menu-username').innerText=app.user;
                if(app.user==="Edonis") document.getElementById('admin-link').style.display='block';
                this.updSide();
            } else { a.innerHTML=`<button class="btn btn-blue" onclick="app.ui.openModal('modal-auth')">CONNEXION</button>`; }
        },
        updSide: function() {
            if(!app.user) return;
            document.getElementById('sidebar-subs').innerHTML = app.data.users[app.user].subs.map(s=>`<div class="nav-item" onclick="app.goProfile('${s}')">${app.utils.av(s,20)} ${s}</div>`).join('');
        }
    },

    // --- UTILS & HELPERS ---
    utils: {
        av: function(u,s=40) {
            const user=app.data.users[u];
            if(user&&user.pp) return `<img src="${user.pp}" style="width:${s}px; height:${s}px; border-radius:50%; object-fit:cover;">`;
            const c='#'+Math.floor(Math.random()*16777215).toString(16);
            return `<div style="width:${s}px; height:${s}px; border-radius:50%; background:${c}; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff;">${u?u[0].toUpperCase():'?'}</div>`;
        },
        ago: function(d) {
            const m=Math.floor((Date.now()-d)/60000);
            if(m<60) return m+" min";
            const h=Math.floor(m/60); if(h<24) return h+" h";
            return Math.floor(h/24)+" j";
        }
    },
    ui: {
        openModal: function(id) { document.getElementById(id).style.display='flex'; },
        closeModals: function() { document.querySelectorAll('.modal').forEach(e=>e.style.display='none'); },
        tab: function(t) { document.getElementById('tab-up').style.display=t==='up'?'block':'none'; document.getElementById('tab-live').style.display=t==='live'?'block':'none'; }
    },
    eggs: { clickLogo: function() { this.c++; if(this.c===10) { document.body.classList.add('christmas'); alert("üéÖ HO HO HO"); } }, clickVersion: function() { document.body.classList.toggle('rainbow'); }, c:0 },
    history: { clear: function() { localStorage.removeItem('titan_h'); app.renderHist(); } },
    addPost: function() { const t=document.getElementById('pf-txt').value; app.data.posts.unshift({author:app.user, text:t, date:Date.now()}); app.save(); app.renderPosts(); },
    search: function() {
        const q=document.getElementById('search-input').value.toLowerCase();
        if(q==='titan') document.body.classList.toggle('gold-mode');
        const r=app.data.videos.filter(v=>v.title.toLowerCase().includes(q));
        document.getElementById('home-grid').innerHTML = r.map(x=>app.card(x)).join('');
        app.nav('home');
    },
    goProfile: function(u) { app.profile.load(u); app.nav('profile'); },
    goMyProfile: function() { app.profile.load(app.user); app.nav('profile'); },
    navToAuthor: function() { app.player.close(); app.profile.load(app.activeVid.author); app.nav('profile'); }
};

window.onload = function() { app.init(); };
</script>
</body>
</html>
