<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona V15 - Stream & Community</title>
    <style>
        :root { 
            --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; 
            --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --gold: #ffd700; --xmas: #d42426;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: Roboto, Arial, sans-serif; overflow-x: hidden; padding-bottom: 60px; }
        
        /* --- MODE NOEL ALEATOIRE --- */
        body.xmas-theme { --bg: #0b1a0e; --header: #4a0a0a; }
        .snowflake { position: fixed; top: -10px; color: white; pointer-events: none; z-index: 9999; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

        /* --- LAYOUT --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; height: 56px; background: var(--header); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        .container { display: flex; height: calc(100vh - 56px); }
        .sidebar { width: 240px; background: var(--bg); padding: 12px; overflow-y: auto; flex-shrink: 0; border-right: 1px solid #222; }
        .nav-item { padding: 12px; border-radius: 10px; cursor: pointer; margin-bottom: 4px; display: flex; align-items: center; gap: 15px; font-size: 14px; }
        .nav-item:hover { background: var(--hover); }
        .nav-active { background: var(--hover); font-weight: bold; }
        
        .sub-list { margin-top: 10px; padding-left: 5px; }
        .sub-item { display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-radius: 8px; font-size: 13px; }
        .sub-item:hover { background: var(--hover); }
        .sub-item img, .sub-item .avatar-letter { width: 24px; height: 24px; font-size: 10px; }

        .content { flex: 1; padding: 24px; overflow-y: auto; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        
        /* --- POSTS / PUBLICATIONS --- */
        .post-card { background: #1a1a1a; border-radius: 12px; padding: 15px; margin-bottom: 20px; max-width: 600px; }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }

        /* --- AVATARS --- */
        .avatar-letter { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; background: #555; flex-shrink: 0; }
        .avatar-img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        
        /* --- PLAYER & COMMENTS --- */
        .player-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; overflow-y: auto; }
        .video-wrapper { width: 100%; aspect-ratio: 16/9; background: #000; position: relative; }
        canvas#liveCanvas { width: 100%; height: 100%; } /* Pour le stream r√©el */
        
        .comment { margin: 15px 0; padding-left: 45px; position: relative; }
        .comment-heart { color: var(--red); font-size: 12px; margin-left: 10px; }
        .comment-pinned { color: var(--blue); font-size: 11px; font-weight: bold; margin-bottom: 5px; }
        .like-gold { color: var(--gold) !important; text-shadow: 0 0 5px var(--gold); }

        .action-pill { background: #272727; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .btn-blue { background: var(--blue); color: #000; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: #212121; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; }

        #santaToast { position: fixed; bottom: 20px; right: 20px; background: var(--xmas); color: white; padding: 15px; border-radius: 10px; display: none; z-index: 3000; animation: slideIn 0.5s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        @media(max-width: 800px) { .sidebar { display: none; } }
    </style>
</head>
<body id="appBody">

    <div id="snowContainer"></div>
    <div id="santaToast">üéÖ P√®re No√´l : "Ho Ho Ho ! Merci pour ton abonnement, mon enfant !"</div>

    <header>
        <div class="logo" onclick="location.reload()"><span>Visiona</span></div>
        <div style="flex:1; max-width:500px; display:flex;">
            <input type="text" id="searchInp" placeholder="Rechercher..." style="width:100%; background:#121212; border:1px solid #333; color:white; padding:8px; border-radius:20px 0 0 20px;">
            <button onclick="app.search()" style="background:#222; border:1px solid #333; padding:0 15px; border-radius:0 20px 20px 0; color:white;">üîç</button>
        </div>
        <div id="authArea"></div>
    </header>

    <div class="container">
        <nav class="sidebar">
            <div class="nav-item" onclick="app.goHome()">üè† Accueil</div>
            <div class="nav-item" onclick="app.goShorts()">‚ö° Zapp</div>
            <div class="nav-item" onclick="app.goStreams()">üî¥ Streams</div>
            <div class="nav-item" onclick="app.goCommunity()">üì∞ Publications</div>
            <hr>
            <div class="nav-item" onclick="app.goHistory()">üïí Historique</div>
            <div class="nav-item" onclick="app.goStats()">üìä Statistiques</div>
            <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma Cha√Æne</div>
            <hr>
            <div style="font-size:12px; color:var(--sec-text); padding-left:10px;">ABONNEMENTS</div>
            <div id="sidebarSubs" class="sub-list"></div>
            <div id="adminLink" class="nav-item" style="display:none; color:var(--red);" onclick="app.goAdmin()">üîë Admin</div>
        </nav>

        <main class="content">
            <div id="viewTitle"></div>
            <div id="mainGrid" class="video-grid"></div>
            <div id="communityView" style="display:none;"></div>
            <div id="statsView" style="display:none;">
                <h2>Tes Statistiques</h2>
                <div id="statsBox" style="background:#1a1a1a; padding:20px; border-radius:12px;"></div>
            </div>
        </main>
    </div>

    <div id="playerModal" class="player-overlay">
        <button class="action-pill" onclick="app.closePlayer()" style="margin:10px;">‚úï Fermer</button>
        <div style="max-width:1100px; margin:0 auto;">
            <div class="video-wrapper">
                <video id="mainVid" controls autoplay style="width:100%; height:100%;"></video>
                <canvas id="liveCanvas" style="display:none; position:absolute; top:0; left:0;"></canvas>
            </div>
            <h2 id="vidTitle"></h2>
            <div id="vidActions" style="display:flex; align-items:center; gap:15px; margin-bottom:20px;"></div>
            <hr style="border:0; border-top:1px solid #333;">
            <div id="commentArea">
                <h3>Commentaires</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="comInp" placeholder="Ajouter un commentaire..." style="flex:1; background:#121212; border:1px solid #333; color:white; padding:10px; border-radius:5px;">
                    <button class="btn-blue" onclick="app.postComment()">Envoyer</button>
                </div>
                <div id="commentList"></div>
            </div>
        </div>
    </div>

    <div id="modalCreate" class="modal">
        <div class="modal-box">
            <h2>Cr√©er</h2>
            <button class="btn-blue" style="width:100%; margin-bottom:10px;" onclick="app.openUpload()">üé¨ Vid√©o / Zapp</button>
            <button class="btn-blue" style="width:100%; background:var(--red);" onclick="app.startStream()">üî¥ Lancer un Stream</button>
            <button class="btn-blue" style="width:100%; background:#444;" onclick="app.openPost()">üì∞ Cr√©er une Publication</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Fermer</button>
        </div>
    </div>

    <script>
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
        const WORKER_URL = "https://mytubeupload.edonis-imbert.workers.dev/";
        const ADMIN_EMAIL = "edonis.imbert@gmail.com";
        const streamChannel = new BroadcastChannel('visiona_live');

        const app = {
            data: {
                user: JSON.parse(localStorage.getItem('mt_user')),
                videos: [], users: {}, posts: [],
                subs: JSON.parse(localStorage.getItem('mt_subs')) || [],
                history: JSON.parse(localStorage.getItem('mt_history')) || [],
                stats: JSON.parse(localStorage.getItem('mt_stats')) || { watchTime: 0, clicks: 0 }
            },
            currentVid: null,

            init: async function() {
                this.checkXmas();
                await this.loadData();
                this.updateUI();
                this.goHome();
                this.listenToStream();
                
                setInterval(() => { 
                    this.data.stats.watchTime += 1; 
                    localStorage.setItem('mt_stats', JSON.stringify(this.data.stats));
                }, 1000);
            },

            checkXmas: function() {
                if (Math.random() < 0.001) {
                    document.getElementById('appBody').classList.add('xmas-theme');
                    for(let i=0; i<50; i++) {
                        let s = document.createElement('div');
                        s.className = 'snowflake';
                        s.innerHTML = '‚ùÑ';
                        s.style.left = Math.random()*100+'vw';
                        s.style.animationDuration = (Math.random()*3+2)+'s';
                        document.getElementById('snowContainer').appendChild(s);
                    }
                }
            },

            loadData: async function() {
                const res = await fetch(GIST_URL + "?t=" + Date.now());
                const json = await res.json();
                this.data.videos = json.videos || [];
                this.data.users = json.users || {};
                this.data.posts = json.posts || [];
            },

            save: async function() {
                const content = { videos: this.data.videos, users: this.data.users, posts: this.data.posts };
                await fetch(WORKER_URL, { method: 'PATCH', body: JSON.stringify({ files: {"video.json": {content: JSON.stringify(content, null, 2)}}}) });
            },

            updateUI: function() {
                const area = document.getElementById('authArea');
                if(this.data.user) {
                    area.innerHTML = `<button onclick="app.openCreate()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer; margin-right:15px;">‚ûï</button>
                                     <div onclick="app.goMyProfile()">${this.getAvatar(this.data.user.name)}</div>`;
                    if(this.data.user.email === ADMIN_EMAIL) document.getElementById('adminLink').style.display='flex';
                    this.renderSidebarSubs();
                } else {
                    area.innerHTML = `<button class="btn-blue" onclick="app.login()">Connexion</button>`;
                }
            },

            getAvatar: function(name) {
                const u = this.data.users[name];
                if(u && u.avatar) return `<img src="${u.avatar}" class="avatar-img">`;
                return `<div class="avatar-letter">${name.charAt(0).toUpperCase()}</div>`;
            },

            renderSidebarSubs: function() {
                const container = document.getElementById('sidebarSubs');
                container.innerHTML = this.data.subs.map(s => `
                    <div class="sub-item" onclick="app.viewProfile('${s}')">
                        ${this.getAvatar(s)}
                        <span>${s}</span>
                    </div>
                `).join('');
            },

            // --- STREAMING REEL (VIA BROADCAST CHANNEL) ---
            startStream: async function() {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const videoId = "stream_" + Date.now();
                const newStream = { id: videoId, title: "LIVE: " + this.data.user.name, author: this.data.user.name, isStream: true, views: 0 };
                this.data.videos.unshift(newStream);
                await this.save();
                this.closeModals();
                this.goStreams();

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const vid = document.createElement('video');
                vid.srcObject = stream;
                vid.play();

                setInterval(() => {
                    ctx.drawImage(vid, 0, 0, canvas.width, canvas.height);
                    streamChannel.postMessage({ id: videoId, frame: canvas.toDataURL('image/webp', 0.5) });
                }, 100);
            },

            listenToStream: function() {
                streamChannel.onmessage = (msg) => {
                    if(this.currentVid && this.currentVid.id === msg.data.id) {
                        const canvas = document.getElementById('liveCanvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.onload = () => {
                            canvas.style.display = 'block';
                            document.getElementById('mainVid').style.display = 'none';
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        };
                        img.src = msg.data.frame;
                    }
                };
            },

            // --- NAVIGATION ---
            goHome: function() {
                this.hideViews();
                document.getElementById('mainGrid').style.display = 'grid';
                this.renderVideos(this.data.videos.filter(v => !v.isShort && !v.isStream));
            },

            goStreams: function() {
                this.hideViews();
                document.getElementById('mainGrid').style.display = 'grid';
                this.renderVideos(this.data.videos.filter(v => v.isStream));
            },

            goStats: function() {
                this.hideViews();
                document.getElementById('statsView').style.display = 'block';
                document.getElementById('statsBox').innerHTML = `
                    <p>‚è± Temps de visionnage : ${Math.floor(this.data.stats.watchTime / 60)} minutes</p>
                    <p>üñ± Clics effectu√©s : ${this.data.stats.clicks}</p>
                `;
            },

            goCommunity: function() {
                this.hideViews();
                const view = document.getElementById('communityView');
                view.style.display = 'block';
                view.innerHTML = this.data.posts.map(p => `
                    <div class="post-card">
                        <div class="post-header">${this.getAvatar(p.author)} <b>${p.author}</b></div>
                        <div>${p.text}</div>
                        <div style="margin-top:10px; display:flex; gap:15px;">
                            <button onclick="app.likePost(${p.id})" style="background:none; border:none; color:white; cursor:pointer;">üëç ${p.likes || 0}</button>
                            <button style="background:none; border:none; color:white; cursor:pointer;">üí¨ Commenter</button>
                        </div>
                    </div>
                `).join('');
            },

            // --- FONCTIONS SOCIALES ---
            postComment: function() {
                const text = document.getElementById('comInp').value;
                if(!text || !this.data.user) return;
                const newCom = {
                    id: Date.now(),
                    author: this.data.user.name,
                    text: text,
                    heart: false,
                    pinned: false
                };
                if(!this.currentVid.comments) this.currentVid.comments = [];
                this.currentVid.comments.push(newCom);
                document.getElementById('comInp').value = "";
                this.renderComments();
                this.save();
            },

            renderComments: function() {
                const list = document.getElementById('commentList');
                const isOwner = this.data.user && this.data.user.name === this.currentVid.author;
                
                list.innerHTML = (this.currentVid.comments || []).sort((a,b) => b.pinned - a.pinned).map(c => `
                    <div class="comment">
                        ${c.pinned ? '<div class="comment-pinned">üìå √âpingl√© par le cr√©ateur</div>' : ''}
                        <div style="position:absolute; left:0;">${this.getAvatar(c.author)}</div>
                        <b>${c.author}</b> ${c.heart ? '<span class="comment-heart">‚ù§Ô∏è</span>' : ''}
                        <p>${c.text}</p>
                        ${isOwner ? `
                            <button onclick="app.toggleHeart(${c.id})" style="font-size:10px;">C≈ìur</button>
                            <button onclick="app.togglePin(${c.id})" style="font-size:10px;">√âpingler</button>
                        ` : ''}
                    </div>
                `).join('');
            },

            toggleHeart: function(id) {
                const c = this.currentVid.comments.find(x => x.id === id);
                c.heart = !c.heart;
                this.renderComments();
                this.save();
            },

            togglePin: function(id) {
                this.currentVid.comments.forEach(c => c.pinned = (c.id === id ? !c.pinned : false));
                this.renderComments();
                this.save();
            },

            toggleSub: function(name) {
                if(this.data.subs.includes(name)) {
                    this.data.subs = this.data.subs.filter(n => n !== name);
                } else {
                    this.data.subs.push(name);
                    if(Math.random() < 0.01) { // 1 chance sur 100
                        const t = document.getElementById('santaToast');
                        t.style.display = 'block';
                        setTimeout(() => t.style.display='none', 5000);
                    }
                }
                localStorage.setItem('mt_subs', JSON.stringify(this.data.subs));
                this.renderSidebarSubs();
                this.viewProfile(name);
            },

            // --- UTILS ---
            renderVideos: function(vids) {
                const grid = document.getElementById('mainGrid');
                grid.innerHTML = vids.map(v => `
                    <div class="video-card" onclick="app.openPlayer('${v.id}')">
                        <div style="width:100%; aspect-ratio:16/9; background:#222; border-radius:12px; overflow:hidden;">
                            <img src="${v.thumb || 'https://via.placeholder.com/400x225/222/fff?text=Visiona'}" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            ${this.getAvatar(v.author)}
                            <div>
                                <h4 style="margin:0;">${v.title}</h4>
                                <p style="font-size:12px; color:var(--sec-text); margin:4px 0;">${v.author}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            openPlayer: function(id) {
                this.data.stats.clicks++;
                this.currentVid = this.data.videos.find(v => v.id == id);
                const isGold = Math.random() < 0.001; // Like dor√© 1/1000
                
                document.getElementById('playerModal').style.display = 'block';
                document.getElementById('vidTitle').innerText = this.currentVid.title;
                document.getElementById('mainVid').src = this.currentVid.url || "";
                document.getElementById('mainVid').style.display = this.currentVid.isStream ? 'none' : 'block';
                document.getElementById('liveCanvas').style.display = 'none';

                document.getElementById('vidActions').innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="app.viewProfile('${this.currentVid.author}')">
                        ${this.getAvatar(this.currentVid.author)} <b>${this.currentVid.author}</b>
                    </div>
                    <button class="action-pill ${isGold ? 'like-gold' : ''}">üëç J'aime</button>
                    <button class="btn-blue" onclick="app.toggleSub('${this.currentVid.author}')">
                        ${this.data.subs.includes(this.currentVid.author) ? 'Abonn√©' : 'S\'abonner'}
                    </button>
                `;
                this.renderComments();
            },

            hideViews: function() {
                ['mainGrid', 'communityView', 'statsView', 'profileView'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.style.display = 'none';
                });
            },

            closePlayer: function() { document.getElementById('playerModal').style.display = 'none'; document.getElementById('mainVid').pause(); },
            openCreate: function() { document.getElementById('modalCreate').style.display = 'flex'; },
            closeModals: function() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); },
            login: function() { const n = prompt("Nom d'utilisateur ?"); if(n) { this.data.user = {name: n, email: n+"@mail.com"}; localStorage.setItem('mt_user', JSON.stringify(this.data.user)); location.reload(); }},
            doLogout: function() { localStorage.removeItem('mt_user'); location.reload(); }
        };

        app.init();
    </script>
</body>
</html>
