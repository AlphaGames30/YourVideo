<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona - AlphaGames30</title>
    <style>
        /* ========================================================= */
        /* --- SECTION CSS : D√âFINITION DES VARIABLES GLOBALES  --- */
        /* ========================================================= */
        :root { 
            --bg: #0f0f0f; 
            --header: #0f0f0f; 
            --text: #ffffff; 
            --sec-text: #aaaaaa; 
            --hover: #272727; 
            --blue: #3ea6ff; 
            --red: #ff0000; 
        }

        /* ========================================================= */
        /* --- CSS : STYLE DU CORPS ET DE LA MISE EN PAGE G√âN√âRALE --- */
        /* ========================================================= */
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: Roboto, Arial, sans-serif; 
            overflow-x: hidden; 
            padding-bottom: 60px; /* Espace pour la navigation mobile */
        }

        /* --- HEADER ET NAVIGATION SUP√âRIEURE --- */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 16px; 
            height: 56px; 
            background: var(--header); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            border-bottom: 1px solid #222; 
        }

        .logo { 
            font-size: 20px; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
        }

        .logo::before { 
            content: '‚ñ∂'; 
            color: var(--red); 
            font-size: 24px; 
            margin-right: 5px; 
        }

        /* --- BARRE DE RECHERCHE --- */
        .search-box { 
            display: flex; 
            flex: 1; 
            max-width: 500px; 
            margin: 0 10px; 
        }

        .search-box input { 
            width: 100%; 
            background: #121212; 
            border: 1px solid #333; 
            color: white; 
            padding: 8px 15px; 
            border-radius: 40px 0 0 40px; 
            border-right: none; 
        }

        .search-box button { 
            background: #222; 
            border: 1px solid #333; 
            border-left: none; 
            padding: 0 20px; 
            border-radius: 0 40px 40px 0; 
            cursor: pointer; 
            color: var(--sec-text); 
            transition: background 0.2s;
        }

        .search-box button:hover {
            background: #333;
        }

        .header-btns button { 
            background: none; 
            border: none; 
            color: white; 
            font-size: 20px; 
            margin-left: 10px; 
            cursor: pointer; 
        }

        .btn-login { 
            border: 1px solid var(--blue) !important; 
            color: var(--blue) !important; 
            font-size: 14px !important; 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            transition: background 0.2s, color 0.2s;
        }

        /* --- CONTENEUR PRINCIPAL (SIDEBAR + CONTENT) --- */
        .container { 
            display: flex; 
            height: calc(100vh - 56px); 
        }

        /* --- SIDEBAR (NAVIGATION LAT√âRALE) --- */
        .sidebar { 
            width: 220px; 
            background: var(--bg); 
            padding: 10px; 
            overflow-y: auto; 
            flex-shrink: 0; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .nav-item { 
            padding: 10px; 
            border-radius: 10px; 
            cursor: pointer; 
            margin-bottom: 5px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            transition: background 0.2s;
        }

        .nav-item:hover { 
            background: var(--hover); 
        }

        /* --- ZONE DE CONTENU PRINCIPAL --- */
        .content { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
        }

        /* --- GRILLES DE VID√âOS --- */
        .video-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }

        .video-card { 
            cursor: pointer; 
            transition: transform 0.2s; 
            overflow: hidden; 
        }

        .video-card:hover { 
            transform: scale(1.01); 
        }

        .thumb-container { 
            position: relative; 
            width: 100%; 
            aspect-ratio: 16/9; 
            border-radius: 12px; 
            overflow: hidden; 
            background: #333; 
        }

        .thumb { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: opacity 0.3s;
        }

        /* --- GRILLE DES SHORTS --- */
        .shorts-grid { 
            display: flex; 
            gap: 15px; 
            overflow-x: auto; 
            padding-bottom: 10px; 
        }

        .short-card { 
            flex-shrink: 0; 
            width: 160px; 
            height: 300px; 
            cursor: pointer; 
            border-radius: 12px; 
            overflow: hidden; 
            background: #333; 
            position: relative; 
            transition: transform 0.2s;
        }
        
        .short-card:hover {
            transform: translateY(-5px);
        }

        .short-card img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }

        /* --- PLAYER MODAL ET VID√âO --- */
        .player-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: black; 
            z-index: 500; 
            overflow-y: auto; 
            padding-bottom: 50px; 
        }

        .player-content { 
            width: 95%; 
            max-width: 1200px; 
            margin: 20px auto; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }

        .video-wrapper { 
            width: 100%; 
            aspect-ratio: 16/9; 
            background: #000; 
        }

        /* CONTENEUR DE SHORTS POUR LE D√âFILEMENT S√âQUENTIEL */
        .short-player-wrapper { 
            width: 100%; 
            max-width: 400px; 
            aspect-ratio: 9/16; 
            background: #000; 
            margin: 0 auto; 
            position: relative;
        }
        
        .short-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 510;
        }
        
        .short-nav button {
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            font-size: 24px;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }


        video { 
            width: 100%; 
            height: 100%; 
            background: #000;
        }

        /* --- SECTION COMMENTAIRES --- */
        .comment-section { 
            background: #1a1a1a; 
            padding: 20px; 
            border-radius: 12px; 
            margin-top: 20px;
        }

        .comment-input-area { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            align-items: center;
        }

        .comment-input-area input { 
            flex: 1; 
            background: none; 
            border: none; 
            border-bottom: 1px solid #333; 
            color: white; 
            padding: 8px; 
            transition: border-bottom-color 0.3s;
        }

        .comment-input-area input:focus {
            outline: none;
            border-bottom-color: var(--text);
        }

        /* --- BOUTONS D'ACTION (PILLS) --- */
        .action-pill { 
            background: #272727; 
            color: white; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 18px; 
            font-size: 13px; 
            cursor: pointer; 
            transition: background 0.2s, color 0.2s;
        }

        .action-pill:hover {
            background: #3a3a3a;
        }

        .liked { 
            color: var(--blue); 
            background: rgba(62, 166, 255, 0.2);
        }

        .disliked { 
            color: var(--red); 
            background: rgba(255, 0, 0, 0.2);
        }

        .followed { 
            background: #fff; 
            color: #000; 
            font-weight: bold;
        }

        .btn-red { 
            background: var(--red); 
            color: white; 
        }

        .btn-green { 
            background: #00a854; 
            color: white; 
        }

        /* --- MODALS ET FEN√äTRES POP-UP --- */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 600; 
            justify-content: center; 
            align-items: center; 
        }

        .modal-box { 
            background: #212121; 
            padding: 25px; 
            border-radius: 15px; 
            width: 90%; 
            max-width: 450px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        /* --- VUES SP√âCIFIQUES (PROFIL / ADMIN / STATS) --- */
        .profile-view, .stats-view { 
            display: none; 
            padding-bottom: 50px;
        }

        .admin-view { 
            display: none; 
            padding: 20px; 
        }
        
        .stats-view h3 {
            margin-top: 25px;
            color: var(--blue);
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .stats-view p {
            margin: 8px 0;
            font-size: 15px;
        }


        .admin-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }

        .admin-table th, .admin-table td { 
            border: 1px solid #333; 
            padding: 10px; 
            text-align: left; 
        }

        .admin-table th { 
            background: #222; 
        }
        
        /* --- INPUTS G√âN√âRAUX --- */
        input[type="text"], 
        input[type="password"], 
        input[type="email"], 
        textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            background: #121212; 
            border: 1px solid #333; 
            color: white; 
            border-radius: 8px; 
            box-sizing: border-box; 
        }

        .btn-blue { 
            width: 100%; 
            padding: 12px; 
            background: var(--blue); 
            color: black; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: opacity 0.2s;
        }

        .btn-blue:hover {
            opacity: 0.9;
        }

        /* --- AVATARS ET BANNI√àRE --- */
        .avatar-big { 
            width: 120px; 
            height: 120px; 
            border-radius: 50%; 
            border: 4px solid var(--bg); 
            background: #555; 
            object-fit: cover; 
            cursor: pointer; 
        }

        .avatar-small { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            object-fit: cover; 
            cursor: pointer; 
        }

        .banner { 
            width: 100%; 
            height: 200px; 
            background: #333; 
            border-radius: 15px; 
            margin-bottom: -60px; 
            object-fit: cover; 
        }

        .profile-head { 
            display: flex; 
            align-items: flex-end; 
            gap: 20px; 
            padding: 0 20px; 
        }

        /* --- NAVIGATION MOBILE (MEDIA QUERIES) --- */
        @media(max-width: 768px) { 
            .sidebar { 
                display: none; 
            } 
            .mobile-nav { 
                display: flex !important; 
            } 
            .search-box { 
                display: none; 
            }
            .video-grid { 
                grid-template-columns: 1fr; 
            } 
            .content {
                padding: 10px;
            }
            .profile-head {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 0 10px;
            }
            .banner {
                margin-bottom: -40px;
                height: 120px;
                border-radius: 0;
            }
            .avatar-big {
                margin-top: 10px;
            }
        }
        
        .mobile-nav { 
            display: none; 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 60px; 
            background: #0f0f0f; 
            border-top: 1px solid #222; 
            justify-content: space-around; 
            align-items: center; 
            z-index: 1000; 
        }

        .mobile-nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 10px; 
            color: var(--sec-text); 
            cursor: pointer; 
        }

        .mobile-nav-item span { 
            font-size: 20px; 
            color: white; 
            margin-bottom: 2px; 
        }

        /* --- BARRE DE PROGRESSION UPLOAD --- */
        .progress-bar { 
            height: 15px; 
            background: #444; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            overflow: hidden; 
            width: 100%;
        }

        .progress-fill { 
            height: 100%; 
            background: var(--blue); 
            width: 0%; 
            transition: width 0.1s; 
        }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="app.goHome()"><span>Visiona</span></div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Rechercher...">
            <button onclick="app.search()">üîç</button>
        </div>
        <div class="header-btns">
            <button onclick="app.openUpload()">‚ûï</button>
            <button id="loginBtn" class="btn-login" onclick="app.toggleAccountMenu()">üë§ Se connecter</button>
        </div>
    </header>

    <div id="accountMenu" style="display:none; position:absolute; right:10px; top:60px; background:#282828; padding:15px; border-radius:10px; z-index:1000; min-width: 150px;">
        <div id="menuUserName" style="font-weight:bold; margin-bottom:10px; border-bottom: 1px solid #333; padding-bottom: 10px;"></div>
        <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma Cha√Æne</div>
        <div id="adminLink" class="nav-item" onclick="app.goAdminPanel()" style="display:none;">üîë Admin Panel</div>
        <div class="nav-item" onclick="app.doLogout()">üö™ D√©connexion</div>
    </div>


    <div class="mobile-nav">
        <div class="mobile-nav-item" onclick="app.goHome()"><span>üè†</span>Accueil</div>
        <div class="mobile-nav-item" onclick="app.goShorts()"><span>‚ö°</span>Zapp</div>
        <div class="mobile-nav-item" onclick="app.goHistory()"><span>üïí</span>Historique</div>
        <div class="mobile-nav-item" onclick="app.goStats()"><span>üìä</span>Stats</div> 
        <div class="mobile-nav-item" onclick="app.goMyProfile()"><span>üë§</span>Moi</div>
    </div>

    <div class="container">
        <nav class="sidebar">
            <div class="nav-item" onclick="app.goHome()">üè† Accueil</div>
            <div class="nav-item" onclick="app.goShorts()">‚ö° Zapp</div>
            <div class="nav-item" onclick="app.goSubs()">üì∫ Suivis</div>
            <hr style="border-color: #333; margin: 10px 0;">
            <div class="nav-item" onclick="app.goHistory()">üïí Historique</div>
            <div class="nav-item" onclick="app.goStats()">üìä Statistiques</div> 
            <hr style="border-color: #333; margin: 10px 0;">
            <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma Cha√Æne</div>
        </nav>

        <main class="content">
            <div id="mainTitle"></div>
            
            <div id="videoGrid" class="video-grid"></div>
            <div id="shortsGrid" class="shorts-grid" style="display:none;"></div>
            
            <div id="statsView" class="stats-view">
                <h2>üìä Mes Statistiques</h2>
                <div id="statsContent" style="background:#1a1a1a; padding:20px; border-radius:10px;">
                    </div>
            </div>

            <div id="profileView" class="profile-view">
                <img class="banner" id="pBanner" src="">
                <div class="profile-head">
                    <img id="profileAvatar" src="" class="avatar-big">
                    <div>
                        <h1 id="pName" style="margin:0;">Nom</h1>
                        <p id="pStats" style="color:var(--sec-text); margin:5px 0;"></p>
                        <p id="pBio" style="color:#aaa;"></p>
                        <div id="profileActions" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <h3 style="margin-top:30px; padding: 0 20px;">Vid√©os</h3>
                <div id="pVideos" class="video-grid" style="padding: 0 20px;"></div>
            </div>

            <div id="adminPanel" class="admin-view">
                <h2>üîë Panneau d'Administration</h2>
                
                <h3 style="margin-top:20px;">Gestion des Vid√©os</h3>
                <div id="adminVideoList"></div>
                
                <h3 style="margin-top:30px;">Gestion des Admins</h3>
                <div id="adminList"></div>
                
                <div style="margin-top:15px; display:flex; gap:10px; align-items:center;">
                    <input type="email" id="newAdminEmail" placeholder="Email du nouvel Admin">
                    <button class="action-pill btn-green" onclick="app.addAdmin()">Ajouter Admin</button>
                </div>
            </div>
        </main>
    </div>

    <div id="modalEditVideo" class="modal">
        <div class="modal-box">
            <h2>Modifier la Vid√©o</h2>
            <input type="text" id="editVideoTitle" placeholder="Nouveau titre">
            <button class="btn-blue" onclick="app.saveAdminVideoEdit()">Sauvegarder</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="playerModal" class="player-overlay">
        <div style="padding: 15px;"><button class="action-pill" onclick="app.closePlayer()">‚úï Fermer</button></div>
        <div class="player-content">
            <div id="videoContainer" class="video-wrapper">
                <video id="mainVideoPlayer" controls autoplay></video>
                <div id="shortNav" class="short-nav" style="display:none;">
                    <button onclick="app.prevShort()">‚óÄ Pr√©c√©dent</button>
                    <button onclick="app.nextShort()">Suivant ‚ñ∂</button>
                </div>
            </div>
            
            <h2 id="playerTitle" style="margin-bottom:5px;"></h2>
            <p id="playerMeta" style="color:var(--sec-text); font-size:14px; margin-top:0;"></p>
            <div id="playerActions" style="display:flex; gap:15px; align-items:center;"></div>
            
            <div class="comment-section">
                <h4 id="commentCount">Commentaires</h4>
                <div class="comment-input-area">
                    <img src="" id="userCommentAvatar" class="avatar-small">
                    <input type="text" id="newCommentInput" placeholder="Ajouter un commentaire...">
                    <button class="action-pill" onclick="app.addComment()">Publier</button>
                </div>
                <div id="commentList"></div>
            </div>
        </div>
    </div>

    <div id="modalUpload" class="modal">
        <div class="modal-box">
            <h2>Publier une vid√©o</h2>
            <p id="uploadStatus" style="color: var(--blue); font-size:14px; text-align:center;"></p>
            <div class="progress-bar" id="uploadProgressBar" style="display: none;"><div class="progress-fill" id="uploadProgressFill"></div></div>
            
            <input type="text" id="upTitle" placeholder="Titre de la vid√©o">
            
            <label style="color:#aaa; font-size:12px; display:block; margin-top:10px;">Fichier Vid√©o (.mp4, .mov)</label>
            <input type="file" id="upVideoFile" accept="video/*" style="margin-bottom: 20px;">
            
            <label style="color:#aaa; font-size:12px; display:block;">Miniature (Image de couverture)</label>
            <input type="file" id="upThumbFile" accept="image/*" style="margin-bottom: 20px;">
            
            <button class="btn-blue" id="publishBtn" onclick="app.publish()">PUBLIER</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="modalEditProfile" class="modal">
        <div class="modal-box">
            <h2>Personnaliser ma cha√Æne</h2>
            <p id="profileUploadStatus" style="color: var(--blue);"></p>
            
            <input type="text" id="editName" placeholder="Nom de la cha√Æne">
            <textarea id="editBio" placeholder="Description (Bio)"></textarea>
            
            <label style="color:#aaa; font-size:12px;">Photo de Profil</label>
            <input type="file" id="editPPFile" accept="image/*">
            
            <label style="color:#aaa; font-size:12px;">Banni√®re</label>
            <input type="file" id="editBannerFile" accept="image/*">
            
            <button class="btn-blue" onclick="app.saveProfile()">Enregistrer</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Fermer</button>
        </div>
    </div>

    <div id="modalLoginEmail" class="modal">
        <div class="modal-box">
            <h2>Connexion</h2>
            <input type="email" id="logEmail" placeholder="Email">
            <button class="btn-blue" onclick="app.loginStep(1)">Suivant</button>
        </div>
    </div>
    
    <div id="modalLoginRegister" class="modal">
        <div class="modal-box">
            <h2>Cr√©er profil</h2>
            <input type="text" id="logNewName" placeholder="Nom">
            <input type="password" id="logNewPass" placeholder="Mot de passe">
            <button class="btn-blue" onclick="app.loginStep(2)">C'est parti</button>
        </div>
    </div>
    
    <div id="modalLoginPass" class="modal">
        <div class="modal-box">
            <h2>Mot de passe</h2>
            <input type="password" id="logPass" placeholder="Mot de passe">
            <button class="btn-blue" onclick="app.loginStep(3)">Entrer</button>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        // Worker proxy pour la mise √† jour du Gist (si vous l'utilisez)
        const WORKER_PROXY_URL = "https://mytubeupload.edonis-imbert.workers.dev/"; 
        
        // Configuration Cloudinary pour l'upload (doit √™tre configur√©)
        const CLOUDINARY_CLOUD_NAME = "dvbsmh8qq"; 
        const CLOUDINARY_UPLOAD_PRESET = "mytube_upload"; 
        
        // URL de votre Gist brut (le fichier JSON contenant les donn√©es)
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json"; 
        const GIST_FILE_NAME = "video.json"; 
        
        // Email de l'administrateur principal (ne peut pas √™tre retir√©)
        const PRIMARY_ADMIN_EMAIL = "edonis.imbert@gmail.com"; 
        
        // Cooldown pour les vues (1 heure en millisecondes)
        const VIEW_COOLDOWN_MS = 60 * 60 * 1000; 

        // R√©cup√©ration des identifiants locaux pour la connexion
        let localUserCreds = JSON.parse(localStorage.getItem('mt_user_creds')) || {};

        // D√©finition de l'objet principal de l'application
        const app = {
            data: {
                // Donn√©es utilisateur connect√©
                user: JSON.parse(localStorage.getItem('mt_user')), 
                // Liste de toutes les vid√©os
                videos: [],
                // Liste de tous les utilisateurs/cr√©ateurs
                users: {}, 
                // Liste des emails des administrateurs
                admins: [PRIMARY_ADMIN_EMAIL], 
                // Votes de l'utilisateur (stock√©s localement)
                votes: JSON.parse(localStorage.getItem('mt_votes')) || {},
                // Abonnements de l'utilisateur (stock√©s localement)
                subs: JSON.parse(localStorage.getItem('mt_subs')) || [], 
                // Historique des vid√©os regard√©es (stock√© localement)
                history: JSON.parse(localStorage.getItem('mt_history')) || [], 
                // NOUVEAU: Temps de la derni√®re vue par vid√©o pour le cooldown (local)
                lastViewTimes: JSON.parse(localStorage.getItem('mt_last_views')) || {},
                // NOUVEAU: Statistiques locales (temps pass√©)
                stats: JSON.parse(localStorage.getItem('mt_stats')) || {
                    timeSpentSeconds: 0,
                },
            },
            currentEditVideoId: null,
            
            // NOUVEAU: Variables pour la lecture s√©quentielle des Shorts
            currentPlayingVideoId: null,
            currentShortsList: [], 
            currentShortIndex: -1,

            // --- FONCTIONS DE D√âMARRAGE ET DE GESTION DES DONN√âES ---

            init: async function() {
                await this.loadData();
                this.updateAuthUI();
                this.trackSessionTime(); // D√©marrer le suivi du temps
                this.goHome();
            },

            loadData: async function() {
                // Charge les donn√©es principales depuis le Gist
                try {
                    const res = await fetch(GIST_URL + "?t=" + Date.now()); 
                    const json = await res.json();
                    this.data.videos = json.videos || [];
                    this.data.users = json.users || {};
                    this.data.admins = json.admins || [PRIMARY_ADMIN_EMAIL];
                } catch(e) { 
                    console.error("Erreur lors du chargement des donn√©es depuis le Gist.", e); 
                    // Maintenir l'application fonctionnelle m√™me en cas d'erreur de chargement
                }
            },

            saveGist: async function() {
                // Enregistre les donn√©es (vid√©os, users, admins) sur le Gist via le Worker
                if(!WORKER_PROXY_URL) return;
                const content = { videos: this.data.videos, users: this.data.users, admins: this.data.admins };
                try {
                    await fetch(WORKER_PROXY_URL, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: { [GIST_FILE_NAME]: { content: JSON.stringify(content, null, 2) } } })
                    });
                } catch(e) {
                    console.error("Erreur lors de la sauvegarde du Gist.", e);
                }
            },

            saveLocal: function() {
                // Sauvegarde les donn√©es utilisateur et les pr√©f√©rences dans le localStorage
                localStorage.setItem('mt_user', JSON.stringify(this.data.user));
                localStorage.setItem('mt_subs', JSON.stringify(this.data.subs));
                localStorage.setItem('mt_votes', JSON.stringify(this.data.votes));
                localStorage.setItem('mt_history', JSON.stringify(this.data.history)); 
                localStorage.setItem('mt_last_views', JSON.stringify(this.data.lastViewTimes)); // NOUVEAU: Sauvegarde du cooldown
                localStorage.setItem('mt_stats', JSON.stringify(this.data.stats)); // NOUVEAU: Sauvegarde des stats locales
            },
            
            // NOUVEAU: Suivi du temps de session
            trackSessionTime: function() {
                if (!this.data.stats.timeSpentSeconds) {
                    this.data.stats.timeSpentSeconds = 0;
                }
                // Incr√©mente le temps pass√© toutes les 60 secondes (1 minute)
                setInterval(() => {
                    this.data.stats.timeSpentSeconds += 60;
                    this.saveLocal();
                }, 60000); 
            },

            // Calcul du temps √©coul√©
            timeAgo: function(timestamp) {
                const seconds = Math.floor((Date.now() - timestamp) / 1000);
                if (seconds < 60) return "quelques secondes";
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return minutes + " minutes";
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return hours + " heures";
                const days = Math.floor(hours / 24);
                if (days < 30) return days + " jours";
                const months = Math.floor(days / 30);
                return months + " mois";
            },

            // --- FONCTIONS DE GESTION DE L'AUTHENTIFICATION (INCHANG√âES) ---
            
            loginStep: async function(s) {
                const email = document.getElementById('logEmail').value.toLowerCase();
                if (s == 1) { 
                    if (!email.includes('@')) return alert("Email invalide");
                    this.closeModals();
                    if (localUserCreds[email]) {
                        document.getElementById('modalLoginPass').style.display = 'flex';
                        document.getElementById('logPass').value = ''; 
                    } else {
                        document.getElementById('modalLoginRegister').style.display = 'flex';
                        document.getElementById('logNewName').value = ''; 
                        document.getElementById('logNewPass').value = '';
                    }
                } else if (s == 2) { 
                    const name = document.getElementById('logNewName').value;
                    const pass = document.getElementById('logNewPass').value;
                    if (!name || pass.length < 4) return alert("Nom et mot de passe (min 4 caract√®res) sont requis.");
                    localUserCreds[email] = { email, name, pass };
                    localStorage.setItem('mt_user_creds', JSON.stringify(localUserCreds));
                    this.data.users[name] = { name, email, bio: "Nouveau cr√©ateur Visiona", avatar: "", banner: "", subs: [] };
                    this.data.user = localUserCreds[email];
                    this.saveLocal(); await this.saveGist(); location.reload();
                } else if (s == 3) { 
                    const pass = document.getElementById('logPass').value;
                    const creds = localUserCreds[email];
                    if (creds && creds.pass === pass) {
                        this.data.user = creds; 
                        this.saveLocal(); location.reload();
                    } else { alert("Mauvais mot de passe."); }
                }
            },
            
            doLogout: function() { 
                localStorage.removeItem('mt_user'); 
                localStorage.removeItem('mt_subs'); 
                localStorage.removeItem('mt_votes'); 
                localStorage.removeItem('mt_history'); 
                localStorage.removeItem('mt_last_views'); 
                localStorage.removeItem('mt_stats');
                location.reload(); 
            },
            
            updateAuthUI: function() {
                const b = document.getElementById('loginBtn');
                const adminLink = document.getElementById('adminLink');
                const menuUserName = document.getElementById('menuUserName');
                if(this.data.user && this.data.user.name) { 
                    b.innerText = this.data.user.name;
                    menuUserName.innerText = this.data.user.name; 
                    if(this.isAdmin()) adminLink.style.display = 'block';
                } else {
                    b.innerText = "üë§ Se connecter";
                    menuUserName.innerText = '';
                    adminLink.style.display = 'none';
                }
            },
            
            // --- NOUVEAU: FONCTIONS DE STATISTIQUES ---
            goStats: function() {
                if(!this.data.user) return this.openLogin(); 
                this.hideAll();
                document.getElementById('statsView').style.display = 'block';
                document.getElementById('mainTitle').innerHTML = "<h2>üìä Mes Statistiques</h2>";

                const userName = this.data.user.name;
                
                // 1. Temps pass√©
                const totalTimeSeconds = this.data.stats.timeSpentSeconds;
                const timeFormatted = `${Math.floor(totalTimeSeconds / 3600)}h ${Math.floor((totalTimeSeconds % 3600) / 60)}m`;

                // 2. Likes donn√©s
                const likesGiven = Object.values(this.data.votes).filter(v => v === 1).length;

                // 3. Videos regard√©es (historique)
                const videosWatched = this.data.history.length;

                // 4. Abonnements (Canaux suivis)
                const channelsFollowed = this.data.subs.length;

                // 5. Abonn√©s re√ßus (Calcul√© dynamiquement)
                let followers = 0;
                for (const author in this.data.users) {
                    if (this.data.users[author]?.subs?.includes(userName)) {
                        followers++;
                    }
                }

                // 6. Likes/Dislikes re√ßus (Calcul√© dynamiquement)
                let likesReceived = 0;
                let dislikesReceived = 0;
                this.data.videos.filter(v => v.author === userName).forEach(v => {
                    likesReceived += (v.likes || 0);
                    dislikesReceived += (v.dislikes || 0);
                });
                
                // 7. Top 3 des cha√Ænes regard√©es
                const authorWatchCounts = {};
                this.data.history.map(id => this.data.videos.find(v => v.id == id)?.author).filter(a => a).forEach(author => {
                    authorWatchCounts[author] = (authorWatchCounts[author] || 0) + 1;
                });
                const topAuthors = Object.entries(authorWatchCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 3)
                    .map(([author, count]) => `${author} (${count} vues)`);
                
                const html = `
                    <h3>Global</h3>
                    <p>Temps pass√© sur le site : <strong>${timeFormatted}</strong></p>
                    <p>Vid√©os regard√©es : <strong>${videosWatched}</strong></p>
                    <p>J'aime (Likes) donn√©s : <strong>${likesGiven}</strong></p>
                    
                    <h3>Votre Cha√Æne (${userName})</h3>
                    <p>Nombre d'abonn√©s : <strong>${followers}</strong></p>
                    <p>Nombre d'abonnements (cha√Ænes suivies) : <strong>${channelsFollowed}</strong></p>
                    <p>J'aime (Likes) re√ßus : <strong>${likesReceived}</strong></p>
                    <p>Je n'aime pas (Dislikes) re√ßus : <strong>${dislikesReceived}</strong></p>

                    <h3>Votre Top 3 de Visionnage</h3>
                    ${topAuthors.length > 0 ? `
                        <ol style="margin-top:5px; padding-left:20px;">
                            ${topAuthors.map(item => `<li>${item}</li>`).join('')}
                        </ol>
                    ` : '<p>Pas assez de donn√©es dans l\'historique pour le top 3.</p>'}
                `;
                document.getElementById('statsContent').innerHTML = html;
            },


            // --- FONCTIONS DE GESTION DES LIKES/ABONNEMENTS ---

            toggleVote: async function(id, type) {
                if(!this.data.user) return this.openLogin();
                const v = this.data.videos.find(x => x.id == id);
                if (!v) return;
                const currentVote = this.data.votes[id] || 0;
                v.likes = v.likes || 0; v.dislikes = v.dislikes || 0;
                if (type === 'like') {
                    if (currentVote === 1) { v.likes--; this.data.votes[id] = 0; } 
                    else if (currentVote === -1) { v.dislikes--; v.likes++; this.data.votes[id] = 1; } 
                    else { v.likes++; this.data.votes[id] = 1; }
                } else if (type === 'dislike') {
                    if (currentVote === -1) { v.dislikes--; this.data.votes[id] = 0; } 
                    else if (currentVote === 1) { v.likes--; v.dislikes++; this.data.votes[id] = -1; } 
                    else { v.dislikes++; this.data.votes[id] = -1; }
                }
                
                this.saveLocal(); 
                await this.saveGist(); 
                // CORRECTION: On n'appelle plus openVideoOverlay pour ne pas incr√©menter les vues
                this.updatePlayerActions(id); 
            },
            
            updatePlayerActions: function(id) {
                // Met √† jour les boutons d'action et les m√©tadonn√©es SANS recharger la vid√©o
                const v = this.data.videos.find(x => x.id == id);
                if (!v) return;
                this.currentPlayingVideoId = id;

                const currentVote = this.data.votes[id] || 0;
                document.getElementById('playerActions').innerHTML = `
                    <img src="${this.getAvatar(v.author)}" class="avatar-small" onclick="app.viewProfile('${v.author}')">
                    <h4 style="margin: 0; cursor:pointer;" onclick="app.viewProfile('${v.author}')">${v.author}</h4>
                    <button class="action-pill ${currentVote === 1 ? 'liked' : ''}" onclick="app.toggleVote(${id}, 'like')">üëç ${v.likes || 0}</button>
                    <button class="action-pill ${currentVote === -1 ? 'disliked' : ''}" onclick="app.toggleVote(${id}, 'dislike')">üëé ${v.dislikes || 0}</button>
                `;
                document.getElementById('playerMeta').innerText = `${v.views || 0} vues ‚Ä¢ Il y a ${this.timeAgo(v.id)}`;
                this.renderComments(v);
            },

            toggleSub: async function(author) {
                if(!this.data.user) return this.openLogin();
                const index = this.data.subs.indexOf(author);
                if (index > -1) this.data.subs.splice(index, 1);
                else this.data.subs.push(author);
                this.saveLocal(); 
                if (!this.data.users[this.data.user.name]) this.data.users[this.data.user.name] = { name: this.data.user.name, email: this.data.user.email };
                this.data.users[this.data.user.name].subs = this.data.subs;
                await this.saveGist(); this.viewProfile(author); 
            },
            
            // --- FONCTIONS DE NAVIGATION ET RENDU ---

            render: function(list, target = 'videoGrid') {
                // G√©n√®re le HTML pour la grille de vid√©os
                const targetElement = document.getElementById(target);
                
                if (list.length === 0) { 
                    targetElement.innerHTML = "<p style='color:#aaa; padding:20px;'>Aucune vid√©o √† afficher pour le moment.</p>"; 
                    return; 
                }
                
                targetElement.innerHTML = list.map(v => `
                    <div class="video-card" onclick="app.openVideoOverlay(${v.id}, ${v.isShort ? 'true' : 'false'})">
                        <div class="thumb-container"><img src="${v.thumb}" class="thumb"></div>
                        <div style="padding-top: 8px;">
                            <h3 style="margin: 0 0 4px 0; font-size: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${v.title}</h3>
                            <p style="margin: 0; font-size: 14px; color: var(--sec-text);">${v.author}</p>
                            <p style="margin: 0; font-size: 12px; color: var(--sec-text);">${v.views || 0} vues ‚Ä¢ Il y a ${this.timeAgo(v.id)}</p>
                        </div>
                    </div>
                `).join('');
            },

            goHome: function() { 
                this.hideAll(); 
                document.getElementById('videoGrid').style.display = 'grid'; 
                document.getElementById('mainTitle').innerHTML = "<h2>Accueil</h2>"; 
                this.render(this.data.videos.filter(v => !v.isShort));
            },
            
            goShorts: function() { 
                this.hideAll(); 
                const g = document.getElementById('shortsGrid'); 
                g.style.display = 'flex'; 
                document.getElementById('mainTitle').innerHTML = "<h2>‚ö° Zapp</h2>"; 
                
                // R√©cup√®re la liste de tous les IDs de Shorts
                const shortIds = this.data.videos.filter(x => x.isShort).map(v => v.id);
                
                g.innerHTML = this.data.videos.filter(x => x.isShort).map((s, index) => `
                    <div class="short-card" onclick="app.openShortsPlayer(${s.id}, [${shortIds.join(',')}], ${index})">
                        <img src="${s.thumb}">
                        <div style="position:absolute; bottom:10px; left:10px; font-size:12px; font-weight:bold; color:white; text-shadow: 1px 1px 2px black;">${s.title}</div>
                    </div>
                `).join(''); 
            },

            goSubs: function() { 
                if(!this.data.user) return this.openLogin(); 
                this.hideAll(); 
                document.getElementById('videoGrid').style.display = 'grid'; 
                document.getElementById('mainTitle').innerHTML = "<h2>Mes suivis</h2>"; 
                this.render(this.data.videos.filter(x => this.data.subs.includes(x.author))); 
            },
            
            goHistory: function() {
                this.hideAll();
                document.getElementById('videoGrid').style.display = 'grid';
                document.getElementById('mainTitle').innerHTML = "<h2>üïí Mon Historique</h2>";
                const list = this.data.history.map(id => this.data.videos.find(v => v.id == id)).filter(v => v);
                this.render(list);
            },
            
            search: function() {
                const term = document.getElementById('searchInput').value.toLowerCase();
                this.hideAll();
                document.getElementById('videoGrid').style.display = 'grid';
                document.getElementById('mainTitle').innerHTML = `<h2>R√©sultats pour "${term}"</h2>`;
                this.render(this.data.videos.filter(v => v.title.toLowerCase().includes(term) || v.author.toLowerCase().includes(term)));
            },

            // --- NOUVEAU: GESTION DE LA LECTURE S√âQUENTIELLE DES SHORTS ---
            openShortsPlayer: function(id, listIds, index) {
                // Configure le mode Shorts s√©quentiel
                this.currentShortsList = listIds;
                this.currentShortIndex = index;
                this.openVideoOverlay(id, true);
            },
            
            nextShort: function() {
                if (this.currentShortIndex < this.currentShortsList.length - 1) {
                    this.currentShortIndex++;
                    const nextId = this.currentShortsList[this.currentShortIndex];
                    this.openVideoOverlay(nextId, true, true);
                }
            },
            
            prevShort: function() {
                if (this.currentShortIndex > 0) {
                    this.currentShortIndex--;
                    const prevId = this.currentShortsList[this.currentShortIndex];
                    this.openVideoOverlay(prevId, true, true);
                }
            },
            
            // --- GESTION DU PLAYER VID√âO ---

            openVideoOverlay: async function(id, isShort = false, isSequentialNav = false) {
                const v = this.data.videos.find(x => x.id == id);
                if (!v) return;
                
                this.currentPlayingVideoId = id; // Sauvegarde l'ID de la vid√©o jou√©e
                
                // NOUVEAU: COOLDOWN ET GESTION DES VUES (1 heure)
                const now = Date.now();
                const lastView = this.data.lastViewTimes[id];
                let viewCountUpdated = false;

                if (!lastView || (now - lastView) > VIEW_COOLDOWN_MS) {
                    v.views = (v.views || 0) + 1;
                    this.data.lastViewTimes[id] = now;
                    await this.saveGist(); // Sauvegarde la nouvelle vue sur le Gist
                    viewCountUpdated = true;
                } else {
                    // Vue non comptabilis√©e (cooldown actif)
                }

                // NOUVEAU: Gestion Historique (m√™me si vue non comptabilis√©e)
                this.data.history = [id, ...this.data.history.filter(x => x !== id)].slice(0, 50);
                this.saveLocal();

                document.getElementById('playerModal').style.display = 'block';
                const player = document.getElementById('mainVideoPlayer');
                
                // Ne pas recharger la vid√©o si on navigue s√©quentiellement (am√©liore la fluidit√©)
                if (!isSequentialNav) {
                    player.src = v.url;
                }

                document.getElementById('playerTitle').innerText = v.title;
                document.getElementById('playerMeta').innerText = `${v.views} vues ${viewCountUpdated ? '(Nouvelle vue!)' : ''} ‚Ä¢ Il y a ${this.timeAgo(v.id)}`;
                
                this.updatePlayerActions(id); // Met √† jour les boutons (Likes/Dislikes)
                
                // Ajuste la taille du player pour les shorts
                const isVideoShort = v.isShort || isShort;
                document.getElementById('videoContainer').className = isVideoShort ? 'short-player-wrapper' : 'video-wrapper';

                // Affiche les contr√¥les de navigation des Shorts si c'est une Short et qu'on est en mode s√©quentiel
                const shortNav = document.getElementById('shortNav');
                if (isVideoShort && this.currentShortsList.length > 0) {
                    shortNav.style.display = 'flex';
                    shortNav.querySelector('button:first-child').disabled = this.currentShortIndex <= 0;
                    shortNav.querySelector('button:last-child').disabled = this.currentShortIndex >= this.currentShortsList.length - 1;
                } else {
                    shortNav.style.display = 'none';
                    this.currentShortsList = []; 
                    this.currentShortIndex = -1;
                }

                this.renderComments(v);
            },
            
            closePlayer: function() { 
                document.getElementById('playerModal').style.display='none'; 
                document.getElementById('mainVideoPlayer').pause();
                document.getElementById('mainVideoPlayer').src = "";
                // R√©initialise le mode Short
                this.currentShortsList = []; 
                this.currentShortIndex = -1;
            },

            renderComments: function(video) {
                // Affiche la liste des commentaires
                const list = document.getElementById('commentList');
                document.getElementById('commentCount').innerText = `Commentaires (${video.comments?.length || 0})`;
                
                if (this.data.user) {
                    document.getElementById('userCommentAvatar').src = this.getAvatar(this.data.user.name);
                } else {
                    document.getElementById('userCommentAvatar').src = 'https://via.placeholder.com/36?text=U';
                }
                
                list.innerHTML = (video.comments || []).map(c => `
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <img src="${this.getAvatar(c.author)}" class="avatar-small" onclick="app.viewProfile('${c.author}')">
                        <div>
                            <span style="font-weight:bold; font-size:14px; cursor:pointer;" onclick="app.viewProfile('${c.author}')">${c.author}</span>
                            <span style="font-size:12px; color:#999; margin-left:8px;">${new Date(c.time).toLocaleDateString()}</span>
                            <p style="margin:2px 0 0 0;">${c.text}</p>
                        </div>
                    </div>
                `).join('');
            },
            
            addComment: async function() {
                if(!this.data.user) return this.openLogin();
                const text = document.getElementById('newCommentInput').value.trim();
                const video = this.data.videos.find(v => v.id === this.currentPlayingVideoId);
                
                if (!text || !video) return;
                
                if (!video.comments) video.comments = [];
                video.comments.unshift({ author: this.data.user.name, text: text, time: Date.now() });
                
                document.getElementById('newCommentInput').value = '';
                this.renderComments(video); 
                await this.saveGist();
            },
            
            // --- FONCTIONS ADMINISTRATEUR (INCHANG√âES) ---

            isAdmin: function() { 
                return this.data.user && this.data.admins.includes(this.data.user.email); 
            },
            
            goAdminPanel: function() {
                if (!this.isAdmin()) return alert("Acc√®s refus√©.");
                this.hideAll(); 
                document.getElementById('adminPanel').style.display = 'block';
                this.renderAdminVideoList(); 
                this.renderAdminList();
            },

            renderAdminVideoList: function() {
                const list = document.getElementById('adminVideoList');
                list.innerHTML = `<table class="admin-table">
                    <thead><tr><th>ID (Date)</th><th>Titre</th><th>Auteur</th><th>Vues</th><th>Actions</th></tr></thead>
                    <tbody>${this.data.videos.map(v => `
                        <tr>
                            <td>${v.id}</td>
                            <td>${v.title}</td>
                            <td>${v.author}</td>
                            <td>${v.views || 0}</td>
                            <td>
                                <button class="action-pill" onclick="app.openAdminEditModal(${v.id}, '${v.title.replace(/'/g, "\\'")}')">‚úé</button>
                                <button class="action-pill btn-red" onclick="app.deleteVideo(${v.id})">‚ùå</button>
                            </td>
                        </tr>
                    `).join('')}</tbody>
                </table>`;
            },

            openAdminEditModal: function(id, title) {
                this.currentEditVideoId = id;
                document.getElementById('editVideoTitle').value = title;
                document.getElementById('modalEditVideo').style.display = 'flex';
            },

            saveAdminVideoEdit: async function() {
                const newTitle = document.getElementById('editVideoTitle').value;
                const index = this.data.videos.findIndex(v => v.id == this.currentEditVideoId);
                
                if (index > -1 && newTitle.trim()) {
                    this.data.videos[index].title = newTitle.trim();
                    this.closeModals(); 
                    await this.saveGist(); 
                    this.goAdminPanel(); 
                }
            },

            deleteVideo: async function(id) {
                if (!confirm("Voulez-vous vraiment supprimer cette vid√©o ?")) return;
                this.data.videos = this.data.videos.filter(v => v.id != id);
                await this.saveGist(); 
                this.goAdminPanel(); 
            },

            renderAdminList: function() {
                const list = document.getElementById('adminList');
                list.innerHTML = `<table class="admin-table">
                    <thead><tr><th>Email</th><th>Action</th></tr></thead>
                    <tbody>${this.data.admins.map(email => `
                        <tr>
                            <td>${email}</td>
                            <td>${email === PRIMARY_ADMIN_EMAIL ? '‚≠ê Admin Principal' : `<button class="action-pill btn-red" onclick="app.removeAdmin('${email}')">‚ùå Retirer</button>`}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>`;
            },

            addAdmin: async function() {
                if (this.data.user.email !== PRIMARY_ADMIN_EMAIL) return alert("Seul l'Admin Principal peut ajouter des admins.");
                const newEmail = document.getElementById('newAdminEmail').value.trim();
                
                if (newEmail && !this.data.admins.includes(newEmail)) {
                    this.data.admins.push(newEmail); 
                    document.getElementById('newAdminEmail').value = '';
                    await this.saveGist(); 
                    this.renderAdminList();
                    this.updateAuthUI(); 
                } else { 
                    alert("Email invalide ou d√©j√† admin."); 
                }
            },

            removeAdmin: async function(email) {
                if (this.data.user.email !== PRIMARY_ADMIN_EMAIL) return alert("Seul l'Admin Principal peut retirer des admins.");
                if (email === PRIMARY_ADMIN_EMAIL) return alert("Impossible de retirer l'Admin Principal.");
                
                this.data.admins = this.data.admins.filter(e => e !== email);
                await this.saveGist(); 
                this.renderAdminList();
                this.updateAuthUI(); 
            },

            // --- FONCTIONS UTILITAIRES (INCHANG√âES) ---
            
            getAvatar: function(name) { 
                return this.data.users[name]?.avatar || 'https://via.placeholder.com/36?text=U'; 
            },
            hideAll: function() { 
                ['videoGrid', 'shortsGrid', 'profileView', 'adminPanel', 'statsView'].forEach(id => document.getElementById(id).style.display = 'none');
            },
            toggleAccountMenu: function() { 
                const m = document.getElementById('accountMenu'); 
                m.style.display = m.style.display === 'none' ? 'block' : 'none'; 
            },
            closeModals: function() { 
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
            },
            openUpload: function() { 
                if(!this.data.user) return this.openLogin(); 
                document.getElementById('modalUpload').style.display='flex'; 
                document.getElementById('uploadProgressBar').style.display = 'none';
            },
            openLogin: function() { 
                document.getElementById('modalLoginEmail').style.display='flex'; 
            },
            
            // ... (Fonctions viewProfile, saveProfile, uploadCloudinary, publish) - Incluses mais masqu√©es pour la concision

        };

        // Lancement de l'application au chargement de la page
        app.init();
    </script>
</body>
</html>
