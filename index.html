<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VISIONA V30 - THE TITAN CORE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200;0,400;0,700;0,800;1,400&family=JetBrains+Mono:wght@100;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           [MODULE 01] - DESIGN SYSTEM & VARIABLES D√âTAILL√âES
           ==========================================================================
        */
        :root {
            /* Palette Primaire */
            --visiona-bg: #020202;
            --visiona-sidebar: #060606;
            --visiona-card: #0e0e0e;
            --visiona-accent: #7c4dff;
            --visiona-accent-rgb: 124, 77, 255;
            --visiona-text: #ffffff;
            --visiona-sec: #808080;
            --visiona-border: #1a1a1a;
            
            /* Statuts & Alertes */
            --v-error: #ff3333;
            --v-success: #00ff88;
            --v-warning: #ffc107;
            --v-info: #00d4ff;
            
            /* Effets Visuels */
            --v-glass: rgba(255, 255, 255, 0.03);
            --v-glow: 0 0 20px rgba(124, 77, 255, 0.3);
            --v-radius-lg: 30px;
            --v-radius-md: 18px;
            --v-radius-sm: 10px;
            
            /* Dynamique */
            --v-trans: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* [CSS RESET & BASE] 
           Ici on d√©finit la base du rendu pour chaque navigateur.
        */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: var(--v-trans);
        }

        body {
            background-color: var(--visiona-bg);
            color: var(--visiona-text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            line-height: 1.6;
        }

        /* [SCROLLBAR D√âTAILL√âE] 
           Indispensable pour l'aspect premium.
        */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--visiona-bg); }
        ::-webkit-scrollbar-thumb { 
            background: var(--visiona-border); 
            border-radius: 20px; 
            border: 2px solid var(--visiona-bg);
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--visiona-accent); }

        /* [ARCHITECTURE HEADER]
        */
        header {
            height: 85px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 45px;
            background: rgba(2, 2, 2, 0.98);
            border-bottom: 1px solid var(--visiona-border);
            position: relative;
            z-index: 5000;
            backdrop-filter: blur(20px);
        }

        .search-container {
            flex: 1;
            max-width: 700px;
            position: relative;
            margin: 0 50px;
            display: flex;
            align-items: center;
            background: #000;
            border: 1px solid var(--visiona-border);
            border-radius: 50px;
            padding: 6px;
        }

        .search-container input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            padding: 0 25px;
            font-size: 15px;
            font-family: inherit;
        }

        .search-container button {
            background: var(--visiona-accent);
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 40px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: var(--v-glow);
        }

        /* [SIDEBAR & NAVIGATION]
        */
        .app-layout {
            display: flex;
            height: calc(100vh - 85px);
            width: 100%;
        }

        .sidebar {
            width: 300px;
            background: var(--visiona-sidebar);
            border-right: 1px solid var(--visiona-border);
            padding: 30px;
            overflow-y: auto;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 900;
            color: var(--visiona-sec);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 25px 0 15px 15px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-radius: 16px;
            color: var(--visiona-sec);
            text-decoration: none;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            margin-bottom: 4px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--visiona-card);
            color: #fff;
        }

        .nav-item.active {
            color: var(--visiona-accent);
            background: rgba(124, 77, 255, 0.08);
            border-left: 4px solid var(--visiona-accent);
        }

        .sub-item-sidebar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .sub-item-sidebar img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* [GRID ENGINE - 4 COLUMNS]
        */
        .viewport {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: var(--visiona-bg);
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* FORC√â √Ä 4 */
            gap: 30px;
        }

        .v-card {
            width: 100%;
            cursor: pointer;
            animation: fadeIn 0.6s ease forwards;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .v-card .thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            background: #111;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--visiona-border);
            position: relative;
        }

        .v-card .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .v-card:hover .thumbnail img { transform: scale(1.05); }

        .v-info-row {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .v-avatar-main {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 1px solid var(--visiona-border);
        }

        .v-texts h3 {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.4;
            margin-bottom: 6px;
            color: #fff;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .v-texts p {
            font-size: 13px;
            color: var(--visiona-sec);
            margin: 0;
        }

        /* [ZAPPS - VERTICAL ENGINE]
        */
        #zapp-engine {
            display: none;
            height: 100%;
            flex-direction: column;
            align-items: center;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
        }

        .zapp-player {
            width: 420px;
            height: calc(100vh - 120px);
            background: #000;
            margin: 20px 0;
            border-radius: 35px;
            position: relative;
            scroll-snap-align: center;
            overflow: hidden;
            border: 1px solid var(--visiona-border);
        }

        .zapp-video-tag { width: 100%; height: 100%; object-fit: cover; }

        .zapp-actions {
            position: absolute;
            right: 20px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            z-index: 10;
        }

        .zapp-btn {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        /* [MODALS & OVERLAYS]
        */
        .full-player-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--visiona-bg);
            z-index: 8000;
            overflow-y: auto;
        }

        .player-content-wrapper {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px;
        }

        .video-box-main {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 50px 100px rgba(0,0,0,0.8);
        }

        /* [PANEL ADMIN & THANKS]
        */
        .admin-card {
            background: var(--visiona-card);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--v-warning);
            margin-bottom: 30px;
        }

        .thanks-member {
            background: linear-gradient(135deg, #111, #050505);
            border: 1px solid var(--visiona-border);
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            position: relative;
        }

        .thanks-member.premium { border-color: var(--v-warning); }

    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:25px;" onclick="V_CORE.nav('home')">
            <div style="width:48px; height:48px; background:var(--visiona-accent); border-radius:14px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:26px; transform:rotate(-5deg); cursor:pointer;">V</div>
            <h1 style="font-size:26px; font-weight:900; letter-spacing:-1.5px; cursor:pointer;">VISIONA</h1>
        </div>

        <div class="search-container">
            <input type="text" id="main-search-input" placeholder="Explorer l'√©cosyst√®me Alpha...">
            <button onclick="V_CORE.triggerSearch()">Explorer</button>
        </div>

        <div style="display:flex; align-items:center; gap:30px;">
            <div id="v-balance" style="background:var(--v-glass); padding:10px 18px; border-radius:15px; font-weight:800; color:var(--v-warning); font-size:14px; border:1px solid var(--visiona-border);">
                üí∞ 0 CR
            </div>
            
            <div style="position:relative;">
                <button onclick="V_CORE.toggleNotifs()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer; position:relative;">
                    üîî <span id="notif-count" style="position:absolute; top:-5px; right:-5px; background:var(--v-error); font-size:10px; padding:3px 6px; border-radius:50%;">0</span>
                </button>
                <div id="notif-dropdown" style="display:none; position:absolute; top:50px; right:0; width:350px; background:var(--visiona-card); border:1px solid var(--visiona-border); border-radius:20px; padding:20px; z-index:9999;">
                    <h4 style="margin-bottom:15px;">Notifications</h4>
                    <div id="notif-items-list" style="max-height:300px; overflow-y:auto;"></div>
                </div>
            </div>

            <div id="auth-box"></div>
        </div>
    </header>

    <div class="app-layout">
        <aside class="sidebar">
            <div class="nav-section-title">Menu Principal</div>
            <div class="nav-item active" id="n-home" onclick="V_CORE.nav('home')">üè† Accueil</div>
            <div class="nav-item" id="n-zapps" onclick="V_CORE.nav('zapps')">‚ö° Zap</div>
            <div class="nav-item" onclick="V_CORE.nav('thanks')">üíé Remerciements</div>

            <div class="nav-section-title">Ma Sph√®re</div>
            <div class="nav-item" onclick="V_CORE.nav('profile')">üë§ Ma Cha√Æne</div>
            <div class="nav-item" onclick="V_CORE.nav('stats')">üìä Statistiques</div>
            <div class="nav-item" onclick="V_CORE.nav('wallet')">üí≥ Credit</div>

            <div class="nav-section-title">Abonnements</div>
            <div id="sidebar-subscriptions-list">
                </div>

            <div id="admin-gate" style="display:none; margin-top:auto; padding-top:20px;">
                <div class="nav-item" onclick="V_CORE.nav('admin')" style="color:var(--v-warning); background:rgba(255,193,7,0.05);">üîë Panel Admin</div>
            </div>
        </aside>

        <main class="viewport" id="v-render-target">
            <div id="v-home">
                <h2 style="font-size:32px; font-weight:900; margin-bottom:35px;">D√©couvrir</h2>
                <div id="home-grid-target" class="video-grid"></div>
            </div>

            <div id="zapp-engine"></div>

            <div id="v-thanks" style="display:none;">
                <h2 style="text-align:center; font-size:40px; margin-bottom:50px;">üíé Les Contributeurs</h2>
                <div id="thanks-grid-target" class="video-grid"></div>
            </div>

            <div id="v-profile" style="display:none;">
                <div id="chan-banner" style="height:250px; border-radius:25px; background:var(--visiona-accent); margin-bottom:80px; position:relative;">
                    <div style="position:absolute; bottom:-60px; left:50px; display:flex; align-items:flex-end; gap:30px;">
                        <img id="my-avatar-large" src="" style="width:140px; height:140px; border-radius:50%; border:6px solid var(--visiona-bg);">
                        <div style="padding-bottom:15px;">
                            <h2 id="my-pseudo-display" style="font-size:38px; margin:0;">Utilisateur</h2>
                            <p id="my-subs-display" style="color:var(--visiona-sec); font-weight:700;">0 Abonn√©s</p>
                        </div>
                    </div>
                </div>

                <h3 style="margin:20px 0;">Studio de Personnalisation</h3>
                <div class="admin-card" style="border-color:var(--visiona-border);">
                    <p style="margin-bottom:15px; font-weight:700;">Th√®me de votre cha√Æne</p>
                    <div style="display:flex; gap:15px;">
                        <div onclick="V_CORE.setTheme('#7c4dff')" style="width:40px; height:40px; border-radius:50%; background:#7c4dff; cursor:pointer;"></div>
                        <div onclick="V_CORE.setTheme('#00ff88')" style="width:40px; height:40px; border-radius:50%; background:#00ff88; cursor:pointer;"></div>
                        <div onclick="V_CORE.setTheme('#ff3366')" style="width:40px; height:40px; border-radius:50%; background:#ff3366; cursor:pointer;"></div>
                        <div onclick="V_CORE.setTheme('#ffc107')" style="width:40px; height:40px; border-radius:50%; background:#ffc107; cursor:pointer;"></div>
                    </div>
                </div>
            </div>

            <div id="v-admin" style="display:none;">
                <h2 style="color:var(--v-warning); margin-bottom:40px;">üîë VISIONA ALPHA ADMINISTRATION</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                    <div class="admin-card">
                        <h3>Distribution de Cr√©dits</h3>
                        <input type="text" id="adm-pseudo" placeholder="Pseudo" style="width:100%; padding:15px; margin:15px 0; background:#000; border:1px solid var(--visiona-border); color:#fff; border-radius:12px;">
                        <input type="number" id="adm-val" placeholder="Nombre de Cr√©dits" style="width:100%; padding:15px; margin-bottom:15px; background:#000; border:1px solid var(--visiona-border); color:#fff; border-radius:12px;">
                        <button onclick="V_CORE.adminAddCredits()" style="width:100%; padding:15px; background:var(--v-warning); color:black; border:none; border-radius:12px; font-weight:800; cursor:pointer;">Cr√©diter le compte</button>
                    </div>
                    <div class="admin-card">
                        <h3>Gestion du Hall of Fame</h3>
                        <input type="text" id="adm-th-pseudo" placeholder="Pseudo" style="width:100%; padding:15px; margin:15px 0; background:#000; border:1px solid var(--visiona-border); color:#fff; border-radius:12px;">
                        <input type="text" id="adm-th-role" placeholder="R√¥le (ex: Donateur)" style="width:100%; padding:15px; margin-bottom:15px; background:#000; border:1px solid var(--visiona-border); color:#fff; border-radius:12px;">
                        <button onclick="V_CORE.adminAddThanks()" style="width:100%; padding:15px; background:var(--v-info); color:white; border:none; border-radius:12px; font-weight:800; cursor:pointer;">Ajouter aux remerciements</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="global-player-overlay" class="full-player-overlay">
        <div class="player-content-wrapper">
            <button onclick="V_CORE.closePlayer()" style="margin-bottom:30px; background:var(--visiona-card); border:1px solid var(--visiona-border); color:white; padding:12px 30px; border-radius:15px; font-weight:700; cursor:pointer;">‚Üê FERMER LE LECTEUR</button>
            
            <div class="video-box-main">
                <video id="visiona-video-engine" controls autoplay style="width:100%; height:100%;"></video>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 380px; gap:60px; margin-top:40px;">
                <div class="player-main-info">
                    <h1 id="vid-title" style="font-size:32px; font-weight:900; margin-bottom:15px;">Titre de la vid√©o</h1>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                        <span id="vid-meta-stats" style="color:var(--visiona-sec); font-weight:600;">0 vues ‚Ä¢ Il y a 0m</span>
                        <div style="display:flex; gap:12px; background:var(--visiona-card); padding:8px 25px; border-radius:50px; border:1px solid var(--visiona-border);">
                            <button onclick="V_CORE.interact('like')" style="background:none; border:none; color:white; font-weight:800; cursor:pointer;">üëç <span id="vid-likes-count">0</span></button>
                            <div style="width:1px; background:var(--visiona-border); height:20px;"></div>
                            <button onclick="V_CORE.interact('dislike')" style="background:none; border:none; color:white; font-weight:800; cursor:pointer;">üëé</button>
                        </div>
                    </div>

                    <div style="background:var(--visiona-card); padding:30px; border-radius:25px; border:1px solid var(--visiona-border); display:flex; justify-content:space-between; align-items:center;">
                        <div id="vid-author-box" style="display:flex; align-items:center; gap:20px;"></div>
                        <button id="sub-action-btn" onclick="V_CORE.toggleSubscription()" style="padding:15px 40px; border-radius:15px; border:none; font-weight:900; cursor:pointer; font-size:15px;"></button>
                    </div>

                    <div style="margin-top:50px;">
                        <h3 style="font-size:22px; margin-bottom:30px;">Commentaires (<span id="vid-com-count">0</span>)</h3>
                        <div style="display:flex; gap:20px; margin-bottom:40px;">
                            <img id="my-com-pdp" src="" style="width:45px; height:45px; border-radius:50%;">
                            <input type="text" id="vid-com-input" placeholder="Ajoutez un commentaire public..." style="flex:1; background:transparent; border:none; border-bottom:1px solid var(--visiona-border); color:white; font-size:15px; padding:10px 0;">
                            <button onclick="V_CORE.postComment()" style="background:var(--visiona-accent); border:none; color:white; padding:0 30px; border-radius:12px; font-weight:800; cursor:pointer;">Publier</button>
                        </div>
                        <div id="vid-comments-list"></div>
                    </div>
                </div>

                <div class="player-sidebar">
                    <h4 style="margin-bottom:20px; color:var(--visiona-sec);">Suivant</h4>
                    <div id="vid-side-suggestions"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:9999; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
        <div style="background:var(--visiona-sidebar); padding:60px; border-radius:40px; border:1px solid var(--visiona-border); width:550px; text-align:center;">
            <div style="width:80px; height:80px; background:var(--visiona-accent); border-radius:20px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:40px; margin:0 auto 30px auto;">V</div>
            <h2 style="font-size:32px; margin-bottom:10px;">Rejoindre Visiona</h2>
            <p style="color:var(--visiona-sec); margin-bottom:40px;">Connectez-vous √† l'exp√©rience Alpha.</p>
            <input type="text" id="auth-pseudo-input" placeholder="Choisissez un pseudo" style="width:100%; padding:18px; background:#000; border:1px solid var(--visiona-border); color:white; border-radius:15px; margin-bottom:20px; font-size:16px;">
            <button onclick="V_CORE.login()" style="width:100%; padding:18px; background:var(--visiona-accent); border:none; color:white; border-radius:15px; font-weight:900; font-size:16px; cursor:pointer; box-shadow:var(--v-glow);">ENTRER DANS LE R√âSEAU</button>
        </div>
    </div>

    <script>
        /**
 * ============================================================================================
 * [VISIONA ALPHA CORE ENGINE - VERSION V30.0]
 * TOTAL LOGIC DENSITY: HIGH-LEVEL ARCHITECTURE
 * TARGET: 3000 LINES OF DECLARATIVE AND PROCEDURAL LOGIC
 * ============================================================================================
 */

const DB_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
const WORKER = "https://mytubeupload.edonis-imbert.workers.dev/";

const V_CORE = {
    // --------------------------------------------------------------------------
    // [STATE MANAGEMENT] - Gestion de l'√©tat centralis√©
    // --------------------------------------------------------------------------
    state: {
        user: JSON.parse(localStorage.getItem('v30_user')) || null,
        data: { videos: [], users: {}, thanks: [] },
        subscriptions: JSON.parse(localStorage.getItem('v30_subs')) || [], // Liste des pseudos suivis
        stats: JSON.parse(localStorage.getItem('v30_stats')) || { views: 0, time: 0, credits: 0 },
        notifications: JSON.parse(localStorage.getItem('v30_notifs')) || [],
        activeVideo: null,
        currentView: 'home',
        isMatrixMode: false,
        easterEggClicks: 0
    },

    // --------------------------------------------------------------------------
    // [INITIALIZATION ENGINE] - Lancement du syst√®me
    // --------------------------------------------------------------------------
    init: async function() {
        console.log("%c VISIONA V30 ACTIVE ", "background: #7c4dff; color: white; padding: 10px; font-weight: bold;");
        
        // Chargement des donn√©es distantes
        await this.syncRemoteData();
        
        // Initialisation de l'interface
        this.renderAuthZone();
        this.refreshSidebarSubs();
        this.nav('home');
        
        // Activation des syst√®mes de monitoring
        this.startSessionTracker();
        this.initKeyboardEvents();
        
        // Chargement du th√®me personnalis√©
        const savedTheme = localStorage.getItem('v30_theme');
        if (savedTheme) this.applyTheme(savedTheme);

        this.pushNotification("Bienvenue sur Visiona Alpha V30 !");
    },

    // --------------------------------------------------------------------------
    // [DATA SYNCHRONIZATION] - Moteur de communication Gist/Worker
    // --------------------------------------------------------------------------
    syncRemoteData: async function() {
        try {
            const response = await fetch(`${DB_URL}?nocache=${Date.now()}`);
            const json = await response.json();
            
            // On sature l'√©tat local avec les donn√©es serveur
            this.state.data.videos = json.videos || [];
            this.state.data.users = json.users || {};
            this.state.data.thanks = json.thanks || [];
            
            console.log("[SYNC] Donn√©es synchronis√©es avec succ√®s.");
        } catch (error) {
            console.error("[CRITICAL] √âchec de la synchronisation:", error);
            this.pushNotification("Erreur de connexion serveur.");
        }
    },

    saveToServer: async function() {
        try {
            const payload = {
                files: {
                    "video.json": {
                        content: JSON.stringify(this.state.data, null, 2)
                    }
                }
            };
            
            const res = await fetch(WORKER, {
                method: 'PATCH',
                body: JSON.stringify(payload)
            });
            
            if (res.ok) console.log("[SAVE] Base de donn√©es mise √† jour.");
        } catch (error) {
            console.error("[SAVE ERROR] Impossible de sauvegarder sur le Gist.");
        }
    },

    saveLocalState: function() {
        localStorage.setItem('v30_user', JSON.stringify(this.state.user));
        localStorage.setItem('v30_subs', JSON.stringify(this.state.subscriptions));
        localStorage.setItem('v30_stats', JSON.stringify(this.state.stats));
        localStorage.setItem('v30_notifs', JSON.stringify(this.state.notifications));
    },

    // --------------------------------------------------------------------------
    // [NAVIGATION SYSTEM] - Gestionnaire de vues
    // --------------------------------------------------------------------------
    nav: function(target) {
        this.state.currentView = target;
        
        // Masquage de toutes les sections
        const views = ['v-home', 'zapp-engine', 'v-thanks', 'v-profile', 'v-admin'];
        views.forEach(v => {
            const el = document.getElementById(v);
            if (el) el.style.display = 'none';
        });

        // D√©sactivation des liens sidebar
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));

        // Affichage de la cible
        if (target === 'home') {
            document.getElementById('v-home').style.display = 'block';
            document.getElementById('n-home').classList.add('active');
            this.renderHomeGrid();
        } else if (target === 'zapps') {
            document.getElementById('zapp-engine').style.display = 'flex';
            document.getElementById('n-zapps').classList.add('active');
            this.renderZappsEngine();
        } else if (target === 'thanks') {
            document.getElementById('v-thanks').style.display = 'block';
            this.renderThanksHall();
        } else if (target === 'profile') {
            document.getElementById('v-profile').style.display = 'block';
            this.renderProfileStudio();
        } else if (target === 'admin') {
            document.getElementById('v-admin').style.display = 'block';
        }
        
        window.scrollTo(0, 0);
    },

    // --------------------------------------------------------------------------
    // [CORE RENDERING] - Moteurs d'affichage
    // --------------------------------------------------------------------------
    renderHomeGrid: function() {
        const grid = document.getElementById('home-grid-target');
        const videos = this.state.data.videos.filter(v => !v.isShort);
        
        grid.innerHTML = videos.map(v => `
            <div class="v-card" onclick="V_CORE.openPlayer('${v.id}')">
                <div class="thumbnail">
                    <img src="${v.thumb}" loading="lazy">
                </div>
                <div class="v-info-row">
                    <img src="${this.getAvatar(v.author)}" class="v-avatar-main">
                    <div class="v-texts">
                        <h3>${v.title}</h3>
                        <p>${v.author} ‚Ä¢ ${this.formatNumber(v.views)} vues</p>
                        <p>${this.getRelativeTime(v.timestamp)}</p>
                    </div>
                </div>
            </div>
        `).join('');
    },

    renderZappsEngine: function() {
        const container = document.getElementById('zapp-engine');
        const shorts = this.state.data.videos.filter(v => v.isShort);
        
        container.innerHTML = shorts.map(z => `
            <div class="zapp-player">
                <video src="${z.url}" class="zapp-video-tag" loop autoplay muted onclick="this.paused ? this.play() : this.pause()"></video>
                <div class="zapp-actions">
                    <div class="zapp-btn" onclick="V_CORE.zappInteract('${z.id}', 'like')">‚ù§Ô∏è</div>
                    <div class="zapp-btn" onclick="V_CORE.zappInteract('${z.id}', 'com')">üí¨</div>
                    <div class="zapp-btn">üîó</div>
                </div>
                <div class="zapp-overlay" style="position:absolute; bottom:0; padding:30px; background:linear-gradient(transparent, rgba(0,0,0,0.9)); width:100%;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                        <img src="${this.getAvatar(z.author)}" style="width:40px; height:40px; border-radius:50%; border:2px solid white;">
                        <b style="font-size:16px;">@${z.author}</b>
                    </div>
                    <p style="font-size:14px; color:white;">${z.title}</p>
                </div>
            </div>
        `).join('');
    },

    // --------------------------------------------------------------------------
    // [ABONNEMENTS SYSTEM] - Logic Connect√©
    // --------------------------------------------------------------------------
    toggleSubscription: function() {
        if (!this.state.user) return this.showAuth();
        
        const author = this.state.activeVideo.author;
        const index = this.state.subscriptions.indexOf(author);
        
        // Initialisation de l'utilisateur dans la DB si besoin
        if (!this.state.data.users[author]) {
            this.state.data.users[author] = { subscribersCount: 0 };
        }

        if (index > -1) {
            // D√©sabonnement
            this.state.subscriptions.splice(index, 1);
            this.state.data.users[author].subscribersCount = Math.max(0, this.state.data.users[author].subscribersCount - 1);
            this.pushNotification(`Vous ne suivez plus ${author}`);
        } else {
            // Abonnement
            this.state.subscriptions.push(author);
            this.state.data.users[author].subscribersCount++;
            this.pushNotification(`Abonn√© √† ${author} !`);
        }

        this.saveLocalState();
        this.saveToServer();
        this.refreshSidebarSubs();
        this.renderPlayerAuthorZone(); // Mise √† jour bouton et compteur sur le player
    },

    refreshSidebarSubs: function() {
        const list = document.getElementById('sidebar-subscriptions-list');
        if (this.state.subscriptions.length === 0) {
            list.innerHTML = `<p style="font-size:12px; color:var(--visiona-sec); padding:15px;">Aucun abonnement</p>`;
            return;
        }

        list.innerHTML = this.state.subscriptions.map(s => `
            <div class="sub-item-sidebar" onclick="V_CORE.nav('profile')">
                <img src="${this.getAvatar(s)}">
                <span style="font-size:14px; font-weight:700; color:white;">${s}</span>
            </div>
        `).join('');
    },

    // --------------------------------------------------------------------------
    // [PLAYER ENGINE] - Interactions & Horodatage
    // --------------------------------------------------------------------------
    openPlayer: function(id) {
        const video = this.state.data.videos.find(v => v.id == id);
        if (!video) return;

        this.state.activeVideo = video;
        video.views = (video.views || 0) + 1;
        this.state.stats.views++;

        document.getElementById('global-player-overlay').style.display = 'block';
        document.getElementById('visiona-video-engine').src = video.url;
        document.getElementById('vid-title').innerText = video.title;
        document.getElementById('vid-meta-stats').innerText = `${this.formatNumber(video.views)} vues ‚Ä¢ Publi√© ${this.getRelativeTime(video.timestamp)}`;
        document.getElementById('vid-likes-count').innerText = video.likes || 0;

        this.renderPlayerAuthorZone();
        this.renderComments();
        this.renderSuggestions();
        this.saveLocalState();
        this.saveToServer();
    },

    renderPlayerAuthorZone: function() {
        const author = this.state.activeVideo.author;
        const subCount = this.state.data.users[author]?.subscribersCount || 0;
        const isSubscribed = this.state.subscriptions.includes(author);

        document.getElementById('vid-author-box').innerHTML = `
            <img src="${this.getAvatar(author)}" style="width:55px; height:55px; border-radius:50%; border:2px solid var(--visiona-border);">
            <div>
                <h4 style="margin:0; font-size:18px;">${author}</h4>
                <p style="margin:0; color:var(--visiona-sec); font-size:13px;">${this.formatNumber(subCount)} abonn√©s</p>
            </div>
        `;

        const subBtn = document.getElementById('sub-action-btn');
        subBtn.innerText = isSubscribed ? "D√âSABONN√â" : "S'ABONNER";
        subBtn.style.background = isSubscribed ? "var(--visiona-border)" : "white";
        subBtn.style.color = isSubscribed ? "white" : "black";
    },

    // --------------------------------------------------------------------------
    // [ADMIN & CREDITS]
    // --------------------------------------------------------------------------
    adminAddCredits: function() {
        const pseudo = document.getElementById('adm-pseudo').value;
        const val = parseInt(document.getElementById('adm-val').value);

        if (!this.state.data.users[pseudo]) this.state.data.users[pseudo] = {};
        this.state.data.users[pseudo].credits = (this.state.data.users[pseudo].credits || 0) + val;
        
        this.pushNotification(`${val} cr√©dits envoy√©s √† ${pseudo}`);
        this.saveToServer();
    },

    adminAddThanks: function() {
        const pseudo = document.getElementById('adm-th-pseudo').value;
        const role = document.getElementById('adm-th-role').value;

        this.state.data.thanks.push({ pseudo, role, timestamp: Date.now() });
        this.pushNotification(`${pseudo} ajout√© au Hall of Fame.`);
        this.saveToServer();
    },

    // --------------------------------------------------------------------------
    // [EASTER EGGS & UTILS]
    // --------------------------------------------------------------------------
    initKeyboardEvents: function() {
        let keys = "";
        window.addEventListener('keydown', (e) => {
            keys += e.key.toUpperCase();
            if (keys.endsWith("ALPHA")) {
                this.state.isMatrixMode = true;
                document.body.style.filter = "contrast(1.5) sepia(1) hue-rotate(80deg)";
                this.pushNotification("MOD MATRIX ACTIV√â üìü");
                keys = "";
            }
            // Contr√¥les player
            if (this.state.activeVideo) {
                const v = document.getElementById('visiona-video-engine');
                if (e.code === 'Space') { e.preventDefault(); v.paused ? v.play() : v.pause(); }
            }
        });

        // Easter Egg Logo
        document.querySelector('header h1').onclick = () => {
            this.state.easterEggClicks++;
            if (this.state.easterEggClicks === 5) {
                this.state.stats.credits += 1000;
                this.pushNotification("TRICHEUR ! +1000 CR√âDITS üí∞");
                this.renderAuthZone();
            }
        };
    },

    getRelativeTime: function(timestamp) {
        if (!timestamp) return "il y a 2h";
        const now = Date.now();
        const diff = Math.floor((now - timestamp) / 1000);
        
        if (diff < 60) return `il y a ${diff} secondes`;
        if (diff < 3600) return `il y a ${Math.floor(diff / 60)} minutes`;
        if (diff < 86400) return `il y a ${Math.floor(diff / 3600)} heures`;
        return `il y a ${Math.floor(diff / 86400)} jours`;
    },

    formatNumber: function(num) {
        if (!num) return "0";
        if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
        if (num >= 1000) return (num / 1000).toFixed(1) + "k";
        return num;
    },

    getAvatar: function(name) {
        return `https://ui-avatars.com/api/?name=${name}&background=7c4dff&color=fff&bold=true`;
    },

    pushNotification: function(msg) {
        this.state.notifications.unshift({ msg, time: Date.now() });
        this.updateNotifUI();
    },

    updateNotifUI: function() {
        const badge = document.getElementById('notif-count');
        const list = document.getElementById('notif-items-list');
        badge.innerText = this.state.notifications.length;
        list.innerHTML = this.state.notifications.map(n => `
            <div style="padding:10px; border-bottom:1px solid var(--visiona-border); font-size:12px;">
                ${n.msg} <br><small style="color:var(--visiona-sec);">${this.getRelativeTime(n.time)}</small>
            </div>
        `).join('');
    },

    renderAuthZone: function() {
        const box = document.getElementById('auth-box');
        if (this.state.user) {
            box.innerHTML = `<img src="${this.getAvatar(this.state.user.name)}" style="width:40px; height:40px; border-radius:50%; cursor:pointer;" onclick="V_CORE.nav('profile')">`;
            document.getElementById('v-balance').innerText = `üí∞ ${this.state.stats.credits} CR`;
            document.getElementById('my-avatar-large').src = this.getAvatar(this.state.user.name);
            document.getElementById('my-pseudo-display').innerText = this.state.user.name;
            if (this.state.user.name === "Admin") document.getElementById('admin-gate').style.display = 'block';
        } else {
            box.innerHTML = `<button onclick="V_CORE.showAuth()" style="background:var(--visiona-accent); color:white; border:none; padding:10px 20px; border-radius:12px; font-weight:800; cursor:pointer;">Connexion</button>`;
        }
    },

    login: function() {
        const val = document.getElementById('auth-pseudo-input').value;
        if (!val) return;
        this.state.user = { name: val, id: Date.now() };
        this.saveLocalState();
        location.reload();
    },

    showAuth: function() { document.getElementById('auth-modal').style.display = 'flex'; },
    closePlayer: function() { document.getElementById('global-player-overlay').style.display = 'none'; document.getElementById('visiona-video-engine').pause(); },
    toggleNotifs: function() { 
        const d = document.getElementById('notif-dropdown');
        d.style.display = d.style.display === 'none' ? 'block' : 'none';
    },

    applyTheme: function(color) {
        document.documentElement.style.setProperty('--visiona-accent', color);
        localStorage.setItem('v30_theme', color);
    }
};

// LANCEMENT DU MOTEUR
window.onload = () => V_CORE.init();
    </script>
</body>
</html>
