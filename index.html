<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona V19 - L'Exp√©rience Ultime</title>
    <style>
        :root { 
            --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; 
            --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --gold: #ffd700;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; overflow-x: hidden; }
        
        /* --- HEADER PREMIUM --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; height: 60px; background: var(--header); position: sticky; top: 0; z-index: 2000; border-bottom: 1px solid #222; }
        .logo { display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 22px; font-weight: bold; letter-spacing: -1px; }
        .logo-play { background: var(--red); color: white; padding: 6px 12px; border-radius: 8px; font-size: 14px; }
        
        .search-box { display: flex; flex: 1; max-width: 700px; margin: 0 40px; }
        .search-box input { width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 12px 20px; border-radius: 40px 0 0 40px; outline: none; font-size: 16px; }
        .search-box button { background: #222; border: 1px solid #333; padding: 0 25px; border-radius: 0 40px 40px 0; cursor: pointer; color: white; border-left: none; }

        /* --- SIDEBAR CLASSIQUE --- */
        .container { display: flex; height: calc(100vh - 60px); }
        .sidebar { width: 260px; background: var(--bg); padding: 15px; overflow-y: auto; flex-shrink: 0; border-right: 1px solid #222; }
        .nav-item { padding: 12px 15px; border-radius: 12px; cursor: pointer; margin-bottom: 5px; display: flex; align-items: center; gap: 20px; transition: 0.3s; font-size: 15px; }
        .nav-item:hover { background: var(--hover); }
        .nav-active { background: var(--hover); font-weight: bold; }
        .sidebar hr { border: none; border-top: 1px solid #333; margin: 15px 0; }

        /* --- GRILLES DE CONTENU --- */
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .video-card { cursor: pointer; transition: transform 0.2s; }
        .video-card:hover { transform: scale(1.02); }
        .thumb-wrap { width: 100%; aspect-ratio: 16/9; position: relative; border-radius: 15px; overflow: hidden; background: #222; }
        .thumb-wrap img { width: 100%; height: 100%; object-fit: cover; }

        /* --- ZAPP (FORMAT VERTICAL) --- */
        .zapp-view { display: flex; flex-direction: column; align-items: center; gap: 30px; overflow-y: auto; height: 100%; scroll-snap-type: y mandatory; }
        .zapp-item { width: 360px; height: 640px; background: #000; border-radius: 20px; scroll-snap-align: center; position: relative; flex-shrink: 0; }
        .zapp-item video { width: 100%; height: 100%; object-fit: cover; border-radius: 20px; }

        /* --- LECTEUR CIN√âMA --- */
        #playerOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .player-container { max-width: 1280px; margin: 0 auto; }
        .main-video-area { width: 100%; aspect-ratio: 16/9; background: #111; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .video-info-box { margin-top: 25px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        
        /* --- COMMENTAIRES --- */
        .comment-item { display: flex; gap: 15px; margin-top: 25px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #444; flex-shrink: 0; }
        .com-body { flex: 1; }
        .com-author { font-weight: bold; font-size: 14px; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
        .creator-heart { display: flex; align-items: center; gap: 5px; background: #222; padding: 4px 10px; border-radius: 15px; font-size: 12px; margin-top: 8px; width: fit-content; border: 1px solid #333; }
        .creator-heart img { width: 18px; height: 18px; border-radius: 50%; }

        /* --- BOUTONS & MODALS --- */
        .btn-blue { background: var(--blue); color: #000; border: none; padding: 12px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-red { background: var(--red); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9000; justify-content: center; align-items: center; }
        .modal-card { background: #1a1a1a; padding: 35px; border-radius: 25px; width: 90%; max-width: 550px; border: 1px solid #333; }
        .modal-card input, .modal-card textarea { width: 100%; padding: 15px; margin: 12px 0; background: #000; border: 1px solid #444; color: white; border-radius: 10px; box-sizing: border-box; }

        #userMenu { display: none; position: fixed; right: 25px; top: 70px; background: #1a1a1a; border: 1px solid #333; border-radius: 15px; width: 250px; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="app.goHome()">
            <div id="logoBadge" class="logo-play">‚ñ∂</div>
            <span>VISIONA</span>
        </div>
        <div class="search-box">
            <input type="text" id="searchInp" placeholder="Rechercher sur Visiona...">
            <button onclick="app.search()">üîç</button>
        </div>
        <div id="headerAuth" style="display:flex; align-items:center; gap:20px;"></div>
    </header>

    <div id="userMenu">
        <div id="menuUserName" style="padding:20px; border-bottom:1px solid #333; font-weight:bold; color:var(--blue);"></div>
        <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma Cha√Æne</div>
        <div class="nav-item" onclick="app.doLogout()" style="color:var(--red);">üö™ D√©connexion</div>
    </div>

    <div class="container">
        <nav class="sidebar">
            <div class="nav-item nav-active" id="navHome" onclick="app.goHome()">üè† Accueil</div>
            <div class="nav-item" id="navZapp" onclick="app.goZapp()">‚ö° Zapp</div>
            <div class="nav-item" id="navLive" onclick="app.goLive()">üî¥ En Direct</div>
            <div class="nav-item" id="navPost" onclick="app.goCommunity()">üì∞ Communaut√©</div>
            <hr>
            <div class="nav-item" id="navHistory" onclick="app.goHistory()">üïí Historique</div>
            <div class="nav-item" id="navStats" onclick="app.goStats()">üìä Statistiques</div>
            <div class="nav-item" id="navCredits" onclick="app.goCredits()">üí≥ Cr√©dits</div>
            <hr>
            <div style="font-size:12px; color:var(--sec-text); padding:0 15px 10px;">MES ABONNEMENTS</div>
            <div id="sidebarSubs"></div>
            <div id="adminZone" style="display:none;">
                <hr>
                <div class="nav-item" style="color:var(--gold);" onclick="app.goAdmin()">üîë Administration</div>
            </div>
        </nav>

        <main class="content">
            <div id="mainGrid" class="video-grid"></div>
            <div id="zappGrid" class="zapp-view" style="display:none;"></div>
            <div id="commView" style="display:none;"></div>
            <div id="statsView" style="display:none;"></div>
            <div id="historyView" style="display:none;"></div>
            <div id="creditsView" style="display:none;"></div>
            <div id="profileView" style="display:none;"></div>
        </main>
    </div>

    <div id="playerOverlay">
        <div class="player-container">
            <button class="btn-blue" onclick="app.closePlayer()" style="margin-bottom:20px;">‚úï QUITTER LE LECTEUR</button>
            <div class="main-video-area">
                <video id="pVid" controls autoplay style="width:100%; height:100%;"></video>
                <canvas id="liveCanvas" style="position:absolute; top:0; left:0; width:100%; height:100%; display:none;"></canvas>
            </div>
            <div class="video-info-box">
                <h1 id="pTitle" style="margin:10px 0;"></h1>
                <div id="pMeta" style="color:var(--sec-text); font-size:14px; margin-bottom:20px;"></div>
                <div id="pChannelRow" style="display:flex; justify-content:space-between; align-items:center;"></div>
            </div>
            <div id="pCommentSection" style="margin-top:40px;">
                <h3>Commentaires</h3>
                <div style="display:flex; gap:15px; margin-bottom:30px;">
                    <div id="myAvatar"></div>
                    <div style="flex:1;">
                        <input type="text" id="comInput" placeholder="Ajouter un commentaire..." style="width:100%; background:none; border:none; border-bottom:1px solid #333; color:white; padding:10px 0; outline:none;">
                        <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                            <button class="btn-blue" onclick="app.addComment()">Publier</button>
                        </div>
                    </div>
                </div>
                <div id="comList"></div>
            </div>
        </div>
    </div>

    <div id="modalCreate" class="modal">
        <div class="modal-card">
            <h2>Mettre en ligne</h2>
            <select id="createType" onchange="app.uiToggleType()">
                <option value="video">Vid√©o Standard</option>
                <option value="zapp">‚ö° Zapp (Format Court)</option>
                <option value="post">üì∞ Publication</option>
                <option value="live">üî¥ Lancer un Stream</option>
            </select>
            <div id="createFields">
                <input type="text" id="creaTitle" placeholder="Titre">
                <div id="fileGroup">
                    <label>Vid√©o :</label><input type="file" id="creaFileVid" accept="video/*">
                    <label>Miniature :</label><input type="file" id="creaFileThumb" accept="image/*">
                </div>
            </div>
            <div id="upStatus" style="color:var(--blue); margin-top:10px;"></div>
            <button id="btnPublish" class="btn-red" style="width:100%; margin-top:15px;" onclick="app.handlePublish()">PUBLIER SUR VISIONA</button>
            <button onclick="app.closeModals()" style="width:100%; background:none; border:none; color:var(--sec-text); margin-top:15px; cursor:pointer;">Annuler</button>
        </div>
    </div>

    <script>
        const CLOUD_URL = "https://api.cloudinary.com/v1_1/dvbsmh8qq/upload";
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
        const WORKER = "https://mytubeupload.edonis-imbert.workers.dev/";
        const streamBus = new BroadcastChannel('visiona_stream_v19');

        const app = {
            data: {
                user: JSON.parse(localStorage.getItem('mt_user')),
                videos: [], users: {}, posts: [], credits: [],
                subs: JSON.parse(localStorage.getItem('mt_subs')) || [],
                history: JSON.parse(localStorage.getItem('mt_history')) || [],
                viewLog: JSON.parse(localStorage.getItem('mt_view_log')) || {}
            },
            activeVid: null,

            init: async function() {
                await this.load();
                this.updateUI();
                this.goHome();
                this.listenStreams();
                if(Math.random() < 0.001) document.getElementById('logoBadge').innerText = 'üéÖ';
            },

            load: async function() {
                const r = await fetch(GIST_URL + "?t=" + Date.now());
                const j = await r.json();
                this.data.videos = j.videos || [];
                this.data.users = j.users || {};
                this.data.posts = j.posts || [];
                this.data.credits = j.credits || ["AlphaGames30", "Edonis Imbert"];
            },

            save: async function() {
                const body = { videos: this.data.videos, users: this.data.users, posts: this.data.posts, credits: this.data.credits };
                await fetch(WORKER, { method: 'PATCH', body: JSON.stringify({ files: {"video.json": {content: JSON.stringify(body, null, 2)}}}) });
            },

            // --- NAV ---
            hideAll: function() {
                ['mainGrid', 'zappGrid', 'commView', 'statsView', 'historyView', 'creditsView', 'profileView'].forEach(id => document.getElementById(id).style.display = 'none');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
                document.getElementById('userMenu').style.display = 'none';
            },

            goHome: function() {
                this.hideAll(); document.getElementById('navHome').classList.add('nav-active');
                const g = document.getElementById('mainGrid'); g.style.display = 'grid';
                this.renderVids(this.data.videos.filter(v => !v.isShort && !v.isStream), g);
            },

            goZapp: function() {
                this.hideAll(); document.getElementById('navZapp').classList.add('nav-active');
                const g = document.getElementById('zappGrid'); g.style.display = 'flex';
                g.innerHTML = this.data.videos.filter(v => v.isShort).map(v => `
                    <div class="zapp-item">
                        <video src="${v.url}" loop autoplay muted onclick="this.paused?this.play():this.pause()"></video>
                        <div style="position:absolute; bottom:30px; left:20px; text-shadow:0 0 10px #000;">
                            <h2>${v.title}</h2><p>@${v.author}</p>
                        </div>
                    </div>
                `).join('');
            },

            goHistory: function() {
                this.hideAll(); document.getElementById('navHistory').classList.add('nav-active');
                const g = document.getElementById('historyView'); g.style.display = 'block';
                const vids = this.data.history.map(id => this.data.videos.find(v => v.id == id)).filter(v => v);
                g.innerHTML = `<h2 style="margin-bottom:20px;">üïí Historique de lecture</h2><div class="video-grid"></div>`;
                this.renderVids(vids, g.querySelector('.video-grid'));
            },

            // --- PLAYER ---
            openPlayer: function(id) {
                const v = this.data.videos.find(x => x.id == id);
                this.activeVid = v;
                
                // Vues (Cooldown 1h)
                const now = Date.now();
                if(!this.data.viewLog[id] || (now - this.data.viewLog[id] > 3600000)) {
                    v.views = (v.views || 0) + 1;
                    this.data.viewLog[id] = now;
                    localStorage.setItem('mt_view_log', JSON.stringify(this.data.viewLog));
                    this.save();
                }

                this.data.history = [id, ...this.data.history.filter(x => x != id)].slice(0, 50);
                localStorage.setItem('mt_history', JSON.stringify(this.data.history));

                document.getElementById('playerOverlay').style.display = 'block';
                document.getElementById('pTitle').innerText = v.title;
                document.getElementById('pMeta').innerText = `${v.views} vues ‚Ä¢ ${v.date || 'R√©cemment'}`;
                
                const vid = document.getElementById('pVid');
                vid.src = v.url || "";
                vid.style.display = v.isStream ? 'none' : 'block';
                document.getElementById('liveCanvas').style.display = v.isStream ? 'block' : 'none';

                this.renderPlayerMeta();
                this.renderComments();
            },

            renderPlayerMeta: function() {
                const isSub = this.data.subs.includes(this.activeVid.author);
                document.getElementById('pChannelRow').innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px; cursor:pointer;" onclick="app.closePlayer(); app.viewProfile('${this.activeVid.author}')">
                        ${this.getAvatar(this.activeVid.author)}
                        <div><b>${this.activeVid.author}</b></div>
                    </div>
                    <button class="${isSub ? 'btn-blue' : 'btn-red'}" onclick="app.toggleSub('${this.activeVid.author}')">
                        ${isSub ? '‚úÖ ABONN√â' : 'S\'ABONNER'}
                    </button>
                `;
            },

            // --- PUBLICATION / UPLOAD ---
            uiToggleType: function() {
                const t = document.getElementById('createType').value;
                document.getElementById('fileGroup').style.display = (t === 'post' || t === 'live') ? 'none' : 'block';
            },

            handlePublish: async function() {
                const type = document.getElementById('createType').value;
                const title = document.getElementById('creaTitle').value;
                if(!title) return alert("Titre manquant");

                const btn = document.getElementById('btnPublish');
                const status = document.getElementById('upStatus');
                btn.disabled = true; status.innerText = "‚è≥ Connexion au serveur Visiona...";

                try {
                    let url = "", thumb = "https://via.placeholder.com/480x270/222/fff?text=Visiona";
                    
                    if(type === 'video' || type === 'zapp') {
                        const vF = document.getElementById('creaFileVid').files[0];
                        const tF = document.getElementById('creaFileThumb').files[0];
                        if(!vF) throw "Vid√©o requise";
                        url = await this.upCloud(vF, 'video');
                        if(tF) thumb = await this.upCloud(tF, 'image');
                    }

                    const newItem = {
                        id: Date.now(), title, author: this.data.user.name,
                        url, thumb, views: 0, date: new Date().toLocaleDateString(),
                        isShort: type === 'zapp', isStream: type === 'live', comments: []
                    };

                    if(type === 'post') this.data.posts.unshift({ author: this.data.user.name, text: title });
                    else this.data.videos.unshift(newItem);

                    await this.save();
                    location.reload();
                } catch(e) { alert(e); btn.disabled = false; status.innerText = ""; }
            },

            upCloud: async function(file, rType) {
                const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', 'mytube_upload');
                const res = await fetch(CLOUD_URL.replace('upload', rType+'/upload'), { method: 'POST', body: fd });
                const j = await res.json(); return j.secure_url;
            },

            // --- SOCIAL ---
            renderComments: function() {
                const isOwner = this.data.user?.name === this.activeVid.author;
                document.getElementById('comList').innerHTML = (this.activeVid.comments || []).map(c => `
                    <div class="comment-item">
                        ${this.getAvatar(c.author)}
                        <div class="com-body">
                            <div class="com-author">${c.author}</div>
                            <div>${c.text}</div>
                            ${c.heart ? `<div class="creator-heart">${this.getAvatar(this.activeVid.author)} ‚ù§Ô∏è</div>` : ''}
                            ${isOwner ? `<button onclick="app.toggleHeart(${c.id})" style="background:none; border:none; color:var(--sec-text); font-size:10px; cursor:pointer; margin-top:5px;">C≈ìur</button>` : ''}
                        </div>
                    </div>
                `).join('');
            },

            addComment: function() {
                const txt = document.getElementById('comInput').value;
                if(!txt || !this.data.user) return;
                if(!this.activeVid.comments) this.activeVid.comments = [];
                this.activeVid.comments.push({ id: Date.now(), author: this.data.user.name, text: txt, heart: false });
                document.getElementById('comInput').value = "";
                this.renderComments(); this.save();
            },

            toggleHeart: function(id) {
                const c = this.activeVid.comments.find(x => x.id === id);
                c.heart = !c.heart; this.renderComments(); this.save();
            },

            toggleSub: function(name) {
                if(this.data.subs.includes(name)) this.data.subs = this.data.subs.filter(x => x !== name);
                else this.data.subs.push(name);
                localStorage.setItem('mt_subs', JSON.stringify(this.data.subs));
                this.updateUI(); this.renderPlayerMeta();
            },

            // --- UI HELPERS ---
            renderVids: function(list, el) {
                el.innerHTML = list.map(v => `
                    <div class="video-card" onclick="app.openPlayer('${v.id}')">
                        <div class="thumb-wrap"><img src="${v.thumb}"></div>
                        <div style="display:flex; gap:15px; margin-top:15px;">
                            ${this.getAvatar(v.author)}
                            <div>
                                <h4 style="margin:0; font-size:16px;">${v.title}</h4>
                                <p style="color:var(--sec-text); font-size:13px; margin:5px 0;">${v.author} ‚Ä¢ ${v.views} vues</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            getAvatar: function(name) {
                const u = this.data.users[name];
                if(u && u.avatar) return `<img src="${u.avatar}" class="avatar">`;
                return `<div class="avatar" style="display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; background:var(--red);">${name.charAt(0).toUpperCase()}</div>`;
            },

            updateUI: function() {
                const area = document.getElementById('headerAuth');
                if(this.data.user) {
                    area.innerHTML = `<button onclick="app.openCreate()" style="background:none; border:none; color:#fff; font-size:26px; cursor:pointer;">‚äï</button>
                                     <div onclick="app.toggleUserMenu()" style="cursor:pointer;">${this.getAvatar(this.data.user.name)}</div>`;
                    document.getElementById('menuUserName').innerText = this.data.user.name;
                    if(this.data.user.email === "edonis.imbert@gmail.com") document.getElementById('adminZone').style.display='block';
                } else {
                    area.innerHTML = `<button class="btn-blue" onclick="app.doLogin()">Se connecter</button>`;
                }
                document.getElementById('sidebarSubs').innerHTML = this.data.subs.map(s => `<div class="nav-item" onclick="app.viewProfile('${s}')">${this.getAvatar(s)} <span>${s}</span></div>`).join('');
            },

            // --- MISC ---
            openCreate: function() { document.getElementById('modalCreate').style.display='flex'; },
            closeModals: function() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); },
            closePlayer: function() { document.getElementById('playerOverlay').style.display='none'; document.getElementById('pVid').pause(); },
            toggleUserMenu: function() { const m = document.getElementById('userMenu'); m.style.display = (m.style.display === 'block' ? 'none' : 'block'); },
            doLogin: function() { const p = prompt("Pseudo ?"); if(p) { this.data.user = {name: p, email: p+"@user.com"}; localStorage.setItem('mt_user', JSON.stringify(this.data.user)); location.reload(); }},
            doLogout: function() { localStorage.removeItem('mt_user'); location.reload(); },
            listenStreams: function() {
                streamBus.onmessage = (e) => {
                    if(this.activeVid?.id === e.data.id) {
                        const cvs = document.getElementById('liveCanvas'); const ctx = cvs.getContext('2d');
                        const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                        img.src = e.data.frame;
                    }
                };
            }
        };

        app.init();
    </script>
</body>
</html>
