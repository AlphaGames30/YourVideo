<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona - AlphaGames30</title>
    <style>
        /* ========================================================= */
        /* --- SECTION CSS : DÃ‰FINITION DES VARIABLES GLOBALESÂ  --- */
        /* ========================================================= */
        :root {Â 
            --bg: #0f0f0f;Â 
            --header: #0f0f0f;Â 
            --text: #ffffff;Â 
            --sec-text: #aaaaaa;Â 
            --hover: #272727;Â 
            --blue: #3ea6ff;Â 
            --red: #ff0000;Â 
        }

        /* ========================================================= */
        /* --- CSS : STYLE DU CORPS ET DE LA MISE EN PAGE GÃ‰NÃ‰RALE --- */
        /* ========================================================= */
        body {Â 
            margin: 0;Â 
            background: var(--bg);Â 
            color: var(--text);Â 
            font-family: Roboto, Arial, sans-serif;Â 
            overflow-x: hidden;Â 
            padding-bottom: 60px; /* Espace pour la navigation mobile */
        }

        /* --- HEADER ET NAVIGATION SUPÃ‰RIEURE --- */
        header {Â 
            display: flex;Â 
            justify-content: space-between;Â 
            align-items: center;Â 
            padding: 0 16px;Â 
            height: 56px;Â 
            background: var(--header);Â 
            position: sticky;Â 
            top: 0;Â 
            z-index: 100;Â 
            border-bottom: 1px solid #222;Â 
        }

        .logo {Â 
            font-size: 20px;Â 
            font-weight: bold;Â 
            cursor: pointer;Â 
            display: flex;Â 
            align-items: center;Â 
        }

        .logo::before {Â 
            content: 'â–¶';Â 
            color: var(--red);Â 
            font-size: 24px;Â 
            margin-right: 5px;Â 
        }

        /* --- BARRE DE RECHERCHE --- */
        .search-box {Â 
            display: flex;Â 
            flex: 1;Â 
            max-width: 500px;Â 
            margin: 0 10px;Â 
        }

        .search-box input {Â 
            width: 100%;Â 
            background: #121212;Â 
            border: 1px solid #333;Â 
            color: white;Â 
            padding: 8px 15px;Â 
            border-radius: 40px 0 0 40px;Â 
            border-right: none;Â 
        }

        .search-box button {Â 
            background: #222;Â 
            border: 1px solid #333;Â 
            border-left: none;Â 
            padding: 0 20px;Â 
            border-radius: 0 40px 40px 0;Â 
            cursor: pointer;Â 
            color: var(--sec-text);Â 
            transition: background 0.2s;
        }

        .search-box button:hover {
            background: #333;
        }

        .header-btns button {Â 
            background: none;Â 
            border: none;Â 
            color: white;Â 
            font-size: 20px;Â 
            margin-left: 10px;Â 
            cursor: pointer;Â 
        }

        .btn-login {Â 
            border: 1px solid var(--blue) !important;Â 
            color: var(--blue) !important;Â 
            font-size: 14px !important;Â 
            padding: 5px 10px;Â 
            border-radius: 20px;Â 
            font-weight: bold;Â 
            display: flex;Â 
            align-items: center;Â 
            gap: 5px;Â 
            transition: background 0.2s, color 0.2s;
        }

        /* --- CONTENEUR PRINCIPAL (SIDEBAR + CONTENT) --- */
        .container {Â 
            display: flex;Â 
            height: calc(100vh - 56px);Â 
        }

        /* --- SIDEBAR (NAVIGATION LATÃ‰RALE) --- */
        .sidebar {Â 
            width: 220px;Â 
            background: var(--bg);Â 
            padding: 10px;Â 
            overflow-y: auto;Â 
            flex-shrink: 0;Â 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .nav-item {Â 
            padding: 10px;Â 
            border-radius: 10px;Â 
            cursor: pointer;Â 
            margin-bottom: 5px;Â 
            display: flex;Â 
            align-items: center;Â 
            gap: 10px;Â 
            transition: background 0.2s;
        }

        .nav-item:hover {Â 
            background: var(--hover);Â 
        }

        /* --- ZONE DE CONTENU PRINCIPAL --- */
        .content {Â 
            flex: 1;Â 
            padding: 20px;Â 
            overflow-y: auto;Â 
        }

        /* --- GRILLES DE VIDÃ‰OS --- */
        .video-grid {Â 
            display: grid;Â 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));Â 
            gap: 20px;Â 
        }

        .video-card {Â 
            cursor: pointer;Â 
            transition: transform 0.2s;Â 
            overflow: hidden;Â 
        }

        .video-card:hover {Â 
            transform: scale(1.01);Â 
        }

        .thumb-container {Â 
            position: relative;Â 
            width: 100%;Â 
            aspect-ratio: 16/9;Â 
            border-radius: 12px;Â 
            overflow: hidden;Â 
            background: #333;Â 
        }

        .thumb {Â 
            width: 100%;Â 
            height: 100%;Â 
            object-fit: cover;Â 
            transition: opacity 0.3s;
        }

        /* --- GRILLE DES SHORTS --- */
        .shorts-grid {Â 
            display: flex;Â 
            gap: 15px;Â 
            overflow-x: auto;Â 
            padding-bottom: 10px;Â 
        }

        .short-card {Â 
            flex-shrink: 0;Â 
            width: 160px;Â 
            height: 300px;Â 
            cursor: pointer;Â 
            border-radius: 12px;Â 
            overflow: hidden;Â 
            background: #333;Â 
            position: relative;Â 
            transition: transform 0.2s;
        }
        Â 
        .short-card:hover {
            transform: translateY(-5px);
        }

        .short-card img {Â 
            width: 100%;Â 
            height: 100%;Â 
            object-fit: cover;Â 
        }

        /* --- PLAYER MODAL ET VIDÃ‰O --- */
        .player-overlay {Â 
            display: none;Â 
            position: fixed;Â 
            top: 0;Â 
            left: 0;Â 
            width: 100%;Â 
            height: 100%;Â 
            background: black;Â 
            z-index: 500;Â 
            overflow-y: auto;Â 
            padding-bottom: 50px;Â 
        }

        .player-content {Â 
            width: 95%;Â 
            max-width: 1200px;Â 
            margin: 20px auto;Â 
            display: flex;Â 
            flex-direction: column;Â 
            gap: 15px;Â 
        }

        .video-wrapper {Â 
            width: 100%;Â 
            aspect-ratio: 16/9;Â 
            background: #000;Â 
        }

        /* CONTENEUR DE SHORTS POUR LE DÃ‰FILEMENT SÃ‰QUENTIEL */
        .short-player-wrapper {Â 
            width: 100%;Â 
            max-width: 400px;Â 
            aspect-ratio: 9/16;Â 
            background: #000;Â 
            margin: 0 auto;Â 
            position: relative;
        }
        Â 
        .short-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 510;
        }
        Â 
        .short-nav button {
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            font-size: 24px;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }


        video {Â 
            width: 100%;Â 
            height: 100%;Â 
            background: #000;
        }

        /* --- SECTION COMMENTAIRES --- */
        .comment-section {Â 
            background: #1a1a1a;Â 
            padding: 20px;Â 
            border-radius: 12px;Â 
            margin-top: 20px;
        }

        .comment-input-area {Â 
            display: flex;Â 
            gap: 10px;Â 
            margin-bottom: 20px;Â 
            align-items: center;
        }

        .comment-input-area input {Â 
            flex: 1;Â 
            background: none;Â 
            border: none;Â 
            border-bottom: 1px solid #333;Â 
            color: white;Â 
            padding: 8px;Â 
            transition: border-bottom-color 0.3s;
        }

        .comment-input-area input:focus {
            outline: none;
            border-bottom-color: var(--text);
        }

        /* --- BOUTONS D'ACTION (PILLS) --- */
        .action-pill {Â 
            background: #272727;Â 
            color: white;Â 
            border: none;Â 
            padding: 6px 12px;Â 
            border-radius: 18px;Â 
            font-size: 13px;Â 
            cursor: pointer;Â 
            transition: background 0.2s, color 0.2s;
        }

        .action-pill:hover {
            background: #3a3a3a;
        }

        .liked {Â 
            color: var(--blue);Â 
            background: rgba(62, 166, 255, 0.2);
        }

        .disliked {Â 
            color: var(--red);Â 
            background: rgba(255, 0, 0, 0.2);
        }

        .followed {Â 
            background: #fff;Â 
            color: #000;Â 
            font-weight: bold;
        }

        .btn-red {Â 
            background: var(--red);Â 
            color: white;Â 
        }

        .btn-green {Â 
            background: #00a854;Â 
            color: white;Â 
        }

        /* --- MODALS ET FENÃŠTRES POP-UP --- */
        .modal {Â 
            display: none;Â 
            position: fixed;Â 
            top: 0;Â 
            left: 0;Â 
            width: 100%;Â 
            height: 100%;Â 
            background: rgba(0,0,0,0.8);Â 
            z-index: 600;Â 
            justify-content: center;Â 
            align-items: center;Â 
        }

        .modal-box {Â 
            background: #212121;Â 
            padding: 25px;Â 
            border-radius: 15px;Â 
            width: 90%;Â 
            max-width: 450px;Â 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        Â 
        /* --- VUES SPÃ‰CIFIQUES (PROFIL / ADMIN / STATS) --- */
        .profile-view, .stats-view {Â 
            display: none;Â 
            padding-bottom: 50px;
        }

        .admin-view {Â 
            display: none;Â 
            padding: 20px;Â 
        }
        Â 
        .stats-view h3 {
            margin-top: 25px;
            color: var(--blue);
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        Â 
        .stats-view p {
            margin: 8px 0;
            font-size: 15px;
        }


        .admin-table {Â 
            width: 100%;Â 
            border-collapse: collapse;Â 
            margin-top: 20px;Â 
        }

        .admin-table th, .admin-table td {Â 
            border: 1px solid #333;Â 
            padding: 10px;Â 
            text-align: left;Â 
        }

        .admin-table th {Â 
            background: #222;Â 
        }
        Â 
        /* --- INPUTS GÃ‰NÃ‰RAUX --- */
        input[type="text"],Â 
        input[type="password"],Â 
        input[type="email"],Â 
        textarea {Â 
            width: 100%;Â 
            padding: 12px;Â 
            margin: 10px 0;Â 
            background: #121212;Â 
            border: 1px solid #333;Â 
            color: white;Â 
            border-radius: 8px;Â 
            box-sizing: border-box;Â 
        }

        .btn-blue {Â 
            width: 100%;Â 
            padding: 12px;Â 
            background: var(--blue);Â 
            color: black;Â 
            border: none;Â 
            border-radius: 8px;Â 
            font-weight: bold;Â 
            cursor: pointer;Â 
            transition: opacity 0.2s;
        }

        .btn-blue:hover {
            opacity: 0.9;
        }

        /* --- AVATARS ET BANNIÃˆRE --- */
        .avatar-big {Â 
            width: 120px;Â 
            height: 120px;Â 
            border-radius: 50%;Â 
            border: 4px solid var(--bg);Â 
            background: #555;Â 
            object-fit: cover;Â 
            cursor: pointer;Â 
        }

        .avatar-small {Â 
            width: 36px;Â 
            height: 36px;Â 
            border-radius: 50%;Â 
            object-fit: cover;Â 
            cursor: pointer;Â 
        }

        .banner {Â 
            width: 100%;Â 
            height: 200px;Â 
            background: #333;Â 
            border-radius: 15px;Â 
            margin-bottom: -60px;Â 
            object-fit: cover;Â 
        }

        .profile-head {Â 
            display: flex;Â 
            align-items: flex-end;Â 
            gap: 20px;Â 
            padding: 0 20px;Â 
        }

        /* --- NAVIGATION MOBILE (MEDIA QUERIES) --- */
        @media(max-width: 768px) {Â 
            .sidebar {Â 
                display: none;Â 
            }Â 
            .mobile-nav {Â 
                display: flex !important;Â 
            }Â 
            .search-box {Â 
                display: none;Â 
            }
            .video-grid {Â 
                grid-template-columns: 1fr;Â 
            }Â 
            .content {
                padding: 10px;
            }
            .profile-head {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 0 10px;
            }
            .banner {
                margin-bottom: -40px;
                height: 120px;
                border-radius: 0;
            }
            .avatar-big {
                margin-top: 10px;
            }
        }
        Â 
        .mobile-nav {Â 
            display: none;Â 
            position: fixed;Â 
            bottom: 0;Â 
            left: 0;Â 
            width: 100%;Â 
            height: 60px;Â 
            background: #0f0f0f;Â 
            border-top: 1px solid #222;Â 
            justify-content: space-around;Â 
            align-items: center;Â 
            z-index: 1000;Â 
        }

        .mobile-nav-item {Â 
            display: flex;Â 
            flex-direction: column;Â 
            align-items: center;Â 
            font-size: 10px;Â 
            color: var(--sec-text);Â 
            cursor: pointer;Â 
        }

        .mobile-nav-item span {Â 
            font-size: 20px;Â 
            color: white;Â 
            margin-bottom: 2px;Â 
        }

        /* --- BARRE DE PROGRESSION UPLOAD --- */
        .progress-bar {Â 
            height: 15px;Â 
            background: #444;Â 
            border-radius: 8px;Â 
            margin-bottom: 10px;Â 
            overflow: hidden;Â 
            width: 100%;
        }

        .progress-fill {Â 
            height: 100%;Â 
            background: var(--blue);Â 
            width: 0%;Â 
            transition: width 0.1s;Â 
        }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="app.goHome()"><span>Visiona</span></div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Rechercher...">
            <button onclick="app.search()">ğŸ”</button>
        </div>
        <div class="header-btns">
            <button onclick="app.openUpload()">â•</button>
            <button id="loginBtn" class="btn-login" onclick="app.toggleAccountMenu()">ğŸ‘¤ Se connecter</button>
        </div>
    </header>

    <div id="accountMenu" style="display:none; position:absolute; right:10px; top:60px; background:#282828; padding:15px; border-radius:10px; z-index:1000; min-width: 150px;">
        <div id="menuUserName" style="font-weight:bold; margin-bottom:10px; border-bottom: 1px solid #333; padding-bottom: 10px;"></div>
        <div class="nav-item" onclick="app.goMyProfile()">ğŸ‘¤ Ma ChaÃ®ne</div>
        <div id="adminLink" class="nav-item" onclick="app.goAdminPanel()" style="display:none;">ğŸ”‘ Admin Panel</div>
        <div class="nav-item" onclick="app.doLogout()">ğŸšª DÃ©connexion</div>
    </div>


    <div class="mobile-nav">
        <div class="mobile-nav-item" onclick="app.goHome()"><span>ğŸ </span>Accueil</div>
        <div class="mobile-nav-item" onclick="app.goShorts()"><span>âš¡</span>Zapp</div>
        <div class="mobile-nav-item" onclick="app.goHistory()"><span>ğŸ•’</span>Historique</div>
        <div class="mobile-nav-item" onclick="app.goStats()"><span>ğŸ“Š</span>Stats</div>Â 
        <div class="mobile-nav-item" onclick="app.goMyProfile()"><span>ğŸ‘¤</span>Moi</div>
    </div>

    <div class="container">
        <nav class="sidebar">
            <div class="nav-item" onclick="app.goHome()">ğŸ  Accueil</div>
            <div class="nav-item" onclick="app.goShorts()">âš¡ Zapp</div>
            <div class="nav-item" onclick="app.goSubs()">ğŸ“º Suivis</div>
            <hr style="border-color: #333; margin: 10px 0;">
            <div class="nav-item" onclick="app.goHistory()">ğŸ•’ Historique</div>
            <div class="nav-item" onclick="app.goStats()">ğŸ“Š Statistiques</div>Â 
            <hr style="border-color: #333; margin: 10px 0;">
            <div class="nav-item" onclick="app.goMyProfile()">ğŸ‘¤ Ma ChaÃ®ne</div>
        </nav>

        <main class="content">
            <div id="mainTitle"></div>
            Â 
            <div id="videoGrid" class="video-grid"></div>
            <div id="shortsGrid" class="shorts-grid" style="display:none;"></div>
            Â 
            <div id="statsView" class="stats-view">
                <h2>ğŸ“Š Mes Statistiques</h2>
                <div id="statsContent" style="background:#1a1a1a; padding:20px; border-radius:10px;">
                    </div>
            </div>

            <div id="profileView" class="profile-view">
                <img class="banner" id="pBanner" src="">
                <div class="profile-head">
                    <img id="profileAvatar" src="" class="avatar-big">
                    <div>
                        <h1 id="pName" style="margin:0;">Nom</h1>
                        <p id="pStats" style="color:var(--sec-text); margin:5px 0;"></p>
                        <p id="pBio" style="color:#aaa;"></p>
                        <div id="profileActions" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <h3 style="margin-top:30px; padding: 0 20px;">VidÃ©os</h3>
                <div id="pVideos" class="video-grid" style="padding: 0 20px;"></div>
            </div>

            <div id="adminPanel" class="admin-view">
                <h2>ğŸ”‘ Panneau d'Administration</h2>
                Â 
                <h3 style="margin-top:20px;">Gestion des VidÃ©os</h3>
                <div id="adminVideoList"></div>
                Â 
                <h3 style="margin-top:30px;">Gestion des Admins</h3>
                <div id="adminList"></div>
                Â 
                <div style="margin-top:15px; display:flex; gap:10px; align-items:center;">
                    <input type="email" id="newAdminEmail" placeholder="Email du nouvel Admin">
                    <button class="action-pill btn-green" onclick="app.addAdmin()">Ajouter Admin</button>
                </div>
            </div>
        </main>
    </div>

    <div id="modalEditVideo" class="modal">
        <div class="modal-box">
            <h2>Modifier la VidÃ©o</h2>
            <input type="text" id="editVideoTitle" placeholder="Nouveau titre">
            <button class="btn-blue" onclick="app.saveAdminVideoEdit()">Sauvegarder</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="playerModal" class="player-overlay">
        <div style="padding: 15px;"><button class="action-pill" onclick="app.closePlayer()">âœ• Fermer</button></div>
        <div class="player-content">
            <div id="videoContainer" class="video-wrapper">
                <video id="mainVideoPlayer" controls autoplay></video>
                <div id="shortNav" class="short-nav" style="display:none;">
                    <button onclick="app.prevShort()">â—€ PrÃ©cÃ©dent</button>
                    <button onclick="app.nextShort()">Suivant â–¶</button>
                </div>
            </div>
            Â 
            <h2 id="playerTitle" style="margin-bottom:5px;"></h2>
            <p id="playerMeta" style="color:var(--sec-text); font-size:14px; margin-top:0;"></p>
            <div id="playerActions" style="display:flex; gap:15px; align-items:center;"></div>
            Â 
            <div class="comment-section">
                <h4 id="commentCount">Commentaires</h4>
                <div class="comment-input-area">
                    <img src="" id="userCommentAvatar" class="avatar-small">
                    <input type="text" id="newCommentInput" placeholder="Ajouter un commentaire...">
                    <button class="action-pill" onclick="app.addComment()">Publier</button>
                </div>
                <div id="commentList"></div>
            </div>
        </div>
    </div>

    <div id="modalUpload" class="modal">
        <div class="modal-box">
            <h2>Publier une vidÃ©o</h2>
            <p id="uploadStatus" style="color: var(--blue); font-size:14px; text-align:center;"></p>
            <div class="progress-bar" id="uploadProgressBar" style="display: none;"><div class="progress-fill" id="uploadProgressFill"></div></div>
            Â 
            <input type="text" id="upTitle" placeholder="Titre de la vidÃ©o">
            Â 
            <label style="color:#aaa; font-size:12px; display:block; margin-top:10px;">Fichier VidÃ©o (.mp4, .mov)</label>
            <input type="file" id="upVideoFile" accept="video/*" style="margin-bottom: 20px;">
            Â 
            <label style="color:#aaa; font-size:12px; display:block;">Miniature (Image de couverture)</label>
            <input type="file" id="upThumbFile" accept="image/*" style="margin-bottom: 20px;">
            Â 
            <button class="btn-blue" id="publishBtn" onclick="app.publish()">PUBLIER</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="modalEditProfile" class="modal">
        <div class="modal-box">
            <h2>Personnaliser ma chaÃ®ne</h2>
            <p id="profileUploadStatus" style="color: var(--blue);"></p>
            Â 
            <input type="text" id="editName" placeholder="Nom de la chaÃ®ne">
            <textarea id="editBio" placeholder="Description (Bio)"></textarea>
            Â 
            <label style="color:#aaa; font-size:12px;">Photo de Profil</label>
            <input type="file" id="editPPFile" accept="image/*">
            Â 
            <label style="color:#aaa; font-size:12px;">BanniÃ¨re</label>
            <input type="file" id="editBannerFile" accept="image/*">
            Â 
            <button class="btn-blue" onclick="app.saveProfile()">Enregistrer</button>
            <button class="action-pill" style="width:100%; margin-top:10px;" onclick="app.closeModals()">Fermer</button>
        </div>
    </div>

    <div id="modalLoginEmail" class="modal">
        <div class="modal-box">
            <h2>Connexion</h2>
            <input type="email" id="logEmail" placeholder="Email">
            <button class="btn-blue" onclick="app.loginStep(1)">Suivant</button>
        </div>
    </div>
    Â 
    <div id="modalLoginRegister" class="modal">
        <div class="modal-box">
            <h2>CrÃ©er profil</h2>
            <input type="text" id="logNewName" placeholder="Nom">
            <input type="password" id="logNewPass" placeholder="Mot de passe">
            <button class="btn-blue" onclick="app.loginStep(2)">C'est parti</button>
        </div>
    </div>
    Â 
    <div id="modalLoginPass" class="modal">
        <div class="modal-box">
            <h2>Mot de passe</h2>
            <input type="password" id="logPass" placeholder="Mot de passe">
            <button class="btn-blue" onclick="app.loginStep(3)">Entrer</button>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        // Worker proxy pour la mise Ã  jour du Gist (si vous l'utilisez)
        const WORKER_PROXY_URL = "https://mytubeupload.edonis-imbert.workers.dev/";Â 
        Â 
        // Configuration Cloudinary pour l'upload (doit Ãªtre configurÃ©)
        const CLOUDINARY_CLOUD_NAME = "dvbsmh8qq";Â 
        const CLOUDINARY_UPLOAD_PRESET = "mytube_upload";Â 
        Â 
        // URL de votre Gist brut (le fichier JSON contenant les donnÃ©es)
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0c560faad87c92/raw/video.json";Â 
        const GIST_FILE_NAME = "video.json";Â 
        Â 
        // Email de l'administrateur principal (ne peut pas Ãªtre retirÃ©)
        const PRIMARY_ADMIN_EMAIL = "edonis.imbert@gmail.com";Â 
        Â 
        // Cooldown pour les vues (1 heure en millisecondes)
        const VIEW_COOLDOWN_MS = 60 * 60 * 1000;Â 

        // RÃ©cupÃ©ration des identifiants locaux pour la connexion
        let localUserCreds = JSON.parse(localStorage.getItem('mt_user_creds')) || {};

        // DÃ©finition de l'objet principal de l'application
        const app = {
            data: {
                // DonnÃ©es utilisateur connectÃ©
                user: JSON.parse(localStorage.getItem('mt_user')),Â 
                // Liste de toutes les vidÃ©os
                videos: [],
                // Liste de tous les utilisateurs/crÃ©ateurs
                users: {},Â 
                // Liste des emails des administrateurs
                admins: [PRIMARY_ADMIN_EMAIL],Â 
                // Votes de l'utilisateur (stockÃ©s localement)
                votes: JSON.parse(localStorage.getItem('mt_votes')) || {},
                // Abonnements de l'utilisateur (stockÃ©s localement)
                subs: JSON.parse(localStorage.getItem('mt_subs')) || [],Â 
                // Historique des vidÃ©os regardÃ©es (stockÃ© localement)
                history: JSON.parse(localStorage.getItem('mt_history')) || [],Â 
                // NOUVEAU: Temps de la derniÃ¨re vue par vidÃ©o pour le cooldown (local)
                lastViewTimes: JSON.parse(localStorage.getItem('mt_last_views')) || {},
                // NOUVEAU: Statistiques locales (temps passÃ©)
                stats: JSON.parse(localStorage.getItem('mt_stats')) || {
                    timeSpentSeconds: 0,
                },
            },
            currentEditVideoId: null,
            Â 
            // NOUVEAU: Variables pour la lecture sÃ©quentielle des Shorts
            currentPlayingVideoId: null,
            currentShortsList: [],Â 
            currentShortIndex: -1,

            // --- FONCTIONS DE DÃ‰MARRAGE ET DE GESTION DES DONNÃ‰ES ---

            init: async function() {
                await this.loadData();
                this.updateAuthUI();
                this.trackSessionTime(); // DÃ©marrer le suivi du temps
                this.goHome();
            },

            loadData: async function() {
                // Charge les donnÃ©es principales depuis le Gist
                try {
                    const res = await fetch(GIST_URL + "?t=" + Date.now());Â 
                    const json = await res.json();
                    this.data.videos = json.videos || [];
                    this.data.users = json.users || {};
                    this.data.admins = json.admins || [PRIMARY_ADMIN_EMAIL];
                } catch(e) {Â 
                    console.error("Erreur lors du chargement des donnÃ©es depuis le Gist.", e);Â 
                    // Maintenir l'application fonctionnelle mÃªme en cas d'erreur de chargement
                }
            },

            saveGist: async function() {
                // Enregistre les donnÃ©es (vidÃ©os, users, admins) sur le Gist via le Worker
                if(!WORKER_PROXY_URL) return;
                const content = { videos: this.data.videos, users: this.data.users, admins: this.data.admins };
                try {
                    await fetch(WORKER_PROXY_URL, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: { [GIST_FILE_NAME]: { content: JSON.stringify(content, null, 2) } } })
                    });
                } catch(e) {
                    console.error("Erreur lors de la sauvegarde du Gist.", e);
                }
            },

            saveLocal: function() {
                // Sauvegarde les donnÃ©es utilisateur et les prÃ©fÃ©rences dans le localStorage
                localStorage.setItem('mt_user', JSON.stringify(this.data.user));
                localStorage.setItem('mt_subs', JSON.stringify(this.data.subs));
                localStorage.setItem('mt_votes', JSON.stringify(this.data.votes));
                localStorage.setItem('mt_history', JSON.stringify(this.data.history));Â 
                localStorage.setItem('mt_last_views', JSON.stringify(this.data.lastViewTimes)); // NOUVEAU: Sauvegarde du cooldown
                localStorage.setItem('mt_stats', JSON.stringify(this.data.stats)); // NOUVEAU: Sauvegarde des stats locales
            },
            Â 
            // NOUVEAU: Suivi du temps de session
            trackSessionTime: function() {
                if (!this.data.stats.timeSpentSeconds) {
                    this.data.stats.timeSpentSeconds = 0;
                }
                // IncrÃ©mente le temps passÃ© toutes les 60 secondes (1 minute)
                setInterval(() => {
                    this.data.stats.timeSpentSeconds += 60;
                    this.saveLocal();
                }, 60000);Â 
            },

            // Calcul du temps Ã©coulÃ©
            timeAgo: function(timestamp) {
                const seconds = Math.floor((Date.now() - timestamp) / 1000);
                if (seconds < 60) return "quelques secondes";
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return minutes + " minutes";
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return hours + " heures";
                const days = Math.floor(hours / 24);
                if (days < 30) return days + " jours";
                const months = Math.floor(days / 30);
                return months + " mois";
            },

            // --- FONCTIONS DE GESTION DE L'AUTHENTIFICATION ---
            Â 
            loginStep: async function(s) {
                const email = document.getElementById('logEmail').value.toLowerCase();
                if (s == 1) {Â 
                    if (!email.includes('@')) return alert("Email invalide");
                    this.closeModals();
                    if (localUserCreds[email]) {
                        document.getElementById('modalLoginPass').style.display = 'flex';
                        document.getElementById('logPass').value = '';Â 
                    } else {
                        document.getElementById('modalLoginRegister').style.display = 'flex';
                        document.getElementById('logNewName').value = '';Â 
                        document.getElementById('logNewPass').value = '';
                    }
                } else if (s == 2) {Â 
                    const name = document.getElementById('logNewName').value;
                    const pass = document.getElementById('logNewPass').value;
                    if (!name || pass.length < 4) return alert("Nom et mot de passe (min 4 caractÃ¨res) sont requis.");
                    localUserCreds[email] = { email, name, pass };
                    localStorage.setItem('mt_user_creds', JSON.stringify(localUserCreds));
                    this.data.users[name] = { name, email, bio: "Nouveau crÃ©ateur Visiona", avatar: "", banner: "", subs: [] };
                    this.data.user = localUserCreds[email];
                    this.saveLocal(); await this.saveGist(); location.reload();
                } else if (s == 3) {Â 
                    const pass = document.getElementById('logPass').value;
                    const userCreds = localUserCreds[email];
                    if (pass === userCreds.pass) {
                        this.data.user = userCreds;
                        this.saveLocal(); location.reload();
                    } else {
                        alert("Mot de passe incorrect.");
                    }
                }
            },

            doLogout: function() {
                this.data.user = null;
                this.saveLocal();
                location.reload();
            },

            updateAuthUI: function() {
                const loggedIn = !!this.data.user;
                const loginBtn = document.getElementById('loginBtn');
                const accountMenu = document.getElementById('accountMenu');
                const adminLink = document.getElementById('adminLink');

                if (loggedIn) {
                    loginBtn.innerHTML = `ğŸ‘¤ ${this.data.user.name.split(' ')[0]}`;
                    loginBtn.onclick = () => this.toggleAccountMenu();
                    document.getElementById('menuUserName').textContent = this.data.user.name;
                    document.getElementById('userCommentAvatar').src = this.getCreatorInfo(this.data.user.name).avatar || 'https://via.placeholder.com/36x36?text=Moi';

                    if (this.data.admins.includes(this.data.user.email)) {
                        adminLink.style.display = 'flex';
                    }
                } else {
                    loginBtn.innerHTML = 'ğŸ‘¤ Se connecter';
                    loginBtn.onclick = () => this.openLogin();
                    accountMenu.style.display = 'none';
                    document.getElementById('userCommentAvatar').src = 'https://via.placeholder.com/36x36?text=U';
                }
            },

            openLogin: function() {
                this.closeModals();
                document.getElementById('modalLoginEmail').style.display = 'flex';
                document.getElementById('logEmail').value = '';
            },

            toggleAccountMenu: function() {
                const menu = document.getElementById('accountMenu');
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            },

            closeModals: function() {
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                document.getElementById('accountMenu').style.display = 'none';
            },

            // --- FONCTIONS D'UPLOAD ET DE PUBLICATION ---

            openUpload: function() {
                if (!this.data.user) return this.openLogin();
                this.closeModals();
                document.getElementById('modalUpload').style.display = 'flex';
                document.getElementById('upTitle').value = '';
                document.getElementById('upVideoFile').value = '';
                document.getElementById('upThumbFile').value = '';
                document.getElementById('uploadStatus').textContent = "";
                document.getElementById('uploadProgressBar').style.display = 'none';
                document.getElementById('publishBtn').disabled = false;
            },

            updateProgress: function(elementId, progress, statusText) {
                const fill = document.getElementById(elementId);
                fill.style.width = Math.min(progress, 100) + '%';
                document.getElementById('uploadStatus').textContent = `${statusText}: ${Math.round(Math.min(progress, 100))}%`;
            },

            uploadToCloudinary: async function(file, resourceType, onProgress) {
                const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', url);
                    
                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const progress = (event.loaded / event.total) * 100;
                            onProgress(progress);
                        }
                    };

                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            resolve(response.secure_url);
                        } else {
                            reject(new Error(`Cloudinary upload failed: ${xhr.responseText}`));
                        }
                    };

                    xhr.onerror = () => reject(new Error('Erreur rÃ©seau lors de l\'upload Cloudinary.'));
                    xhr.send(formData);
                });
            },

            /**
             * CORRECTION LIGNE ~650:
             * Ajoute la logique de crÃ©ation de l'objet vidÃ©o et de sauvegarde sur le Gist.
             * Le problÃ¨me "les vidÃ©o ne se publie pas" est corrigÃ© en insÃ©rant ce bloc.
             */
            publish: async function() {
                if (!this.data.user) return alert("Vous devez Ãªtre connectÃ© pour publier.");
                const title = document.getElementById('upTitle').value.trim();
                const videoFile = document.getElementById('upVideoFile').files[0];
                const thumbFile = document.getElementById('upThumbFile').files[0];

                if (!title || !videoFile || !thumbFile) {
                    return alert("Tous les champs sont requis.");
                }

                document.getElementById('publishBtn').disabled = true;
                document.getElementById('uploadStatus').textContent = "DÃ©but de l'upload...";
                document.getElementById('uploadProgressBar').style.display = 'block';

                try {
                    // 1. Upload du Fichier VidÃ©o
                    const videoUrl = await this.uploadToCloudinary(videoFile, 'video', (progress) => {
                        this.updateProgress('uploadProgressFill', progress, "Upload VidÃ©o");
                    });

                    // 2. Upload de la Miniature
                    const thumbUrl = await this.uploadToCloudinary(thumbFile, 'image', (progress) => {
                        this.updateProgress('uploadProgressFill', 100 + progress, "Upload Miniature");
                    });
                    
                    // --- CORRECTION DU PROBLÃˆME DE PUBLICATION ---
                    const newVideo = {
                        id: 'v' + Date.now(),
                        title: title,
                        creator: this.data.user.name,
                        creatorEmail: this.data.user.email,
                        videoUrl: videoUrl,
                        thumbUrl: thumbUrl,
                        // Simplification d'une vÃ©rification plus complexe (dÃ©pend de l'API File ou des metadata)
                        isShort: (videoFile.size < 5000000), 
                        views: 0,
                        likes: 0,
                        dislikes: 0,
                        date: Date.now(),
                        comments: [],
                    };

                    this.data.videos.unshift(newVideo); // Ajout au dÃ©but
                    await this.saveGist(); // Sauvegarde des nouvelles donnÃ©es
                    // ---------------------------------------------

                    alert("VidÃ©o publiÃ©e avec succÃ¨s !");
                    this.closeModals();
                    this.goHome();
                } catch(e) {
                    console.error("Erreur de publication:", e);
                    alert("Erreur lors de la publication. Voir la console pour les dÃ©tails.");
                } finally {
                    document.getElementById('publishBtn').disabled = false;
                    document.getElementById('uploadProgressBar').style.display = 'none';
                    document.getElementById('uploadStatus').textContent = "";
                }
            },

            // --- FONCTIONS DE RENDU (UI) ---

            clearContent: function() {
                document.getElementById('videoGrid').style.display = 'grid';
                document.getElementById('shortsGrid').style.display = 'none';
                document.getElementById('videoGrid').innerHTML = '';
                document.getElementById('shortsGrid').innerHTML = '';
                document.getElementById('profileView').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('statsView').style.display = 'none';
                document.getElementById('mainTitle').textContent = '';
                document.getElementById('playerModal').style.display = 'none';
            },

            renderVideoCard: function(video) {
                const user = this.data.users[video.creator] || { avatar: '', name: video.creator };
                
                return `
                    <div class="video-card" onclick="app.openPlayer('${video.id}')">
                        <div class="thumb-container">
                            <img class="thumb" src="${video.thumbUrl}" alt="Thumbnail">
                        </div>
                        <div style="display:flex; margin-top:10px; gap:8px; align-items:flex-start;">
                            <img src="${user.avatar || 'https://via.placeholder.com/36x36?text=U'}" 
                                 class="avatar-small" 
                                 onclick="event.stopPropagation(); app.goProfile('${video.creator}')">
                            <div style="flex:1;">
                                <div style="font-weight:bold; font-size:16px; line-height:1.4; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${video.title}</div>
                                <p style="color:var(--sec-text); font-size:14px; margin:3px 0; cursor:pointer;"
                                   onclick="event.stopPropagation(); app.goProfile('${video.creator}')">${user.name}</p>
                                <p style="color:var(--sec-text); font-size:13px; margin:0;">${video.views} vues â€¢ il y a ${this.timeAgo(video.date)}</p>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            renderShortCard: function(video) {
                return `
                    <div class="short-card" onclick="app.openPlayer('${video.id}', true)">
                        <img src="${video.thumbUrl}" alt="Short Thumbnail">
                        <div style="position:absolute; bottom:10px; left:10px; right:10px; color:white; font-weight:bold;">
                            ${video.title}
                        </div>
                    </div>
                `;
            },
            
            // --- FONCTIONS D'AFFICHAGE DES VUES ---

            goHome: function() {
                this.clearContent();
                document.getElementById('mainTitle').textContent = 'VidÃ©os RecommandÃ©es';
                
                // MÃ©langer les vidÃ©os pour une meilleure expÃ©rience 'Accueil'
                const allVideos = [...this.data.videos].sort(() => Math.random() - 0.5); 
                
                const shorts = allVideos.filter(v => v.isShort);
                const videos = allVideos.filter(v => !v.isShort);
                
                document.getElementById('videoGrid').innerHTML = videos.map(v => this.renderVideoCard(v)).join('');
                
                if (shorts.length > 0) {
                    document.getElementById('shortsGrid').style.display = 'flex';
                    document.getElementById('shortsGrid').innerHTML = shorts.map(v => this.renderShortCard(v)).join('');
                    document.getElementById('mainTitle').insertAdjacentHTML('afterend', '<h2 style="margin-top:20px; font-size: 20px;">âš¡ Zapp (Shorts)</h2>');
                }
            },

            goSubs: function() {
                if (!this.data.user) return this.openLogin();
                this.clearContent();
                document.getElementById('mainTitle').textContent = 'VidÃ©os de vos Abonnements';
                
                const subscribedUsers = this.data.subs;
                if (subscribedUsers.length === 0) {
                    document.getElementById('videoGrid').innerHTML = '<p style="color:#aaa;">Vous n\'Ãªtes abonnÃ© Ã  aucune chaÃ®ne. Visitez la page d\'accueil pour dÃ©couvrir des crÃ©ateurs !</p>';
                    return;
                }
                
                const subVideos = this.data.videos
                    .filter(v => subscribedUsers.includes(v.creator))
                    .sort((a, b) => b.date - a.date);
                    
                if (subVideos.length === 0) {
                    document.getElementById('videoGrid').innerHTML = '<p style="color:#aaa;">Aucune nouvelle vidÃ©o de vos abonnements.</p>';
                    return;
                }
                    
                document.getElementById('videoGrid').innerHTML = subVideos.map(v => this.renderVideoCard(v)).join('');
            },

            goHistory: function() {
                if (!this.data.user) return this.openLogin();
                this.clearContent();
                document.getElementById('mainTitle').textContent = 'Historique des VidÃ©os';
                
                if (this.data.history.length === 0) {
                    document.getElementById('videoGrid').innerHTML = '<p style="color:#aaa;">Votre historique est vide.</p>';
                    return;
                }
                
                const historyVideos = this.data.history
                    .map(id => this.data.videos.find(v => v.id === id))
                    .filter(v => v !== undefined)
                    .reverse(); // Afficher les plus rÃ©cents en premier
                    
                document.getElementById('videoGrid').innerHTML = historyVideos.map(v => this.renderVideoCard(v)).join('');
            },

            goStats: function() {
                this.clearContent();
                document.getElementById('statsView').style.display = 'block';
                const statsContent = document.getElementById('statsContent');
                
                const totalViews = this.data.videos.reduce((sum, v) => sum + v.views, 0);
                const totalLikes = this.data.videos.reduce((sum, v) => sum + v.likes, 0);
                const totalComments = this.data.videos.reduce((sum, v) => sum + v.comments.length, 0);
                
                const mins = Math.floor(this.data.stats.timeSpentSeconds / 60);
                const hrs = Math.floor(mins / 60);
                const displayMins = mins % 60;
                
                let myStats = '';
                if (this.data.user) {
                    const myVideos = this.data.videos.filter(v => v.creator === this.data.user.name);
                    const myViews = myVideos.reduce((sum, v) => sum + v.views, 0);
                    const myLikes = myVideos.reduce((sum, v) => sum + v.likes, 0);
                    const mySubs = this.data.users[this.data.user.name]?.subs.length || 0;
                    
                    myStats = `
                        <h3>Vos Statistiques de CrÃ©ateur</h3>
                        <p>Total de Vues sur vos vidÃ©os : <strong>${myViews}</strong></p>
                        <p>Total de Likes sur vos vidÃ©os : <strong>${myLikes}</strong></p>
                        <p>Nombre d'AbonnÃ©s : <strong>${mySubs}</strong></p>
                    `;
                }

                statsContent.innerHTML = `
                    <h3>Statistiques Globales de la Plateforme</h3>
                    <p>Nombre total de vidÃ©os : <strong>${this.data.videos.length}</strong></p>
                    <p>Total des vues sur toutes les vidÃ©os : <strong>${totalViews}</strong></p>
                    <p>Total des J'aime (Likes) : <strong>${totalLikes}</strong></p>
                    <p>Total des Commentaires : <strong>${totalComments}</strong></p>
                    
                    <h3>Votre ActivitÃ©</h3>
                    <p>Temps passÃ© sur Visiona : <strong>${hrs}h ${displayMins}m</strong></p>
                    
                    ${myStats}
                `;
            },

            goShorts: function() {
                this.clearContent();
                document.getElementById('videoGrid').style.display = 'none';
                document.getElementById('shortsGrid').style.display = 'flex';
                document.getElementById('mainTitle').textContent = 'âš¡ Zapp (Shorts)';
                
                this.currentShortsList = this.data.videos.filter(v => v.isShort);
                this.currentShortsList.sort(() => Math.random() - 0.5); // Randomiser

                if (this.currentShortsList.length === 0) {
                    document.getElementById('shortsGrid').innerHTML = '<p style="color:#aaa;">Aucun Short disponible.</p>';
                    return;
                }
                
                // Afficher uniquement les miniatures au lieu de lancer le player directement
                document.getElementById('shortsGrid').innerHTML = this.currentShortsList.map(v => this.renderShortCard(v)).join('');
            },

            // Ouvre le lecteur modal pour une vidÃ©o ou un short
            openPlayer: function(videoId, isShortsList = false) {
                this.closeModals();
                const video = this.data.videos.find(v => v.id === videoId);
                if (!video) return;

                const playerModal = document.getElementById('playerModal');
                const videoPlayer = document.getElementById('mainVideoPlayer');
                const videoContainer = document.getElementById('videoContainer');
                const shortNav = document.getElementById('shortNav');

                // Configuration pour Short ou VidÃ©o longue
                if (isShortsList) {
                    videoContainer.className = 'short-player-wrapper';
                    shortNav.style.display = 'flex';
                    this.currentShortIndex = this.currentShortsList.findIndex(v => v.id === videoId);
                } else {
                    videoContainer.className = 'video-wrapper';
                    shortNav.style.display = 'none';
                    this.currentShortsList = []; // RÃ©initialiser la liste des shorts
                    this.currentShortIndex = -1;
                }

                videoPlayer.src = video.videoUrl;
                playerModal.style.display = 'block';
                this.currentPlayingVideoId = video.id;

                const creator = this.getCreatorInfo(video.creator);
                
                // Met Ã  jour les informations de la vidÃ©o
                document.getElementById('playerTitle').textContent = video.title;
                
                /**
                 * CORRECTION LIGNE ~720 (suite) pour l'affichage dans le lecteur:
                 * Ajout de l'onClick sur l'avatar et le nom du crÃ©ateur.
                 */
                document.getElementById('playerMeta').innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${creator.avatar || 'https://via.placeholder.com/36x36?text=U'}" 
                             class="avatar-small" 
                             onclick="app.closePlayer(); app.goProfile('${video.creator}')">
                        <span style="font-weight:bold; cursor:pointer;"
                              onclick="app.closePlayer(); app.goProfile('${video.creator}')">${creator.name}</span>
                        <span style="color:var(--sec-text); font-size:14px;">â€¢ ${video.views} vues â€¢ PubliÃ© il y a ${this.timeAgo(video.date)}</span>
                    </div>
                `;

                this.renderPlayerActions(video);
                this.renderComments(video);
                this.registerView(video);
                
                // DÃ©filement automatique au player sur mobile
                if(window.innerWidth <= 768) {
                    playerModal.scrollTo(0, 0);
                }
            },
            
            closePlayer: function() {
                document.getElementById('mainVideoPlayer').pause();
                document.getElementById('playerModal').style.display = 'none';
                this.currentPlayingVideoId = null;
            },

            prevShort: function() {
                if (this.currentShortsList.length === 0 || this.currentShortIndex <= 0) return;
                this.currentShortIndex--;
                this.openPlayer(this.currentShortsList[this.currentShortIndex].id, true);
            },

            nextShort: function() {
                if (this.currentShortsList.length === 0 || this.currentShortIndex >= this.currentShortsList.length - 1) return;
                this.currentShortIndex++;
                this.openPlayer(this.currentShortsList[this.currentShortIndex].id, true);
            },
            
            // --- FONCTIONS DE PROFIL ---

            getCreatorInfo: function(creatorName) {
                return this.data.users[creatorName] || { name: creatorName, email: '', bio: 'ChaÃ®ne inconnue', avatar: 'https://via.placeholder.com/36x36?text=U', banner: '' };
            },

            goMyProfile: function() {
                if (!this.data.user) return this.openLogin();
                this.goProfile(this.data.user.name, true);
            },

            goProfile: function(creatorName, isMyProfile = false) {
                this.clearContent();
                document.getElementById('profileView').style.display = 'block';

                const creator = this.getCreatorInfo(creatorName);
                const videos = this.data.videos.filter(v => v.creator === creatorName).sort((a, b) => b.date - a.date);
                const followers = creator.subs.length;
                
                // Rendu des informations de base
                document.getElementById('pBanner').src = creator.banner || 'https://via.placeholder.com/1200x200?text=BanniÃ¨re';
                document.getElementById('profileAvatar').src = creator.avatar || 'https://via.placeholder.com/120x120?text=U';
                document.getElementById('pName').textContent = creator.name;
                document.getElementById('pStats').textContent = `${followers} abonnÃ©s â€¢ ${videos.length} vidÃ©os`;
                document.getElementById('pBio').textContent = creator.bio || 'Aucune description.';
                
                // Rendu des actions (S'abonner ou Modifier)
                const actionsDiv = document.getElementById('profileActions');
                actionsDiv.innerHTML = '';
                
                if (isMyProfile) {
                    actionsDiv.innerHTML = `<button class="action-pill btn-blue" onclick="app.openEditProfile()">Personnaliser la chaÃ®ne</button>`;
                } else if (this.data.user) {
                    const isSubscribed = this.data.subs.includes(creatorName);
                    const subClass = isSubscribed ? 'followed' : 'btn-red';
                    const subText = isSubscribed ? 'âœ… AbonnÃ©' : 'ğŸ”´ S\'abonner';
                    actionsDiv.innerHTML = `<button class="action-pill ${subClass}" onclick="app.toggleSubscription('${creatorName}')">${subText}</button>`;
                }
                
                // Rendu des vidÃ©os
                document.getElementById('pVideos').innerHTML = videos.map(v => this.renderVideoCard(v)).join('');
                
                // Mise Ã  jour de l'URL pour un lien direct (si vous utilisez le routing URL)
                // window.history.pushState(null, '', `?view=profile&user=${creatorName}`);
            },

            openEditProfile: function() {
                if (!this.data.user) return this.openLogin();
                this.closeModals();
                document.getElementById('modalEditProfile').style.display = 'flex';
                
                const creator = this.getCreatorInfo(this.data.user.name);
                document.getElementById('editName').value = creator.name;
                document.getElementById('editBio').value = creator.bio || '';
                document.getElementById('editPPFile').value = '';
                document.getElementById('editBannerFile').value = '';
                document.getElementById('profileUploadStatus').textContent = '';
            },

            saveProfile: async function() {
                if (!this.data.user) return;
                
                const newName = document.getElementById('editName').value.trim();
                const newBio = document.getElementById('editBio').value.trim();
                const ppFile = document.getElementById('editPPFile').files[0];
                const bannerFile = document.getElementById('editBannerFile').files[0];
                
                const creatorName = this.data.user.name;
                let creator = this.data.users[creatorName];
                let uploadedCount = 0;
                
                document.getElementById('profileUploadStatus').textContent = "Sauvegarde en cours...";
                
                try {
                    // 1. Mise Ã  jour de l'Avatar (PDP)
                    if (ppFile) {
                        const ppUrl = await this.uploadToCloudinary(ppFile, 'image', (p) => document.getElementById('profileUploadStatus').textContent = `Upload Photo Profil: ${Math.round(p)}%`);
                        creator.avatar = ppUrl;
                        uploadedCount++;
                    }

                    // 2. Mise Ã  jour de la BanniÃ¨re
                    if (bannerFile) {
                        const bannerUrl = await this.uploadToCloudinary(bannerFile, 'image', (p) => document.getElementById('profileUploadStatus').textContent = `Upload BanniÃ¨re: ${Math.round(p)}%`);
                        creator.banner = bannerUrl;
                        uploadedCount++;
                    }
                    
                    // 3. Mise Ã  jour du nom et de la bio (gestion du changement de nom plus complexe, ici on se concentre sur la bio)
                    creator.bio = newBio;
                    
                    // Si le nom change (trÃ¨s complexe Ã  gÃ©rer dans cette architecture), on alerte
                    if (newName !== creator.name) {
                        alert("Le changement de nom de chaÃ®ne n'est pas supportÃ© dans cette version simplifiÃ©e.");
                    }

                    this.data.users[creatorName] = creator;
                    
                    await this.saveGist();
                    
                    alert("Profil mis Ã  jour !");
                    this.closeModals();
                    this.goMyProfile();
                } catch(e) {
                    console.error("Erreur de sauvegarde de profil:", e);
                    document.getElementById('profileUploadStatus').textContent = "Erreur de sauvegarde.";
                }
            },
            
            // --- FONCTIONS D'INTERACTION UTILISATEUR (LIKE/SUB) ---

            toggleLike: async function(videoId) {
                if (!this.data.user) return this.openLogin();
                
                const video = this.data.videos.find(v => v.id === videoId);
                let vote = this.data.votes[videoId];
                
                if (vote === 'like') {
                    video.likes--;
                    delete this.data.votes[videoId];
                } else if (vote === 'dislike') {
                    video.dislikes--;
                    video.likes++;
                    this.data.votes[videoId] = 'like';
                } else {
                    video.likes++;
                    this.data.votes[videoId] = 'like';
                }
                
                this.saveLocal();
                await this.saveGist();
                this.renderPlayerActions(video);
            },
            
            toggleDislike: async function(videoId) {
                if (!this.data.user) return this.openLogin();
                
                const video = this.data.videos.find(v => v.id === videoId);
                let vote = this.data.votes[videoId];
                
                if (vote === 'dislike') {
                    video.dislikes--;
                    delete this.data.votes[videoId];
                } else if (vote === 'like') {
                    video.likes--;
                    video.dislikes++;
                    this.data.votes[videoId] = 'dislike';
                } else {
                    video.dislikes++;
                    this.data.votes[videoId] = 'dislike';
                }
                
                this.saveLocal();
                await this.saveGist();
                this.renderPlayerActions(video);
            },
            
            renderPlayerActions: function(video) {
                const actionsDiv = document.getElementById('playerActions');
                const vote = this.data.votes[video.id];
                
                const likeClass = vote === 'like' ? 'liked' : '';
                const dislikeClass = vote === 'dislike' ? 'disliked' : '';
                
                actionsDiv.innerHTML = `
                    <button class="action-pill ${likeClass}" onclick="app.toggleLike('${video.id}')">ğŸ‘ ${video.likes}</button>
                    <button class="action-pill ${dislikeClass}" onclick="app.toggleDislike('${video.id}')">ğŸ‘ ${video.dislikes}</button>
                    <button class="action-pill" onclick="alert('FonctionnalitÃ© de partage non implÃ©mentÃ©e.')">ğŸ”— Partager</button>
                    <button class="action-pill" onclick="alert('FonctionnalitÃ© de tÃ©lÃ©chargement non implÃ©mentÃ©e.')">â¬‡ï¸ TÃ©lÃ©charger</button>
                `;
            },
            
            toggleSubscription: async function(creatorName) {
                if (!this.data.user) return this.openLogin();
                
                const user = this.data.users[creatorName];
                if (!user) return;
                
                const index = this.data.subs.indexOf(creatorName);
                const isSubscribed = index !== -1;
                
                if (isSubscribed) {
                    this.data.subs.splice(index, 1);
                    user.subs = user.subs.filter(s => s !== this.data.user.name);
                } else {
                    this.data.subs.push(creatorName);
                    if (!user.subs.includes(this.data.user.name)) {
                        user.subs.push(this.data.user.name);
                    }
                }
                
                this.saveLocal();
                await this.saveGist();
                this.goProfile(creatorName);
            },
            
            // --- FONCTIONS DE VUES ET COMMENTAIRES ---
            
            registerView: async function(video) {
                const videoId = video.id;
                const now = Date.now();
                const lastView = this.data.lastViewTimes[videoId] || 0;

                // Applique le cooldown d'une heure pour compter une vue
                if (now - lastView > VIEW_COOLDOWN_MS) {
                    video.views++;
                    this.data.lastViewTimes[videoId] = now;
                    this.saveLocal();
                    await this.saveGist();
                    
                    // Mettre Ã  jour l'historique seulement si une vue a Ã©tÃ© comptÃ©e
                    if (this.data.user) {
                        const history = this.data.history.filter(id => id !== videoId);
                        history.push(videoId);
                        this.data.history = history.slice(-50); // Limiter Ã  50 vidÃ©os
                        this.saveLocal();
                    }
                }
            },
            
            addComment: async function() {
                if (!this.data.user) return this.openLogin();
                
                const input = document.getElementById('newCommentInput');
                const text = input.value.trim();
                const videoId = this.currentPlayingVideoId;
                
                if (!text || !videoId) return;
                
                const video = this.data.videos.find(v => v.id === videoId);
                if (!video) return;
                
                const newComment = {
                    id: 'c' + Date.now(),
                    creator: this.data.user.name,
                    text: text,
                    date: Date.now(),
                };
                
                video.comments.unshift(newComment);
                input.value = '';
                
                await this.saveGist();
                this.renderComments(video);
            },
            
            renderComments: function(video) {
                const list = document.getElementById('commentList');
                const count = document.getElementById('commentCount');
                
                count.textContent = `${video.comments.length} Commentaires`;
                
                if (video.comments.length === 0) {
                    list.innerHTML = '<p style="color:#aaa; text-align:center;">Soyez le premier Ã  commenter !</p>';
                    return;
                }
                
                list.innerHTML = video.comments.map(c => {
                    const creator = this.getCreatorInfo(c.creator);
                    return `
                        <div style="display:flex; gap:10px; margin-bottom:20px;">
                            <img src="${creator.avatar || 'https://via.placeholder.com/36x36?text=U'}" 
                                 class="avatar-small" 
                                 onclick="app.closePlayer(); app.goProfile('${c.creator}')">
                            <div style="flex:1;">
                                <div style="font-size:13px; color:var(--sec-text);">
                                    <span style="font-weight:bold; color:var(--text); cursor:pointer;" onclick="app.closePlayer(); app.goProfile('${c.creator}')">${c.creator}</span> 
                                    â€¢ il y a ${this.timeAgo(c.date)}
                                </div>
                                <p style="margin:5px 0 0 0;">${c.text}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // --- FONCTIONS DE RECHERCHE ---

            search: function() {
                const query = document.getElementById('searchInput').value.trim().toLowerCase();
                if (!query) {
                    return this.goHome();
                }
                
                this.clearContent();
                document.getElementById('mainTitle').textContent = `RÃ©sultats pour "${query}"`;

                const results = this.data.videos.filter(v => 
                    v.title.toLowerCase().includes(query) || 
                    v.creator.toLowerCase().includes(query)
                ).sort((a, b) => b.views - a.views); // Triage par pertinence (vues)
                
                if (results.length === 0) {
                    document.getElementById('videoGrid').innerHTML = `<p style="color:#aaa;">Aucun rÃ©sultat trouvÃ© pour "${query}".</p>`;
                } else {
                    document.getElementById('videoGrid').innerHTML = results.map(v => this.renderVideoCard(v)).join('');
                }
            },
            
            // --- FONCTIONS ADMIN ---

            goAdminPanel: function() {
                if (!this.data.user || !this.data.admins.includes(this.data.user.email)) {
                    return alert("AccÃ¨s refusÃ©. Vous n'Ãªtes pas administrateur.");
                }
                
                this.clearContent();
                document.getElementById('adminPanel').style.display = 'block';
                this.renderAdminVideoList();
                this.renderAdminList();
            },

            renderAdminVideoList: function() {
                const listDiv = document.getElementById('adminVideoList');
                const videosHtml = this.data.videos.sort((a, b) => b.date - a.date).map(v => `
                    <tr id="adminVideoRow-${v.id}">
                        <td>${v.title}</td>
                        <td>${v.creator}</td>
                        <td>${v.views}</td>
                        <td>
                            <button class="action-pill" onclick="app.openAdminEditVideo('${v.id}', '${v.title}')">Modifier</button>
                            <button class="action-pill btn-red" onclick="app.deleteVideo('${v.id}')">Supprimer</button>
                        </td>
                    </tr>
                `).join('');
                
                listDiv.innerHTML = `
                    <table class="admin-table">
                        <thead>
                            <tr><th>Titre</th><th>CrÃ©ateur</th><th>Vues</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${videosHtml}
                        </tbody>
                    </table>
                `;
            },
            
            openAdminEditVideo: function(videoId, title) {
                this.currentEditVideoId = videoId;
                document.getElementById('editVideoTitle').value = title;
                document.getElementById('modalEditVideo').style.display = 'flex';
            },

            saveAdminVideoEdit: async function() {
                const videoId = this.currentEditVideoId;
                const newTitle = document.getElementById('editVideoTitle').value.trim();
                
                if (!videoId || !newTitle) return;

                const video = this.data.videos.find(v => v.id === videoId);
                if (video) {
                    video.title = newTitle;
                    await this.saveGist();
                    this.closeModals();
                    this.renderAdminVideoList();
                }
            },

            deleteVideo: async function(videoId) {
                if (!confirm("ÃŠtes-vous sÃ»r de vouloir supprimer cette vidÃ©o ?")) return;
                
                this.data.videos = this.data.videos.filter(v => v.id !== videoId);
                await this.saveGist();
                this.renderAdminVideoList();
            },

            renderAdminList: function() {
                const listDiv = document.getElementById('adminList');
                listDiv.innerHTML = `
                    <table class="admin-table">
                        <thead>
                            <tr><th>Email</th><th>Actions</th></tr>
                        </thead>
                        <tbody>${this.data.admins.map(email => `
                            <tr>
                                <td>${email} ${email === PRIMARY_ADMIN_EMAIL ? '(Principal)' : ''}</td>
                                <td>
                                    ${email === PRIMARY_ADMIN_EMAIL ? 
                                        '<button class="action-pill" disabled>Admin Principal</button>' : 
                                        `<button class="action-pill btn-red" onclick="app.removeAdmin('${email}')">Retirer</button>`
                                    }
                                </td>
                            </tr>
                        `).join('')}</tbody>
                    </table>
                `;
            },
            addAdmin: async function() {
                if (this.data.user.email !== PRIMARY_ADMIN_EMAIL) return alert("Seul l'Admin Principal peut ajouter des admins.");
                const newEmail = document.getElementById('newAdminEmail').value.trim();
                if (newEmail && !this.data.admins.includes(newEmail)) {
                    this.data.admins.push(newEmail);
                    document.getElementById('newAdminEmail').value = '';
                    await this.saveGist();
                    alert(`Admin ${newEmail} ajoutÃ© !`);
                    this.renderAdminList();
                    // CORRECTION: Met Ã  jour l'interface pour afficher le lien admin immÃ©diatement
                    this.updateAuthUI(); 
                } else { alert("Email invalide ou dÃ©jÃ  admin."); }
            },
            removeAdmin: async function(email) {
                if (this.data.user.email !== PRIMARY_ADMIN_EMAIL) return alert("Seul l'Admin Principal peut retirer des admins.");
                if (email === PRIMARY_ADMIN_EMAIL) return alert("Impossible de retirer l'Admin Principal.");
                this.data.admins = this.data.admins.filter(e => e !== email);
                await this.saveGist();
                alert(`Admin ${email} retirÃ©.`);
                this.renderAdminList();
            },
        };

        app.init();
    </script>
</body>
</html>
