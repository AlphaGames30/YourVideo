<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visiona Titan - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f0f; --header: #0f0f0f; --text: #fff; --sec-text: #aaa;
            --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --green: #00a854; --gold: #ffc107;
            --sidebar-width: 240px;
        }
        
        /* TH√àME NO√ãL (Activ√© par JS) */
        body.christmas-mode {
            --bg: #0b1a0e; --header: #1a0b0b; --blue: #00ff00; --red: #ff0000;
            background-image: url('https://www.transparenttextures.com/patterns/snow.png');
        }
        
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; overflow-x: hidden; }
        
        /* HEADER */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 56px; background: var(--header);
            display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
            z-index: 2000; border-bottom: 1px solid #222;
        }
        .logo-area { display: flex; align-items: center; gap: 20px; cursor: pointer; user-select: none; }
        .search-bar { display: flex; flex: 1; max-width: 600px; margin: 0 20px; }
        .search-bar input { width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 10px; border-radius: 40px 0 0 40px; }
        .search-bar button { background: #222; border: 1px solid #333; color: white; padding: 0 20px; border-radius: 0 40px 40px 0; cursor: pointer; }
        
        /* SIDEBAR */
        .sidebar {
            position: fixed; top: 56px; bottom: 0; left: 0; width: var(--sidebar-width);
            background: var(--bg); overflow-y: auto; padding: 10px; z-index: 1000;
        }
        .nav-item { display: flex; align-items: center; gap: 20px; padding: 10px 20px; cursor: pointer; border-radius: 10px; }
        .nav-item:hover, .nav-item.active { background: var(--hover); }
        
        /* MAIN */
        .main { margin-left: var(--sidebar-width); margin-top: 56px; padding: 24px; min-height: 100vh; }
        
        /* GRID VIDEOS */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { cursor: pointer; transition: 0.2s; }
        .card:hover { transform: scale(1.02); }
        .thumb { position: relative; width: 100%; aspect-ratio: 16/9; background: #222; border-radius: 12px; overflow: hidden; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .duration { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.8); padding: 2px 5px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .live-badge { position: absolute; top: 5px; left: 5px; background: var(--red); padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        
        /* ZAPP (Shorts) */
        .zapp-container { display: none; height: calc(100vh - 60px); overflow-y: scroll; scroll-snap-type: y mandatory; max-width: 450px; margin: 0 auto; }
        .zapp-item { height: 100%; scroll-snap-align: start; position: relative; background: #000; display: flex; justify-content: center; border-radius: 15px; margin-bottom: 20px; overflow: hidden; }
        .zapp-video { height: 100%; width: 100%; object-fit: cover; }
        .zapp-ui { position: absolute; right: 10px; bottom: 80px; display: flex; flex-direction: column; gap: 20px; align-items: center; text-shadow: 1px 1px 2px black; }
        
        /* PROFIL */
        .banner { width: 100%; height: 200px; background-size: cover; background-position: center; border-radius: 15px; background-color: #333; }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-top: -40px; padding: 0 20px; position: relative; }
        .pp-big { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--bg); object-fit: cover; background: #333; }
        .tabs { display: flex; border-bottom: 1px solid #333; margin: 20px 0; }
        .tab { padding: 15px 30px; cursor: pointer; font-weight: bold; color: var(--sec-text); border-bottom: 3px solid transparent; }
        .tab.active { color: var(--text); border-color: var(--text); }
        
        /* POSTS COMMUNAUT√â */
        .post-card { background: #1a1a1a; border: 1px solid #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; max-width: 800px; }
        
        /* PLAYER OVERLAY */
        #player-overlay { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 3000; overflow-y: auto; padding: 20px; }
        .player-grid { display: grid; grid-template-columns: 1fr 350px; gap: 24px; max-width: 1400px; margin: 0 auto; }
        
        /* MODALES */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
        .modal-content { background: #212121; padding: 30px; border-radius: 15px; width: 500px; max-width: 90%; }
        input, textarea, select { width: 100%; background: #111; border: 1px solid #333; color: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; box-sizing: border-box; }
        
        /* UTILITAIRES */
        .btn { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .btn-blue { background: var(--blue); color: black; }
        .btn-red { background: var(--red); color: white; }
        .btn-gray { background: #333; color: white; }
        .avatar-circle { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; object-fit: cover; }
    </style>
</head>
<body>

<header>
    <div class="logo-area" onclick="app.egg.click()">
        <span style="color: var(--red); font-size: 24px;">‚ñ∂</span>
        <h2 style="margin:0; letter-spacing: -1px;">Visiona<span style="font-weight:300;">Titan</span></h2>
    </div>
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Rechercher...">
        <button onclick="app.search()">üîç</button>
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
        <button onclick="app.openModal('modal-upload')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;" title="Cr√©er">üìπ</button>
        <div id="user-area" style="cursor:pointer;" onclick="app.toggleMenu()">
            <div id="header-pp" class="avatar-circle" style="background:#333;">?</div>
        </div>
    </div>
</header>

<div id="user-menu" style="display:none; position:fixed; right:10px; top:60px; background:#282828; width:250px; border-radius:10px; padding:10px; z-index:4000; box-shadow: 0 5px 20px rgba(0,0,0,0.5);">
    <div id="menu-header" style="padding-bottom:10px; border-bottom:1px solid #444; margin-bottom:10px; display:flex; align-items:center; gap:10px;">
        <div id="menu-pp" class="avatar-circle" style="width:40px; height:40px;"></div>
        <b id="menu-name">Pseudo</b>
    </div>
    <div class="nav-item" onclick="app.router('profile')">üë§ Ma Cha√Æne</div>
    <div class="nav-item" onclick="app.router('stats')">üìä Statistiques</div>
    <div id="admin-link" class="nav-item" style="display:none; color:var(--gold);" onclick="app.router('admin')">üõ°Ô∏è Admin Panel</div>
    <div class="nav-item" onclick="app.auth.logout()" style="color:var(--red);">üö™ D√©connexion</div>
</div>

<nav class="sidebar">
    <div class="nav-item" onclick="app.router('home')">üè† Accueil</div>
    <div class="nav-item" onclick="app.router('zapp')">‚ö° Zapps</div>
    <div class="nav-item" onclick="app.router('subs')">üì∫ Abonnements</div>
    <hr>
    <div class="nav-item" onclick="app.router('history')">üïí Historique</div>
    <div class="nav-item" onclick="app.router('community')">üìù Communaut√©</div>
    <div class="nav-item" onclick="app.router('thanks')">üíé Remerciements</div>
    <hr>
    <div id="subs-sidebar-list"></div>
</nav>

<main class="main">
    <div id="view-home" class="page"><div class="grid" id="home-grid"></div></div>
    <div id="view-zapp" class="page zapp-container"></div>
    <div id="view-subs" class="page"><div class="grid" id="subs-grid"></div></div>
    <div id="view-history" class="page"><div class="grid" id="history-grid"></div></div>
    <div id="view-community" class="page"></div>
    <div id="view-thanks" class="page"></div>
    <div id="view-admin" class="page"></div>
    
    <div id="view-profile" class="page" style="display:none;">
        <div id="p-banner" class="banner"></div>
        <div class="profile-header">
            <div id="p-pp" class="pp-big avatar-circle" style="font-size:40px;"></div>
            <div>
                <h1 id="p-name" style="margin:0;">Nom</h1>
                <p id="p-sub-count" style="color:#aaa;">0 abonn√©s</p>
                <p id="p-desc" style="font-size:14px; margin-top:5px;"></p>
            </div>
            <div style="margin-left:auto; display:flex; gap:10px;">
                <button id="p-edit-btn" class="btn btn-gray" style="display:none;" onclick="app.openModal('modal-custom')">Personnaliser</button>
                <button id="p-sub-btn" class="btn btn-red" onclick="app.social.toggleSub()">S'ABONNER</button>
            </div>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="app.profile.switchTab('videos')">VID√âOS</div>
            <div class="tab" onclick="app.profile.switchTab('zapps')">ZAPPS</div>
            <div class="tab" onclick="app.profile.switchTab('posts')">POSTS</div>
            <div class="tab" onclick="app.profile.switchTab('about')">√Ä PROPOS</div>
        </div>
        <div id="p-content"></div>
    </div>
</main>
<div id="player-overlay">
    <div class="player-grid">
        <div>
            <div style="width:100%; aspect-ratio:16/9; background:black; border-radius:12px; overflow:hidden;">
                <video id="main-video" controls autoplay style="width:100%; height:100%;"></video>
            </div>
            <h2 id="vid-title" style="margin:15px 0 5px;">Titre</h2>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="app.router('profile', app.player.active.author)">
                    <div id="vid-author-pp" class="avatar-circle"></div>
                    <div>
                        <b id="vid-author-name">Auteur</b>
                        <div id="vid-author-subs" style="font-size:12px; color:#aaa;"></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-gray" onclick="app.social.likeVid()">üëç <span id="vid-likes">0</span></button>
                    <button class="btn btn-gray" onclick="app.social.dislikeVid()">üëé <span id="vid-dislikes">0</span></button>
                </div>
            </div>
            <div style="background:#222; padding:15px; border-radius:10px; margin-top:15px;">
                <b id="vid-meta">0 vues ‚Ä¢ Il y a 0 min</b>
                <p id="vid-desc" style="white-space:pre-wrap; margin-top:10px;"></p>
            </div>
            
            <div style="margin-top:20px;">
                <h3>Commentaires</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <div id="my-com-pp" class="avatar-circle" style="width:30px; height:30px;"></div>
                    <input id="com-input" placeholder="Ajouter un commentaire...">
                    <button class="btn btn-blue" onclick="app.social.postComment()">Envoyer</button>
                </div>
                <div id="com-list"></div>
            </div>
        </div>
        <div>
            <button class="btn btn-gray" style="margin-bottom:20px;" onclick="document.getElementById('player-overlay').style.display='none'; document.getElementById('main-video').pause();">Fermer</button>
            <div id="reco-list"></div>
        </div>
    </div>
</div>

<div id="modal-upload" class="modal">
    <div class="modal-content">
        <h2>Cr√©er</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn btn-blue" style="flex:1" onclick="document.getElementById('upload-form').style.display='block'; document.getElementById('live-form').style.display='none'">Importer Vid√©o</button>
            <button class="btn btn-red" style="flex:1" onclick="document.getElementById('upload-form').style.display='none'; document.getElementById('live-form').style.display='block'">Lancer Direct</button>
        </div>
        
        <div id="upload-form">
            <input id="up-title" placeholder="Titre">
            <textarea id="up-desc" placeholder="Description"></textarea>
            <label>Vid√©o: <input type="file" id="up-file" accept="video/*"></label>
            <label>Miniature: <input type="file" id="up-thumb" accept="image/*"></label>
            <label><input type="checkbox" id="up-zapp"> Est un Zapp (Short)</label>
            <button class="btn btn-blue" onclick="app.upload.processFile()">Mettre en ligne</button>
        </div>
        
        <div id="live-form" style="display:none;">
            <input id="live-title" placeholder="Titre du Live">
            <video id="live-preview" autoplay muted style="width:100%; background:black; margin-bottom:10px; border-radius:5px;"></video>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gray" onclick="app.upload.startCam()">üì∑ Cam√©ra</button>
                <button class="btn btn-gray" onclick="app.upload.startScreen()">üíª √âcran</button>
            </div>
            <br>
            <button class="btn btn-red" style="width:100%" onclick="app.upload.goLive()">PASSER EN DIRECT</button>
        </div>
        <button class="btn btn-gray" style="margin-top:10px; width:100%" onclick="app.closeModals()">Annuler</button>
    </div>
</div>

<div id="modal-custom" class="modal">
    <div class="modal-content">
        <h2>Personnaliser la cha√Æne</h2>
        <input id="cust-banner" placeholder="URL Banni√®re (ou laisser vide)">
        <textarea id="cust-desc" placeholder="Description de la cha√Æne"></textarea>
        <p>Pour la Photo de Profil, on utilise la 1√®re lettre + couleur (auto) ou URL :</p>
        <input id="cust-pp" placeholder="URL Avatar (Optionnel)">
        <button class="btn btn-blue" onclick="app.profile.saveCustom()">Enregistrer</button>
        <button class="btn btn-gray" onclick="app.closeModals()">Fermer</button>
    </div>
</div>

<div id="modal-auth" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h2>Connexion</h2>
        <input id="auth-user" placeholder="Pseudo">
        <button class="btn btn-blue" onclick="app.auth.login()">Entrer</button>
    </div>
</div>

<script>
const app = {
    data: {
        videos: [],
        users: { 
            "Edonis": { color: "#ff0000", pp: "", banner: "", desc: "Le Cr√©ateur Supr√™me", subs: [], role: "admin" } 
        },
        posts: [],
        thanks: ["Edonis - Cr√©ateur", "Toi - Testeur"]
    },
    currentUser: null,
    
    init: function() {
        // Chargement LocalStorage
        const saved = localStorage.getItem('visiona_db');
        if(saved) this.data = JSON.parse(saved);
        const user = localStorage.getItem('visiona_user');
        if(user) this.currentUser = user;
        
        this.router('home');
        this.auth.updateUI();
        
        // Easter Egg Counter
        this.egg.count = 0;
    },
    
    save: function() {
        localStorage.setItem('visiona_db', JSON.stringify(this.data));
    },

    utils: {
        getAvatar: function(username) {
            const u = app.data.users[username];
            if(u && u.pp) return `<img src="${u.pp}" class="avatar-circle" style="width:100%; height:100%;">`;
            // Avatar g√©n√©r√©
            const color = u ? u.color : '#'+Math.floor(Math.random()*16777215).toString(16);
            return `<div class="avatar-circle" style="background:${color}; width:100%; height:100%;">${username[0].toUpperCase()}</div>`;
        },
        timeAgo: function(ts) {
            const diff = Date.now() - ts;
            const h = Math.floor(diff/3600000);
            if(h < 1) return Math.floor(diff/60000) + " min";
            if(h < 24) return h + " heures";
            return Math.floor(h/24) + " jours";
        },
        formatDur: function(sec) {
            if(!sec) return "LIVE";
            const m = Math.floor(sec/60);
            const s = Math.floor(sec%60);
            return `${m}:${s<10?'0'+s:s}`;
        }
    },

    router: function(page, param) {
        document.querySelectorAll('.page').forEach(e => e.style.display = 'none');
        document.getElementById('user-menu').style.display = 'none';
        
        if(page === 'home') {
            document.getElementById('view-home').style.display = 'block';
            this.render.grid('home-grid', this.data.videos.filter(v => !v.isShort));
        }
        else if(page === 'zapp') {
            document.getElementById('view-zapp').style.display = 'block';
            this.render.zapps();
        }
        else if(page === 'profile') {
            document.getElementById('view-profile').style.display = 'block';
            this.profile.load(param || this.currentUser);
        }
        else if(page === 'subs') {
            document.getElementById('view-subs').style.display = 'block';
            if(!this.currentUser) return;
            const mySubs = this.data.users[this.currentUser].subs;
            const vids = this.data.videos.filter(v => mySubs.includes(v.author));
            this.render.grid('subs-grid', vids);
        }
        else if(page === 'history') {
            document.getElementById('view-history').style.display = 'block';
            // Historique simul√© (filtre vues)
            this.render.grid('history-grid', this.data.videos.filter(v => v.views > 0)); // Simplification
        }
        else if(page === 'community') {
            document.getElementById('view-community').style.display = 'block';
            this.render.posts('view-community');
        }
        else if(page === 'thanks') {
            document.getElementById('view-thanks').style.display = 'block';
            document.getElementById('view-thanks').innerHTML = `<h2>üíé Remerciements</h2><ul>${this.data.thanks.map(t=>`<li>${t}</li>`).join('')}</ul>`;
        }
        else if(page === 'admin') {
            if(this.data.users[this.currentUser]?.role !== 'admin') return alert("Acc√®s refus√©");
            document.getElementById('view-admin').style.display = 'block';
            this.admin.render();
        }
    },
    upload: {
        fileData: null,
        thumbData: null,
        
        processFile: function() {
            if(!app.currentUser) return app.openModal('modal-auth');
            const vFile = document.getElementById('up-file').files[0];
            const tFile = document.getElementById('up-thumb').files[0];
            const title = document.getElementById('up-title').value;
            
            if(!vFile || !title) return alert("Fichier et titre requis");
            
            // Conversion Video
            const reader = new FileReader();
            reader.onload = function(e) {
                const vData = e.target.result;
                
                // Extraction Dur√©e R√©elle
                const tempVid = document.createElement('video');
                tempVid.src = vData;
                tempVid.onloadedmetadata = function() {
                    const duration = tempVid.duration;
                    
                    // Conversion Thumb
                    if(tFile) {
                        const tr = new FileReader();
                        tr.onload = function(ev) {
                            app.upload.finalize(title, vData, ev.target.result, duration);
                        }
                        tr.readAsDataURL(tFile);
                    } else {
                        app.upload.finalize(title, vData, null, duration);
                    }
                };
            };
            reader.readAsDataURL(vFile);
        },
        
        finalize: function(title, url, thumb, dur) {
            const isShort = document.getElementById('up-zapp').checked;
            app.data.videos.unshift({
                id: Date.now(),
                title: title,
                desc: document.getElementById('up-desc').value,
                author: app.currentUser,
                url: url,
                thumb: thumb,
                duration: dur,
                isShort: isShort,
                date: Date.now(),
                views: 0, likes: 0, dislikes: 0,
                viewers: {}, // Pour cooldown
                comments: []
            });
            app.save();
            alert("Publi√© !");
            app.closeModals();
            app.router('home');
        },

        // LOGIQUE LIVE (STREAMING LOCAL)
        stream: null,
        startCam: async function() {
            this.stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('live-preview').srcObject = this.stream;
        },
        startScreen: async function() {
            this.stream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
            document.getElementById('live-preview').srcObject = this.stream;
        },
        goLive: function() {
            if(!this.stream) return alert("Activez une source !");
            app.data.videos.unshift({
                id: Date.now(),
                title: "üî¥ " + document.getElementById('live-title').value,
                author: app.currentUser,
                isLive: true,
                date: Date.now(),
                thumb: null, // Pas de thumb
                views: 0, likes: 0, dislikes: 0, comments: [], viewers: {}
            });
            app.save();
            alert("Vous √™tes EN DIRECT ! (Simulation locale)");
            app.closeModals();
            app.router('home');
            // Note: Le stream s'arr√™tera si on change de page car pas de serveur RTMP
        }
    },

    player: {
        active: null,
        load: function(id) {
            const v = app.data.videos.find(x => x.id == id);
            this.active = v;
            
            // COOLDOWN VUES (1h)
            const now = Date.now();
            if(!v.viewers[app.currentUser] || now - v.viewers[app.currentUser] > 3600000) {
                v.views++;
                if(app.currentUser) v.viewers[app.currentUser] = now;
                app.save();
            }

            const p = document.getElementById('player-overlay');
            const vid = document.getElementById('main-video');
            p.style.display = 'block';
            
            // Si c'est un live local (l'utilisateur actuel est l'auteur)
            if(v.isLive && v.author === app.currentUser && app.upload.stream) {
                vid.srcObject = app.upload.stream;
            } else {
                vid.src = v.url || ""; 
            }
            
            document.getElementById('vid-title').innerText = v.title;
            document.getElementById('vid-desc').innerText = v.desc || "";
            document.getElementById('vid-meta').innerText = `${v.views} vues ‚Ä¢ ${app.utils.timeAgo(v.date)}`;
            document.getElementById('vid-author-name').innerText = v.author;
            document.getElementById('vid-author-pp').innerHTML = app.utils.getAvatar(v.author);
            document.getElementById('vid-likes').innerText = v.likes;
            document.getElementById('vid-dislikes').innerText = v.dislikes;
            
            // Recommandations al√©atoires
            const recos = app.data.videos.filter(x => !x.isShort && x.id != id).sort(() => 0.5 - Math.random()).slice(0,5);
            document.getElementById('reco-list').innerHTML = recos.map(r => app.render.cardHTML(r)).join('');
            
            app.social.renderComments();
        }
    },

    social: {
        likeVid: function() { app.social.vote(1); },
        dislikeVid: function() { app.social.vote(-1); },
        vote: function(val) {
            if(!app.currentUser) return app.openModal('modal-auth');
            // Simplification: pas de liste de voters pour √©conomiser taille, juste +/-
            if(val>0) app.player.active.likes++; else app.player.active.dislikes++;
            app.save();
            app.player.load(app.player.active.id); // Refresh
        },
        toggleSub: function() {
            if(!app.currentUser) return app.openModal('modal-auth');
            const target = document.getElementById('p-name').innerText; // Hack rapide
            const me = app.data.users[app.currentUser];
            if(me.subs.includes(target)) me.subs = me.subs.filter(s => s !== target);
            else me.subs.push(target);
            app.save();
            app.profile.load(target);
        },
        postComment: function() {
            const txt = document.getElementById('com-input').value;
            if(!txt) return;
            app.player.active.comments.push({
                author: app.currentUser, text: txt, date: Date.now(), heart: false
            });
            document.getElementById('com-input').value = "";
            app.save();
            this.renderComments();
        },
        toggleHeart: function(idx) {
            const c = app.player.active.comments[idx];
            if(app.currentUser !== app.player.active.author) return;
            c.heart = !c.heart;
            app.save();
            this.renderComments();
        },
        renderComments: function() {
            const list = document.getElementById('com-list');
            list.innerHTML = app.player.active.comments.map((c, i) => `
                <div style="margin-bottom:15px; display:flex; gap:10px;">
                    <div style="width:30px; height:30px;">${app.utils.getAvatar(c.author)}</div>
                    <div>
                        <div style="font-size:12px;"><b>${c.author}</b> ${app.utils.timeAgo(c.date)}</div>
                        <div>${c.text}</div>
                        ${c.heart ? '<div style="color:red; font-size:12px;">‚ù§Ô∏è Aim√© par l\'auteur</div>' : ''}
                        ${app.currentUser === app.player.active.author ? `<button onclick="app.social.toggleHeart(${i})">‚ù§Ô∏è</button>` : ''}
                    </div>
                </div>
            `).join('');
        }
    },

    render: {
        grid: function(id, list) {
            document.getElementById(id).innerHTML = list.map(v => this.cardHTML(v)).join('');
        },
        cardHTML: function(v) {
            const thumb = v.thumb ? `<img src="${v.thumb}">` : `<div style="width:100%; height:100%; background:#333;"></div>`;
            return `
            <div class="card" onclick="app.player.load(${v.id})">
                <div class="thumb">
                    ${thumb}
                    <div class="duration">${app.utils.formatDur(v.duration)}</div>
                    ${v.isLive ? '<div class="live-badge">DIRECT</div>' : ''}
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="width:36px; height:36px;">${app.utils.getAvatar(v.author)}</div>
                    <div>
                        <div style="font-weight:bold; line-height:1.2;">${v.title}</div>
                        <div style="font-size:12px; color:#aaa;">${v.author} ‚Ä¢ ${v.views} vues</div>
                    </div>
                </div>
            </div>`;
        },
        zapps: function() {
            const list = app.data.videos.filter(v => v.isShort);
            document.getElementById('view-zapp').innerHTML = list.map(z => `
                <div class="zapp-item">
                    <video class="zapp-video" src="${z.url}" controls loop></video>
                    <div class="zapp-ui">
                        <div style="font-size:20px;">‚ù§Ô∏è ${z.likes}</div>
                        <div onclick="app.player.load(${z.id})">üí¨</div>
                    </div>
                </div>
            `).join('');
        },
        posts: function(targetId) {
            // Afficher posts globaux pour la communaut√©
            const area = document.getElementById(targetId);
            const list = targetId === 'view-community' ? app.data.posts : app.data.posts.filter(p => p.author === document.getElementById('p-name').innerText);
            
            let html = "";
            if(app.currentUser && targetId === 'view-community') {
                html += `<div class="post-card">
                    <textarea id="new-post-txt" placeholder="Exprimez-vous..."></textarea>
                    <button class="btn btn-blue" onclick="app.profile.addPost()">Publier</button>
                </div>`;
            }
            html += list.map(p => `
                <div class="post-card">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                        <div style="width:30px; height:30px;">${app.utils.getAvatar(p.author)}</div>
                        <b>${p.author}</b> <span style="color:#aaa; font-size:12px;">${app.utils.timeAgo(p.date)}</span>
                    </div>
                    <p>${p.text}</p>
                </div>
            `).join('');
            area.innerHTML = html;
        }
    },

    profile: {
        current: null,
        load: function(username) {
            this.current = username;
            if(!app.data.users[username]) {
                // Cr√©ation user fictif si clic sur auteur inconnu (pour l'affichage)
                app.data.users[username] = { color: "#555", pp: "", subs: [], desc: "Membre Visiona" };
            }
            const u = app.data.users[username];
            
            document.getElementById('p-name').innerText = username;
            document.getElementById('p-pp').innerHTML = app.utils.getAvatar(username);
            document.getElementById('p-sub-count').innerText = "??? abonn√©s"; // Pas de calcul complexe ici
            document.getElementById('p-desc').innerText = u.desc || "";
            if(u.banner) document.getElementById('p-banner').style.backgroundImage = `url(${u.banner})`;
            
            // Boutons
            const isMe = (username === app.currentUser);
            document.getElementById('p-edit-btn').style.display = isMe ? 'block' : 'none';
            document.getElementById('p-sub-btn').style.display = isMe ? 'none' : 'block';
            
            if(app.data.users[app.currentUser]?.subs.includes(username)) {
                document.getElementById('p-sub-btn').innerText = "ABONN√â";
                document.getElementById('p-sub-btn').className = "btn btn-gray";
            } else {
                document.getElementById('p-sub-btn').innerText = "S'ABONNER";
                document.getElementById('p-sub-btn').className = "btn btn-red";
            }
            
            this.switchTab('videos');
        },
        switchTab: function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            const cont = document.getElementById('p-content');
            const author = document.getElementById('p-name').innerText;
            
            if(tab === 'videos') {
                const list = app.data.videos.filter(v => v.author === author && !v.isShort);
                cont.innerHTML = `<div class="grid">${list.map(v => app.render.cardHTML(v)).join('')}</div>`;
            } else if(tab === 'zapps') {
                const list = app.data.videos.filter(v => v.author === author && v.isShort);
                cont.innerHTML = `<div class="grid">${list.map(v => app.render.cardHTML(v)).join('')}</div>`;
            } else if(tab === 'posts') {
                app.render.posts('p-content');
            } else {
                cont.innerHTML = `<div style="padding:20px;">${app.data.users[author].desc || "Pas de description"}</div>`;
            }
        },
        saveCustom: function() {
            const u = app.data.users[app.currentUser];
            u.banner = document.getElementById('cust-banner').value;
            u.desc = document.getElementById('cust-desc').value;
            u.pp = document.getElementById('cust-pp').value;
            app.save();
            app.closeModals();
            this.load(app.currentUser);
        },
        addPost: function() {
            const txt = document.getElementById('new-post-txt').value;
            if(!txt) return;
            app.data.posts.unshift({ author: app.currentUser, text: txt, date: Date.now() });
            app.save();
            app.render.posts(document.getElementById('view-community').style.display === 'block' ? 'view-community' : 'p-content');
        }
    },

    auth: {
        login: function() {
            const u = document.getElementById('auth-user').value;
            if(!u) return;
            if(!app.data.users[u]) app.data.users[u] = { color: '#'+Math.floor(Math.random()*16777215).toString(16), subs: [] };
            app.currentUser = u;
            localStorage.setItem('visiona_user', u);
            app.save();
            app.closeModals();
            this.updateUI();
        },
        logout: function() {
            localStorage.removeItem('visiona_user');
            location.reload();
        },
        updateUI: function() {
            if(app.currentUser) {
                document.getElementById('user-area').style.display = 'block';
                document.getElementById('header-pp').innerHTML = app.utils.getAvatar(app.currentUser);
                document.getElementById('menu-pp').innerHTML = app.utils.getAvatar(app.currentUser);
                document.getElementById('menu-name').innerText = app.currentUser;
                if(app.data.users[app.currentUser].role === 'admin') document.getElementById('admin-link').style.display = 'block';
            } else {
                document.getElementById('user-area').innerHTML = "<button class='btn btn-blue' onclick=\"app.openModal('modal-auth')\">Connexion</button>";
            }
        }
    },

    admin: {
        render: function() {
            const div = document.getElementById('view-admin');
            div.innerHTML = `
                <h2>Panel Admin (Edonis)</h2>
                <h3>Vid√©os</h3>
                ${app.data.videos.map(v => `<div>${v.title} <button onclick="app.admin.delVid(${v.id})">Suppr</button></div>`).join('')}
                <h3>Remerciements</h3>
                <input id="new-thanks"><button onclick="app.data.thanks.push(document.getElementById('new-thanks').value); app.save(); app.router('admin');">Ajouter</button>
            `;
        },
        delVid: function(id) {
            app.data.videos = app.data.videos.filter(v => v.id !== id);
            app.save();
            this.render();
        }
    },

    egg: {
        count: 0,
        click: function() {
            this.count++;
            if(this.count === 10) {
                document.body.classList.add('christmas-mode');
                alert("üéÖ MODE NO√ãL ACTIV√â !");
            }
        }
    },
    
    // UTILS UI
    toggleMenu: function() {
        const m = document.getElementById('user-menu');
        m.style.display = m.style.display === 'none' ? 'block' : 'none';
    },
    openModal: function(id) {
        if(!app.currentUser && id !== 'modal-auth') return document.getElementById('modal-auth').style.display = 'flex';
        document.getElementById(id).style.display = 'flex';
    },
    closeModals: function() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); },
    search: function() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const res = app.data.videos.filter(v => v.title.toLowerCase().includes(q));
        app.render.grid('home-grid', res);
        app.router('home');
    }
};

// D√âMARRAGE
window.onload = function() { app.init(); };
</script>
</body>
</html>
