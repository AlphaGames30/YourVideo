<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona Titan - L'Exp√©rience Ultime</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; 
            --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --green: #00a854; 
            --gold: #ffc107; --glass: rgba(255, 255, 255, 0.05); --sidebar-width: 240px;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; overflow-x: hidden; }

        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* HEADER */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 56px;
            background: var(--header); display: flex; align-items: center;
            justify-content: space-between; padding: 0 16px; z-index: 2000;
        }

        .search-container { display: flex; align-items: center; background: #121212; border: 1px solid #333; border-radius: 40px; padding: 0 15px; width: 40%; max-width: 600px; }
        .search-container input { background: none; border: none; color: white; padding: 8px; width: 100%; outline: none; }

        /* SIDEBAR */
        .sidebar {
            position: fixed; left: 0; top: 56px; bottom: 0; width: var(--sidebar-width);
            background: var(--bg); overflow-y: auto; padding-top: 10px; z-index: 1000;
        }
        .nav-item {
            display: flex; align-items: center; gap: 20px; padding: 10px 24px;
            cursor: pointer; border-radius: 10px; margin: 0 10px; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: var(--hover); }

        /* CONTENT */
        .main-content { margin-left: var(--sidebar-width); margin-top: 56px; padding: 20px; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }

        /* VIDEO CARDS */
        .v-card { cursor: pointer; transition: 0.3s; }
        .v-thumb { position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; background: #222; }
        .v-thumb img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .v-card:hover img { transform: scale(1.05); }
        .v-duration { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); padding: 2px 6px; border-radius: 4px; font-size: 12px; }

        /* ZAPPS (Format Vertical) */
        .zapp-view { display: none; height: calc(100vh - 56px); overflow-y: scroll; scroll-snap-type: y mandatory; }
        .zapp-container { height: 100%; scroll-snap-align: start; position: relative; display: flex; justify-content: center; background: #000; }
        .zapp-video-wrapper { height: 95%; aspect-ratio: 9/16; margin: auto; position: relative; border-radius: 15px; overflow: hidden; }
        .zapp-video { width: 100%; height: 100%; object-fit: cover; }
        .zapp-actions { position: absolute; right: 10px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; z-index: 10; }

        /* MODALES */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(5px); }
        .modal-content { background: #212121; padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; position: relative; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }

        /* PLAYER OVERLAY */
        #player-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2500; display: none; overflow-y: auto; }
        .player-container { max-width: 1280px; margin: 0 auto; display: grid; grid-template-columns: 1fr 350px; gap: 24px; padding: 20px; }

        /* STATS TITAN */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background: var(--hover); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #333; }
        .stat-val { font-size: 32px; font-weight: bold; color: var(--blue); }

        @media (max-width: 1000px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .player-container { grid-template-columns: 1fr; }
            .search-container { width: 50px; border: none; }
            .search-container input { display: none; }
        }
    </style>
</head>
<body>
    <header>
        <div style="display:flex; align-items:center; gap:20px;">
            <span style="font-size:24px; cursor:pointer;" onclick="app.nav('home')">‚ò∞</span>
            <h1 style="font-size:20px; color:var(--red); letter-spacing:-1px; cursor:pointer;" onclick="app.nav('home')">VISIONA<span style="color:white; font-weight:300;">TITAN</span></h1>
        </div>
        <div class="search-container">
            <input type="text" id="mainSearch" placeholder="Rechercher une vid√©o, un auteur..." onkeyup="if(event.key==='Enter') app.search()">
            <button onclick="app.search()" style="background:none; border:none; color:white; cursor:pointer;">üîç</button>
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <button onclick="app.openModal('modal-upload')" style="background:var(--hover); border:none; color:white; padding:8px 15px; border-radius:20px; cursor:pointer; font-weight:500;">+ Cr√©er</button>
            <div id="notif-bell" style="position:relative; cursor:pointer;" onclick="app.toggleNotifs()">
                üîî<span id="notif-badge" style="position:absolute; top:-5px; right:-5px; background:red; font-size:10px; padding:2px 5px; border-radius:50%; display:none;">0</span>
            </div>
            <img id="header-avatar-img" onclick="app.toggleDropdown()" src="https://via.placeholder.com/34" style="width:34px; height:34px; border-radius:50%; cursor:pointer; border:1px solid #333;">
            
            <div id="profile-dropdown" style="display:none; position:absolute; top:50px; right:15px; background:#282828; border-radius:8px; width:220px; box-shadow:0 10px 30px rgba(0,0,0,0.5); z-index:100;">
                <div style="padding:15px; border-bottom:1px solid #444;" id="dropdown-username">Non connect√©</div>
                <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma cha√Æne</div>
                <div class="nav-item" onclick="app.openModal('modal-admin')" id="admin-panel-btn" style="display:none;">üõ°Ô∏è Admin</div>
                <div class="nav-item" onclick="app.logout()" style="color:var(--red);">üö™ D√©connexion</div>
            </div>
        </div>
    </header>

    <div class="sidebar">
        <div class="nav-item active" onclick="app.nav('home', this)">üè† Accueil</div>
        <div class="nav-item" onclick="app.nav('zapp', this)">üöÄ Zapps (Shorts)</div>
        <div class="nav-item" onclick="app.nav('subs', this)">üì∫ Abonnements</div>
        <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
        <div class="nav-item" onclick="app.nav('history', this)">üïí Historique</div>
        <div class="nav-item" onclick="app.nav('posts', this)">üí¨ Communaut√©</div>
        <div class="nav-item" onclick="app.nav('stats', this)">üìä Stats Titan</div>
        <div class="nav-item" onclick="app.triggerEgg()">üåå Myst√®re</div>
    </div>

    <main class="main-content">
        <div id="alert-area"></div>
        <section id="view-home"><div class="video-grid" id="home-grid"></div></section>
        <section id="view-zapp" class="zapp-view"></section>
        </main>
        <div id="player-overlay">
        <div class="player-container">
            <div class="player-left-col">
                <button onclick="app.closePlayer()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer; margin-bottom:10px;">‚úï</button>
                <div style="width:100%; aspect-ratio:16/9; background:black; border-radius:12px; overflow:hidden;">
                    <video id="main-video" controls autoplay style="width:100%; height:100%;"></video>
                </div>
                <h2 id="video-title" style="margin-top:15px;">Chargement...</h2>
                <div id="v-author-info" style="display:flex; align-items:center; gap:15px; margin:15px 0;">
                    <img id="v-author-avatar" src="" style="width:40px; height:40px; border-radius:50%;">
                    <div style="flex:1">
                        <b id="v-author-name">Auteur</b>
                        <p id="v-author-subs" style="margin:0; font-size:12px; color:var(--sec-text);">0 abonn√©s</p>
                    </div>
                    <button id="player-sub-btn" onclick="app.toggleSub()" style="background:white; color:black; border:none; padding:10px 20px; border-radius:24px; font-weight:bold; cursor:pointer;">S'ABONNER</button>
                </div>
                <div id="v-description-block" style="background:var(--hover); padding:15px; border-radius:12px;">
                    <b id="v-stats-line">0 vues ‚Ä¢ il y a 2 jours</b>
                    <p id="v-desc-content" style="white-space:pre-wrap; margin-top:10px;">Description...</p>
                </div>
            </div>
            <div class="player-right-col">
                <h4>Vid√©os sugg√©r√©es</h4>
                <div id="suggestions-list"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
        const WORKER_URL = "https://mytubeupload.edonis-imbert.workers.dev/";

        const app = {
            data: { 
                videos: [], 
                users: {}, 
                posts: [], 
                annonces: [], 
                notifications: [] 
            },
            user: JSON.parse(localStorage.getItem('visiona_user')),
            stats: JSON.parse(localStorage.getItem('visiona_stats')) || { time: 0, views: 0, likes: 0, level: 1 },
            history: JSON.parse(localStorage.getItem('v_history')) || [],
            activeVid: null,
            activeStream: null,
            eggCount: 0,

            // --- 2. INITIALISATION ---
            init: async function() {
                console.log("Titan Engine : Booting...");
                await this.fetchData();
                this.updateUI();
                this.nav('home');
                this.startStatsTimer();
                this.checkAnnonces();
                this.initZappObserver();
                
                // Fermeture dropdown auto
                window.onclick = (e) => {
                    if (!e.target.closest('#header-avatar-img') && !e.target.closest('#profile-dropdown')) {
                        document.getElementById('profile-dropdown').style.display = 'none';
                    }
                };
            },

            // --- 3. SYNCHRONISATION CLOUD (GIST) ---
            fetchData: async function() {
                try {
                    const r = await fetch(GIST_URL + "?t=" + Date.now());
                    if (!r.ok) throw new Error("Gist non trouv√©");
                    this.data = await r.json();
                    
                    // Initialisation des structures si vides
                    if (!this.data.videos) this.data.videos = [];
                    if (!this.data.users) this.data.users = {};
                    if (!this.data.posts) this.data.posts = [];
                    
                    console.log("Donn√©es Titan synchronis√©es.");
                } catch(e) {
                    console.error("Erreur Sync Gist:", e);
                    // Tentative de r√©cup√©ration via secours (localStorage)
                    const backup = localStorage.getItem('visiona_backup');
                    if (backup) this.data = JSON.parse(backup);
                }
            },

            saveGist: async function() {
                if (!this.user) return;
                try {
                    const response = await fetch(WORKER_URL, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            files: { "video.json": { content: JSON.stringify(this.data, null, 2) } }
                        })
                    });
                    if (response.ok) {
                        console.log("‚úÖ Sauvegarde Cloud OK");
                        localStorage.setItem('visiona_backup', JSON.stringify(this.data));
                    }
                } catch(e) {
                    console.error("‚ùå Erreur de sauvegarde:", e);
                }
            },

            // --- 4. MOTEUR DE STATISTIQUES (XP) ---
            startStatsTimer: function() {
                setInterval(() => {
                    if (document.visibilityState === 'visible') {
                        this.stats.time += 1;
                        if (this.stats.time % 30 === 0) { // Sauvegarde stats locales toutes les 30s
                            localStorage.setItem('visiona_stats', JSON.stringify(this.stats));
                            this.checkLevelUp();
                        }
                    }
                }, 1000);
            },

            checkLevelUp: function() {
                const newLevel = Math.floor(this.stats.time / 3600) + 1;
                if (newLevel > this.stats.level) {
                    this.stats.level = newLevel;
                    alert(`‚≠ê NIVEAU TITAN ATTEINT : ${newLevel} !`);
                    this.addNotification(`F√©licitations ! Vous √™tes d√©sormais Niveau ${newLevel}`);
                }
            },

            addNotification: function(txt) {
                if (!this.data.notifications) this.data.notifications = [];
                this.data.notifications.unshift({ text: txt, date: Date.now(), read: false });
                this.updateNotifBadge();
            },

            updateNotifBadge: function() {
                const count = (this.data.notifications || []).filter(n => !n.read).length;
                const badge = document.getElementById('notif-badge');
                if (badge) {
                    badge.innerText = count;
                    badge.style.display = count > 0 ? 'block' : 'none';
                }
            },
            // --- 5. MOTEUR DE NAVIGATION (NAV SYSTEM) ---
            nav: function(viewId, element = null) {
                console.log("Navigation vers : " + viewId);
                
                // Fermer les lecteurs et modales avant de changer de vue
                this.closePlayer();
                this.closeModals();
                
                // G√©rer l'√©tat visuel de la Sidebar
                if (element) {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    element.classList.add('active');
                }

                // Liste de toutes les sections g√©r√©es par le moteur
                const sections = ['view-home', 'view-zapp', 'view-profile', 'view-stats', 'view-history', 'view-posts', 'view-subs'];
                sections.forEach(s => {
                    const el = document.getElementById(s);
                    if (el) el.style.display = 'none';
                });

                // Afficher la section cible
                const target = document.getElementById('view-' + viewId);
                if (target) {
                    target.style.display = 'block';
                    // D√©clencher le rendu sp√©cifique √† la vue
                    switch(viewId) {
                        case 'home': this.renderHome(); break;
                        case 'zapp': this.renderZapp(); break;
                        case 'stats': this.renderStats(); break;
                        case 'posts': this.renderPosts(); break;
                        case 'history': this.renderHistory(); break;
                        case 'subs': this.renderSubs(); break;
                    }
                }
                window.scrollTo(0,0);
            },

            // --- 6. GESTION DES COMPTES (AUTH & SESSION) ---
            toggleDropdown: function() {
                const dd = document.getElementById('profile-dropdown');
                dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
            },

            handleAuth: async function() {
                const name = document.getElementById('auth-username').value.trim();
                const email = document.getElementById('auth-email').value.trim();
                
                if (!name || !email) return alert("Veuillez remplir tous les champs !");

                // Si l'utilisateur n'existe pas dans le Gist, on le cr√©e
                if (!this.data.users[name]) {
                    this.data.users[name] = {
                        email: email,
                        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`,
                        banner: "https://images.unsplash.com/photo-1579546678195-a9d20f0b4d44",
                        bio: "Nouveau membre Titan",
                        subs: {}, // Personnes √† qui il est abonn√©
                        followers: {}, // Personnes abonn√©es √† lui
                        level: 1,
                        date: Date.now()
                    };
                    await this.saveGist();
                }

                const userData = { name: name, email: email };
                localStorage.setItem('visiona_user', JSON.stringify(userData));
                this.user = userData;
                
                alert(`Content de vous revoir, ${name} !`);
                location.reload(); // On recharge pour appliquer l'√©tat connect√© partout
            },

            logout: function() {
                if(confirm("Voulez-vous vous d√©connecter ?")) {
                    localStorage.removeItem('visiona_user');
                    location.reload();
                }
            },

            updateUI: function() {
                // Met √† jour l'interface selon si on est connect√© ou non
                const headImg = document.getElementById('header-avatar-img');
                const dropdownName = document.getElementById('dropdown-username');
                
                if (this.user) {
                    const uData = this.data.users[this.user.name] || {};
                    if (headImg) headImg.src = uData.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${this.user.name}`;
                    if (dropdownName) dropdownName.innerText = this.user.name;
                    
                    // Afficher le bouton Admin si c'est toi
                    if (this.user.name === "Admin" || this.user.name === "AlphaGames30") {
                        const adminBtn = document.getElementById('admin-panel-btn');
                        if (adminBtn) adminBtn.style.display = 'flex';
                    }
                } else {
                    if (headImg) headImg.src = "https://via.placeholder.com/34?text=?";
                    if (dropdownName) dropdownName.innerText = "Non connect√©";
                }
            },

            // --- 7. RENDU DE L'ACCUEIL ---
            renderHome: function() {
                const grid = document.getElementById('home-grid');
                if (!grid) return;
                
                // On filtre pour ne pas afficher les Zapps (Shorts) sur l'accueil
                const vids = (this.data.videos || []).filter(v => !v.isShort);
                
                if (vids.length === 0) {
                    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:var(--sec-text);">
                        <h3>Aucune vid√©o pour le moment.</h3>
                        <p>Soyez le premier √† publier !</p>
                    </div>`;
                    return;
                }

                grid.innerHTML = vids.map(v => this.createVideoCard(v)).join('');
            },

            createVideoCard: function(v) {
                const authorData = this.data.users[v.author] || {};
                return `
                <div class="v-card" onclick="app.openPlayer('${v.id}')">
                    <div class="v-thumb">
                        <img src="${v.thumb}" loading="lazy">
                        <div class="v-duration">${v.duration || "0:00"}</div>
                    </div>
                    <div style="display:flex; gap:12px; margin-top:12px;">
                        <img src="${authorData.avatar || 'https://via.placeholder.com/36'}" 
                             style="width:36px; height:36px; border-radius:50%; object-fit:cover;"
                             onclick="event.stopPropagation(); app.goProfile('${v.author}')">
                        <div style="flex:1;">
                            <b style="font-size:14px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${v.title}</b>
                            <p style="font-size:12px; color:var(--sec-text); margin:4px 0;" onclick="event.stopPropagation(); app.goProfile('${v.author}')">${v.author}</p>
                            <p style="font-size:12px; color:var(--sec-text);">${this.formatViews(v.views)} vues ‚Ä¢ ${this.timeAgo(v.date)}</p>
                        </div>
                    </div>
                </div>`;
            },
            // --- 8. SYST√àME D'UPLOAD (COH√âRENCE CLOUD) ---
            openModal: function(id) {
                const m = document.getElementById(id);
                if (m) m.style.display = 'flex';
                if (id === 'modal-direct') this.startCamera(); // Active cam si direct
            },

            closeModals: function() {
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                this.stopCamera();
            },

            handleUpload: async function() {
                if (!this.user) return this.openModal('modal-auth');

                const title = document.getElementById('upTitle').value.trim();
                const desc = document.getElementById('upDesc').value.trim();
                const videoFile = document.getElementById('upVideoFile').files[0];
                const thumbFile = document.getElementById('upThumbFile').files[0];
                const isShort = document.getElementById('upIsShort').checked;

                if (!title || !videoFile) return alert("Le titre et la vid√©o sont obligatoires !");

                // Affichage barre de progression
                const zone = document.getElementById('upProgressZone');
                const bar = document.getElementById('upProgressBar');
                const percentText = document.getElementById('upPercent');
                if(zone) zone.style.display = 'block';

                try {
                    // 1. Pr√©paration du FormData pour le Worker (Envoi vers Cloudinary)
                    const formData = new FormData();
                    formData.append('video', videoFile);
                    if (thumbFile) formData.append('thumb', thumbFile);
                    formData.append('title', title);

                    // 2. Envoi au Worker
                    const response = await fetch(WORKER_URL, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error || "Erreur Upload");

                    // 3. Cr√©ation de l'objet vid√©o Titan
                    const newVideo = {
                        id: "v" + Date.now(),
                        title: title,
                        description: desc,
                        url: result.videoUrl,
                        thumb: result.thumbUrl || "https://via.placeholder.com/800x450/222/fff?text=Visiona",
                        author: this.user.name,
                        date: Date.now(),
                        views: 0,
                        likes: 0,
                        dislikes: 0,
                        comments: [],
                        isShort: isShort,
                        duration: "0:00" // Id√©alement calcul√© c√¥t√© serveur
                    };

                    this.data.videos.unshift(newVideo);
                    await this.saveGist();
                    
                    alert("Vid√©o publi√©e avec succ√®s !");
                    location.reload();
                } catch (e) {
                    alert("Erreur Titan : " + e.message);
                } finally {
                    if(zone) zone.style.display = 'none';
                }
            },

            // --- 9. SYST√àME DE DIRECTS (LIVE STREAMING) ---
            startCamera: async function() {
                const preview = document.getElementById('direct-preview');
                try {
                    this.activeStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    if (preview) preview.srcObject = this.activeStream;
                } catch (e) {
                    alert("Cam√©ra inaccessible : " + e.message);
                }
            },

            stopCamera: function() {
                if (this.activeStream) {
                    this.activeStream.getTracks().forEach(track => track.stop());
                    this.activeStream = null;
                }
            },

            publishLive: async function() {
                const title = document.getElementById('direct-title').value.trim();
                if (!title) return alert("Donnez un titre √† votre live !");

                const liveVideo = {
                    id: "live_" + Date.now(),
                    title: "[DIRECT] " + title,
                    description: "Flux en direct de " + this.user.name,
                    url: "", // Le flux r√©el n√©cessiterait un serveur RTMP, ici on simule la pr√©sence
                    thumb: "https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=800",
                    author: this.user.name,
                    date: Date.now(),
                    views: 1, // On commence √† 1 (soi-m√™me)
                    isLive: true,
                    isShort: false
                };

                this.data.videos.unshift(liveVideo);
                await this.saveGist();
                alert("Votre Direct a √©t√© lanc√© sur Visiona !");
                this.closeModals();
                this.nav('home');
            },

            // --- 10. MOTEUR ZAPPS (SHORTS) ---
            renderZapp: function() {
                const container = document.getElementById('view-zapp');
                const zapps = (this.data.videos || []).filter(v => v.isShort);
                
                if (zapps.length === 0) {
                    container.innerHTML = `<div style="color:white; text-align:center; padding-top:100px;">Aucun Zapp disponible.</div>`;
                    return;
                }

                container.innerHTML = zapps.map((z, index) => `
                    <div class="zapp-container">
                        <div class="zapp-video-wrapper">
                            <video class="zapp-video" loop playsinline 
                                   onclick="app.toggleZappPlay(this)"
                                   onmouseover="this.muted=false"
                                   src="${z.url}"></video>
                            
                            <div class="zapp-actions">
                                <div onclick="app.handleVote('${z.id}', 'like')" style="text-align:center;">
                                    <div style="font-size:24px;">üëç</div>
                                    <small>${this.formatViews(z.likes || 0)}</small>
                                </div>
                                <div onclick="app.openZappComments('${z.id}')" style="text-align:center;">
                                    <div style="font-size:24px;">üí¨</div>
                                    <small>${z.comments ? z.comments.length : 0}</small>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:24px;">üîÑ</div>
                                </div>
                            </div>

                            <div style="position:absolute; bottom:20px; left:20px; text-shadow:0 2px 4px rgba(0,0,0,0.8);">
                                <b>@${z.author}</b>
                                <p style="font-size:14px; margin-top:5px;">${z.title}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            toggleZappPlay: function(vid) {
                if (vid.paused) vid.play();
                else vid.pause();
            },

            initZappObserver: function() {
                // Moteur pour l'autoplay au scroll (Zapps)
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const vid = entry.target.querySelector('video');
                        if (entry.isIntersecting) {
                            if(vid) {
                                vid.play().catch(e => console.log("Attente interaction pour son"));
                                // On ne demute pas par d√©faut pour respecter les navigateurs, 
                                // mais on permet le unmute au survol/clic
                            }
                        } else {
                            if(vid) vid.pause();
                        }
                    });
                }, { threshold: 0.7 });

                document.querySelectorAll('.zapp-container').forEach(c => observer.observe(c));
            },
            // --- 11. SYST√àME DE VOTE (LIKE / DISLIKE) ---
            handleVote: async function(type) {
                if (!this.user) return this.openModal('modal-auth');
                if (!this.activeVid) return;

                const v = this.activeVid;
                if (!v.voters) v.voters = {}; // Stocke qui a vot√© quoi

                const userName = this.user.name;
                const currentVote = v.voters[userName];

                if (currentVote === type) {
                    // Annuler le vote si on reclique sur le m√™me
                    delete v.voters[userName];
                    type === 'like' ? v.likes-- : v.dislikes--;
                } else {
                    // Changer de vote ou voter pour la premi√®re fois
                    if (currentVote) {
                        currentVote === 'like' ? v.likes-- : v.dislikes--;
                    }
                    v.voters[userName] = type;
                    type === 'like' ? v.likes++ : v.dislikes++;
                    
                    // Stats Titan : Gagner de l'XP pour l'interaction
                    if (type === 'like') this.stats.likes++;
                }

                this.updatePlayerUI();
                await this.saveGist();
            },

            // --- 12. MOTEUR DE COMMENTAIRES ---
            renderComments: function() {
                const area = document.getElementById('comments-render-area');
                const title = document.getElementById('com-count-title');
                if (!area || !this.activeVid) return;

                const coms = this.activeVid.comments || [];
                title.innerText = `${coms.length} Commentaires`;

                area.innerHTML = coms.map((c, index) => `
                    <div style="display:flex; gap:15px; margin-bottom:20px;">
                        <img src="${this.data.users[c.author]?.avatar || 'https://via.placeholder.com/32'}" style="width:32px; height:32px; border-radius:50%;">
                        <div style="flex:1;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <b style="font-size:13px;">@${c.author}</b>
                                <small style="color:var(--sec-text); font-size:11px;">${this.timeAgo(c.date)}</small>
                            </div>
                            <p style="margin:5px 0; font-size:14px;">${c.text}</p>
                            <div style="display:flex; align-items:center; gap:15px; margin-top:5px;">
                                <span style="cursor:pointer; font-size:12px;" onclick="app.likeComment(${index})">üëç ${c.likes || 0}</span>
                                ${this.activeVid.author === this.user?.name ? 
                                    `<span title="C≈ìur de l'auteur" style="cursor:pointer; filter:${c.hasHeart ? 'none' : 'grayscale(1)'}" onclick="app.heartComment(${index})">‚ù§Ô∏è</span>` 
                                    : (c.hasHeart ? `‚ù§Ô∏è <small style="font-size:10px; color:var(--blue)">√âpingl√© par l'auteur</small>` : '')}
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            postComment: async function() {
                if (!this.user) return this.openModal('modal-auth');
                const input = document.getElementById('com-input');
                const text = input.value.trim();
                if (!text) return;

                const newComment = {
                    author: this.user.name,
                    text: text,
                    date: Date.now(),
                    likes: 0,
                    hasHeart: false
                };

                if (!this.activeVid.comments) this.activeVid.comments = [];
                this.activeVid.comments.unshift(newComment);
                
                input.value = "";
                this.renderComments();
                await this.saveGist();
                this.addNotification(`Nouveau commentaire sur votre vid√©o : "${this.activeVid.title}"`);
            },

            heartComment: async function(index) {
                if (this.user?.name !== this.activeVid.author) return;
                this.activeVid.comments[index].hasHeart = !this.activeVid.comments[index].hasHeart;
                this.renderComments();
                await this.saveGist();
            },

            // --- 13. ABONNEMENTS (SUBSCRIPTION ENGINE) ---
            toggleSub: async function() {
                if (!this.user) return this.openModal('modal-auth');
                const targetAuthor = this.activeVid.author;
                if (targetAuthor === this.user.name) return alert("Vous ne pouvez pas vous abonner √† vous-m√™me !");

                const me = this.data.users[this.user.name];
                const target = this.data.users[targetAuthor];

                if (!me.subs) me.subs = {};
                if (!target.followers) target.followers = {};

                if (me.subs[targetAuthor]) {
                    delete me.subs[targetAuthor];
                    delete target.followers[this.user.name];
                } else {
                    me.subs[targetAuthor] = Date.now();
                    target.followers[this.user.name] = Date.now();
                    this.addNotification(`@${this.user.name} s'est abonn√© √† votre cha√Æne !`);
                }

                this.updatePlayerUI();
                await this.saveGist();
            },

            // --- 14. MOTEUR DE RECHERCHE TITAN ---
            search: function() {
                const query = document.getElementById('mainSearch').value.toLowerCase().trim();
                if (!query) return this.renderHome();

                const filtered = this.data.videos.filter(v => 
                    v.title.toLowerCase().includes(query) || 
                    v.author.toLowerCase().includes(query) ||
                    (v.description && v.description.toLowerCase().includes(query))
                );

                this.nav('home'); // On s'assure d'√™tre sur la grille
                const grid = document.getElementById('home-grid');
                if (filtered.length === 0) {
                    grid.innerHTML = `<div style="padding:50px; text-align:center; width:100%;">Aucun r√©sultat pour "${query}"</div>`;
                } else {
                    grid.innerHTML = filtered.map(v => this.createVideoCard(v)).join('');
                }
            },
            // --- 15. MOTEUR DE PROFIL (MA CHA√éNE & AUTRES) ---
            goProfile: function(username) {
                this.activeProfile = username;
                this.nav('profile');
                this.renderProfile();
            },

            goMyProfile: function() {
                if (!this.user) return this.openModal('modal-auth');
                this.goProfile(this.user.name);
            },

            renderProfile: function() {
                const container = document.getElementById('view-profile');
                if (!container) return;

                const u = this.data.users[this.activeProfile];
                if (!u) {
                    container.innerHTML = "<h2>Utilisateur introuvable</h2>";
                    return;
                }

                const isMe = this.user && this.user.name === this.activeProfile;
                const subCount = Object.keys(u.followers || {}).length;

                container.innerHTML = `
                    <div class="profile-header">
                        <div class="banner" style="height:200px; background:url('${u.banner || 'https://images.unsplash.com/photo-1579546678195-a9d20f0b4d44'}'); background-size:cover; border-radius:15px; position:relative;">
                            ${isMe ? `<button onclick="app.editProfile()" style="position:absolute; bottom:10px; right:10px; padding:8px 15px; border-radius:20px; border:none; background:rgba(0,0,0,0.6); color:white; cursor:pointer;">Modifier le profil</button>` : ''}
                        </div>
                        <div style="display:flex; align-items:center; gap:25px; padding:25px 0;">
                            <img src="${u.avatar}" style="width:120px; height:120px; border-radius:50%; border:4px solid var(--bg); margin-top:-60px; z-index:10; background:var(--bg);">
                            <div style="flex:1">
                                <h1 style="margin:0;">${this.activeProfile}</h1>
                                <p style="color:var(--sec-text); margin:5px 0;">${this.formatViews(subCount)} abonn√©s ‚Ä¢ ${u.bio || 'Aucune description'}</p>
                            </div>
                            ${!isMe ? `<button onclick="app.toggleSub()" class="sub-btn" style="background:${this.isSubscribed(this.activeProfile) ? '#222' : 'white'}; color:${this.isSubscribed(this.activeProfile) ? 'white' : 'black'}">${this.isSubscribed(this.activeProfile) ? 'ABONN√â' : 'S\'ABONNER'}</button>` : ''}
                        </div>
                        <div class="profile-tabs" style="display:flex; border-bottom:1px solid #333; margin-bottom:20px;">
                            <div class="tab active" onclick="app.switchTab('vids', this)">VID√âOS</div>
                            <div class="tab" onclick="app.switchTab('posts', this)">POSTS</div>
                            <div class="tab" onclick="app.switchTab('about', this)">√Ä PROPOS</div>
                        </div>
                        <div id="profile-content-area" class="video-grid"></div>
                    </div>
                `;
                this.switchTab('vids');
            },

            editProfile: function() {
                const u = this.data.users[this.user.name];
                const newBio = prompt("Votre nouvelle bio :", u.bio || "");
                const newAvatar = prompt("URL de votre nouvel avatar :", u.avatar);
                const newBanner = prompt("URL de votre nouvelle banni√®re :", u.banner);

                if (newBio !== null) u.bio = newBio;
                if (newAvatar) u.avatar = newAvatar;
                if (newBanner) u.banner = newBanner;

                this.saveGist();
                this.renderProfile();
                this.updateUI();
            },

            // --- 16. SYST√àME D'HISTORIQUE ---
            addToHistory: function(id) {
                this.history = this.history.filter(vidId => vidId !== id);
                this.history.unshift(id);
                if (this.history.length > 50) this.history.pop();
                localStorage.setItem('v_history', JSON.stringify(this.history));
            },

            renderHistory: function() {
                const container = document.getElementById('view-history');
                container.innerHTML = "<h2>Votre historique</h2>";
                const vids = this.history.map(id => this.data.videos.find(v => v.id == id)).filter(v => v);
                
                if (vids.length === 0) {
                    container.innerHTML += "<p style='color:var(--sec-text)'>Aucune vid√©o vue r√©cemment.</p>";
                    return;
                }
                
                const grid = document.createElement('div');
                grid.className = "video-grid";
                grid.innerHTML = vids.map(v => this.createVideoCard(v)).join('');
                container.appendChild(grid);
            },

            // --- 17. PANEL ADMIN (GESTION DE L'EMPIRE) ---
            renderAdmin: function() {
                const modal = document.getElementById('modal-admin');
                const content = document.getElementById('admin-panel-content');
                modal.style.display = 'flex';

                content.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div class="admin-box" style="background:rgba(255,0,0,0.1); border:1px solid var(--red);">
                            <h3>Danger Zone</h3>
                            <button onclick="app.resetData()" style="background:var(--red); border:none; color:white; padding:10px; border-radius:5px; cursor:pointer;">R√©initialiser tout le Gist</button>
                        </div>
                        <div class="admin-box">
                            <h3>Annonces Globales</h3>
                            <textarea id="adm-ann-txt" style="width:100%; height:60px; background:#000; color:white; border:1px solid #333; border-radius:5px;">${this.data.annonces?.[0]?.text || ''}</textarea>
                            <button onclick="app.saveAnn()" style="margin-top:10px; background:var(--blue); border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">Diffuser l'annonce</button>
                        </div>
                    </div>
                    <div style="margin-top:20px;">
                        <h3>Vid√©os Signal√©es / Gestion</h3>
                        <div style="max-height:300px; overflow-y:auto;">
                            ${this.data.videos.map(v => `
                                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #333;">
                                    <span>${v.title} (@${v.author})</span>
                                    <button onclick="app.deleteVideo('${v.id}')" style="color:red; background:none; border:none; cursor:pointer;">Supprimer</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            deleteVideo: async function(id) {
                if (!confirm("Supprimer d√©finitivement cette vid√©o ?")) return;
                this.data.videos = this.data.videos.filter(v => v.id !== id);
                await this.saveGist();
                this.renderAdmin();
                this.renderHome();
            },
            // --- 18. GESTION DU LECTEUR (PLAYER LOGIC) ---
            openPlayer: function(id) {
                const v = this.data.videos.find(x => x.id === id);
                if (!v) return;
                this.activeVid = v;
                
                // Marquer comme vue (Stats Titan)
                v.views++;
                this.stats.views++;
                this.addToHistory(v.id);
                localStorage.setItem('visiona_stats', JSON.stringify(this.stats));

                const overlay = document.getElementById('player-overlay');
                const video = document.getElementById('main-video');
                
                // Remplissage des donn√©es
                video.src = v.url;
                document.getElementById('video-title').innerText = v.title;
                document.getElementById('v-desc-content').innerText = v.description || "Aucune description.";
                document.getElementById('v-stats-line').innerText = `${this.formatViews(v.views)} vues ‚Ä¢ ${this.timeAgo(v.date)}`;
                
                // Infos Auteur
                const author = this.data.users[v.author] || { avatar: 'https://via.placeholder.com/40', followers: {} };
                document.getElementById('v-author-name').innerText = v.author;
                document.getElementById('v-author-avatar').src = author.avatar;
                document.getElementById('v-author-subs').innerText = `${this.formatViews(Object.keys(author.followers || {}).length)} abonn√©s`;
                
                // √âtat du bouton S'abonner
                const subBtn = document.getElementById('player-sub-btn');
                if (this.isSubscribed(v.author)) {
                    subBtn.innerText = "ABONN√â";
                    subBtn.style.background = "#222";
                    subBtn.style.color = "white";
                } else {
                    subBtn.innerText = "S'ABONNER";
                    subBtn.style.background = "white";
                    subBtn.style.color = "black";
                }

                overlay.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Bloque le scroll arri√®re
                
                this.renderComments();
                this.renderSuggestions();
                this.saveGist(); // Sauvegarde la vue
            },

            closePlayer: function() {
                const overlay = document.getElementById('player-overlay');
                const video = document.getElementById('main-video');
                if(overlay) overlay.style.display = 'none';
                if(video) {
                    video.pause();
                    video.src = "";
                }
                this.activeVid = null;
                document.body.style.overflow = 'auto';
            },

            renderSuggestions: function() {
                const list = document.getElementById('suggestions-list');
                const related = this.data.videos
                    .filter(v => v.id !== this.activeVid.id && !v.isShort)
                    .sort(() => 0.5 - Math.random()) // M√©lange
                    .slice(0, 10);

                list.innerHTML = related.map(v => `
                    <div style="display:flex; gap:10px; margin-bottom:12px; cursor:pointer;" onclick="app.openPlayer('${v.id}')">
                        <div style="width:160px; height:90px; border-radius:8px; overflow:hidden; flex-shrink:0;">
                            <img src="${v.thumb}" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div style="flex:1;">
                            <b style="font-size:14px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${v.title}</b>
                            <p style="font-size:12px; color:var(--sec-text); margin:4px 0;">${v.author}</p>
                            <p style="font-size:12px; color:var(--sec-text);">${this.formatViews(v.views)} vues</p>
                        </div>
                    </div>
                `).join('');
            },

            // --- 19. SYST√àME DE COMMUNAUT√â (POSTS) ---
            renderPosts: function() {
                const view = document.getElementById('view-posts');
                view.innerHTML = `
                    <div style="max-width:600px; margin:0 auto;">
                        <h2>Communaut√©</h2>
                        ${this.user ? `
                        <div style="background:var(--hover); padding:15px; border-radius:12px; margin-bottom:30px;">
                            <textarea id="post-input" placeholder="Quoi de neuf ?" style="width:100%; background:none; border:none; border-bottom:1px solid #444; color:white; padding:10px 0; outline:none; font-family:inherit; resize:none;"></textarea>
                            <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                                <button onclick="app.createPost()" style="background:var(--blue); color:black; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">Publier</button>
                            </div>
                        </div>` : ''}
                        <div id="posts-list"></div>
                    </div>
                `;
                this.updatePostsList();
            },

            createPost: async function() {
                const txt = document.getElementById('post-input').value.trim();
                if (!txt) return;

                const newPost = {
                    id: "p" + Date.now(),
                    author: this.user.name,
                    text: txt,
                    date: Date.now(),
                    likes: 0
                };

                if (!this.data.posts) this.data.posts = [];
                this.data.posts.unshift(newPost);
                await this.saveGist();
                this.renderPosts();
            },

            updatePostsList: function() {
                const list = document.getElementById('posts-list');
                if (!list) return;

                const posts = this.data.posts || [];
                list.innerHTML = posts.map(p => `
                    <div style="background:var(--hover); padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #333;">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                            <img src="${this.data.users[p.author]?.avatar || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:50%;">
                            <div>
                                <b style="display:block;">${p.author}</b>
                                <small style="color:var(--sec-text);">${this.timeAgo(p.date)}</small>
                            </div>
                        </div>
                        <p style="white-space:pre-wrap; line-height:1.5;">${p.text}</p>
                        <div style="margin-top:15px; display:flex; gap:20px; color:var(--sec-text); font-size:14px;">
                            <span style="cursor:pointer;" onclick="app.likePost('${p.id}')">üëç ${p.likes || 0}</span>
                            <span style="cursor:pointer;">üí¨ 0</span>
                        </div>
                    </div>
                `).join('');
            },

            // --- 20. SYST√àME DE REMERCIEMENTS (THANKS) ---
            renderThanks: function() {
                const view = document.getElementById('view-thanks');
                if (!view) return;
                const thanks = this.data.thanks || [];
                view.innerHTML = `
                    <div style="text-align:center; padding:40px 20px;">
                        <h1 style="color:var(--gold);">üíé Donateurs & Contributeurs</h1>
                        <p style="color:var(--sec-text);">Ceux qui font vivre Visiona Titan</p>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:20px; margin-top:40px;">
                            ${thanks.map(t => `
                                <div style="background:var(--hover); padding:20px; border-radius:15px; border:1px solid var(--gold);">
                                    <h3 style="margin:0;">${t.name}</h3>
                                    <p style="font-size:12px; color:var(--gold);">${t.role}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },
            // --- 21. MOTEUR DE CALCULS & FORMATTAGE (LOGIQUE INTERNE) ---
            timeAgo: function(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = Math.floor(seconds / 31536000);
                if (interval >= 1) return `il y a ${interval} an${interval > 1 ? 's' : ''}`;
                interval = Math.floor(seconds / 2592000);
                if (interval >= 1) return `il y a ${interval} mois`;
                interval = Math.floor(seconds / 86400);
                if (interval >= 1) return `il y a ${interval} jour${interval > 1 ? 's' : ''}`;
                interval = Math.floor(seconds / 3600);
                if (interval >= 1) return `il y a ${interval} heure${interval > 1 ? 's' : ''}`;
                interval = Math.floor(seconds / 60);
                if (interval >= 1) return `il y a ${interval} minute${interval > 1 ? 's' : ''}`;
                return `√† l'instant`;
            },

            formatViews: function(num) {
                if (!num) return "0";
                if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
                if (num >= 1000) return (num / 1000).toFixed(1) + "k";
                return num.toString();
            },

            isSubscribed: function(authorName) {
                if (!this.user || !this.data.users[this.user.name]) return false;
                const mySubs = this.data.users[this.user.name].subs || {};
                return !!mySubs[authorName];
            },

            // --- 22. SYST√àME DE MEMBRES (NIVEAUX D'ABONNEMENT) ---
            openJoinModal: function() {
                if (!this.user) return this.openModal('modal-auth');
                this.openModal('modal-join');
                const content = document.getElementById('join-content');
                content.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                        <div class="stat-card" style="border:1px solid #cd7f32;">
                            <h4>BRONZE</h4><p>1.99‚Ç¨/mois</p>
                            <button onclick="app.buyLevel('Bronze')" style="width:100%; border-radius:5px; border:none; padding:5px; cursor:pointer;">Rejoindre</button>
                        </div>
                        <div class="stat-card" style="border:1px solid #c0c0c0;">
                            <h4>ARGENT</h4><p>4.99‚Ç¨/mois</p>
                            <button onclick="app.buyLevel('Argent')" style="width:100%; border-radius:5px; border:none; padding:5px; cursor:pointer;">Rejoindre</button>
                        </div>
                        <div class="stat-card" style="border:1px solid var(--gold);">
                            <h4>OR</h4><p>9.99‚Ç¨/mois</p>
                            <button onclick="app.buyLevel('Or')" style="width:100%; border-radius:5px; border:none; padding:5px; cursor:pointer;">Rejoindre</button>
                        </div>
                    </div>
                `;
            },

            buyLevel: async function(lvl) {
                const u = this.data.users[this.user.name];
                u.membership = lvl;
                u.badge = lvl === 'Or' ? 'üëë' : (lvl === 'Argent' ? 'ü•à' : 'ü•â');
                await this.saveGist();
                alert(`F√©licitations ! Vous √™tes maintenant membre ${lvl}`);
                this.closeModals();
                this.renderProfile();
            },

            // --- 23. MOTEUR DE RENDU DES STATISTIQUES (FIX) ---
            renderStats: function() {
                const container = document.getElementById('view-stats');
                if (!container) return;
                
                const hours = Math.floor(this.stats.time / 3600);
                const mins = Math.floor((this.stats.time % 3600) / 60);
                const progress = (this.stats.time % 3600) / 36; // Pourcentage vers prochain niveau

                container.innerHTML = `
                    <div style="max-width:800px; margin:0 auto; padding:20px;">
                        <h1 style="border-left:5px solid var(--blue); padding-left:15px;">Tableau de bord Titan</h1>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-val">${this.stats.level}</div>
                                <div style="color:var(--sec-text);">Niveau Actuel</div>
                                <div style="width:100%; height:4px; background:#333; margin-top:10px; border-radius:2px;">
                                    <div style="width:${progress}%; height:100%; background:var(--blue);"></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-val">${hours}h ${mins}m</div>
                                <div style="color:var(--sec-text);">Temps pass√©</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-val">${this.stats.views}</div>
                                <div style="color:var(--sec-text);">Vid√©os regard√©es</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-val">${this.stats.likes}</div>
                                <div style="color:var(--sec-text);">Interactions (Likes)</div>
                            </div>
                        </div>

                        <div style="margin-top:40px; background:var(--hover); padding:20px; border-radius:15px;">
                            <h3>üöÄ Progression vers le Niveau ${this.stats.level + 1}</h3>
                            <p>Continuez √† regarder des vid√©os pour monter en grade et d√©bloquer des badges exclusifs.</p>
                        </div>
                    </div>
                `;
            },

            // --- 24. GESTION DES ANNONCES & MODALES D'AUTH ---
            checkAnnonces: function() {
                if (this.data.annonces && this.data.annonces.length > 0) {
                    const ann = this.data.annonces[0];
                    const area = document.getElementById('alert-area');
                    area.innerHTML = `
                        <div style="background:linear-gradient(90deg, #1e3c72, #2a5298); color:white; padding:15px; border-radius:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; animation: slideIn 0.5s ease-out;">
                            <span>üì¢ <b>INFO TITAN :</b> ${ann.text}</span>
                            <button onclick="this.parentElement.remove()" style="background:none; border:none; color:white; cursor:pointer; font-size:20px;">√ó</button>
                        </div>
                    `;
                }
            },

            // --- 25. INITIALISATION FINALE DES √âV√âNEMENTS (DOM) ---
            bindEvents: function() {
                // Gestion du scroll pour les Zapps (re-d√©clenchement si besoin)
                const zappView = document.getElementById('view-zapp');
                zappView.addEventListener('scroll', () => {
                    // Logique optionnelle de chargement infini ici
                });

                // Raccourcis clavier (K pour pause, F pour plein √©cran)
                document.addEventListener('keydown', (e) => {
                    if (this.activeVid) {
                        const v = document.getElementById('main-video');
                        if (e.key.toLowerCase() === 'k') v.paused ? v.play() : v.pause();
                        if (e.key.toLowerCase() === 'f') v.requestFullscreen();
                    }
                });
            },

            addThx: async function() {
                const name = document.getElementById('thx-n').value;
                const role = document.getElementById('thx-r').value;
                if(!this.data.thanks) this.data.thanks = [];
                this.data.thanks.push({name, role});
                await this.saveGist();
                this.renderAdmin();
            }
        };

        // --- 26. LANCEMENT DU MOTEUR ---
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
            app.bindEvents();
        });
    </script>
</body>
</html>
