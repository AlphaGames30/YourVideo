<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona Titan - Alpha Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- SYST√àME DE VARIABLES (PR√âSERV√â & AM√âLIOR√â) --- */
        :root { 
            --bg: #0f0f0f; 
            --header: #0f0f0f; 
            --text: #ffffff; 
            --sec-text: #aaaaaa; 
            --hover: #272727; 
            --blue: #3ea6ff; 
            --red: #ff0000; 
            --green: #00a854; 
            --gold: #ffc107;
            --glass: rgba(255, 255, 255, 0.05);
            --sidebar-width: 240px;
        }

        /* --- BASE --- */
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Roboto', sans-serif; 
            overflow-x: hidden; 
            padding-bottom: 60px; 
            transition: background 0.5s ease;
        }

        /* --- HEADER --- */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 16px; 
            height: 56px; 
            background: var(--header); 
            position: sticky; 
            top: 0; 
            z-index: 2000; 
            border-bottom: 1px solid #222; 
        }
        .logo { font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; user-select: none; }
        .logo::before { content: '‚ñ∂'; color: var(--red); font-size: 24px; margin-right: 5px; }

        .search-box { display: flex; flex: 1; max-width: 600px; margin: 0 40px; }
        .search-box input { 
            width: 100%; 
            background: #121212; 
            border: 1px solid #333; 
            color: white; 
            padding: 10px 16px; 
            border-radius: 40px 0 0 40px; 
            outline: none; 
            font-size: 16px;
        }
        .search-box input:focus { border-color: var(--blue); }
        .search-box button { 
            background: #222; 
            border: 1px solid #333; 
            border-left: none; 
            color: white; 
            padding: 0 20px; 
            border-radius: 0 40px 40px 0; 
            cursor: pointer; 
        }

        /* --- NAVIGATION --- */
        .container { display: flex; min-height: calc(100vh - 56px); }
        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--bg); 
            padding: 12px; 
            height: calc(100vh - 56px); 
            position: fixed; 
            top: 56px; 
            overflow-y: auto; 
            border-right: 1px solid #222;
            z-index: 1000;
        }
        .nav-item { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 14px; 
            color: var(--text);
            margin-bottom: 2px;
        }
        .nav-item:hover { background: var(--hover); }
        .nav-item.active { background: var(--hover); font-weight: bold; }
        .sidebar hr { border: 0; border-top: 1px solid #333; margin: 12px 0; }

        /* --- CONTENU --- */
        .main-content { 
            flex: 1; 
            margin-left: var(--sidebar-width); 
            padding: 24px; 
            transition: margin 0.3s;
        }
        .video-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }

        /* --- CARDS --- */
        .v-card { cursor: pointer; border-radius: 12px; overflow: hidden; transition: transform 0.2s; }
        .v-card:hover { transform: scale(1.02); }
        .v-thumb { 
            width: 100%; 
            aspect-ratio: 16/9; 
            background: #222; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative; 
        }
        .v-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .v-duration { 
            position: absolute; 
            bottom: 8px; 
            right: 8px; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            padding: 2px 4px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: 500;
        }
        .live-tag { 
            position: absolute; 
            top: 8px; 
            left: 8px; 
            background: var(--red); 
            color: white; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: bold; 
            font-size: 12px; 
        }

        /* --- ZAPP (VERTICAL TIKTOK) --- */
        .zapp-view { 
            display: none; 
            height: calc(100vh - 100px); 
            overflow-y: scroll; 
            scroll-snap-type: y mandatory; 
            max-width: 420px; 
            margin: 0 auto; 
            scrollbar-width: none;
        }
        .zapp-view::-webkit-scrollbar { display: none; }
        .zapp-card { 
            height: 100%; 
            scroll-snap-align: start; 
            position: relative; 
            background: #000; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            overflow: hidden;
        }
        .zapp-video { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .zapp-ui { 
            position: absolute; 
            right: 12px; 
            bottom: 40px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            z-index: 10; 
            align-items: center;
        }
        .zapp-btn { 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: white; 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px;
            backdrop-filter: blur(10px);
        }
        .zapp-btn small { font-size: 10px; margin-top: 2px; }

        /* --- PLAYER --- */
        #player-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: var(--bg); 
            z-index: 3000; 
            overflow-y: auto; 
            padding: 20px; 
        }
        .player-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            display: grid; 
            grid-template-columns: 1fr 380px; 
            gap: 24px; 
        }

        /* --- MODALS --- */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.8); 
            z-index: 4000; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(8px);
        }
        .modal-content { 
            background: #1e1e1e; 
            padding: 30px; 
            border-radius: 16px; 
            width: 90%; 
            max-width: 500px; 
            border: 1px solid #333;
        }

        /* --- MOBILE --- */
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .player-container { grid-template-columns: 1fr; }
            .mobile-nav { 
                display: flex !important; 
                position: fixed; 
                bottom: 0; 
                width: 100%; 
                background: #0f0f0f; 
                border-top: 1px solid #222; 
                height: 60px; 
                justify-content: space-around; 
                align-items: center; 
                z-index: 2500; 
            }
        }
        .mobile-nav { display: none; }
    </style>
</head>
    <body id="visiona-titan">
    <header>
        <div class="logo" onclick="app.eggClick()">Visiona</div>
        <div class="search-box">
            <input type="text" id="mainSearch" placeholder="Rechercher sur Visiona..." onkeyup="if(event.key==='Enter') app.search()">
            <button onclick="app.search()">üîç</button>
        </div>
        <div style="display:flex; gap:18px; align-items:center;">
            <button class="icon-btn" onclick="app.toggleUploadMenu()" style="background:none; border:none; color:white; font-size:22px; cursor:pointer;" title="Cr√©er">‚ûï</button>
            <div style="position:relative; cursor:pointer;" onclick="app.showNotifs()">
                <span style="font-size:22px;">üîî</span>
                <span id="notif-count" style="position:absolute; top:-5px; right:-5px; background:var(--red); font-size:10px; padding:2px 5px; border-radius:10px; display:none;">0</span>
            </div>
            <div id="user-pdp-header" onclick="app.toggleProfileMenu()" style="width:34px; height:34px; border-radius:50%; background:#333; cursor:pointer; overflow:hidden; border:1px solid #444;">
                <img id="header-avatar-img" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
            </div>
        </div>
    </header>

    <div id="profile-dropdown" style="display:none; position:fixed; right:16px; top:60px; background:#282828; border:1px solid #444; border-radius:12px; width:250px; z-index:5000; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <div style="padding:15px; border-bottom:1px solid #444; display:flex; align-items:center; gap:10px;">
            <img id="dropdown-avatar" src="" style="width:40px; height:40px; border-radius:50%; background:#444;">
            <b id="dropdown-username">Non connect√©</b>
        </div>
        <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma cha√Æne</div>
        <div class="nav-item" onclick="app.nav('stats')">üìä Mes Statistiques</div>
        <div id="admin-panel-btn" class="nav-item" style="display:none; color:var(--red);" onclick="app.openModal('modal-admin')">üõ°Ô∏è Panel Administrateur</div>
        <div class="nav-item" onclick="app.logout()">üö™ D√©connexion</div>
    </div>

    <div class="container">
        <aside class="sidebar">
            <div class="nav-item active" onclick="app.nav('home', this)">üè† Accueil</div>
            <div class="nav-item" onclick="app.nav('zapp', this)">‚ö° Zapp</div>
            <div class="nav-item" onclick="app.nav('subs', this)">üîî Abonnements</div>
            <hr>
            <div class="nav-item" onclick="app.nav('history', this)">üïí Historique</div>
            <div class="nav-item" onclick="app.nav('posts', this)">üìù Communaut√©</div>
            <div class="nav-item" onclick="app.openModal('modal-direct')">üî¥ Direct</div>
            <hr>
            <div class="nav-item" onclick="app.nav('stats', this)">üìä Statistiques Titan</div>
            <div class="nav-item" onclick="app.nav('thanks', this)">üíé Remerciements</div>
            <hr>
            <div id="sidebar-subs-title" style="padding:0 12px; font-size:12px; color:var(--sec-text); margin-bottom:10px;">VOS ABONNEMENTS</div>
            <div id="subs-list-container"></div>
        </aside>

        <main class="main-content">
            <div id="alert-area"></div>

            <section id="view-home">
                <div class="video-grid" id="home-grid"></div>
            </section>

            <section id="view-zapp" class="zapp-view"></section>

            <section id="view-profile" style="display:none;">
                <div id="prof-banner-img" class="banner" style="height:200px; background-size:cover; background-position:center; border-radius:15px;"></div>
                <div style="display:flex; align-items:center; gap:25px; padding:25px 0;">
                    <img id="prof-avatar-img" src="" style="width:100px; height:100px; border-radius:50%; border:4px solid var(--bg);">
                    <div style="flex:1">
                        <h1 id="prof-display-name" style="margin:0;"></h1>
                        <p id="prof-sub-stats" style="color:var(--sec-text); margin:5px 0;"></p>
                    </div>
                    <div id="prof-btn-container"></div>
                </div>
                <div class="p-tabs" style="display:flex; border-bottom:1px solid #333; margin-bottom:20px;">
                    <div class="tab active" onclick="app.switchTab('vids', this)" style="padding:15px 25px; cursor:pointer;">VID√âOS</div>
                    <div class="tab" onclick="app.switchTab('zapps', this)" style="padding:15px 25px; cursor:pointer;">ZAPPS</div>
                    <div class="tab" onclick="app.switchTab('posts', this)" style="padding:15px 25px; cursor:pointer;">POSTS</div>
                    <div class="tab" onclick="app.switchTab('about', this)" style="padding:15px 25px; cursor:pointer;">√Ä PROPOS</div>
                </div>
                <div id="prof-content-area" class="video-grid"></div>
            </section>

            <section id="view-stats" style="display:none;">
                <h2>Statistiques de Visionnage Titan</h2>
                <div id="stats-cards-container" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;"></div>
            </section>
        </main>
    </div>

    <div id="modal-direct" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h2 style="margin-top:0;">Lancer un Direct üî¥</h2>
            <div style="background:black; border-radius:12px; overflow:hidden; aspect-ratio:16/9; margin-bottom:15px;">
                <video id="direct-preview" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover;"></video>
            </div>
            <input type="text" id="direct-title" placeholder="Titre du direct..." style="width:100%; padding:12px; background:#121212; border:1px solid #333; color:white; border-radius:8px; margin-bottom:15px;">
            
            <div style="display:flex; gap:10px;">
                <button onclick="app.startCamera()" style="flex:1; padding:12px; background:#444; color:white; border:none; border-radius:8px; cursor:pointer;">üì∑ Tester Cam√©ra</button>
                <button onclick="app.publishLive()" style="flex:1; padding:12px; background:var(--red); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">üöÄ PUBLIER LE DIRECT</button>
            </div>
            <button onclick="app.closeModals()" style="width:100%; margin-top:15px; background:none; border:none; color:gray; cursor:pointer;">Annuler</button>
        </div>
    </div>
        <div id="player-overlay">
        <div class="player-container">
            <div class="player-left-col">
                <div style="position: sticky; top: 0; background: var(--bg); padding-bottom: 20px; z-index: 10;">
                    <button onclick="app.closePlayer()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer; margin-bottom:10px;">‚úï</button>
                    <div style="width:100%; aspect-ratio:16/9; background:black; border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.6);">
                        <video id="main-video" controls autoplay style="width:100%; height:100%;"></video>
                    </div>
                    <h2 id="video-title" style="margin:15px 0 8px 0; font-size:20px;">Chargement du titre...</h2>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img id="v-author-avatar" src="" style="width:40px; height:40px; border-radius:50%; background:#333; cursor:pointer;" onclick="app.goProfile(app.activeVid.author)">
                            <div>
                                <b id="v-author-name" style="cursor:pointer;" onclick="app.goProfile(app.activeVid.author)">Auteur</b>
                                <p id="v-author-subs" style="margin:0; font-size:12px; color:var(--sec-text);">0 abonn√©s</p>
                            </div>
                            <button id="player-sub-btn" onclick="app.toggleSub()" style="background:white; color:black; border:none; padding:10px 20px; border-radius:24px; font-weight:bold; margin-left:10px; cursor:pointer; transition:0.3s;">S'ABONNER</button>
                        </div>
                        
                        <div style="display:flex; gap:8px; background:var(--hover); padding:6px; border-radius:30px;">
                            <button onclick="app.handleVote('like')" class="icon-btn" style="padding:6px 16px; border-right:1px solid #444; display:flex; align-items:center; gap:8px;">
                                üëç <span id="v-likes-count">0</span>
                            </button>
                            <button onclick="app.handleVote('dislike')" class="icon-btn" style="padding:6px 16px;">
                                üëé
                            </button>
                        </div>
                    </div>

                    <div id="v-description-block" style="background:var(--hover); padding:15px; border-radius:12px; margin-top:20px; font-size:14px; line-height:1.5;">
                        <b id="v-stats-line">0 vues ‚Ä¢ il y a 2 jours</b>
                        <p id="v-desc-content" style="white-space:pre-wrap; margin-top:10px;">Description...</p>
                    </div>
                </div>

                <div class="comments-section" style="margin-top:30px;">
                    <h3 id="com-count-title">0 Commentaires</h3>
                    <div style="display:flex; gap:15px; margin-bottom:30px;">
                        <img id="user-comment-pdp" src="" style="width:40px; height:40px; border-radius:50%; background:#444;">
                        <div style="flex:1;">
                            <input type="text" id="com-input" placeholder="Ajouter un commentaire public..." style="width:100%; background:none; border:none; border-bottom:1px solid #333; color:white; padding:10px 0; outline:none; font-size:14px;">
                            <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                                <button onclick="app.postComment()" style="background:var(--blue); color:black; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">Ajouter</button>
                            </div>
                        </div>
                    </div>
                    <div id="comments-render-area"></div>
                </div>
            </div>

            <div class="player-right-col">
                <h4 style="margin-bottom:15px;">Vid√©os sugg√©r√©es</h4>
                <div id="suggestions-list"></div>
            </div>
        </div>
    </div>

    <div id="modal-upload" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">Mettre en ligne une vid√©o</h2>
            <div style="max-height:70vh; overflow-y:auto; padding-right:10px;">
                <label style="font-size:14px; color:var(--sec-text);">Titre (obligatoire)</label>
                <input type="text" id="upTitle" placeholder="Ex: Mon Meilleur Clip !" style="width:100%; padding:12px; margin:8px 0 20px 0; background:#121212; border:1px solid #333; color:white; border-radius:8px;">
                
                <label style="font-size:14px; color:var(--sec-text);">Description</label>
                <textarea id="upDesc" placeholder="Parlez-nous de votre vid√©o..." style="width:100%; height:100px; padding:12px; margin:8px 0 20px 0; background:#121212; border:1px solid #333; color:white; border-radius:8px; font-family:inherit;"></textarea>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label style="font-size:12px;">Fichier Vid√©o</label>
                        <input type="file" id="upVideoFile" accept="video/*" style="width:100%; margin-top:5px; font-size:12px;">
                    </div>
                    <div>
                        <label style="font-size:12px;">Miniature (Thumbnail)</label>
                        <input type="file" id="upThumbFile" accept="image/*" style="width:100%; margin-top:5px; font-size:12px;">
                    </div>
                </div>

                <div style="background:rgba(62,166,255,0.1); padding:15px; border-radius:10px; border:1px dashed var(--blue); margin-bottom:20px;">
                    <label style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                        <input type="checkbox" id="upIsShort" style="width:18px; height:18px;">
                        <span style="font-weight:500;">üöÄ Publier en tant que Zapp (Short)</span>
                    </label>
                    <p style="font-size:11px; color:var(--sec-text); margin:8px 0 0 30px;">Les Zapps sont au format vertical (9:16) et durent moins de 60s.</p>
                </div>

                <div id="upProgressZone" style="display:none; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                        <span id="upProgressStatus">Upload en cours...</span>
                        <span id="upPercent">0%</span>
                    </div>
                    <div style="width:100%; height:6px; background:#333; border-radius:3px; overflow:hidden;">
                        <div id="upProgressBar" style="width:0%; height:100%; background:var(--blue); transition:0.3s;"></div>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="app.closeModals()" style="flex:1; padding:12px; background:none; border:1px solid #444; color:white; border-radius:8px; cursor:pointer;">Annuler</button>
                <button onclick="app.handleUpload()" style="flex:2; padding:12px; background:var(--blue); color:black; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">PUBLIER LA VID√âO</button>
            </div>
        </div>
    </div>
        <div id="modal-auth" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h2>Rejoindre Visiona</h2>
            <p style="color:var(--sec-text); margin-bottom:20px;">Connectez-vous pour interagir, publier et vous abonner.</p>
            <input type="text" id="auth-username" placeholder="Nom d'utilisateur" style="width:100%; padding:12px; background:#121212; border:1px solid #333; color:white; border-radius:8px; margin-bottom:10px;">
            <input type="email" id="auth-email" placeholder="Email" style="width:100%; padding:12px; background:#121212; border:1px solid #333; color:white; border-radius:8px; margin-bottom:20px;">
            <button onclick="app.handleAuth()" style="width:100%; padding:14px; background:white; color:black; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">SE CONNECTER / S'INSCRIRE</button>
            <button onclick="app.closeModals()" style="background:none; border:none; color:gray; margin-top:15px; cursor:pointer;">Annuler</button>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content" style="max-width:800px; width:95%;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üõ°Ô∏è Panel Titan Administration</h2>
                <button onclick="app.closeModals()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">‚úï</button>
            </div>
            <div id="admin-panel-content"></div>
        </div>
    </div>
        <script>
        // --- 1. CONFIGURATION ET √âTAT GLOBAL ---
        // On conserve tes URLs de base du Worker et du Gist
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
        const WORKER_URL = "https://mytubeupload.edonis-imbert.workers.dev/";

        const app = {
            data: { 
                videos: [], 
                users: {}, 
                posts: [], 
                thanks: [], 
                annonces: [], 
                notifications: [] 
            },
            user: JSON.parse(localStorage.getItem('visiona_user')),
            stats: JSON.parse(localStorage.getItem('visiona_stats')) || { time: 0, views: 0, likes: 0, level: 1 },
            history: JSON.parse(localStorage.getItem('v_history')) || [],
            cooldowns: JSON.parse(localStorage.getItem('v_cd')) || {},
            activeVid: null,
            activeProfile: null,
            eggCount: 0,

            // --- 2. INITIALISATION (L'ALLUMAGE) ---
            init: async function() {
                console.log("Titan Engine : Initialisation...");
                await this.fetchData();
                this.updateUI();
                this.nav('home');
                this.startStatsTimer();
                this.initZappObserver(); // Pour le fix du son et scroll
                this.checkAnnonces();
                
                // Fermeture des menus au clic ext√©rieur
                window.onclick = (e) => {
                    if (!e.target.closest('#user-pdp-header') && !e.target.closest('#profile-dropdown')) {
                        document.getElementById('profile-dropdown').style.display = 'none';
                    }
                };
            },
            
            handleAuth: async function() {
                const name = document.getElementById('auth-username').value.trim();
                const email = document.getElementById('auth-email').value.trim();
                if (!name || !email) return alert("Remplissez tous les champs !");

                // Cr√©ation ou r√©cup√©ration de l'utilisateur dans la base Titan
                if (!this.data.users[name]) {
                    this.data.users[name] = {
                        email: email,
                        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`,
                        banner: "https://images.unsplash.com/photo-1579546678195-a9d20f0b4d44",
                        subs: {},
                        followers: {},
                        date: Date.now()
                    };
                    await this.saveGist();
                }

                const userData = { name: name, email: email };
                localStorage.setItem('visiona_user', JSON.stringify(userData));
                this.user = userData;
                
                alert(`Bienvenue ${name} !`);
                location.reload();
            },

            // --- 3. GESTION DES DONN√âES (GIST & WORKER) ---
            fetchData: async function() {
                try {
                    const r = await fetch(GIST_URL + "?t=" + Date.now());
                    if (!r.ok) throw new Error("Gist inaccessible");
                    this.data = await r.json();
                    console.log("Synchronisation Gist r√©ussie.");
                } catch(e) {
                    console.error("Erreur Sync :", e);
                }
            },

            saveGist: async function() {
                if (!this.user) return;
                try {
                    await fetch(WORKER_URL, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            files: { "video.json": { content: JSON.stringify(this.data, null, 2) } }
                        })
                    });
                    console.log("Sauvegarde Cloud effectu√©e.");
                } catch(e) {
                    console.error("Erreur Sauvegarde :", e);
                }
            },

            // --- 4. MOTEUR DE NAVIGATION (FIX BOUTONS SIDEBAR) ---
            nav: function(viewId, element = null) {
                // On ferme tout ce qui est ouvert
                this.closePlayer();
                this.closeModals();
                
                // Gestion visuelle de la sidebar
                if (element) {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    element.classList.add('active');
                }

                // Masquage de toutes les sections
                const sections = ['view-home', 'view-zapp', 'view-profile', 'view-stats', 'view-history', 'view-posts', 'view-subs', 'view-thanks'];
                sections.forEach(s => {
                    const el = document.getElementById(s);
                    if (el) el.style.display = 'none';
                });

                // Affichage de la vue demand√©e
                const target = document.getElementById('view-' + viewId);
                if (target) {
                    target.style.display = (viewId === 'home' || viewId === 'profile') ? 'block' : 'block';
                    
                    // Chargement sp√©cifique des donn√©es par vue
                    switch(viewId) {
                        case 'home': this.renderHome(); break;
                        case 'zapp': this.renderZapp(); break;
                        case 'stats': this.renderStats(); break;
                        case 'history': this.renderHistory(); break;
                        case 'posts': this.renderPosts(); break;
                        case 'subs': this.renderSubs(); break;
                        case 'thanks': this.renderThanks(); break;
                    }
                }
                window.scrollTo(0,0);
            },

            // --- 5. INTERFACE ET PROFIL (FIX BOUTON CLOCHE & MENU) ---
            updateUI: function() {
                if (this.user) {
                    const uData = this.data.users[this.user.name] || {};
                    document.getElementById('dropdown-username').innerText = this.user.name;
                    document.getElementById('header-avatar-img').src = uData.avatar || 'https://via.placeholder.com/34';
                    document.getElementById('header-avatar-img').style.display = 'block';
                    document.getElementById('dropdown-avatar').src = uData.avatar || 'https://via.placeholder.com/40';
                    document.getElementById('user-comment-pdp').src = uData.avatar || 'https://via.placeholder.com/40';

                    // Activation du Panel Admin si autoris√© (Edonis ou Admin)
                    if (this.user.name === "Admin" || this.user.email.includes("edonis")) {
                        document.getElementById('admin-panel-btn').style.display = 'flex';
                    }
                }
                this.renderSubsSidebar();
            },

            toggleProfileMenu: function() {
                if (!this.user) return this.openModal('modal-auth'); // √Ä venir dans Partie 5
                const menu = document.getElementById('profile-dropdown');
                menu.style.display = (menu.style.display === 'none') ? 'block' : 'none';
            },

            toggleUploadMenu: function() {
                if (!this.user) return this.openModal('modal-auth');
                this.openModal('modal-upload');
            },

            showNotifs: function() {
                alert("Vous n'avez aucune nouvelle notification pour le moment.");
            },

            // --- 6. GESTION DU TEMPS ET DUR√âE (FIX DUR√âES R√âELLES) ---
            formatDuration: function(seconds) {
                if (!seconds) return "0:00";
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60);
                return (h > 0 ? h + ":" : "") + (m < 10 && h > 0 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
            },

            getVideoDuration: function(url) {
                // Cette fonction simule l'extraction de dur√©e r√©elle via un √©l√©ment vid√©o fant√¥me
                return new Promise((resolve) => {
                    const v = document.createElement('video');
                    v.src = url;
                    v.onloadedmetadata = () => resolve(this.formatDuration(v.duration));
                    v.onerror = () => resolve("--:--");
                });
            },

            startStatsTimer: function() {
                setInterval(() => {
                    if (this.activeVid) {
                        this.stats.time += 1; // On compte chaque seconde
                        if (this.stats.time % 60 === 0) { // On sauvegarde chaque minute
                            localStorage.setItem('visiona_stats', JSON.stringify(this.stats));
                        }
                    }
                }, 1000);
            },
            // --- 7. RENDU DE L'ACCUEIL (HOME) ---
            renderHome: function() {
                const grid = document.getElementById('home-grid');
                if (!grid) return;
                
                // Filtrage : On ne garde que les vid√©os longues pour l'accueil
                const videos = this.data.videos.filter(v => !v.isShort);
                
                if (videos.length === 0) {
                    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px;">
                        <p style="color:var(--sec-text);">Aucune vid√©o disponible pour le moment.</p>
                    </div>`;
                    return;
                }

                grid.innerHTML = videos.map(v => this.createVideoCard(v)).join('');
            },

            // --- 8. CR√âATION D'UNE CARTE VID√âO (AVEC DUR√âE R√âELLE) ---
            createVideoCard: function(v) {
                const author = this.data.users[v.author] || { avatar: "" };
                const isLive = v.isLive ? `<div class="live-tag">DIRECT</div>` : '';
                
                // On utilise la dur√©e stock√©e ou on met un placeholder intelligent
                const displayDuration = v.duration || "0:00";
                
                return `
                <div class="v-card" onclick="app.openPlayer('${v.id}')">
                    <div class="v-thumb">
                        <img src="${v.thumb}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x168/222/fff?text=Visiona'">
                        ${isLive}
                        <div class="v-duration">${displayDuration}</div>
                    </div>
                    <div style="display:flex; gap:12px; margin-top:12px; padding:0 4px;">
                        <img src="${author.avatar || 'https://via.placeholder.com/36'}" 
                             style="width:36px; height:36px; border-radius:50%; object-fit:cover;" 
                             onclick="event.stopPropagation(); app.goProfile('${v.author}')">
                        <div style="overflow:hidden;">
                            <b style="display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.2; font-size:14px;" title="${v.title}">${v.title}</b>
                            <p style="font-size:12px; color:var(--sec-text); margin:4px 0;" onclick="event.stopPropagation(); app.goProfile('${v.author}')">${v.author}</p>
                            <p style="font-size:12px; color:var(--sec-text);">${this.formatViews(v.views)} vues ‚Ä¢ ${this.timeAgo(v.date)}</p>
                        </div>
                    </div>
                </div>`;
            },

            // --- 9. SYST√àME ZAPP (FIX DU SON & SCROLL) ---
            renderZapp: function() {
                const container = document.getElementById('view-zapp');
                const zapps = this.data.videos.filter(v => v.isShort);
                
                if (zapps.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding-top:100px;">Aucun Zapp disponible.</div>`;
                    return;
                }

                container.innerHTML = zapps.map((z, idx) => `
                    <div class="zapp-card" id="zapp-${idx}">
                        <video class="zapp-video" src="${z.url}" loop muted playsinline onclick="app.toggleZappAudio(this)"></video>
                        <div class="zapp-ui">
                            <div class="zapp-btn" onclick="app.handleZappVote('${z.id}', 'like', this)">
                                <span>‚ù§Ô∏è</span>
                                <small>${z.likes || 0}</small>
                            </div>
                            <div class="zapp-btn" onclick="app.openPlayer('${z.id}')">
                                <span>üí¨</span>
                                <small>${z.comments?.length || 0}</small>
                            </div>
                            <div class="zapp-btn" onclick="app.shareVideo('${z.id}')">
                                <span>üì§</span>
                            </div>
                            <img src="${this.data.users[z.author]?.avatar || ''}" 
                                 style="width:45px; height:45px; border-radius:50%; border:2px solid white; cursor:pointer;"
                                 onclick="app.goProfile('${z.author}')">
                        </div>
                        <div style="position:absolute; bottom:20px; left:15px; right:80px; text-shadow:2px 2px 4px rgba(0,0,0,0.8);">
                            <b style="font-size:18px;">@${z.author}</b>
                            <p style="margin:5px 0; font-size:14px;">${z.title}</p>
                            <div style="display:flex; align-items:center; gap:8px; font-size:12px;">
                                <span class="music-icon">üéµ</span> 
                                <marquee scrollamount="3" style="width:150px;">Son original - ${z.author}</marquee>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                this.initZappObserver();
            },

            // FIX DU SON : Active l'audio au clic (car les navigateurs bloquent l'autoplay sonore)
            toggleZappAudio: function(video) {
                video.muted = !video.muted;
                if (!video.muted) {
                    video.volume = 1.0;
                    console.log("Audio activ√© pour le Zapp");
                }
            },

            // FIX DU SCROLL : G√®re l'activation/arr√™t automatique
            initZappObserver: function() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const video = entry.target.querySelector('video');
                        if (entry.isIntersecting) {
                            video.play().catch(e => console.log("Autoplay bloqu√©"));
                            // On enregistre la vue quand on arrive sur le Zapp
                            app.addView(video.closest('.zapp-card').id);
                        } else {
                            video.pause();
                        }
                    });
                }, { threshold: 0.8 });

                document.querySelectorAll('.zapp-card').forEach(card => observer.observe(card));
            },

            // --- 10. GESTION DES ABONNEMENTS (FIX BOUTON SUBS) ---
            renderSubs: function() {
                const container = document.getElementById('view-subs');
                if (!this.user) {
                    container.innerHTML = `<div style="text-align:center; padding:100px;">
                        <h2>Ne manquez rien</h2>
                        <p>Connectez-vous pour voir les vid√©os de vos cha√Ænes pr√©f√©r√©es.</p>
                        <button onclick="app.openModal('modal-auth')" style="background:var(--blue); border:none; padding:12px 24px; border-radius:20px; font-weight:bold; margin-top:20px; cursor:pointer;">SE CONNECTER</button>
                    </div>`;
                    return;
                }

                const mySubs = this.data.users[this.user.name]?.subs || {};
                const subNames = Object.keys(mySubs);
                
                if (subNames.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:100px;">Vous n'√™tes abonn√© √† aucune cha√Æne.</div>`;
                    return;
                }

                // On r√©cup√®re les vid√©os des gens auxquels on est abonn√©
                const subVids = this.data.videos.filter(v => subNames.includes(v.author));
                container.innerHTML = `<h2>Vid√©os de vos abonnements</h2>
                <div class="video-grid">${subVids.map(v => this.createVideoCard(v)).join('')}</div>`;
            },

            renderSubsSidebar: function() {
                const container = document.getElementById('subs-list-container');
                if (!this.user || !container) return;
                
                const mySubs = this.data.users[this.user.name]?.subs || {};
                container.innerHTML = Object.keys(mySubs).map(name => {
                    const u = this.data.users[name] || {};
                    return `
                    <div class="nav-item" onclick="app.goProfile('${name}')" style="gap:12px; padding:8px 12px;">
                        <img src="${u.avatar || 'https://via.placeholder.com/24'}" style="width:24px; height:24px; border-radius:50%;">
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${name}</span>
                    </div>`;
                }).join('');
            },

            // --- 11. HISTORIQUE (FIX BOUTON HISTORY) ---
            renderHistory: function() {
                const container = document.getElementById('view-history');
                if (this.history.length === 0) {
                    container.innerHTML = `<h2>Historique</h2><p>Aucune vid√©o visionn√©e r√©cemment.</p>`;
                    return;
                }
                
                const historyVids = this.history.map(id => this.data.videos.find(v => v.id == id)).filter(v => v);
                container.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Historique de visionnage</h2>
                    <button onclick="app.clearHistory()" style="background:none; border:none; color:var(--blue); cursor:pointer;">Effacer tout</button>
                </div>
                <div class="video-grid">${historyVids.map(v => this.createVideoCard(v)).join('')}</div>`;
            },

            clearHistory: function() {
                if(confirm("Effacer tout l'historique ?")) {
                    this.history = [];
                    localStorage.setItem('v_history', JSON.stringify(this.history));
                    this.renderHistory();
                }
            },
            // --- 12. SYST√àME DE DIRECT (LIVE) R√âEL ---
            activeStream: null,

            startCamera: async function() {
                try {
                    this.activeStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    const preview = document.getElementById('direct-preview');
                    preview.srcObject = this.activeStream;
                    preview.muted = true; // √âviter l'√©cho en retour
                    console.log("Flux Cam√©ra activ√©");
                } catch (e) {
                    alert("Erreur : Impossible d'acc√©der √† la cam√©ra. V√©rifiez les autorisations.");
                }
            },

            // FONCTION SP√âCIALE : PARTAGE D'√âCRAN
            startScreenShare: async function() {
                try {
                    this.activeStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    const preview = document.getElementById('direct-preview');
                    preview.srcObject = this.activeStream;
                    console.log("Partage d'√©cran activ√©");
                    
                    // Si l'utilisateur arr√™te le partage via le bouton du navigateur
                    this.activeStream.getVideoTracks()[0].onended = () => {
                        alert("Partage d'√©cran termin√©.");
                    };
                } catch (e) {
                    console.error("Erreur Partage √âcran:", e);
                }
            },

            publishLive: async function() {
                const title = document.getElementById('direct-title').value.trim();
                if (!title) return alert("Donnez un titre √† votre direct !");
                if (!this.activeStream) return alert("Activez votre cam√©ra ou votre √©cran avant de publier.");

                // On simule la cr√©ation d'une entr√©e "Live" dans la base
                const newLive = {
                    id: "live_" + Date.now(),
                    title: "[EN DIRECT] " + title,
                    author: this.user.name,
                    url: "", // Dans un vrai syst√®me, on streamerait vers un serveur RTMP
                    thumb: "https://images.unsplash.com/photo-1516035069371-29a1b244cc32?auto=format&fit=crop&w=800&q=80",
                    isLive: true,
                    views: 1,
                    date: Date.now(),
                    duration: "LIVE"
                };

                this.data.videos.unshift(newLive);
                await this.saveGist();
                
                alert("Votre direct est maintenant public !");
                this.closeModals();
                this.nav('home');
                
                // On arr√™te le flux local pour √©conomiser les ressources apr√®s publication
                if(this.activeStream) {
                    this.activeStream.getTracks().forEach(track => track.stop());
                }
            },

            // --- 13. SYST√àME DE VOTES (LIKE / DISLIKE) ---
            handleVote: function(type) {
                if (!this.user) return this.openModal('modal-auth');
                const v = this.activeVid;
                if (!v) return;

                if (!v.voters) v.voters = {}; // S√©curit√© si l'objet n'existe pas

                const userVote = v.voters[this.user.name];

                if (userVote === type) {
                    // Annuler le vote si on reclique sur le m√™me
                    delete v.voters[this.user.name];
                    type === 'like' ? v.likes-- : v.dislikes--;
                } else {
                    // Si on change de vote
                    if (userVote) {
                        userVote === 'like' ? v.likes-- : v.dislikes--;
                    }
                    // Nouveau vote
                    v.voters[this.user.name] = type;
                    type === 'like' ? v.likes++ : v.dislikes++;
                    if (type === 'like') this.stats.likes++;
                }

                this.updatePlayerUI();
                this.saveGist();
            },

            // Correction sp√©cifique pour les Zapps (Shorts)
            handleZappVote: function(id, type, btnElement) {
                if (!this.user) return this.openModal('modal-auth');
                const z = this.data.videos.find(x => x.id === id);
                if (!z) return;

                if (!z.voters) z.voters = {};
                
                if (z.voters[this.user.name] === 'like') {
                    z.likes--;
                    delete z.voters[this.user.name];
                    btnElement.style.color = "white";
                } else {
                    z.likes++;
                    z.voters[this.user.name] = 'like';
                    btnElement.style.color = "var(--red)";
                }
                
                btnElement.querySelector('small').innerText = z.likes;
                this.saveGist();
            },

            // --- 14. ESPACE COMMENTAIRES INTERACTIF ---
            renderComments: function() {
                const area = document.getElementById('comments-render-area');
                const v = this.activeVid;
                if (!v.comments) v.comments = [];

                document.getElementById('com-count-title').innerText = `${v.comments.length} Commentaires`;

                area.innerHTML = v.comments.map((c, index) => {
                    const authorData = this.data.users[c.author] || {};
                    const isVidAuthor = c.author === v.author;
                    
                    return `
                    <div style="display:flex; gap:12px; margin-bottom:20px;">
                        <img src="${authorData.avatar || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <div style="flex:1;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <b style="font-size:13px; cursor:pointer;" onclick="app.goProfile('${c.author}')">@${c.author}</b>
                                ${isVidAuthor ? `<span style="background:#888; color:white; padding:1px 6px; border-radius:10px; font-size:10px;">Auteur</span>` : ''}
                                <span style="color:var(--sec-text); font-size:12px;">${this.timeAgo(c.date)}</span>
                            </div>
                            <p style="margin:5px 0; font-size:14px; color:#efefef;">${c.text}</p>
                            <div style="display:flex; align-items:center; gap:15px; margin-top:5px;">
                                <button class="comment-action-btn">üëç ${c.likes || ''}</button>
                                <button class="comment-action-btn" onclick="app.replyTo('${c.author}')">R√©pondre</button>
                                ${this.user && this.user.name === v.author ? `<button onclick="app.heartComment(${index})" style="background:none; border:none; color:var(--red); cursor:pointer;">‚ù§Ô∏è</button>` : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },

            postComment: async function() {
                if (!this.user) return this.openModal('modal-auth');
                const input = document.getElementById('com-input');
                const text = input.value.trim();
                if (!text) return;

                const newComment = {
                    author: this.user.name,
                    text: text,
                    date: Date.now(),
                    likes: 0
                };

                if (!this.activeVid.comments) this.activeVid.comments = [];
                this.activeVid.comments.unshift(newComment);
                input.value = "";
                this.renderComments();
                await this.saveGist();
            },

            replyTo: function(author) {
                const input = document.getElementById('com-input');
                input.value = `@${author} `;
                input.focus();
            },
               
            // --- 14b. FONCTIONS DE NAVIGATION ET MODALES (R√âVEIL DES BOUTONS) ---
            openModal: function(id) {
                const modal = document.getElementById(id);
                if (modal) modal.style.display = 'flex';
            },

            closeModals: function() {
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                if(this.activeStream) {
                    this.activeStream.getTracks().forEach(track => track.stop());
                }
            },

            closePlayer: function() {
                const overlay = document.getElementById('player-overlay');
                const video = document.getElementById('main-video');
                overlay.style.display = 'none';
                if(video) {
                    video.pause();
                    video.src = "";
                }
                this.activeVid = null;
                document.body.style.overflow = 'auto';
            },

            openPlayer: function(id) {
                const v = this.data.videos.find(x => x.id === id);
                if (!v) return;
                this.activeVid = v;
                
                const overlay = document.getElementById('player-overlay');
                const video = document.getElementById('main-video');
                
                video.src = v.url;
                document.getElementById('video-title').innerText = v.title;
                document.getElementById('v-desc-content').innerText = v.description || "Aucune description.";
                document.getElementById('v-stats-line').innerText = `${this.formatViews(v.views)} vues ‚Ä¢ ${this.timeAgo(v.date)}`;
                
                // Mise √† jour des infos auteur
                const author = this.data.users[v.author] || {};
                document.getElementById('v-author-name').innerText = v.author;
                document.getElementById('v-author-avatar').src = author.avatar || 'https://via.placeholder.com/40';
                document.getElementById('v-author-subs').innerText = `${Object.keys(author.followers || {}).length} abonn√©s`;
                
                overlay.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                this.renderComments();
                this.renderSuggestions();
                this.addView(id);
                
                // Mise √† jour du bouton s'abonner
                this.updateSubBtn();

                // Ajout √† l'historique local
                if (!this.history.includes(id)) {
                    this.history.unshift(id);
                    if (this.history.length > 20) this.history.pop();
                    localStorage.setItem('v_history', JSON.stringify(this.history));
                }
            },

            // --- 14c. SYST√àME D'ABONNEMENT (FONCTIONNEL) ---
            toggleSub: async function() {
                if (!this.user) return this.openModal('modal-auth');
                const targetName = this.activeVid.author;
                if (targetName === this.user.name) return alert("Vous ne pouvez pas vous abonner √† vous-m√™me !");

                const me = this.data.users[this.user.name];
                const target = this.data.users[targetName];

                if (!me.subs) me.subs = {};
                if (!target.followers) target.followers = {};

                if (me.subs[targetName]) {
                    delete me.subs[targetName];
                    delete target.followers[this.user.name];
                } else {
                    me.subs[targetName] = true;
                    target.followers[this.user.name] = true;
                }

                this.updateSubBtn();
                this.renderSubsSidebar();
                await this.saveGist();
            },

            updateSubBtn: function() {
                const btn = document.getElementById('player-sub-btn');
                if (!btn || !this.activeVid) return;
                const targetName = this.activeVid.author;
                
                if (this.user && this.data.users[this.user.name]?.subs?.[targetName]) {
                    btn.innerText = "ABONN√â";
                    btn.style.background = "var(--hover)";
                    btn.style.color = "white";
                } else {
                    btn.innerText = "S'ABONNER";
                    btn.style.background = "white";
                    btn.style.color = "black";
                }
            },

            // --- 14d. GESTION DES PROFILS ---
            goProfile: function(name) {
                this.activeProfile = name;
                this.nav('profile');
                this.renderProfile();
            },

            goMyProfile: function() {
                if (!this.user) return this.openModal('modal-auth');
                this.goProfile(this.user.name);
            },

            renderProfile: function() {
                const u = this.data.users[this.activeProfile];
                if (!u) return;

                document.getElementById('prof-display-name').innerText = this.activeProfile;
                document.getElementById('prof-avatar-img').src = u.avatar || 'https://via.placeholder.com/100';
                document.getElementById('prof-banner-img').style.backgroundImage = `url(${u.banner || 'https://via.placeholder.com/1200x200/222/444'})`;
                document.getElementById('prof-sub-stats').innerText = `${Object.keys(u.followers || {}).length} abonn√©s ‚Ä¢ ${this.data.videos.filter(v => v.author === this.activeProfile).length} vid√©os`;
                
                this.switchTab('vids');
            },

            // --- 14e. FORMATAGE (VUES & SUGGESTIONS) ---
            formatViews: function(num) {
                if (!num) return "0";
                if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
                if (num >= 1000) return (num / 1000).toFixed(1) + "k";
                return num;
            },

            renderSuggestions: function() {
                const list = document.getElementById('suggestions-list');
                const vids = this.data.videos.filter(v => v.id !== this.activeVid.id).slice(0, 10);
                
                list.innerHTML = vids.map(v => `
                    <div style="display:flex; gap:10px; margin-bottom:12px; cursor:pointer;" onclick="app.openPlayer('${v.id}')">
                        <img src="${v.thumb}" style="width:160px; aspect-ratio:16/9; border-radius:8px; object-fit:cover;">
                        <div style="flex:1;">
                            <b style="font-size:14px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${v.title}</b>
                            <p style="font-size:12px; color:var(--sec-text); margin:4px 0;">${v.author}</p>
                            <p style="font-size:12px; color:var(--sec-text);">${this.formatViews(v.views)} vues</p>
                        </div>
                    </div>
                `).join('');
            },

            logout: function() {
                localStorage.removeItem('visiona_user');
                location.reload();
            },
                // --- 15. SYST√àME COMMUNAUT√â (POSTS) ---
            renderPosts: function() {
                const container = document.getElementById('view-posts');
                if (!container) return;

                // On r√©cup√®re tous les posts de la base Titan
                const posts = (this.data.posts || []).sort((a, b) => b.date - a.date);

                let html = `
                    <div style="max-width: 850px; margin: 0 auto; padding-top: 20px;">
                        <h2 style="margin-bottom: 25px;">Flux Communautaire</h2>`;
                
                // Si l'utilisateur est connect√©, il peut cr√©er un post
                if (this.user) {
                    html += `
                    <div style="background: var(--hover); padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #333;">
                        <div style="display:flex; gap:15px;">
                            <img src="${this.data.users[this.user.name]?.avatar || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:50%;">
                            <textarea id="new-post-text" placeholder="Quoi de neuf ?" style="flex:1; background:none; border:none; color:white; font-family:inherit; resize:none; outline:none; font-size:16px;"></textarea>
                        </div>
                        <div style="display:flex; justify-content:flex-end; border-top:1px solid #444; margin-top:15px; padding-top:10px;">
                            <button onclick="app.publishPost()" style="background:var(--blue); color:black; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">PUBLIER</button>
                        </div>
                    </div>`;
                }

                if (posts.length === 0) {
                    html += `<p style="text-align:center; color:var(--sec-text); padding:40px;">Aucun post pour le moment.</p>`;
                } else {
                    html += posts.map(p => {
                        const u = this.data.users[p.author] || {};
                        return `
                        <div style="background: var(--bg); border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                                <img src="${u.avatar || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:50%; cursor:pointer;" onclick="app.goProfile('${p.author}')">
                                <div>
                                    <b style="cursor:pointer;" onclick="app.goProfile('${p.author}')">${p.author}</b>
                                    <p style="margin:0; font-size:12px; color:var(--sec-text);">${this.timeAgo(p.date)}</p>
                                </div>
                            </div>
                            <p style="font-size:15px; line-height:1.5; white-space:pre-wrap;">${p.text}</p>
                            <div style="display:flex; gap:20px; margin-top:15px; border-top:1px solid #222; padding-top:10px;">
                                <button class="icon-btn" onclick="app.likePost('${p.id}')">üëç ${p.likes || 0}</button>
                                <button class="icon-btn">üí¨</button>
                            </div>
                        </div>`;
                    }).join('');
                }
                
                html += `</div>`;
                container.innerHTML = html;
            },

            publishPost: async function() {
                const txt = document.getElementById('new-post-text').value.trim();
                if (!txt) return;

                const post = {
                    id: "post_" + Date.now(),
                    author: this.user.name,
                    text: txt,
                    date: Date.now(),
                    likes: 0
                };

                if (!this.data.posts) this.data.posts = [];
                this.data.posts.unshift(post);
                await this.saveGist();
                this.renderPosts();
            },

            // --- 16. MOTEUR DE STOCKAGE (CLOUDINARY REAL UPLOAD) ---
            uploadFile: async function(file, type) {
                const cloudName = "dbx6v6szb"; // Ton Cloudinary
                const preset = "visiona_preset";
                const url = `https://api.cloudinary.com/v1_1/${cloudName}/${type}/upload`;

                const fd = new FormData();
                fd.append("file", file);
                fd.append("upload_preset", preset);

                try {
                    const res = await fetch(url, { method: "POST", body: fd });
                    const data = await res.json();
                    return data.secure_url;
                } catch (e) {
                    console.error("Upload Error", e);
                    return null;
                }
            },

            handleUpload: async function() {
                if (!this.user) return this.openModal('modal-auth');
                
                const title = document.getElementById('upTitle').value;
                const vFile = document.getElementById('upVideoFile').files[0];
                const tFile = document.getElementById('upThumbFile').files[0];
                const isShort = document.getElementById('upIsShort').checked;
                const status = document.getElementById('upProgressZone');

                if (!title || !vFile) return alert("Titre et vid√©o requis !");

                status.style.display = 'block';
                document.getElementById('upProgressBar').style.width = '30%';
                
                // 1. Upload Vid√©o
                const vUrl = await this.uploadFile(vFile, 'video');
                document.getElementById('upProgressBar').style.width = '70%';
                
                // 2. Upload Thumb (ou d√©faut)
                let tUrl = "https://via.placeholder.com/800x450";
                if (tFile) tUrl = await this.uploadFile(tFile, 'image');

                // 3. Extraction Dur√©e R√©elle (Fix)
                const realDuration = await this.getVideoDuration(vUrl);

                const newVid = {
                    id: "v_" + Date.now(),
                    title: title,
                    description: document.getElementById('upDesc').value,
                    url: vUrl,
                    thumb: tUrl,
                    author: this.user.name,
                    views: 0,
                    likes: 0,
                    dislikes: 0,
                    date: Date.now(),
                    isShort: isShort,
                    duration: realDuration,
                    comments: []
                };

                this.data.videos.unshift(newVid);
                document.getElementById('upProgressBar').style.width = '100%';
                await this.saveGist();
                
                alert("Publication r√©ussie !");
                location.reload();
            },

            // --- 17. RECHERCHE GLOBALE ---
            search: function() {
                const query = document.getElementById('mainSearch').value.toLowerCase();
                if (!query) return this.nav('home');

                const results = this.data.videos.filter(v => 
                    v.title.toLowerCase().includes(query) || 
                    v.author.toLowerCase().includes(query)
                );

                this.nav('home');
                const grid = document.getElementById('home-grid');
                grid.innerHTML = results.length ? results.map(v => this.createVideoCard(v)).join('') : `<p style="grid-column:1/-1; text-align:center;">Aucun r√©sultat pour "${query}"</p>`;
            },

            // --- 18. PANEL ADMIN (GESTION TOTALE) ---
            renderAdmin: function() {
                const content = document.getElementById('admin-panel-content');
                content.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                        <div class="admin-box">
                            <h3>üì¢ G√©rer l'Annonce</h3>
                            <textarea id="adm-ann-txt" style="width:100%; height:60px; background:#111; color:white; border:1px solid #333; border-radius:5px;">${this.data.annonces?.[0]?.text || ""}</textarea>
                            <button onclick="app.saveAnn()" style="margin-top:10px; background:var(--red); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Mettre √† jour</button>
                        </div>
                        <div class="admin-box">
                            <h3>üë• Utilisateurs (${Object.keys(this.data.users).length})</h3>
                            <div style="max-height:100px; overflow-y:auto; font-size:12px;">
                                ${Object.keys(this.data.users).map(u => `<div>‚Ä¢ ${u}</div>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="admin-box" style="margin-top:15px;">
                        <h3>üíé Cr√©dits & Thanks</h3>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input id="thx-n" placeholder="Nom" style="flex:1; background:#111; color:white; border:1px solid #333; padding:5px;">
                            <input id="thx-r" placeholder="R√¥le" style="flex:1; background:#111; color:white; border:1px solid #333; padding:5px;">
                            <button onclick="app.addThx()" style="background:var(--green); border:none; color:white; padding:5px 15px; border-radius:5px;">+</button>
                        </div>
                    </div>
                `;
            },

            saveAnn: async function() {
                const txt = document.getElementById('adm-ann-txt').value;
                this.data.annonces = [{ text: txt, date: Date.now() }];
                await this.saveGist();
                alert("Annonce mise √† jour !");
                this.checkAnnonces();
            }
        };

        // --- D√âMARRAGE FINAL ---
        app.init();
    </script>
</body>
</html>
