<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona Titan - Version Corrig√©e</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- SYST√àME DE VARIABLES (TON STYLE ORIGINAL) --- */
        :root { 
            --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; 
            --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --green: #00a854; --gold: #ffc107;
            --glass: rgba(255, 255, 255, 0.05); --sidebar-width: 240px;
        }

        /* EASTER EGG NOEL */
        body.christmas-mode {
            --bg: #0b1d0e; --header: #1a0505; --blue: #00ff00; --red: #ff0000;
            background-image: url('https://www.transparenttextures.com/patterns/snow.png');
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; overflow-x: hidden; padding-bottom: 60px; transition: 0.5s; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; height: 56px; background: var(--header); position: sticky; top: 0; z-index: 2000; border-bottom: 1px solid #222; }
        .logo { font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; user-select: none; }
        .logo::before { content: '‚ñ∂'; color: var(--red); font-size: 24px; margin-right: 5px; }

        .search-box { display: flex; flex: 1; max-width: 600px; margin: 0 40px; }
        .search-box input { width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 10px 16px; border-radius: 40px 0 0 40px; outline: none; font-size: 16px; }
        .search-box button { background: #222; border: 1px solid #333; border-left: none; color: white; padding: 0 20px; border-radius: 0 40px 40px 0; cursor: pointer; }

        .container { display: flex; min-height: calc(100vh - 56px); }
        .sidebar { width: var(--sidebar-width); background: var(--bg); padding: 12px; height: calc(100vh - 56px); position: fixed; top: 56px; overflow-y: auto; border-right: 1px solid #222; z-index: 1000; }
        .nav-item { display: flex; align-items: center; gap: 20px; padding: 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 14px; color: var(--text); margin-bottom: 2px; }
        .nav-item:hover { background: var(--hover); }
        .nav-item.active { background: var(--hover); font-weight: bold; }
        .sidebar hr { border: 0; border-top: 1px solid #333; margin: 12px 0; }

        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 24px; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        .v-card { cursor: pointer; border-radius: 12px; overflow: hidden; transition: transform 0.2s; }
        .v-card:hover { transform: scale(1.02); }
        .v-thumb { width: 100%; aspect-ratio: 16/9; background: #222; border-radius: 12px; overflow: hidden; position: relative; }
        .v-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .v-duration { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 2px 4px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .live-tag { position: absolute; top: 8px; left: 8px; background: var(--red); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px; }

        /* ZAPPS */
        .zapp-view { display: none; height: calc(100vh - 100px); overflow-y: scroll; scroll-snap-type: y mandatory; max-width: 420px; margin: 0 auto; scrollbar-width: none; }
        .zapp-view::-webkit-scrollbar { display: none; }
        .zapp-card { height: 100%; scroll-snap-align: start; position: relative; background: #000; border-radius: 16px; margin-bottom: 20px; overflow: hidden; display: flex; justify-content: center;}
        .zapp-video { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .zapp-ui { position: absolute; right: 12px; bottom: 40px; display: flex; flex-direction: column; gap: 20px; z-index: 10; align-items: center; }
        .zapp-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 20px; backdrop-filter: blur(10px); }

        /* PLAYER & MODALS */
        #player-overlay { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 3000; overflow-y: auto; padding: 20px; }
        .player-container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-content { background: #1e1e1e; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; border: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        
        .titan-input { width: 100%; padding: 12px; background: #121212; border: 1px solid #333; color: white; border-radius: 8px; margin-bottom: 10px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-blue { background: var(--blue); color: black; }
        .btn-red { background: var(--red); color: white; }

        /* LIVE & ADMIN STYLES (AJOUT) */
        #live-interface { display: none; position: fixed; inset: 0; background: #000; z-index: 4500; grid-template-columns: 1fr 300px; }
        .chat-box { background: #1a1a1a; border-left: 1px solid #333; display: flex; flex-direction: column; height: 100vh; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; font-size: 13px; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { text-align: left; padding: 8px; border-bottom: 1px solid #333; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .player-container { grid-template-columns: 1fr; }
            #live-interface { grid-template-columns: 1fr; grid-template-rows: 1fr 200px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="app.clickEgg()">Visiona</div>
        <div class="search-box">
            <input type="text" id="mainSearch" placeholder="Rechercher..." onkeyup="if(event.key==='Enter') app.search()">
            <button onclick="app.search()">üîç</button>
        </div>
        <div style="display:flex; gap:18px; align-items:center;">
            <button onclick="app.openModal('modal-upload')" style="background:none; border:none; color:white; font-size:22px; cursor:pointer;">‚ûï</button>
            <div onclick="app.toggleProfileMenu()" id="header-profile-area" style="cursor:pointer;">
                <button class="btn-blue" style="width:auto; padding: 5px 15px;">Connexion</button>
            </div>
        </div>
    </header>

    <div id="profile-dropdown" style="display:none; position:fixed; right:16px; top:60px; background:#282828; border:1px solid #444; border-radius:12px; width:250px; z-index:5000; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <div style="padding:15px; border-bottom:1px solid #444; display:flex; align-items:center; gap:10px;">
            <div id="dropdown-avatar" style="width:40px; height:40px;"></div>
            <b id="dropdown-username">Non connect√©</b>
        </div>
        <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma cha√Æne</div>
        <div class="nav-item" onclick="app.nav('stats')">üìä Mes Statistiques</div>
        <div id="admin-panel-btn" class="nav-item" style="display:none; color:var(--gold);" onclick="app.nav('admin')">üõ°Ô∏è Panel Admin</div>
        <div class="nav-item" onclick="app.logout()" style="color:var(--red);">üö™ D√©connexion</div>
    </div>
<div class="container">
        <aside class="sidebar">
            <div class="nav-item active" id="btn-home" onclick="app.nav('home', this)">üè† Accueil</div>
            <div class="nav-item" id="btn-zapp" onclick="app.nav('zapp', this)">‚ö° Zapp</div>
            <div class="nav-item" id="btn-subs" onclick="app.nav('subs', this)">üîî Abonnements</div>
            <hr>
            <div class="nav-item" onclick="app.nav('history', this)">üïí Historique</div>
            <div class="nav-item" onclick="app.nav('posts', this)">üìù Communaut√©</div>
            <div class="nav-item" onclick="app.openModal('modal-upload')">üî¥ Direct</div>
            <hr>
            <div class="nav-item" onclick="app.nav('stats', this)">üìä Statistiques</div>
            <div class="nav-item" onclick="app.nav('thanks', this)">üíé Remerciements</div>
            <hr>
            <div style="padding:0 12px; font-size:12px; color:var(--sec-text); margin-bottom:10px;">VOS ABONNEMENTS</div>
            <div id="subs-list-container"></div>
        </aside>

        <main class="main-content">
            <section id="view-home">
                <div id="announcement-area"></div>
                <div class="video-grid" id="home-grid"></div>
            </section>

            <section id="view-zapp" class="zapp-view"></section>
            
            <section id="view-subs" style="display:none;">
                <h2>Vid√©os de vos abonnements</h2>
                <div class="video-grid" id="subs-grid"></div>
            </section>

            <section id="view-history" style="display:none;">
                <h2>Historique</h2>
                <div class="video-grid" id="history-grid"></div>
            </section>

            <section id="view-posts" style="display:none;">
                <h2>Flux Communautaire</h2>
                <div id="posts-feed"></div>
            </section>

            <section id="view-thanks" style="display:none;">
                <h1 style="color:var(--gold); text-align:center;">Panth√©on Visiona</h1>
                <div id="thanks-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;"></div>
            </section>

            <section id="view-admin" style="display:none;">
                <h1 style="color:var(--red);">üõ°Ô∏è Panel Administrateur (Edonis)</h1>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background:#1e1e1e; padding:15px; border-radius:10px;">
                        <h3>Gestion Vid√©os</h3>
                        <table class="admin-table">
                            <thead><tr><th>Titre</th><th>Auteur</th><th>Action</th></tr></thead>
                            <tbody id="admin-video-list"></tbody>
                        </table>
                    </div>
                    <div style="background:#1e1e1e; padding:15px; border-radius:10px;">
                        <h3>Annonce Globale</h3>
                        <textarea id="admin-ann-txt" class="titan-input" style="height:60px;"></textarea>
                        <button class="btn btn-blue" onclick="app.admin.postAnn()">Publier</button>
                        <hr>
                        <h3>Ajouter au Panth√©on</h3>
                        <input id="admin-thx-input" class="titan-input" placeholder="Nom">
                        <button class="btn btn-blue" onclick="app.admin.addThanks()">Ajouter</button>
                    </div>
                </div>
            </section>

            <section id="view-profile" style="display:none;">
                <div id="prof-banner" style="height:200px; background:#333; border-radius:15px; background-size:cover;"></div>
                <div style="display:flex; gap:20px; align-items:center; margin-top:-40px; padding:0 30px;">
                    <div id="prof-pp" style="width:120px; height:120px; border-radius:50%; border:5px solid var(--bg); background:#222; overflow:hidden;"></div>
                    <div style="margin-top:40px;">
                        <h1 id="prof-name" style="margin:0;">Nom</h1>
                        <p id="prof-stats" style="color:#aaa;">0 abonn√©s</p>
                    </div>
                    <div style="margin-left:auto; margin-top:40px; display:flex; gap:10px;">
                        <button id="btn-edit-prof" class="btn btn-blue" style="width:auto; display:none;" onclick="app.openModal('modal-custom')">Personnaliser</button>
                        <button id="btn-sub-prof" class="btn btn-red" style="width:auto;" onclick="app.toggleSubFromProfile()">S'ABONNER</button>
                    </div>
                </div>
                <div style="display:flex; border-bottom:1px solid #333; margin-top:20px;">
                    <div class="nav-item active" onclick="app.profile.tab('videos')">VID√âOS</div>
                    <div class="nav-item" onclick="app.profile.tab('zapps')">ZAPPS</div>
                    <div class="nav-item" onclick="app.profile.tab('posts')">POSTS</div>
                    <div class="nav-item" onclick="app.profile.tab('about')">√Ä PROPOS</div>
                </div>
                <div id="prof-content" class="video-grid" style="padding-top:20px;"></div>
            </section>

            <section id="view-stats" style="display:none;">
                <h1>Statistiques</h1>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div style="background:#1e1e1e; padding:20px; border-radius:10px;"><h3>Vues</h3><h1 id="stat-views">0</h1></div>
                    <div style="background:#1e1e1e; padding:20px; border-radius:10px;"><h3>Abonn√©s</h3><h1 id="stat-subs">0</h1></div>
                    <div style="background:#1e1e1e; padding:20px; border-radius:10px;"><h3>J'aime</h3><h1 id="stat-likes">0</h1></div>
                </div>
            </section>
        </main>
    </div>

    <div id="player-overlay">
        <div class="player-container">
            <div>
                <button onclick="app.closePlayer()" style="color:white; background:none; border:none; font-size:20px; cursor:pointer;">‚úï Fermer</button>
                <div style="width:100%; aspect-ratio:16/9; background:black; border-radius:12px; overflow:hidden; margin-top:10px;">
                    <video id="main-video" controls autoplay style="width:100%; height:100%;"></video>
                </div>
                <h1 id="vid-title" style="font-size:22px; margin:15px 0 5px 0;">Titre</h1>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="app.goProfile(app.activeVid.author)">
                        <div id="vid-auth-pp" style="width:40px; height:40px;"></div>
                        <div><b id="vid-auth-name">Auteur</b><div id="vid-auth-sub-count" style="font-size:12px; color:#aaa;"></div></div>
                        <button id="vid-sub-btn" class="btn btn-red" style="width:auto; padding:5px 15px; margin-left:10px;" onclick="event.stopPropagation(); app.toggleSub()">S'ABONNER</button>
                    </div>
                    <button class="btn btn-blue" style="width:auto;" onclick="app.toggleLike()">üëç <span id="vid-likes">0</span></button>
                </div>
                <div style="background:#1e1e1e; padding:15px; margin-top:15px; border-radius:10px;">
                    <b id="vid-meta">0 vues ‚Ä¢ date</b>
                    <p id="vid-desc" style="margin-top:10px; white-space:pre-wrap;"></p>
                </div>
                <div style="margin-top:20px;">
                    <h3>Commentaires</h3>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <input id="com-input" class="titan-input" placeholder="Ajouter un commentaire..." style="margin:0;">
                        <button class="btn btn-blue" style="width:auto; margin:0;" onclick="app.postComment()">Envoyer</button>
                    </div>
                    <div id="com-list"></div>
                </div>
            </div>
            <div>
                <h3>Suggestions</h3>
                <div id="suggestions-list"></div>
            </div>
        </div>
    </div>

    <div id="live-interface">
        <div style="background:black; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <video id="live-stream-preview" autoplay muted style="max-width:100%; max-height:80%;"></video>
            <div style="color:red; font-weight:bold; margin-top:20px; animation: blink 1s infinite;">üî¥ EN DIRECT</div>
            <button class="btn btn-red" style="width:auto; margin-top:10px;" onclick="app.live.stop()">ARR√äTER LE DIRECT</button>
        </div>
        <div class="chat-box">
            <div style="padding:10px; border-bottom:1px solid #333; font-weight:bold;">Tchat du Direct</div>
            <div id="live-chat-msgs" class="chat-messages"></div>
            <div style="padding:10px; border-top:1px solid #333;">
                <input id="live-chat-input" class="titan-input" placeholder="Message..." onkeyup="if(event.key==='Enter') app.live.sendChat()">
            </div>
        </div>
    </div>

    <div id="modal-upload" class="modal">
        <div class="modal-content">
            <h2>Cr√©er</h2>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn btn-blue" onclick="document.getElementById('form-up').style.display='block';document.getElementById('form-live').style.display='none'">Importer Vid√©o</button>
                <button class="btn btn-red" onclick="document.getElementById('form-up').style.display='none';document.getElementById('form-live').style.display='block'">Lancer Direct</button>
            </div>
            <div id="form-up">
                <input id="up-title" class="titan-input" placeholder="Titre">
                <textarea id="up-desc" class="titan-input" placeholder="Description"></textarea>
                <label>Fichier Vid√©o: <input type="file" id="up-file" class="titan-input" accept="video/*"></label>
                <label>Miniature: <input type="file" id="up-thumb" class="titan-input" accept="image/*"></label>
                <label><input type="checkbox" id="up-short"> Est un Zapp (Short)</label>
                <button class="btn btn-blue" onclick="app.upload.start()">METTRE EN LIGNE</button>
            </div>
            <div id="form-live" style="display:none;">
                <input id="live-title" class="titan-input" placeholder="Titre du Live">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-blue" onclick="app.live.init('cam')">üì∑ Cam√©ra</button>
                    <button class="btn btn-blue" onclick="app.live.init('screen')">üíª √âcran</button>
                </div>
                <video id="pre-live-vid" autoplay muted style="width:100%; background:black; margin-top:10px; border-radius:5px;"></video>
                <button class="btn btn-red" onclick="app.live.go()">PASSER EN DIRECT</button>
            </div>
            <button class="btn" style="background:none; color:#aaa;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="modal-auth" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h2>Connexion</h2>
            <input id="auth-user" class="titan-input" placeholder="Pseudo">
            <button class="btn btn-blue" onclick="app.auth.login()">SE CONNECTER</button>
        </div>
    </div>

    <div id="modal-custom" class="modal">
        <div class="modal-content">
            <h2>Personnaliser</h2>
            <label>Avatar (Image): <input type="file" id="cust-pp" class="titan-input" accept="image/*"></label>
            <label>Banni√®re (Image): <input type="file" id="cust-banner" class="titan-input" accept="image/*"></label>
            <label>Bio: <textarea id="cust-bio" class="titan-input"></textarea></label>
            <button class="btn btn-blue" onclick="app.profile.save()">ENREGISTRER</button>
            <button class="btn" onclick="app.closeModals()">Fermer</button>
        </div>
    </div>
    <script>
    /* TITAN ENGINE V5 - ULTIMATE CORRECTION */
    const app = {
        data: {
            videos: [],
            users: {
                "Edonis": { pp:"", banner:"", bio:"Admin Supr√™me", subs:[], followers:[], role:"admin", created: Date.now() }
            },
            posts: [],
            annonces: ["Bienvenue sur Visiona Titan !"],
            thanks: ["Edonis", "Toi"]
        },
        user: null, // Pseudo string
        activeVid: null,
        stream: null,
        eggClicks: 0,

        init: function() {
            // Chargement Persistant
            const db = localStorage.getItem('titan_db_final');
            if(db) this.data = JSON.parse(db);
            this.user = localStorage.getItem('titan_user');
            
            this.auth.updateHeader();
            this.nav('home');
            
            // Easter Egg No√´l reset
            this.eggClicks = 0;
        },

        save: function() {
            localStorage.setItem('titan_db_final', JSON.stringify(this.data));
            this.auth.updateHeader(); // Rafraichir UI
        },

        // --- NAVIGATION ---
        nav: function(page, el) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            
            const target = document.getElementById('view-'+page);
            if(target) target.style.display = 'block';
            if(el) el.classList.add('active');
            
            document.getElementById('user-dropdown').style.display = 'none';
            document.getElementById('player-overlay').style.display = 'none'; // Ferme player si chgmt page
            if(this.activeVid && document.getElementById('main-video')) document.getElementById('main-video').pause();

            if(page === 'home') this.renderHome();
            if(page === 'zapp') this.renderZapp();
            if(page === 'subs') this.renderSubs();
            if(page === 'history') this.renderHistory();
            if(page === 'posts') this.renderPosts();
            if(page === 'thanks') this.renderThanks();
            if(page === 'admin') this.admin.render();
            if(page === 'stats') this.renderStats();
            
            window.scrollTo(0,0);
        },

        // --- RENDUS ---
        renderHome: function() {
            const vids = this.data.videos.filter(v => !v.isShort).sort((a,b) => b.date - a.date);
            document.getElementById('announcement-area').innerHTML = this.data.annonces.map(a => `<div style="background:var(--blue); color:black; padding:10px; border-radius:8px; margin-bottom:15px;">üì¢ ${a}</div>`).join('');
            document.getElementById('home-grid').innerHTML = vids.map(v => this.card(v)).join('');
        },
        renderZapp: function() {
            const vids = this.data.videos.filter(v => v.isShort);
            document.getElementById('view-zapp').innerHTML = vids.map(v => `
                <div class="zapp-card">
                    <video class="zapp-video" src="${v.url}" loop onclick="this.paused?this.play():this.pause()"></video>
                    <div class="zapp-ui">
                        <div class="zapp-btn" onclick="app.player.load(${v.id})">‚ù§Ô∏è <small>${v.likes}</small></div>
                        <div class="zapp-btn" onclick="app.goProfile('${v.author}')">üë§</div>
                    </div>
                </div>
            `).join('');
        },
        renderSubs: function() {
            if(!this.user) return document.getElementById('subs-grid').innerHTML = "<p>Connectez-vous.</p>";
            const subs = this.data.users[this.user].subs;
            const vids = this.data.videos.filter(v => subs.includes(v.author) && !v.isShort);
            document.getElementById('subs-grid').innerHTML = vids.map(v => this.card(v)).join('');
        },
        renderHistory: function() {
            const h = JSON.parse(localStorage.getItem('titan_hist') || "[]");
            const vids = h.map(id => this.data.videos.find(v => v.id == id)).filter(v => v);
            document.getElementById('history-grid').innerHTML = vids.map(v => this.card(v)).join('');
        },
        renderPosts: function() {
            const area = document.getElementById('posts-feed');
            let html = "";
            if(this.user) html += `<div class="post-card"><textarea id="new-post-txt" class="titan-input" placeholder="Exprimez-vous..."></textarea><button class="btn btn-blue" onclick="app.addPost()">Publier</button></div>`;
            html += this.data.posts.map(p => `
                <div class="post-card">
                    <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                        ${this.utils.avatar(p.author, 30)} <b>${p.author}</b> <span style="color:#aaa; font-size:12px;">${this.utils.ago(p.date)}</span>
                    </div>
                    ${p.text}
                </div>
            `).join('');
            area.innerHTML = html;
        },
        renderThanks: function() {
            document.getElementById('thanks-grid').innerHTML = this.data.thanks.map(t => `
                <div style="background:#1e1e1e; padding:20px; border:1px solid gold; border-radius:10px; text-align:center;">üèÜ ${t}</div>
            `).join('');
        },

        card: function(v) {
            return `
            <div class="v-card" onclick="app.player.load(${v.id})">
                <div class="v-thumb">
                    <img src="${v.thumb}">
                    ${v.isLive ? '<div class="live-tag">DIRECT</div>' : `<div class="v-duration">${v.duration}</div>`}
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="width:36px; height:36px;">${this.utils.avatar(v.author)}</div>
                    <div>
                        <div style="font-weight:bold; font-size:14px; line-height:1.2;">${v.title}</div>
                        <div style="font-size:12px; color:#aaa;">${v.author} ‚Ä¢ ${v.views} vues</div>
                    </div>
                </div>
            </div>`;
        },

        // --- PLAYER ---
        player: {
            load: function(id) {
                const v = app.data.videos.find(x => x.id == id);
                app.activeVid = v;
                
                // COOLDOWN VUE 1H
                const now = Date.now();
                if(!v.viewers) v.viewers = {};
                if(!app.user || !v.viewers[app.user] || (now - v.viewers[app.user] > 3600000)) {
                    v.views++;
                    if(app.user) v.viewers[app.user] = now;
                    app.save();
                }

                // HISTORIQUE
                let h = JSON.parse(localStorage.getItem('titan_hist') || "[]");
                if(!h.includes(id)) h.unshift(id);
                localStorage.setItem('titan_hist', JSON.stringify(h));

                const p = document.getElementById('player-overlay');
                const vid = document.getElementById('main-video');
                p.style.display = 'block';
                
                // Source
                if(v.isLive && v.streamRef) vid.srcObject = v.streamRef;
                else { vid.srcObject = null; vid.src = v.url; }

                document.getElementById('vid-title').innerText = v.title;
                document.getElementById('vid-auth-name').innerText = v.author;
                document.getElementById('vid-auth-sub-count').innerText = app.data.users
                <script>
 
                    /* TITAN ENGINE V5 - ULTIMATE CORRECTION */
    const app = {
        data: {
            videos: [],
            users: {
                "Edonis": { pp:"", banner:"", bio:"Admin Supr√™me", subs:[], followers:[], role:"admin", created: Date.now() }
            },
            posts: [],
            annonces: ["Bienvenue sur Visiona Titan !"],
            thanks: ["Edonis", "Toi"]
        },
        user: null, // Pseudo string
        activeVid: null,
        stream: null,
        eggClicks: 0,

        init: function() {
            // Chargement Persistant
            const db = localStorage.getItem('titan_db_final');
            if(db) this.data = JSON.parse(db);
            this.user = localStorage.getItem('titan_user');
            
            this.auth.updateHeader();
            this.nav('home');
            
            // Easter Egg No√´l reset
            this.eggClicks = 0;
        },

        save: function() {
            localStorage.setItem('titan_db_final', JSON.stringify(this.data));
            this.auth.updateHeader(); // Rafraichir UI
        },

        // --- NAVIGATION ---
        nav: function(page, el) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            
            const target = document.getElementById('view-'+page);
            if(target) target.style.display = 'block';
            if(el) el.classList.add('active');
            
            document.getElementById('user-dropdown').style.display = 'none';
            document.getElementById('player-overlay').style.display = 'none'; // Ferme player si chgmt page
            if(this.activeVid && document.getElementById('main-video')) document.getElementById('main-video').pause();

            if(page === 'home') this.renderHome();
            if(page === 'zapp') this.renderZapp();
            if(page === 'subs') this.renderSubs();
            if(page === 'history') this.renderHistory();
            if(page === 'posts') this.renderPosts();
            if(page === 'thanks') this.renderThanks();
            if(page === 'admin') this.admin.render();
            if(page === 'stats') this.renderStats();
            
            window.scrollTo(0,0);
        },

        // --- RENDUS ---
        renderHome: function() {
            const vids = this.data.videos.filter(v => !v.isShort).sort((a,b) => b.date - a.date);
            document.getElementById('announcement-area').innerHTML = this.data.annonces.map(a => `<div style="background:var(--blue); color:black; padding:10px; border-radius:8px; margin-bottom:15px;">üì¢ ${a}</div>`).join('');
            document.getElementById('home-grid').innerHTML = vids.map(v => this.card(v)).join('');
        },
        renderZapp: function() {
            const vids = this.data.videos.filter(v => v.isShort);
            document.getElementById('view-zapp').innerHTML = vids.map(v => `
                <div class="zapp-card">
                    <video class="zapp-video" src="${v.url}" loop onclick="this.paused?this.play():this.pause()"></video>
                    <div class="zapp-ui">
                        <div class="zapp-btn" onclick="app.player.load(${v.id})">‚ù§Ô∏è <small>${v.likes}</small></div>
                        <div class="zapp-btn" onclick="app.goProfile('${v.author}')">üë§</div>
                    </div>
                </div>
            `).join('');
        },
        renderSubs: function() {
            if(!this.user) return document.getElementById('subs-grid').innerHTML = "<p>Connectez-vous.</p>";
            const subs = this.data.users[this.user].subs;
            const vids = this.data.videos.filter(v => subs.includes(v.author) && !v.isShort);
            document.getElementById('subs-grid').innerHTML = vids.map(v => this.card(v)).join('');
        },
        renderHistory: function() {
            const h = JSON.parse(localStorage.getItem('titan_hist') || "[]");
            const vids = h.map(id => this.data.videos.find(v => v.id == id)).filter(v => v);
            document.getElementById('history-grid').innerHTML = vids.map(v => this.card(v)).join('');
        },
        renderPosts: function() {
            const area = document.getElementById('posts-feed');
            let html = "";
            if(this.user) html += `<div class="post-card"><textarea id="new-post-txt" class="titan-input" placeholder="Exprimez-vous..."></textarea><button class="btn btn-blue" onclick="app.addPost()">Publier</button></div>`;
            html += this.data.posts.map(p => `
                <div class="post-card">
                    <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                        ${this.utils.avatar(p.author, 30)} <b>${p.author}</b> <span style="color:#aaa; font-size:12px;">${this.utils.ago(p.date)}</span>
                    </div>
                    ${p.text}
                </div>
            `).join('');
            area.innerHTML = html;
        },
        renderThanks: function() {
            document.getElementById('thanks-grid').innerHTML = this.data.thanks.map(t => `
                <div style="background:#1e1e1e; padding:20px; border:1px solid gold; border-radius:10px; text-align:center;">üèÜ ${t}</div>
            `).join('');
        },

        card: function(v) {
            return `
            <div class="v-card" onclick="app.player.load(${v.id})">
                <div class="v-thumb">
                    <img src="${v.thumb}">
                    ${v.isLive ? '<div class="live-tag">DIRECT</div>' : `<div class="v-duration">${v.duration}</div>`}
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="width:36px; height:36px;">${this.utils.avatar(v.author)}</div>
                    <div>
                        <div style="font-weight:bold; font-size:14px; line-height:1.2;">${v.title}</div>
                        <div style="font-size:12px; color:#aaa;">${v.author} ‚Ä¢ ${v.views} vues</div>
                    </div>
                </div>
            </div>`;
        },

        // --- PLAYER ---
        player: {
            load: function(id) {
                const v = app.data.videos.find(x => x.id == id);
                app.activeVid = v;
                
                // COOLDOWN VUE 1H
                const now = Date.now();
                if(!v.viewers) v.viewers = {};
                if(!app.user || !v.viewers[app.user] || (now - v.viewers[app.user] > 3600000)) {
                    v.views++;
                    if(app.user) v.viewers[app.user] = now;
                    app.save();
                }

                // HISTORIQUE
                let h = JSON.parse(localStorage.getItem('titan_hist') || "[]");
                if(!h.includes(id)) h.unshift(id);
                localStorage.setItem('titan_hist', JSON.stringify(h));

                const p = document.getElementById('player-overlay');
                const vid = document.getElementById('main-video');
                p.style.display = 'block';
                
                // Source
                if(v.isLive && v.streamRef) vid.srcObject = v.streamRef;
                else { vid.srcObject = null; vid.src = v.url; }

                document.getElementById('vid-title').innerText = v.title;
                document.getElementById('vid-auth-name').innerText = v.author;
                document.getElementById('vid-auth-sub-count').innerText = app.data.users[v.author].followers.length + " abonn√©s";
                document.getElementById('vid-auth-pp').innerHTML = app.utils.avatar(v.author);
                document.getElementById('vid-likes').innerText = v.likes;
                document.getElementById('vid-meta').innerText = `${v.views} vues ‚Ä¢ ${app.utils.ago(v.date)}`;
                document.getElementById('vid-desc').innerText = v.desc;

                app.social.updateSubBtn();
                app.social.renderComs();

                // SUGGESTIONS
                const recos = app.data.videos.filter(x => !x.isShort && x.id != id).slice(0, 5);
                document.getElementById('suggestions-list').innerHTML = recos.map(r => `
                    <div style="display:flex; gap:10px; margin-bottom:10px; cursor:pointer;" onclick="app.player.load(${r.id})">
                        <img src="${r.thumb}" style="width:120px; border-radius:5px;">
                        <div><b style="font-size:13px;">${r.title}</b><div style="font-size:12px; color:#aaa;">${r.author}</div></div>
                    </div>
                `).join('');
            },
            close: function() {
                document.getElementById('player-overlay').style.display = 'none';
                document.getElementById('main-video').pause();
            }
        },

        // --- SOCIAL (SUBS, LIKES, COEUR) ---
        social: {
            toggleSubscribe: function() {
                const target = document.getElementById('prof-name').innerText;
                this.doSub(target);
                app.profile.load(target);
            },
            toggleSubscribePlayer: function() {
                this.doSub(app.activeVid.author);
                this.updateSubBtn();
            },
            doSub: function(target) {
                if(!app.user) return app.openModal('modal-auth');
                if(target === app.user) return alert("Impossible");
                
                const me = app.data.users[app.user];
                const them = app.data.users[target];
                
                if(me.subs.includes(target)) {
                    me.subs = me.subs.filter(x => x !== target); // D√©sabonnement
                    them.followers = them.followers.filter(x => x !== app.user); // -1 abonn√©s
                } else {
                    me.subs.push(target); // Abonnement
                    them.followers.push(app.user); // +1 abonn√©s
                }
                app.save();
                app.auth.updateSidebar();
            },
            updateSubBtn: function() {
                const target = app.activeVid.author;
                const isSub = app.data.users[app.user]?.subs.includes(target);
                const btn = document.getElementById('vid-sub-btn');
                btn.innerText = isSub ? "ABONN√â" : "S'ABONNER";
                btn.className = isSub ? "btn" : "btn btn-red";
                btn.style.background = isSub ? "#333" : "var(--red)";
            },
            vote: function(val) {
                if(!app.user) return app.openModal('modal-auth');
                const v = app.activeVid;
                if(!v.voters) v.voters = [];
                
                if(v.voters.includes(app.user)) return alert("D√©j√† vot√© !");
                v.likes += val;
                v.voters.push(app.user);
                app.save();
                document.getElementById('vid-likes').innerText = v.likes;
            },
            postComment: function() {
                const t = document.getElementById('com-input').value;
                if(!t) return;
                app.activeVid.comments.unshift({author: app.user, text: t, date: Date.now(), heart: false});
                app.save(); this.renderComs();
                document.getElementById('com-input').value = "";
            },
            renderComs: function() {
                document.getElementById('com-list').innerHTML = (app.activeVid.comments||[]).map((c,i) => `
                    <div style="margin-bottom:15px; display:flex; gap:10px;">
                        <div style="width:30px;">${app.utils.avatar(c.author)}</div>
                        <div>
                            <div style="font-size:12px;"><b>${c.author}</b> ${app.utils.ago(c.date)}</div>
                            <div>${c.text}</div>
                            ${c.heart ? '<span style="color:red; font-size:12px;">‚ù§Ô∏è Aim√© par l\'auteur</span>' : ''}
                            ${app.user === app.activeVid.author ? `<button onclick="app.social.heart(${i})" style="border:none; background:none; cursor:pointer;">‚ù§Ô∏è</button>` : ''}
                        </div>
                    </div>
                `).join('');
            },
            heart: function(idx) {
                app.activeVid.comments[idx].heart = !app.activeVid.comments[idx].heart;
                app.save(); this.renderComs();
            }
        },

        // --- UPLOAD & LIVE ---
        upload: {
            start: function() {
                const f = document.getElementById('up-file').files[0];
                const t = document.getElementById('up-thumb').files[0];
                const title = document.getElementById('up-title').value;
                if(!f || !title) return alert("Fichier manquant");

                // FILE READER (VRAI UPLOAD LOCAL)
                const r = new FileReader();
                r.onload = (e) => {
                    const vidUrl = e.target.result;
                    // Dur√©e r√©elle
                    const vidTemp = document.createElement('video');
                    vidTemp.src = vidUrl;
                    vidTemp.onloadedmetadata = () => {
                        const dur = Math.floor(vidTemp.duration);
                        const min = Math.floor(dur/60); const sec = dur%60;
                        const durationStr = `${min}:${sec<10?'0'+sec:sec}`;
                        
                        if(t) {
                            const rt = new FileReader();
                            rt.onload = (ev) => app.upload.finish(title, vidUrl, ev.target.result, durationStr);
                            rt.readAsDataURL(t);
                        } else app.upload.finish(title, vidUrl, "https://via.placeholder.com/640x360", durationStr);
                    };
                };
                r.readAsDataURL(f);
            },
            finish: function(title, url, thumb, dur) {
                app.data.videos.unshift({
                    id: Date.now(), title: title, desc: document.getElementById('up-desc').value,
                    author: app.user, url: url, thumb: thumb, duration: dur,
                    views: 0, likes: 0, date: Date.now(), isShort: document.getElementById('up-short').checked,
                    comments: [], voters: [], viewers: {}
                });
                app.save(); app.closeModals(); app.nav('home');
            }
        },

        live: {
            init: async function(type) {
                try {
                    if(type === 'cam') app.stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                    else app.stream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
                    document.getElementById('pre-live-vid').srcObject = app.stream;
                } catch(e) { alert("Erreur: " + e); }
            },
            go: function() {
                if(!app.stream) return alert("Source manquante");
                const title = document.getElementById('live-title').value;
                app.data.videos.unshift({
                    id: Date.now(), title: "üî¥ " + title, author: app.user, isLive: true,
                    streamRef: app.stream, thumb: "", views: 0, likes: 0, date: Date.now(), comments: []
                });
                // Ouvrir Interface Live
                document.getElementById('live-interface').style.display = 'grid';
                document.getElementById('live-stream-preview').srcObject = app.stream;
                app.save(); app.closeModals();
            },
            stop: function() {
                app.stream.getTracks().forEach(t => t.stop());
                document.getElementById('live-interface').style.display = 'none';
                app.nav('home');
            },
            sendChat: function() {
                const i = document.getElementById('live-chat-input');
                document.getElementById('live-chat-msgs').innerHTML += `<div><b>${app.user}:</b> ${i.value}</div>`;
                i.value = "";
            }
        },

        // --- PROFIL ---
        profile: {
            load: function(name) {
                if(!app.data.users[name]) app.data.users[name] = { pp:"", banner:"", bio:"Nouveau", subs:[], followers:[] };
                const u = app.data.users[name];
                document.getElementById('prof-name').innerText = name;
                document.getElementById('prof-stats').innerText = u.followers.length + " abonn√©s";
                document.getElementById('prof-pp').innerHTML = app.utils.avatar(name, 120);
                if(u.banner) document.getElementById('prof-banner').style.backgroundImage = `url(${u.banner})`;
                
                const isMe = name === app.user;
                document.getElementById('btn-edit-prof').style.display = isMe ? 'block' : 'none';
                document.getElementById('btn-sub-prof').style.display = isMe ? 'none' : 'block';
                
                if(!isMe) {
                    const isSub = app.data.users[app.user]?.subs.includes(name);
                    document.getElementById('btn-sub-prof').innerText = isSub ? "ABONN√â" : "S'ABONNER";
                    document.getElementById('btn-sub-prof').style.background = isSub ? "#333" : "var(--red)";
                }
                this.tab('videos');
            },
            save: function() {
                const pp = document.getElementById('cust-pp').files[0];
                const bn = document.getElementById('cust-banner').files[0];
                const u = app.data.users[app.user];
                u.bio = document.getElementById('cust-bio').value;
                
                const done = () => { app.save(); app.closeModals(); app.profile.load(app.user); app.auth.updateHeader(); };
                
                if(pp) {
                    const r = new FileReader();
                    r.onload = (e) => { u.pp = e.target.result; if(bn) loadBn(); else done(); };
                    r.readAsDataURL(pp);
                } else if(bn) loadBn(); else done();

                function loadBn() {
                    const r = new FileReader();
                    r.onload = (e) => { u.banner = e.target.result; done(); };
                    r.readAsDataURL(bn);
                }
            },
            tab: function(t) {
                const c = document.getElementById('prof-content');
                const u = document.getElementById('prof-name').innerText;
                const vids = app.data.videos.filter(v => v.author === u);
                
                if(t === 'videos') c.innerHTML = vids.filter(v => !v.isShort).map(v => app.card(v)).join('');
                if(t === 'zapps') c.innerHTML = vids.filter(v => v.isShort).map(v => app.card(v)).join('');
                if(t === 'posts') c.innerHTML = app.data.posts.filter(p => p.author === u).map(p => `<div style="background:#1e1e1e; padding:10px; margin-bottom:10px; border-radius:5px;">${p.text}</div>`).join('');
                if(t === 'about') c.innerHTML = `<div style="padding:20px;">${app.data.users[u].bio}</div>`;
            }
        },

        // --- ADMIN ---
        admin: {
            render: function() {
                const rows = app.data.videos.map(v => `
                    <tr><td>${v.title}</td><td>${v.author}</td><td><button onclick="app.admin.delVid(${v.id})" style="color:red;">Suppr</button></td></tr>
                `).join('');
                document.getElementById('admin-video-list').innerHTML = rows;
            },
            delVid: function(id) {
                if(confirm("Supprimer ?")) {
                    app.data.videos = app.data.videos.filter(v => v.id !== id);
                    app.save(); this.render();
                }
            },
            addThanks: function() {
                app.data.thanks.push(document.getElementById('admin-thx-input').value);
                app.save(); alert("Ajout√© !");
            },
            postAnn: function() {
                app.data.annonces.unshift(document.getElementById('admin-ann-txt').value);
                app.save(); alert("Publi√©");
            }
        },

        // --- AUTH & UTILS ---
        auth: {
            login: function() {
                const u = document.getElementById('auth-user').value;
                if(!u) return;
                if(!app.data.users[u]) app.data.users[u] = { pp:"", banner:"", bio:"Nouveau", subs:[], followers:[] };
                app.user = u;
                localStorage.setItem('titan_user', u);
                app.closeModals();
                app.init();
            },
            logout: function() { localStorage.removeItem('titan_user'); location.reload(); },
            updateHeader: function() {
                const area = document.getElementById('auth-section');
                if(app.user) {
                    area.innerHTML = `<div onclick="app.toggleProfileMenu()">${app.utils.avatar(app.user, 36)}</div>`;
                    document.getElementById('dropdown-avatar').innerHTML = app.utils.avatar(app.user, 40);
                    document.getElementById('dropdown-username').innerText = app.user;
                    if(app.user === "Edonis") document.getElementById('admin-panel-btn').style.display = 'block';
                    this.updateSidebar();
                } else {
                    area.innerHTML = `<button class="btn-blue" onclick="app.openModal('modal-auth')" style="width:auto; padding:5px 15px;">Connexion</button>`;
                }
            },
            updateSidebar: function() {
                if(!app.user) return;
                document.getElementById('subs-list-container').innerHTML = app.data.users[app.user].subs.map(s => `
                    <div class="nav-item" onclick="app.goProfile('${s}')">${app.utils.avatar(s, 20)} ${s}</div>
                `).join('');
            }
        },

        utils: {
            avatar: function(u, s=40) {
                const usr = app.data.users[u];
                if(usr && usr.pp) return `<img src="${usr.pp}" style="width:${s}px; height:${s}px; border-radius:50%; object-fit:cover;">`;
                const c = '#'+Math.floor(Math.random()*16777215).toString(16);
                return `<div style="width:${s}px; height:${s}px; background:${c}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white;">${u[0].toUpperCase()}</div>`;
            },
            ago: function(d) {
                const min = Math.floor((Date.now()-d)/60000);
                if(min<60) return min + " min";
                const h = Math.floor(min/60);
                if(h<24) return h + " h";
                return Math.floor(h/24) + " j";
            }
        },

        // Easter Egg
        clickEgg: function() {
            this.eggClicks++;
            if(this.eggClicks >= 10) {
                document.body.classList.add('christmas-mode');
                alert("üéÖ MODE NO√ãL ACTIV√â !");
            }
        },
        
        // Helpers
        openModal: function(id) { document.getElementById(id).style.display='flex'; },
        closeModals: function() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); },
        goProfile: function(u) { app.profile.load(u); app.nav('profile'); },
        goMyProfile: function() { app.profile.load(app.user); app.nav('profile'); },
        closePlayer: function() { document.getElementById('player-overlay').style.display='none'; document.getElementById('main-video').pause(); },
        toggleProfileMenu: function() { const m = document.getElementById('profile-dropdown'); m.style.display = m.style.display==='none'?'block':'none'; },
        addPost: function() {
            const t = document.getElementById('new-post-txt').value;
            app.data.posts.unshift({author:app.user, text:t, date:Date.now()});
            app.save(); app.renderPosts();
        },
        history: { clear: function() { localStorage.removeItem('titan_hist'); app.renderHistory(); } }
    };

    window.onload = function() { app.init(); };
    </script>
</body>
</html>
