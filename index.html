<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTube - AlphaGames30</title>
    <style>
        :root { --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; --hover: #272727; --blue: #3ea6ff; --red: #ff0000; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: Roboto, Arial, sans-serif; overflow-x: hidden; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; height: 56px; background: var(--header); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        .logo { font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; }
        .logo::before { content: '‚ñ∂'; color: var(--red); font-size: 24px; margin-right: 5px; }
        .search-box { display: flex; flex: 1; max-width: 500px; margin: 0 10px; }
        .search-box input { width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 8px 15px; border-radius: 40px 0 0 40px; }
        .search-box button { background: #222; border: 1px solid #333; border-left: none; padding: 0 20px; border-radius: 0 40px 40px 0; cursor: pointer; color: var(--sec-text); }
        .header-btns button { background: none; border: none; color: white; font-size: 20px; margin-left: 10px; cursor: pointer; }
        .btn-login { border: 1px solid var(--blue) !important; color: var(--blue) !important; font-size: 14px !important; padding: 5px 10px; border-radius: 20px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .container { display: flex; height: calc(100vh - 60px); }
        .sidebar { width: 220px; background: var(--bg); padding: 10px; overflow-y: auto; display: none; }
        @media(min-width: 768px) { .sidebar { display: block; } }
        .nav-item { padding: 10px; border-radius: 10px; cursor: pointer; margin-bottom: 5px; }
        .nav-item:hover { background: var(--hover); }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .video-card { cursor: pointer; transition: transform 0.2s; }
        .video-card:hover { transform: scale(1.02); }
        .thumb-container { position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; background: #333; }
        .thumb { width: 100%; height: 100%; object-fit: cover; }
        .play-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; opacity: 0.8; text-shadow: 0 0 10px black; }
        .info { display: flex; gap: 10px; margin-top: 10px; }
        .avatar-small { width: 36px; height: 36px; border-radius: 50%; background: #555; object-fit: cover; }
        .details h4 { margin: 0 0 5px 0; font-size: 16px; line-height: 1.2; color: #fff; }
        .details p { margin: 0; color: var(--sec-text); font-size: 14px; }
        .actions-bar { display: flex; gap: 10px; margin-top: 8px; }
        .action-pill { background: #272727; color: white; border: none; padding: 4px 10px; border-radius: 12px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .action-pill:hover { background: #3f3f3f; }
        .liked { color: var(--blue); }
        .disliked { color: var(--red); } 
        .player-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 500; justify-content: center; align-items: center; flex-direction: column; }
        .video-wrapper { width: 90%; max-width: 1000px; aspect-ratio: 16/9; background: #000; position: relative; }
        video { width: 100%; height: 100%; outline: none; }
        .close-player { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 510; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 5px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; }
        .modal-box { background: #212121; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; position: relative; }
        .close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #121212; border: 1px solid #333; color: white; border-radius: 5px; box-sizing: border-box; }
        .btn-blue { width: 100%; padding: 10px; background: var(--blue); color: black; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .profile-view { display: none; padding: 0 20px; }
        .banner { height: 150px; background: linear-gradient(90deg, #b92b27, #1565C0); border-radius: 15px; }
        .profile-head { display: flex; margin-top: -40px; padding: 0 20px; align-items: flex-end; }
        .avatar-big { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--bg); background: #555; object-fit: cover; }
        .action-edit { background: var(--hover); color: white; border: none; padding: 8px 16px; border-radius: 18px; margin-top: 10px; cursor: pointer; }
        .account-menu { position: absolute; top: 60px; right: 10px; background: #282828; border-radius: 10px; padding: 10px; width: 200px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 150; display: none; }
        .account-info { padding: 10px; border-bottom: 1px solid #3c3c3c; margin-bottom: 10px; }
        .account-menu div { cursor: pointer; padding: 8px 10px; border-radius: 5px; }
        .account-menu div:hover { background: var(--hover); }
        .btn-blue.disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="app.goHome()"><span>MyTube</span></div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Rechercher...">
            <button onclick="app.search()">üîç</button>
        </div>
        <div class="header-btns">
            <button onclick="app.openUpload()">‚ûï</button>
            <button id="loginBtn" class="btn-login" onclick="app.toggleAccountMenu()">üë§ Se connecter</button>
        </div>
    </header>
    <div id="accountMenu" class="account-menu">
        <div class="account-info"><p id="menuUserName" style="font-weight: bold; margin: 0;"></p><p id="menuUserEmail" style="font-size: 12px; color: var(--sec-text); margin: 0;"></p></div>
        <div onclick="app.goProfile(); app.toggleAccountMenu()">üë§ Ma Cha√Æne</div>
        <div onclick="app.doLogout()">üö™ D√©connexion</div>
    </div>

    <div class="container">
        <nav class="sidebar">
            <div class="nav-item" onclick="app.goHome()">üè† Accueil</div>
            <div class="nav-item">üì± Shorts</div>
            <div class="nav-item" onclick="app.goSubs()">üì∫ Abonnements</div>
            <hr style="border-color: #333;">
            <div class="nav-item" onclick="app.goProfile()">üë§ Ma Cha√Æne</div>
        </nav>
        <main class="content">
            <div id="videoGrid" class="video-grid"></div>
            <div id="profileView" class="profile-view">
                <div class="banner"></div>
                <div class="profile-head">
                    <img id="profileAvatar" src="" class="avatar-big">
                    <div style="margin-left: 20px;">
                        <h1 id="pName">Nom</h1>
                        <p id="pBio" style="color:#aaa;">Bio...</p>
                        <button class="action-edit" onclick="app.openEditProfile()">‚úé Personnaliser</button>
                    </div>
                </div>
                <h3>Mes Vid√©os</h3>
                <div id="pVideos" class="video-grid"></div>
            </div>
        </main>
    </div>

    <div id="playerModal" class="player-overlay">
        <div class="close-player" onclick="app.closePlayer()">‚ùå FERMER</div>
        <div class="video-wrapper"><video id="mainVideoPlayer" controls autoplay></video></div>
        <h2 id="playerTitle" style="color: white; margin-top: 10px;"></h2>
    </div>

    <div id="modalUpload" class="modal">
        <div class="modal-box">
            <span class="close" onclick="app.closeModals()">&times;</span>
            <h2>Publier une vid√©o</h2>
            <p id="uploadStatus" style="color: #3ea6ff; text-align: center; font-weight: bold; margin: 0;"></p>
            <input type="text" id="upTitle" placeholder="Titre de la vid√©o">
            <label for="upVideoFile" style="color:#aaa;">S√©lectionnez la Vid√©o (MP4)</label>
            <input type="file" id="upVideoFile" accept="video/mp4,video/*">
            <label for="upThumbFile" style="color:#aaa;">S√©lectionnez la Miniature</label>
            <input type="file" id="upThumbFile" accept="image/*">
            <button class="btn-blue" id="publishBtn" onclick="app.publish()">PUBLIER MAINTENANT</button>
        </div>
    </div>

    <div id="modalEditProfile" class="modal">
        <div class="modal-box">
            <span class="close" onclick="app.closeModals()">&times;</span>
            <h2>Modifier ma cha√Æne</h2>
            <input type="text" id="editName" placeholder="Nom">
            <input type="text" id="editBio" placeholder="Bio">
            <label for="editPPFile" style="color:#aaa;">Nouvelle Photo de Profil</label>
            <input type="file" id="editPPFile" accept="image/*">
            <label for="editBannerFile" style="color:#aaa;">Nouvelle Banni√®re</label>
            <input type="file" id="editBannerFile" accept="image/*">
            <button class="btn-blue" onclick="app.saveProfile()">Enregistrer</button>
        </div>
    </div>

    <div id="modalLoginEmail" class="modal"><div class="modal-box"><span class="close" onclick="app.closeModals()">&times;</span><h2>1/4 Email</h2><input type="email" id="logEmail"><button class="btn-blue" onclick="app.loginStep(1)">Suivant</button></div></div>
    <div id="modalLoginRegister" class="modal"><div class="modal-box"><span class="close" onclick="app.closeModals()">&times;</span><h2>2/4 Cr√©ation</h2><input type="text" id="logNewName" placeholder="Pseudo"><input type="password" id="logNewPass" placeholder="Mot de passe"><button class="btn-blue" onclick="app.loginStep(2)">Cr√©er</button></div></div>
    <div id="modalLoginPass" class="modal"><div class="modal-box"><span class="close" onclick="app.closeModals()">&times;</span><h2>3/4 Connexion</h2><p id="welcomeUser"></p><input type="password" id="logPass"><button class="btn-blue" onclick="app.loginStep(3)">Connexion</button></div></div>
    
    <script>
        // =========================================================================
        // ‚ö†Ô∏è CONFIGURATION CRITIQUE
        // =========================================================================
        
        // 1. URL DU WORKER CLOUDFLARE (Le lien que vous avez eu √† l'√©tape 1)
        const WORKER_PROXY_URL = "https://mytubeupload.edonis-imbert.workers.dev/"; // ‚¨ÖÔ∏è COLLEZ VOTRE URL ICI !
        
        // 2. CONFIG CLOUDINARY (Images/Vid√©os)
        const CLOUDINARY_CLOUD_NAME = "dvbsmh8qq"; 
        const CLOUDINARY_UPLOAD_PRESET = "mytube_upload"; 

        // 3. URL LECTURE GIST (Ne changez pas √ßa)
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json"; 
        const GIST_FILE_NAME = "video.json";
        // =========================================================================

        let registeredUsers = JSON.parse(localStorage.getItem('mt_users_db')) || {};
        const app = {
            data: {
                user: JSON.parse(localStorage.getItem('mt_user')),
                videos: JSON.parse(localStorage.getItem('mt_videos')) || [],
                votes: JSON.parse(localStorage.getItem('mt_votes')) || {}, 
                subs: JSON.parse(localStorage.getItem('mt_subs')) || [], 
            },
            
            init: function() {
                this.loadVideosFromGist().then(() => {
                    this.updateAuthUI();
                    this.goHome();
                });
            },
            
            // --- CHARGEMENT (LECTURE SEULE) ---
            loadVideosFromGist: async function() {
                try {
                    const response = await fetch(GIST_URL + "?t=" + Date.now());
                    if (!response.ok) throw new Error("Erreur lecture Gist");
                    this.data.videos = await response.json();
                    localStorage.setItem('mt_videos', JSON.stringify(this.data.videos));
                } catch (error) {
                    console.error("Erreur de chargement des vid√©os:", error);
                }
                this.save();
            },

            // --- SAUVEGARDE VIA LE WORKER (S√âCURIS√â) ---
            updateGist: async function(newVideoList) {
                if (WORKER_PROXY_URL.includes("votre-worker")) {
                    alert("ERREUR: Vous n'avez pas mis l'URL de votre Worker Cloudflare !");
                    return;
                }

                const payload = {
                    files: {
                        [GIST_FILE_NAME]: {
                            content: JSON.stringify(newVideoList, null, 2)
                        }
                    }
                };

                try {
                    const response = await fetch(WORKER_PROXY_URL, { 
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        alert("Erreur sauvegarde. Le Worker n'a pas r√©ussi √† joindre GitHub (Code: " + response.status + ")");
                        throw new Error("Worker Error");
                    }
                    console.log("Sauvegarde r√©ussie via Worker !");
                } catch (error) {
                    alert("Impossible de sauvegarder. V√©rifiez si le Worker est bien d√©ploy√© et si son URL est correcte.");
                }
            },

            // --- GESTION DES VOTES (LIKE/DISLIKE) ---
            toggleVote: async function(videoId, type) {
                if (!this.data.user) return alert("Connecte-toi pour voter !");
                
                const currentVote = this.data.votes[videoId];
                const videoIndex = this.data.videos.findIndex(v => v.id == videoId);
                if (videoIndex === -1) return;

                const v = this.data.videos[videoIndex];

                // 1. Retirer le vote pr√©c√©dent (si existant)
                if (currentVote === 'like') { v.likes--; }
                if (currentVote === 'dislike') { v.dislikes--; }
                
                // 2. D√©terminer le nouveau vote
                if (currentVote === type) {
                    // Clic sur le m√™me bouton : ON D√â-VOTE
                    delete this.data.votes[videoId];
                } else {
                    // Clic sur un autre bouton ou pas de vote : ON VOTE
                    if (type === 'like') { v.likes++; }
                    if (type === 'dislike') { v.dislikes++; }
                    this.data.votes[videoId] = type;
                }

                this.save();
                this.render(this.data.videos); 
                await this.updateGist(this.data.videos);
            },

            // --- GESTION DES ABONNEMENTS ---
            toggleSub: async function(authorName) {
                if (!this.data.user) return alert("Connecte-toi pour t'abonner !");

                const index = this.data.subs.indexOf(authorName);
                if (index > -1) {
                    // D√©j√† abonn√© -> D√©sabonnement
                    this.data.subs.splice(index, 1);
                    alert(`Vous √™tes d√©sabonn√© de ${authorName}.`);
                } else {
                    // Pas abonn√© -> Abonnement
                    this.data.subs.push(authorName);
                    alert(`Vous √™tes abonn√© √† ${authorName}.`);
                }

                this.save();
                this.render(this.data.videos); 
            },

            // --- UPLOAD CLOUDINARY ---
            uploadToCloudinary: async function(file, resourceType) {
                const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) throw new Error("Erreur Upload Cloudinary");
                const data = await response.json();
                return data.secure_url;
            },

            // --- PUBLICATION ---
            publish: async function() {
                const rawTitle = document.getElementById('upTitle').value;
                const title = rawTitle.replace(/[\u0000-\u001F\u007F-\u009F]/g, "").trim(); 
                const videoInput = document.getElementById('upVideoFile');
                const thumbInput = document.getElementById('upThumbFile');

                if (!title || !videoInput.files.length || !thumbInput.files.length) {
                    return alert("Tout est requis !");
                }
                
                const btn = document.getElementById('publishBtn');
                const status = document.getElementById('uploadStatus');
                btn.classList.add('disabled');
                
                try {
                    status.innerText = '1/2 Upload miniature...';
                    const thumbUrl = await this.uploadToCloudinary(thumbInput.files[0], 'image');

                    status.innerText = '2/2 Upload vid√©o... (Patientez)';
                    const videoUrl = await this.uploadToCloudinary(videoInput.files[0], 'video');

                    status.innerText = 'Sauvegarde...';
                    const newVideo = {
                        id: Date.now(),
                        title: title,
                        url: videoUrl, 
                        thumb: thumbUrl, 
                        author: this.data.user.name,
                        likes: 0, 
                        dislikes: 0 
                    };

                    this.data.videos.unshift(newVideo);
                    await this.updateGist(this.data.videos);
                    
                    alert("Vid√©o publi√©e !");
                    this.closeModals();
                    this.goHome();
                } catch (error) {
                    alert("Erreur: " + error.message);
                } finally {
                    status.innerText = '';
                    btn.classList.remove('disabled');
                }
            },

            // --- RENDER (AFFICHAGE) ---
            render: function(list, target='videoGrid') {
                const g = document.getElementById(target); g.innerHTML = "";
                list.forEach(v => {
                    const t = v.thumb || "https://placehold.co/600x400?text=No+Image";
                    const isLiked = this.data.votes[v.id] === 'like' ? 'liked' : '';
                    const isDisliked = this.data.votes[v.id] === 'dislike' ? 'disliked' : '';
                    const isSubscribed = this.data.subs.includes(v.author);
                    const subText = isSubscribed ? '‚úÖ Abonn√©' : 'üîî S\'abonner';

                    g.innerHTML += `
                    <div class="video-card">
                        <div class="thumb-container" onclick="app.playVideo('${v.url}', '${v.title.replace(/'/g, "\\'")}')">
                            <img src="${t}" class="thumb"><div class="play-icon">‚ñ∂</div>
                        </div>
                        <div class="info">
                            <img src="${this.generateAvatarUrl(v.author, 36)}" class="avatar-small">
                            <div class="details">
                                <h4>${v.title}</h4>
                                <p>${v.author} 
                                    <button class="action-pill" onclick="event.stopPropagation(); app.toggleSub('${v.author.replace(/'/g, "\\'")}')">${subText}</button>
                                </p>
                                <div class="actions-bar">
                                    <button class="action-pill ${isLiked}" onclick="event.stopPropagation(); app.toggleVote(${v.id}, 'like')">üëç ${v.likes}</button>
                                    <button class="action-pill ${isDisliked}" onclick="event.stopPropagation(); app.toggleVote(${v.id}, 'dislike')">üëé ${v.dislikes}</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
            },

            // --- AUTRES FONCTIONS (Navigation, Profil, etc.) ---
            saveProfile: async function() {
                if (!this.data.user) return alert("Connectez-vous.");
                const ppFile = document.getElementById('editPPFile').files[0];
                const bannerFile = document.getElementById('editBannerFile').files[0];
                
                try {
                    if(ppFile) this.data.user.avatar = await this.uploadToCloudinary(ppFile, 'image');
                    if(bannerFile) this.data.user.banner = await this.uploadToCloudinary(bannerFile, 'image');
                    
                    this.data.user.name = document.getElementById('editName').value || this.data.user.name;
                    this.data.user.bio = document.getElementById('editBio').value || this.data.user.bio;
                    
                    registeredUsers[this.data.user.email] = this.data.user;
                    this.save();
                    this.updateAuthUI();
                    this.closeModals();
                    this.goProfile();
                } catch(e) { alert("Erreur profil: " + e.message); }
            },

            // Outils et Navigation
            save: function() {
                localStorage.setItem('mt_user', JSON.stringify(this.data.user));
                localStorage.setItem('mt_users_db', JSON.stringify(registeredUsers));
                localStorage.setItem('mt_votes', JSON.stringify(this.data.votes));
                localStorage.setItem('mt_subs', JSON.stringify(this.data.subs)); 
            },
            generateAvatarUrl: function(name, size) {
                return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><circle cx='${size/2}' cy='${size/2}' r='${size/2}' fill='#555'/><text x='50%' y='60%' text-anchor='middle' fill='white' font-size='${size/2}'>${name?name[0]:'U'}</text></svg>`;
            },
            goHome: function() {
                document.getElementById('profileView').style.display = 'none';
                document.getElementById('videoGrid').style.display = 'grid';
                this.render(this.data.videos);
            },
            goProfile: function() {
                if(!this.data.user) return alert("Connecte-toi !");
                document.getElementById('videoGrid').style.display = 'none';
                document.getElementById('profileView').style.display = 'block';
                
                const u = this.data.user;
                const av = (u.avatar && u.avatar.startsWith('http')) ? u.avatar : this.generateAvatarUrl(u.name, 100);
                document.getElementById('profileAvatar').src = av;
                document.getElementById('pName').innerText = u.name;
                document.getElementById('pBio').innerText = u.bio || "";
                
                const ban = document.querySelector('#profileView .banner');
                if(u.banner && u.banner.startsWith('http')) {
                    ban.style.backgroundImage = `url(${u.banner})`;
                    ban.style.backgroundSize = 'cover';
                } else {
                    ban.style.background = 'linear-gradient(90deg, #b92b27, #1565C0)';
                }
                
                this.render(this.data.videos.filter(v => v.author === u.name), 'pVideos');
            },
            goSubs: function() {
                if(!this.data.user) return alert("Connecte-toi pour voir tes abonnements !");
                document.getElementById('profileView').style.display = 'none';
                document.getElementById('videoGrid').style.display = 'grid';
                
                const filteredVideos = this.data.videos.filter(v => this.data.subs.includes(v.author));
                this.render(filteredVideos);

                if (filteredVideos.length === 0) {
                     document.getElementById('videoGrid').innerHTML = '<h3 style="color:#aaa; text-align:center;">Aucune vid√©o de vos abonnements.</h3>';
                }
            },
            playVideo: function(url, title) {
                const p = document.getElementById('playerModal');
                const v = document.getElementById('mainVideoPlayer');
                document.getElementById('playerTitle').innerText = title;
                v.src = url; p.style.display = 'flex'; v.play();
            },
            closePlayer: function() {
                const v = document.getElementById('mainVideoPlayer');
                v.pause(); v.src = ""; document.getElementById('playerModal').style.display = 'none';
            },
            // UI Helpers
            openUpload: function() { 
                if(!this.data.user) return alert("Connecte-toi !");
                document.getElementById('modalUpload').style.display = 'flex'; 
            },
            openEditProfile: function() {
                if(!this.data.user) return alert("Connecte-toi !");
                document.getElementById('editName').value = this.data.user.name;
                document.getElementById('modalEditProfile').style.display = 'flex';
            },
            closeModals: function() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); },
            // Login logic (simplifi√©)
            toggleAccountMenu: function() { if(!this.data.user) this.openLogin(); else document.getElementById('accountMenu').style.display = 'block'; },
            openLogin: function() { document.getElementById('modalLoginEmail').style.display = 'flex'; },
            loginStep: function(s) { /* Logique identique √† avant */ app.closeModals(); if(s==1) document.getElementById('modalLoginRegister').style.display='flex'; else if(s==2) { registeredUsers['test']={name:'test', email:'test'}; app.data.user=registeredUsers['test']; app.save(); app.updateAuthUI(); } },
            doLogout: function() { this.data.user=null; this.save(); this.updateAuthUI(); document.getElementById('accountMenu').style.display='none'; },
            updateAuthUI: function() { 
                const b = document.getElementById('loginBtn');
                if(this.data.user) { b.innerText = this.data.user.name; b.style.border='none'; }
                else { b.innerText = 'üë§ Se connecter'; b.style.border='1px solid var(--blue)'; }
            }
        };
        app.init();
    </script>
</body>
</html>
