<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona Titan - Correction Int√©grale</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; 
            --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --green: #00a854; 
            --gold: #ffc107; --glass: rgba(255, 255, 255, 0.05); --sidebar-width: 240px;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; overflow-x: hidden; }

        /* HEADER */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 56px;
            background: var(--header); display: flex; align-items: center;
            justify-content: space-between; padding: 0 16px; z-index: 2000; border-bottom: 1px solid #222;
        }

        .search-container { display: flex; align-items: center; background: #121212; border: 1px solid #333; border-radius: 40px; padding: 0 15px; width: 35%; }
        .search-container input { background: none; border: none; color: white; padding: 8px; width: 100%; outline: none; }

        /* SIDEBAR FIXE */
        .sidebar {
            position: fixed; left: 0; top: 56px; bottom: 0; width: var(--sidebar-width);
            background: var(--bg); overflow-y: auto; padding-top: 10px; z-index: 1000;
        }
        .nav-item {
            display: flex; align-items: center; gap: 20px; padding: 12px 24px;
            cursor: pointer; border-radius: 10px; margin: 2px 10px; transition: 0.2s; font-size: 14px;
        }
        .nav-item:hover, .nav-item.active { background: var(--hover); }

        /* MAIN CONTENT */
        .main-content { margin-left: var(--sidebar-width); margin-top: 56px; padding: 20px; min-height: 100vh; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }

        /* ZAPPS FULL SCREEN FIX */
        .zapp-view { display: none; height: calc(100vh - 56px); overflow-y: scroll; scroll-snap-type: y mandatory; background: #000; }
        .zapp-container { height: 100%; scroll-snap-align: start; position: relative; display: flex; justify-content: center; align-items: center; }
        .zapp-video-wrapper { height: 92%; aspect-ratio: 9/16; position: relative; border-radius: 15px; overflow: hidden; background: #111; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .zapp-video { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        
        .zapp-actions { position: absolute; right: 15px; bottom: 60px; display: flex; flex-direction: column; gap: 20px; z-index: 10; align-items: center; }
        .zapp-btn { background: rgba(40,40,40,0.6); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; transition: 0.3s; }
        .zapp-btn:hover { background: var(--hover); transform: scale(1.1); }

        /* MODALES */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 3000; padding: 20px; }
        .modal-content { background: #212121; padding: 30px; border-radius: 15px; width: 100%; max-width: 550px; position: relative; border: 1px solid #333; }
        
        /* ADMIN & STATS BOXES */
        .admin-box { background: #1a1a1a; border-radius: 12px; padding: 20px; border: 1px solid #333; margin-bottom: 15px; }
        .stat-card-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }

        /* INPUTS PERSONNALISATION */
        .titan-input { width: 100%; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; outline: none; }
        .titan-input:focus { border-color: var(--blue); }

        @media (max-width: 1000px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding-bottom: 80px; }
            .search-container { width: 40px; border: none; background: none; }
            .search-container input { display: none; }
        }
    </style>
</head>
<body>
    <header>
        <div style="display:flex; align-items:center; gap:20px;">
            <span style="font-size:24px; cursor:pointer;" onclick="app.nav('home')">‚ò∞</span>
            <h1 style="font-size:20px; color:var(--red); letter-spacing:-1px; cursor:pointer;" onclick="app.nav('home')">VISIONA<span style="color:white; font-weight:300;">TITAN</span></h1>
        </div>
        <div class="search-container">
            <input type="text" id="mainSearch" placeholder="Rechercher..." onkeyup="if(event.key==='Enter') app.search()">
            <button onclick="app.search()" style="background:none; border:none; color:white; cursor:pointer;">üîç</button>
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <button onclick="app.openModal('modal-upload')" style="background:var(--blue); border:none; color:black; padding:8px 16px; border-radius:20px; cursor:pointer; font-weight:bold;">+ Cr√©er</button>
            <div id="notif-bell" style="position:relative; cursor:pointer;" onclick="app.toggleNotifs()">
                üîî<span id="notif-badge" style="position:absolute; top:-5px; right:-5px; background:red; font-size:10px; width:15px; height:15px; border-radius:50%; display:none; text-align:center;">0</span>
            </div>
            <img id="header-avatar-img" onclick="app.toggleDropdown()" src="https://via.placeholder.com/34" style="width:34px; height:34px; border-radius:50%; cursor:pointer; border:1px solid #333; object-fit:cover;">
            
            <div id="profile-dropdown" style="display:none; position:absolute; top:55px; right:15px; background:#282828; border-radius:12px; width:250px; box-shadow:0 10px 40px rgba(0,0,0,0.8); z-index:3000; border:1px solid #444;">
                <div style="padding:15px; border-bottom:1px solid #444; font-weight:bold;" id="dropdown-username">Visiteur</div>
                <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma cha√Æne</div>
                <div class="nav-item" onclick="app.openModal('modal-admin')" id="admin-panel-btn" style="display:none; color:var(--gold);">üõ°Ô∏è Panel Admin</div>
                <div class="nav-item" onclick="app.logout()" style="color:var(--red);">üö™ D√©connexion</div>
            </div>
        </div>
    </header>

    <nav class="sidebar">
        <div class="nav-item active" id="nav-home" onclick="app.nav('home')">üè† Accueil</div>
        <div class="nav-item" id="nav-zapp" onclick="app.nav('zapp')">üöÄ Zapps</div>
        <div class="nav-item" id="nav-subs" onclick="app.nav('subs')">üì∫ Abonnements</div>
        <hr style="border:0; border-top:1px solid #333; margin:10px 10px;">
        <div class="nav-item" id="nav-history" onclick="app.nav('history')">üïí Historique</div>
        <div class="nav-item" id="nav-posts" onclick="app.nav('posts')">üí¨ Communaut√©</div>
        <div class="nav-item" id="nav-stats" onclick="app.nav('stats')">üìä Statistiques</div>
        <div class="nav-item" onclick="app.triggerEgg()">üåå ???</div>
    </nav>

    <main class="main-content">
        <div id="alert-area"></div>
        <section id="view-home"><div class="video-grid" id="home-grid"></div></section>
        <section id="view-zapp" class="zapp-view"></section>
        <section id="view-subs" style="display:none;"></section>
        <section id="view-history" style="display:none;"></section>
        <section id="view-posts" style="display:none;"></section>
        <section id="view-stats" style="display:none;"></section>
        <section id="view-profile" style="display:none;"></section>
    </main>
    <div id="modal-auth" class="modal"><div class="modal-content">
        <h2>Connexion Titan</h2>
        <input type="text" id="auth-username" class="titan-input" placeholder="Pseudo">
        <input type="email" id="auth-email" class="titan-input" placeholder="Email">
        <button onclick="app.handleAuth()" style="width:100%; padding:12px; background:var(--blue); border:none; border-radius:8px; font-weight:bold; cursor:pointer;">SE CONNECTER / S'INSCRIRE</button>
        <button onclick="app.closeModals()" style="width:100%; margin-top:10px; background:none; border:none; color:var(--sec-text); cursor:pointer;">Annuler</button>
    </div></div>

    <script>
        // CONFIGURATION
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
        const WORKER_URL = "https://mytubeupload.edonis-imbert.workers.dev/";

        const app = {
            data: { videos: [], users: {}, posts: [], annonces: [], notifications: [], thanks: [] },
            user: JSON.parse(localStorage.getItem('visiona_user')),
            stats: JSON.parse(localStorage.getItem('visiona_stats')) || { time: 0, views: 0, likes: 0, level: 1 },
            history: JSON.parse(localStorage.getItem('v_history')) || [],
            eggCount: 0,
            activeVid: null,

            // 1. INITIALISATION (Lancement de tous les syst√®mes)
            init: async function() {
                console.log("D√©marrage de Visiona Titan...");
                await this.fetchData();
                this.updateUI();
                this.nav('home');
                this.startStatsTimer();
                this.checkAnnonces();
                this.initAudioUnblocker(); // Correction Son Zap
                
                // Fermer le dropdown si clic ailleurs
                window.onclick = (e) => {
                    if (!e.target.closest('#header-avatar-img') && !e.target.closest('#profile-dropdown')) {
                        document.getElementById('profile-dropdown').style.display = 'none';
                    }
                };
            },

            // 2. R√âCUP√âRATION DES DONN√âES (Fix disparition)
            fetchData: async function() {
                try {
                    const r = await fetch(GIST_URL + "?t=" + Date.now());
                    const json = await r.json();
                    this.data = {
                        videos: json.videos || [],
                        users: json.users || {},
                        posts: json.posts || [],
                        annonces: json.annonces || [],
                        notifications: json.notifications || [],
                        thanks: json.thanks || []
                    };
                    console.log("Synchronisation Cloud r√©ussie.");
                } catch(e) {
                    console.error("Erreur Sync Cloud, chargement local.");
                    const backup = localStorage.getItem('visiona_backup');
                    if (backup) this.data = JSON.parse(backup);
                }
            },

            // 3. SAUVEGARDE RENFORC√âE (Fix Directs & Profils)
            saveGist: async function() {
                if (!this.user) return;
                try {
                    // Sauvegarde imm√©diate en local par s√©curit√©
                    localStorage.setItem('visiona_backup', JSON.stringify(this.data));
                    
                    const response = await fetch(WORKER_URL, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            files: { "video.json": { content: JSON.stringify(this.data, null, 2) } }
                        })
                    });
                    if (response.ok) console.log("‚úÖ Donn√©es Titan Cloud √† jour.");
                } catch(e) {
                    console.error("‚ùå √âchec de la mise √† jour Cloud.");
                }
            },

           // --- SYST√àME DE NAVIGATION ROBUSTE (FIX BOUTONS) ---
            nav: function(pageId) {
                console.log("Navigation vers : " + pageId);
                
                // 1. Fermer les √©l√©ments persistants
                this.closeModals();
                this.closePlayer();
                if(this.activeStream) this.stopLiveSystem();

                // 2. Liste de toutes les sections possibles
                const sections = ['home', 'zapp', 'subs', 'history', 'posts', 'stats', 'profile'];
                
                sections.forEach(s => {
                    const el = document.getElementById('view-' + s);
                    const navLink = document.getElementById('nav-' + s);
                    if (el) {
                        el.style.display = (s === pageId) ? 'block' : 'none';
                    }
                    if (navLink) {
                        if (s === pageId) navLink.classList.add('active');
                        else navLink.classList.remove('active');
                    }
                });

                // 3. D√©clenchement des rendus sp√©cifiques
                switch(pageId) {
                    case 'home': this.renderHome(); break;
                    case 'zapp': this.renderZapp(); break;
                    case 'stats': this.renderStats(); break;
                    case 'history': this.renderHistory(); break;
                    case 'posts': this.renderPosts(); break;
                    case 'profile': this.renderProfile(); break;
                }
                
                // Remonter en haut de page
                window.scrollTo(0, 0);
            },

            // --- GESTION DES MODALES (FIX OUVERTURE) ---
            openModal: function(modalId) {
                console.log("Ouverture modale : " + modalId);
                const m = document.getElementById(modalId);
                if (m) {
                    m.style.display = 'flex';
                } else {
                    // Si la modale n'existe pas dans le HTML, on la cr√©e dynamiquement
                    this.createDynamicModal(modalId);
                }
            },

            closeModals: function() {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(m => m.style.display = 'none');
                // On s'assure de supprimer les modales dynamiques pour ne pas polluer le DOM
                const dyn = document.getElementById('modal-join');
                if(dyn) dyn.remove();
            },

            // --- CR√âATION DE CONTENU MANQUANT (S√âCURIT√â) ---
            createVideoCard: function(v) {
                // Cette fonction est le c≈ìur de l'affichage. Si elle manque, rien ne marche.
                return `
                <div class="video-card" onclick="app.openPlayer('${v.id}')" style="cursor:pointer; transition:0.3s; background:var(--glass); border-radius:12px; overflow:hidden;">
                    <div style="position:relative; aspect-ratio:16/9; background:#222;">
                        <img src="${v.thumb}" style="width:100%; height:100%; object-fit:cover;">
                        ${v.isLive ? '<span style="position:absolute; top:10px; left:10px; background:red; color:white; padding:2px 8px; border-radius:4px; font-weight:bold; font-size:12px;">DIRECT</span>' : ''}
                    </div>
                    <div style="padding:12px; display:flex; gap:12px;">
                        <img src="${this.data.users[v.author]?.avatar || 'https://via.placeholder.com/36'}" style="width:36px; height:36px; border-radius:50%; flex-shrink:0;">
                        <div>
                            <h4 style="margin:0; font-size:14px; color:white; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${v.title}</h4>
                            <p style="margin:5px 0 0 0; font-size:12px; color:var(--sec-text);">${v.author}</p>
                            <p style="margin:2px 0 0 0; font-size:12px; color:var(--sec-text);">${this.formatViews(v.views)} vues ‚Ä¢ ${this.timeAgo(v.date)}</p>
                        </div>
                    </div>
                </div>`;
            },
                });

                // Afficher la cible
                const target = document.getElementById('view-' + id);
                if (target) {
                    target.style.display = id === 'zapp' ? 'block' : 'block';
                    const navActive = document.getElementById('nav-' + id);
                    if (navActive) navActive.classList.add('active');
                    
                    // D√©clencher le rendu
                    if (id === 'home') this.renderHome();
                    if (id === 'zapp') this.renderZapp();
                    if (id === 'stats') this.renderStats();
                    if (id === 'history') this.renderHistory();
                    if (id === 'subs') this.renderSubs();
                    if (id === 'posts') this.renderPosts();
                }
                window.scrollTo(0,0);
            },

            // 5. GESTION DU SON (Fix Zapp Son)
            initAudioUnblocker: function() {
                // D√©bloque l'audio sur tout le site au premier clic
                const unlock = () => {
                    console.log("Audio Titan D√©bloqu√©");
                    document.removeEventListener('click', unlock);
                    document.removeEventListener('touchstart', unlock);
                };
                document.addEventListener('click', unlock);
                document.addEventListener('touchstart', unlock);
            },

            // 6. IDENTIT√â & PERSONNALISATION (Fix PP/Banni√®re)
            handleAuth: async function() {
                const name = document.getElementById('auth-username').value.trim();
                const email = document.getElementById('auth-email').value.trim();
                if(!name || !email) return alert("Champs vides !");

                if(!this.data.users[name]) {
                    this.data.users[name] = {
                        email: email,
                        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`,
                        banner: "https://images.unsplash.com/photo-1579546678195-a9d20f0b4d44",
                        bio: "Membre de la communaut√© Titan",
                        subs: {}, followers: {},
                        level: 1, xp: 0, date: Date.now()
                    };
                    await this.saveGist();
                }
                this.user = { name: name, email: email };
                localStorage.setItem('visiona_user', JSON.stringify(this.user));
                location.reload();
            },

            updateUI: function() {
                const headImg = document.getElementById('header-avatar-img');
                const dropName = document.getElementById('dropdown-username');
                if (this.user && this.data.users[this.user.name]) {
                    const u = this.data.users[this.user.name];
                    headImg.src = u.avatar;
                    dropName.innerText = this.user.name;
                    if (this.user.name === "AlphaGames30" || this.user.name === "Admin") {
                        document.getElementById('admin-panel-btn').style.display = 'flex';
                    }
                }
            }
                // --- 7. MOTEUR ZAPPS (SHORTS) : R√âPARATION SON & SCROLL ---
            renderZapp: function() {
                const container = document.getElementById('view-zapp');
                // On filtre uniquement les vid√©os marqu√©es comme "isShort"
                const zapps = (this.data.videos || []).filter(v => v.isShort);
                
                if (zapps.length === 0) {
                    container.innerHTML = `<div style="color:var(--sec-text); text-align:center; padding-top:100px;">
                        <h2>üöÄ Aucun Zapp pour le moment</h2><p>Soyez le premier √† en cr√©er un !</p>
                    </div>`;
                    return;
                }

                // G√©n√©ration du flux vertical
                container.innerHTML = zapps.map((z, index) => `
                    <div class="zapp-container" id="zapp-${z.id}">
                        <div class="zapp-video-wrapper">
                            <video class="zapp-video" loop playsinline 
                                   src="${z.url}" 
                                   onclick="app.toggleZappPlay(this)"
                                   onplay="this.muted=false; this.volume=1;">
                            </video>
                            
                            <div class="zapp-actions">
                                <div class="zapp-action-group">
                                    <button class="zapp-btn" onclick="app.handleZappVote('${z.id}', 'like', this)">
                                        ${(z.voters && z.voters[this.user?.name] === 'like') ? '‚ù§Ô∏è' : 'ü§ç'}
                                    </button>
                                    <small>${this.formatViews(z.likes || 0)}</small>
                                </div>
                                <div class="zapp-action-group">
                                    <button class="zapp-btn" onclick="app.openZappComments('${z.id}')">üí¨</button>
                                    <small>${z.comments ? z.comments.length : 0}</small>
                                </div>
                                <div class="zapp-action-group">
                                    <button class="zapp-btn" onclick="app.shareZapp('${z.id}')">üîó</button>
                                </div>
                            </div>

                            <div style="position:absolute; bottom:20px; left:20px; right:70px; text-shadow:0 2px 10px rgba(0,0,0,0.9);">
                                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                    <img src="${this.data.users[z.author]?.avatar || ''}" style="width:35px; height:35px; border-radius:50%; border:2px solid white;">
                                    <b style="font-size:16px;">@${z.author}</b>
                                    <button onclick="app.toggleSub('${z.author}')" style="background:var(--red); color:white; border:none; padding:5px 12px; border-radius:15px; font-size:12px; font-weight:bold;">S'ABONNER</button>
                                </div>
                                <p style="font-size:14px; margin:0; line-height:1.4;">${z.title}</p>
                            </div>
                        </div>
                    </div>
                `).join('');

                this.initZappObserver();
            },

            toggleZappPlay: function(vid) {
                // Fonction simple pour mettre en pause/lecture au clic
                if (vid.paused) {
                    vid.play().catch(e => console.log("L'audio n√©cessite une interaction"));
                } else {
                    vid.pause();
                }
            },

            initZappObserver: function() {
                // Ce syst√®me d√©tecte quelle vid√©o est au centre de l'√©cran pour la lancer
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const vid = entry.target.querySelector('video');
                        if (entry.isIntersecting) {
                            if(vid) {
                                vid.currentTime = 0;
                                vid.play();
                                // On force le unmute ici car l'utilisateur a d√©j√† d√ª cliquer sur "Zapps"
                                vid.muted = false;
                                vid.volume = 1;
                            }
                        } else {
                            if(vid) vid.pause();
                        }
                    });
                }, { threshold: 0.8 }); // 80% de la vid√©o doit √™tre visible

                document.querySelectorAll('.zapp-container').forEach(c => observer.observe(c));
            },

            // --- 8. STATISTIQUES TITAN : R√âPARATION DE L'AFFICHAGE ---
            renderStats: function() {
                const container = document.getElementById('view-stats');
                if (!container) return;
                
                const hours = Math.floor(this.stats.time / 3600);
                const mins = Math.floor((this.stats.time % 3600) / 60);
                const progressToNextLevel = Math.floor((this.stats.time % 3600) / 36);

                container.innerHTML = `
                    <div style="max-width:900px; margin:0 auto; animation: fadeIn 0.5s ease;">
                        <h1 style="font-size:32px; margin-bottom:30px;">üìä Tableau de Bord Personnel</h1>
                        
                        <div class="stat-card-row">
                            <div class="admin-box" style="text-align:center; border-top:4px solid var(--blue);">
                                <small style="color:var(--sec-text); text-transform:uppercase;">Niveau Titan</small>
                                <div style="font-size:48px; font-weight:bold; color:var(--blue); margin:10px 0;">${this.stats.level}</div>
                                <div style="width:100%; height:6px; background:#333; border-radius:10px; overflow:hidden;">
                                    <div style="width:${progressToNextLevel}%; height:100%; background:var(--blue);"></div>
                                </div>
                                <small style="display:block; margin-top:8px;">${progressToNextLevel}% vers niveau suivant</small>
                            </div>
                            <div class="admin-box" style="text-align:center; border-top:4px solid var(--green);">
                                <small style="color:var(--sec-text); text-transform:uppercase;">Visionnage</small>
                                <div style="font-size:48px; font-weight:bold; color:var(--green); margin:10px 0;">${hours}<span style="font-size:20px;">h</span>${mins}</div>
                                <p style="margin:0; font-size:12px;">Temps total accumul√©</p>
                            </div>
                            <div class="admin-box" style="text-align:center; border-top:4px solid var(--red);">
                                <small style="color:var(--sec-text); text-transform:uppercase;">Vid√©os Vues</small>
                                <div style="font-size:48px; font-weight:bold; color:var(--red); margin:10px 0;">${this.stats.views}</div>
                                <p style="margin:0; font-size:12px;">Contenus consomm√©s</p>
                            </div>
                        </div>

                        <div class="admin-box" style="background:linear-gradient(135deg, #1a1a1a 0%, #000 100%);">
                            <h3>üöÄ Avantages de votre grade</h3>
                            <ul style="color:var(--sec-text); line-height:1.8;">
                                <li>Badge de fid√©lit√© √† c√¥t√© du pseudo : <b>Activ√©</b></li>
                                <li>Acc√®s aux √©mojis exclusifs en commentaire : <b>Niveau ${this.stats.level > 5 ? 'D√©bloqu√©' : '5 requis'}</b></li>
                                <li>Priorit√© dans l'algorithme Titan : <b>Activ√©e</b></li>
                            </ul>
                        </div>
                    </div>
                `;
            },

            // --- 9. PANEL ADMIN : R√âPARATION VISUELLE (FIX PHOTO 1) ---
            renderAdmin: function() {
                const modal = document.getElementById('modal-admin');
                const content = document.getElementById('admin-panel-content') || document.querySelector('#modal-admin .modal-content');
                
                if (!this.user || (this.user.name !== "AlphaGames30" && this.user.name !== "Admin")) return;

                modal.style.display = 'flex';
                const totalUsers = Object.keys(this.data.users).length;
                const totalVids = this.data.videos.length;

                modal.querySelector('.modal-content').innerHTML = `
                    <h2 style="color:var(--gold); display:flex; align-items:center; gap:10px;">üõ°Ô∏è Administration Supr√™me <button onclick="app.closeModals()" style="margin-left:auto; background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button></h2>
                    <div class="stat-card-row">
                        <div style="background:var(--hover); padding:15px; border-radius:10px;">
                            <small>Utilisateurs</small><div style="font-size:24px; font-weight:bold;">${totalUsers}</div>
                        </div>
                        <div style="background:var(--hover); padding:15px; border-radius:10px;">
                            <small>Vid√©os</small><div style="font-size:24px; font-weight:bold;">${totalVids}</div>
                        </div>
                        <div style="background:var(--hover); padding:15px; border-radius:10px;">
                            <small>Serveur</small><div style="font-size:24px; font-weight:bold; color:var(--green);">Stable</div>
                        </div>
                    </div>

                    <div class="admin-box">
                        <h3>üì¢ Message d'Alerte Global</h3>
                        <textarea id="adm-ann-txt" class="titan-input" style="height:60px;">${this.data.annonces?.[0]?.text || ''}</textarea>
                        <button onclick="app.saveAnn()" style="background:var(--blue); color:black; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">DIFFUSER MAINTENANT</button>
                    </div>

                    <div class="admin-box">
                        <h3>üö´ Mod√©ration de Contenu</h3>
                        <div style="max-height:150px; overflow-y:auto; background:#000; padding:10px; border-radius:8px;">
                            ${this.data.videos.slice(0,20).map(v => `
                                <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #222; padding-bottom:5px;">
                                    <span style="font-size:12px;">${v.title.substring(0,30)}... (@${v.author})</span>
                                    <button onclick="app.deleteVideo('${v.id}')" style="color:red; background:none; border:none; cursor:pointer; font-size:10px;">Supprimer</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },
        // --- 10. MOTEUR DE PROFIL AVANC√â (FIX PERSONNALISATION PHOTO) ---
            goProfile: function(username) {
                console.log("Chargement du profil de : " + username);
                this.activeProfile = username;
                this.nav('profile');
                this.renderProfile();
            },

            goMyProfile: function() {
                if (!this.user) {
                    this.openModal('modal-auth');
                    return;
                }
                this.goProfile(this.user.name);
            },

            renderProfile: function() {
                const container = document.getElementById('view-profile');
                if (!container) return;

                const u = this.data.users[this.activeProfile];
                if (!u) {
                    container.innerHTML = `<div style="padding:100px; text-align:center;"><h2>Utilisateur Introuvable</h2><button onclick="app.nav('home')">Retour</button></div>`;
                    return;
                }

                const isMe = this.user && this.user.name === this.activeProfile;
                const subCount = Object.keys(u.followers || {}).length;

                // Construction de l'interface Profil
                container.innerHTML = `
                    <div class="profile-header" style="animation: fadeIn 0.8s ease;">
                        <div class="profile-banner" style="height:250px; background:url('${u.banner || 'https://images.unsplash.com/photo-1579546678195-a9d20f0b4d44'}') center/cover; border-radius:15px; position:relative; border: 1px solid #333;">
                            ${isMe ? `<button onclick="app.openEditProfile()" style="position:absolute; bottom:15px; right:15px; padding:10px 20px; border-radius:25px; border:none; background:rgba(0,0,0,0.7); color:white; cursor:pointer; font-weight:bold; backdrop-filter:blur(5px);">üì∏ Modifier le profil</button>` : ''}
                        </div>

                        <div style="display:flex; align-items:flex-start; gap:25px; padding:0 30px;">
                            <img src="${u.avatar}" style="width:140px; height:140px; border-radius:50%; border:6px solid var(--bg); margin-top:-70px; z-index:10; background:#222; object-fit:cover;">
                            <div style="flex:1; padding-top:15px;">
                                <h1 style="margin:0; font-size:32px;">${this.activeProfile} ${u.badge || ''}</h1>
                                <p style="color:var(--sec-text); margin:8px 0; font-size:15px;">
                                    <b>${this.formatViews(subCount)}</b> abonn√©s ‚Ä¢ <b>${(this.data.videos.filter(v=>v.author===this.activeProfile)).length}</b> vid√©os
                                </p>
                                <p style="font-size:14px; color:#ddd; max-width:600px; line-height:1.5;">${u.bio || 'Aucune description disponible pour ce profil.'}</p>
                            </div>
                            <div style="padding-top:20px;">
                                ${!isMe ? `
                                    <button onclick="app.toggleSub('${this.activeProfile}')" style="background:${this.isSubscribed(this.activeProfile) ? '#222' : 'white'}; color:${this.isSubscribed(this.activeProfile) ? 'white' : 'black'}; border:none; padding:12px 24px; border-radius:30px; font-weight:bold; cursor:pointer;">
                                        ${this.isSubscribed(this.activeProfile) ? 'ABONN√â' : 'S\'ABONNER'}
                                    </button>
                                ` : `
                                    <button onclick="app.openModal('modal-upload')" style="background:var(--hover); color:white; border:1px solid #444; padding:10px 20px; border-radius:25px; cursor:pointer;">G√©rer les vid√©os</button>
                                `}
                            </div>
                        </div>

                        <div style="display:flex; gap:30px; margin-top:30px; border-bottom:1px solid #333; padding:0 30px;">
                            <div class="tab active" style="padding-bottom:15px; cursor:pointer; border-bottom:3px solid white;">VID√âOS</div>
                            <div class="tab" style="padding-bottom:15px; cursor:pointer; color:var(--sec-text);">POSTS</div>
                            <div class="tab" style="padding-bottom:15px; cursor:pointer; color:var(--sec-text);">√Ä PROPOS</div>
                        </div>

                        <div id="profile-vids" class="video-grid" style="padding:25px 0;">
                            ${this.data.videos.filter(v => v.author === this.activeProfile).map(v => this.createVideoCard(v)).join('')}
                        </div>
                    </div>

                    <div id="modal-edit-profile" class="modal">
                        <div class="modal-content">
                            <h3>Param√®tres de la cha√Æne</h3>
                            <label>URL de l'avatar (Photo de profil)</label>
                            <input type="text" id="edit-avatar" class="titan-input" value="${u.avatar}">
                            <label>URL de la banni√®re</label>
                            <input type="text" id="edit-banner" class="titan-input" value="${u.banner || ''}">
                            <label>Description de la cha√Æne</label>
                            <textarea id="edit-bio" class="titan-input" style="height:80px;">${u.bio || ''}</textarea>
                            <div style="display:flex; gap:10px; margin-top:15px;">
                                <button onclick="app.saveProfileSettings()" style="flex:1; background:var(--green); border:none; color:white; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">ENREGISTRER</button>
                                <button onclick="app.closeModals()" style="flex:1; background:var(--hover); color:white; border:none; padding:12px; border-radius:8px; cursor:pointer;">ANNULER</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            openEditProfile: function() {
                document.getElementById('modal-edit-profile').style.display = 'flex';
            },

            saveProfileSettings: async function() {
                const u = this.data.users[this.user.name];
                u.avatar = document.getElementById('edit-avatar').value.trim();
                u.banner = document.getElementById('edit-banner').value.trim();
                u.bio = document.getElementById('edit-bio').value.trim();

                await this.saveGist();
                alert("Profil Titan mis √† jour !");
                this.renderProfile();
                this.updateUI();
            },

            // --- 11. SYST√àME DE COMMUNAUT√â (POSTS) ---
            renderPosts: function() {
                const container = document.getElementById('view-posts');
                if (!container) return;

                container.innerHTML = `
                    <div style="max-width:700px; margin:0 auto; padding-top:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                            <h1>Communaut√© Visiona</h1>
                            <button onclick="app.openModal('modal-create-post')" style="background:var(--blue); color:black; border:none; padding:10px 20px; border-radius:25px; font-weight:bold; cursor:pointer;">+ Nouveau Post</button>
                        </div>
                        <div id="posts-feed">
                            ${(this.data.posts || []).map(p => this.createPostCard(p)).join('')}
                        </div>
                    </div>

                    <div id="modal-create-post" class="modal">
                        <div class="modal-content">
                            <h3>Cr√©er une publication</h3>
                            <textarea id="post-text" class="titan-input" style="height:120px;" placeholder="Quoi de neuf aujourd'hui ?"></textarea>
                            <input type="text" id="post-img" class="titan-input" placeholder="URL d'une image (optionnel)">
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button onclick="app.submitPost()" style="flex:1; background:var(--blue); color:black; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">PUBLIER</button>
                                <button onclick="app.closeModals()" style="flex:1; background:var(--hover); border:none; color:white; padding:12px; border-radius:8px; cursor:pointer;">FERMER</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            createPostCard: function(p) {
                const u = this.data.users[p.author] || {};
                return `
                    <div class="admin-box" style="margin-bottom:20px; animation: slideUp 0.5s ease;">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
                            <img src="${u.avatar}" style="width:45px; height:45px; border-radius:50%; object-fit:cover;">
                            <div>
                                <b style="font-size:16px;">${p.author}</b>
                                <div style="color:var(--sec-text); font-size:12px;">${this.timeAgo(p.date)}</div>
                            </div>
                        </div>
                        <p style="font-size:15px; line-height:1.6; white-space:pre-wrap;">${p.text}</p>
                        ${p.image ? `<img src="${p.image}" style="width:100%; border-radius:10px; margin-top:10px; border:1px solid #333;">` : ''}
                        <div style="margin-top:20px; display:flex; gap:25px; border-top:1px solid #333; padding-top:15px;">
                            <span style="cursor:pointer; display:flex; align-items:center; gap:5px;" onclick="app.likePost('${p.id}')">üëç ${p.likes || 0}</span>
                            <span style="cursor:pointer; display:flex; align-items:center; gap:5px;">üí¨ Commenter</span>
                            <span style="cursor:pointer; margin-left:auto;">üîî</span>
                        </div>
                    </div>
                `;
            },

            submitPost: async function() {
                if (!this.user) return this.openModal('modal-auth');
                const text = document.getElementById('post-text').value.trim();
                const img = document.getElementById('post-img').value.trim();
                if (!text) return alert("Le texte est obligatoire !");

                const newPost = {
                    id: "p_" + Date.now(),
                    author: this.user.name,
                    text: text,
                    image: img,
                    date: Date.now(),
                    likes: 0
                };

                if (!this.data.posts) this.data.posts = [];
                this.data.posts.unshift(newPost);
                await this.saveGist();
                this.closeModals();
                this.renderPosts();
            },
        // --- 12. MOTEUR DE LECTURE VID√âO (PLAYER ULTIME) ---
            /**
             * Ouvre le lecteur, initialise la vid√©o, g√®re les stats et les suggestions.
             * @param {string} id - L'identifiant unique de la vid√©o √† charger.
             */
            openPlayer: function(id) {
                console.log("Tentative d'ouverture du lecteur pour l'ID : " + id);
                
                // Recherche de la vid√©o dans la base de donn√©es synchronis√©e
                const v = this.data.videos.find(x => x.id === id);
                if (!v) {
                    console.error("Erreur : Vid√©o introuvable dans la base de donn√©es.");
                    alert("D√©sol√©, cette vid√©o n'est plus disponible.");
                    return;
                }

                // Initialisation de la vid√©o active dans l'√©tat de l'application
                this.activeVid = v;
                
                // --- GESTION DES STATISTIQUES DE VUE ---
                // On incr√©mente les vues de la vid√©o et les stats globales de l'utilisateur
                if (!v.views) v.views = 0;
                v.views++;
                this.stats.views++;
                
                // Enregistrement imm√©diat dans l'historique local
                this.addToHistory(v.id);
                
                // Sauvegarde des statistiques locales pour √©viter toute perte en cas de crash
                localStorage.setItem('visiona_stats', JSON.stringify(this.stats));

                // --- PR√âPARATION DE L'INTERFACE DU LECTEUR ---
                const overlay = document.getElementById('player-overlay');
                const videoElement = document.getElementById('main-video');
                
                if (!overlay || !videoElement) {
                    console.error("√âl√©ments DOM du player manquants.");
                    return;
                }

                // Injection de la source vid√©o et d√©marrage
                videoElement.src = v.url;
                videoElement.load(); // Force le rechargement du buffer
                
                // Mise √† jour des textes et m√©tadonn√©es
                document.getElementById('video-title').innerText = v.title;
                
                const descBox = document.getElementById('v-desc-content');
                if (descBox) descBox.innerText = v.description || "Aucune description fournie par l'auteur.";

                const statsLine = document.getElementById('v-stats-line');
                if (statsLine) {
                    statsLine.innerText = `${this.formatViews(v.views)} vues ‚Ä¢ Publi√© ${this.timeAgo(v.date)}`;
                }
                
                // --- GESTION DES INFOS AUTEUR DANS LE PLAYER ---
                const authorData = this.data.users[v.author] || { 
                    avatar: 'https://via.placeholder.com/40', 
                    followers: {} 
                };

                const authorNameEl = document.getElementById('v-author-name');
                const authorAvatarEl = document.getElementById('v-author-avatar');
                const authorSubsEl = document.getElementById('v-author-subs');

                if (authorNameEl) authorNameEl.innerText = v.author;
                if (authorAvatarEl) authorAvatarEl.src = authorData.avatar;
                if (authorSubsEl) {
                    const count = Object.keys(authorData.followers || {}).length;
                    authorSubsEl.innerText = `${this.formatViews(count)} abonn√©s`;
                }
                
                // Mise √† jour visuelle du bouton d'abonnement
                this.refreshSubButton(v.author);

                // Affichage du player et blocage du d√©filement de la page de fond
                overlay.style.display = 'block';
                document.body.style.overflow = 'hidden'; 
                
                // --- CHARGEMENT DES COMPOSANTS ANNEXES ---
                this.renderComments();
                this.renderSuggestions();
                
                // On synchronise le nombre de vues avec le serveur Gist
                this.saveGist();
            },

            /**
             * Ferme proprement le lecteur et lib√®re les ressources.
             */
            closePlayer: function() {
                console.log("Fermeture du lecteur vid√©o.");
                const overlay = document.getElementById('player-overlay');
                const video = document.getElementById('main-video');
                
                if (overlay) overlay.style.display = 'none';
                if (video) {
                    video.pause();
                    video.src = ""; // Lib√®re la m√©moire tampon
                }
                
                this.activeVid = null;
                document.body.style.overflow = 'auto'; // R√©active le scroll
            },

            /**
             * Met √† jour le bouton s'abonner selon l'√©tat actuel.
             */
            refreshSubButton: function(authorName) {
                const btn = document.getElementById('player-sub-btn');
                if (!btn) return;

                if (this.isSubscribed(authorName)) {
                    btn.innerText = "ABONN√â";
                    btn.style.background = "#333";
                    btn.style.color = "#aaa";
                } else {
                    btn.innerText = "S'ABONNER";
                    btn.style.background = "white";
                    btn.style.color = "black";
                }
            },

            // --- 13. MOTEUR DE SUGGESTIONS (ALGORITHME TITAN) ---
            /**
             * G√©n√®re une liste de vid√©os recommand√©es.
             */
            renderSuggestions: function() {
                const listContainer = document.getElementById('suggestions-list');
                if (!listContainer) return;

                // On filtre pour ne pas sugg√©rer la vid√©o en cours de lecture
                // Et on √©vite de sugg√©rer des Zapps dans le lecteur standard
                const suggestions = this.data.videos
                    .filter(video => video.id !== this.activeVid.id && !video.isShort)
                    .sort(() => Math.random() - 0.5) // M√©lange al√©atoire simple
                    .slice(0, 12); // On limite √† 12 r√©sultats

                if (suggestions.length === 0) {
                    listContainer.innerHTML = "<p style='color:gray; font-size:12px;'>Aucune suggestion pour le moment.</p>";
                    return;
                }

                listContainer.innerHTML = suggestions.map(v => `
                    <div class="suggestion-item" onclick="app.openPlayer('${v.id}')" 
                         style="display:flex; gap:10px; margin-bottom:12px; cursor:pointer; transition: 0.2s;">
                        <div style="width:160px; height:90px; border-radius:8px; overflow:hidden; flex-shrink:0; background:#222;">
                            <img src="${v.thumb}" style="width:100%; height:100%; object-fit:cover;" loading="lazy">
                        </div>
                        <div style="flex:1;">
                            <b style="font-size:13px; line-height:1.2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; color:white;">
                                ${v.title}
                            </b>
                            <p style="font-size:11px; color:var(--sec-text); margin:4px 0 2px 0;">${v.author}</p>
                            <p style="font-size:11px; color:var(--sec-text);">${this.formatViews(v.views)} vues</p>
                        </div>
                    </div>
                `).join('');
            },

            // --- 14. SYST√àME DE COMMENTAIRES D√âTAILL√â ---
            /**
             * Affiche la section des commentaires avec gestion des c≈ìurs et des likes.
             */
            renderComments: function() {
                const area = document.getElementById('comments-render-area');
                if (!area || !this.activeVid) return;

                const comments = this.activeVid.comments || [];
                const countTitle = document.getElementById('com-count-title');
                if (countTitle) countTitle.innerText = `${comments.length} Commentaires`;

                if (comments.length === 0) {
                    area.innerHTML = `<div style="padding:20px; text-align:center; color:gray;">Soyez le premier √† commenter cette vid√©o !</div>`;
                    return;
                }

                area.innerHTML = comments.map((c, idx) => {
                    const user = this.data.users[c.author] || {};
                    const isAuthor = (this.activeVid.author === c.author);
                    
                    return `
                    <div class="comment-block" style="display:flex; gap:15px; margin-bottom:24px; animation: fadeIn 0.4s ease;">
                        <img src="${user.avatar || 'https://via.placeholder.com/40'}" 
                             style="width:40px; height:40px; border-radius:50%; object-fit:cover; cursor:pointer;"
                             onclick="app.goProfile('${c.author}')">
                        <div style="flex:1;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <b style="font-size:13px; color:${isAuthor ? 'var(--blue)' : 'white'};">
                                    @${c.author} ${isAuthor ? ' <small>(Auteur)</small>' : ''}
                                </b>
                                <span style="color:var(--sec-text); font-size:11px;">${this.timeAgo(c.date)}</span>
                            </div>
                            <p style="margin:6px 0; font-size:14px; line-height:1.4; color:#efefef;">${c.text}</p>
                            <div style="display:flex; align-items:center; gap:16px; margin-top:8px;">
                                <div style="display:flex; align-items:center; gap:5px; cursor:pointer;" onclick="app.likeComment(${idx})">
                                    <span style="font-size:14px;">üëç</span>
                                    <span style="font-size:12px; color:var(--sec-text);">${c.likes || 0}</span>
                                </div>
                                ${this.activeVid.author === this.user?.name ? 
                                    `<span title="Donner un c≈ìur" style="cursor:pointer; font-size:14px; filter:${c.hasHeart ? 'none' : 'grayscale(1)'}" onclick="app.heartComment(${idx})">‚ù§Ô∏è</span>` 
                                    : (c.hasHeart ? `<span style="font-size:14px;">‚ù§Ô∏è <small style="color:var(--blue); font-size:10px;">√âpingl√©</small></span>` : '')}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },
        // --- 15. SYST√àME DE RECHERCHE TITAN (MULTI-FILTRES) ---
            /**
             * Moteur de recherche global.
             * Filtre les vid√©os par titre, auteur, description et tags.
             */
            search: function() {
                const query = document.getElementById('mainSearch').value.toLowerCase().trim();
                console.log("Recherche Titan lanc√©e pour : " + query);

                // Si la barre est vide, on r√©initialise l'accueil
                if (!query) {
                    this.renderHome();
                    return;
                }

                // Filtrage avanc√© dans la base de donn√©es locale synchronis√©e
                const results = this.data.videos.filter(v => {
                    const inTitle = v.title.toLowerCase().includes(query);
                    const inAuthor = v.author.toLowerCase().includes(query);
                    const inDesc = v.description ? v.description.toLowerCase().includes(query) : false;
                    return inTitle || inAuthor || inDesc;
                });

                // Bascule vers la vue accueil pour afficher les r√©sultats
                this.nav('home');
                const grid = document.getElementById('home-grid');
                
                if (results.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align:center; padding:100px 20px;">
                            <div style="font-size:50px; margin-bottom:20px;">üîç</div>
                            <h2>Aucun r√©sultat pour "${query}"</h2>
                            <p style="color:var(--sec-text);">Essayez d'autres mots-cl√©s ou v√©rifiez l'orthographe.</p>
                            <button onclick="document.getElementById('mainSearch').value=''; app.renderHome()" 
                                    style="margin-top:20px; background:var(--hover); color:white; border:none; padding:10px 20px; border-radius:20px; cursor:pointer;">
                                Retour √† l'accueil
                            </button>
                        </div>`;
                } else {
                    grid.innerHTML = results.map(v => this.createVideoCard(v)).join('');
                    // Petit feedback visuel en haut de la grille
                    const header = document.createElement('h3');
                    header.style.cssText = "grid-column: 1/-1; margin-bottom: 20px; color: var(--sec-text);";
                    header.innerText = `${results.length} r√©sultat(s) trouv√©(s)`;
                    grid.prepend(header);
                }
            },

            // --- 16. MOTEUR D'UPLOAD (COH√âRENCE CLOUDINARY + GIST) ---
            /**
             * G√®re l'envoi des fichiers vers le Worker et la mise √† jour du Gist.
             */
            handleUpload: async function() {
                console.log("Initialisation du processus d'upload...");
                
                if (!this.user) {
                    alert("Vous devez √™tre connect√© pour publier.");
                    return this.openModal('modal-auth');
                }

                const title = document.getElementById('upTitle').value.trim();
                const desc = document.getElementById('upDesc').value.trim();
                const videoFile = document.getElementById('upVideoFile').files[0];
                const thumbFile = document.getElementById('upThumbFile').files[0];
                const isShort = document.getElementById('upIsShort').checked;

                // Validation stricte des entr√©es
                if (!title) return alert("Le titre est obligatoire.");
                if (!videoFile) return alert("Veuillez s√©lectionner un fichier vid√©o.");
                if (videoFile.size > 100 * 1024 * 1024) return alert("Fichier trop lourd (Max 100Mo).");

                // Activation de l'interface de progression
                const progressZone = document.getElementById('upProgressZone');
                const progressBar = document.getElementById('upProgressBar');
                const progressText = document.getElementById('upPercent');

                if (progressZone) progressZone.style.display = 'block';
                
                try {
                    console.log("Envoi du flux binaire au Worker Titan...");
                    
                    const formData = new FormData();
                    formData.append('video', videoFile);
                    if (thumbFile) formData.append('thumb', thumbFile);
                    formData.append('title', title);

                    // Appel au Cloudinary Worker
                    const response = await fetch(WORKER_URL, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error("Le serveur Titan a refus√© l'upload.");

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error || "Erreur de stockage.");

                    // Cr√©ation de l'objet vid√©o final
                    const newVideo = {
                        id: "v_" + Date.now(),
                        title: title,
                        description: desc,
                        url: result.videoUrl,
                        thumb: result.thumbUrl || "https://images.unsplash.com/photo-1611162617474-5b21e879e113?w=800",
                        author: this.user.name,
                        date: Date.now(),
                        views: 0,
                        likes: 0,
                        dislikes: 0,
                        comments: [],
                        isShort: isShort,
                        duration: "0:00"
                    };

                    // Ajout en haut de la liste
                    this.data.videos.unshift(newVideo);
                    
                    // Sauvegarde Cloud et rafra√Æchissement
                    await this.saveGist();
                    
                    alert("Publication r√©ussie ! Votre vid√©o est en ligne.");
                    location.reload();

                } catch (err) {
                    console.error("√âchec Upload :", err);
                    alert("ERREUR CRITIQUE : " + err.message);
                } finally {
                    if (progressZone) progressZone.style.display = 'none';
                }
            },

            // --- 17. SYST√àME DE DIRECTS (LIVE STREAMING FIX) ---
            /**
             * D√©clenche le mode direct avec acc√®s cam√©ra.
             */
            startLiveSystem: async function() {
                console.log("Tentative de d√©marrage du flux cam√©ra...");
                const preview = document.getElementById('direct-preview');
                
                try {
                    this.activeStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 1280, height: 720 }, 
                        audio: true 
                    });
                    
                    if (preview) {
                        preview.srcObject = this.activeStream;
                        preview.onloadedmetadata = () => preview.play();
                    }
                    console.log("Cam√©ra active.");
                } catch (e) {
                    console.error("Acc√®s cam√©ra refus√© :", e);
                    alert("Impossible d'acc√©der √† la cam√©ra. V√©rifiez les autorisations.");
                }
            },

            /**
             * Publie l'entr√©e du Live dans le Gist pour qu'il apparaisse sur l'accueil.
             */
            publishLive: async function() {
                const title = document.getElementById('direct-title').value.trim();
                if (!title) return alert("Veuillez donner un titre √† votre Direct !");

                console.log("Lancement du Direct sur Visiona...");

                const liveEntry = {
                    id: "live_" + Date.now(),
                    title: "üî¥ EN DIRECT : " + title,
                    description: "Rejoignez le direct de " + this.user.name,
                    url: "LIVE_STREAM", // Marqueur pour le player
                    thumb: "https://images.unsplash.com/photo-1478720568477-152d9b164e26?w=800",
                    author: this.user.name,
                    date: Date.now(),
                    views: 1,
                    isLive: true,
                    isShort: false
                };

                // On injecte le live en priorit√© absolue
                this.data.videos.unshift(liveEntry);
                
                // Sauvegarde Cloud cruciale
                await this.saveGist();
                
                alert("Vous √™tes maintenant en direct !");
                this.closeModals();
                this.nav('home');
            },

            /**
             * Coupe proprement la cam√©ra.
             */
            stopLiveSystem: function() {
                if (this.activeStream) {
                    this.activeStream.getTracks().forEach(track => track.stop());
                    this.activeStream = null;
                    console.log("Flux cam√©ra coup√©.");
                }
            },
        // --- 18. SYST√àME DE FID√âLIT√â & PROGRESSION (XP TITAN) ---
            /**
             * Calcule et met √† jour l'exp√©rience de l'utilisateur.
             * L'XP est gagn√©e en regardant des vid√©os et en interagissant.
             */
            updateExperience: function(amount) {
                if (!this.user) return;
                console.log(`Gain de XP : +${amount}`);
                
                const u = this.data.users[this.user.name];
                if (!u) return;

                if (!u.xp) u.xp = 0;
                if (!u.level) u.level = 1;

                u.xp += amount;

                // Formule de niveau : Palier de 1000 XP par niveau
                const nextLevelThreshold = u.level * 1000;
                
                if (u.xp >= nextLevelThreshold) {
                    u.level++;
                    u.xp = 0; // R√©initialisation pour le nouveau palier
                    this.addNotification(`F√©licitations ! Vous avez atteint le Niveau ${u.level} ! üöÄ`);
                    this.triggerLevelUpAnimation();
                }

                // Sauvegarde des stats Titan en local pour affichage rapide
                this.stats.level = u.level;
                localStorage.setItem('visiona_stats', JSON.stringify(this.stats));
                
                // On ne sauvegarde pas le Gist √† chaque gain de XP pour √©viter le spam API
                // Mais on le fera lors de la prochaine action majeure
            },

            triggerLevelUpAnimation: function() {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; inset: 0; z-index: 9999; pointer-events: none;
                    display: flex; align-items: center; justify-content: center;
                    background: rgba(0,0,0,0.5); font-size: 50px; color: var(--gold);
                    animation: fadeOut 3s forwards;
                `;
                overlay.innerHTML = `<div>üåü NIVEAU SUP√âRIEUR üåü</div>`;
                document.body.appendChild(overlay);
                setTimeout(() => overlay.remove(), 3000);
            },

            // --- 19. SYST√àME DE NOTIFICATIONS TEMPS R√âEL ---
            /**
             * Ajoute une notification dans la liste de l'utilisateur.
             */
            addNotification: function(msg) {
                const newNotif = {
                    id: "n_" + Date.now(),
                    text: msg,
                    date: Date.now(),
                    read: false
                };

                if (!this.data.notifications) this.data.notifications = [];
                this.data.notifications.unshift(newNotif);

                // Mise √† jour du badge visuel sur la cloche
                const badge = document.getElementById('notif-badge');
                if (badge) {
                    const unreadCount = this.data.notifications.filter(n => !n.read).length;
                    badge.innerText = unreadCount;
                    badge.style.display = unreadCount > 0 ? 'block' : 'none';
                }
                
                console.log("Nouvelle notification : " + msg);
            },

            toggleNotifs: function() {
                const pane = document.getElementById('notif-pane');
                if (pane) {
                    pane.style.display = pane.style.display === 'none' ? 'block' : 'none';
                    // On marque tout comme lu √† l'ouverture
                    this.data.notifications.forEach(n => n.read = true);
                    const badge = document.getElementById('notif-badge');
                    if (badge) badge.style.display = 'none';
                }
            },

            // --- 20. EASTER EGG TITAN (LE SECRET DES 7 CLICS) ---
            /**
             * D√©clenche un mode visuel sp√©cial si l'utilisateur clique 7 fois
             * sur le bouton "???" dans la sidebar.
             */
            triggerEgg: function() {
                this.eggCount++;
                console.log(`Easter Egg Progress: ${this.eggCount}/7`);
                
                if (this.eggCount === 3) {
                    alert("Vous approchez d'une autre dimension...");
                }

                if (this.eggCount >= 7) {
                    console.log("ACTIVATION MODE TITAN COSMIQUE");
                    document.body.style.transition = "5s";
                    document.body.style.filter = "hue-rotate(270deg) contrast(1.5)";
                    
                    const music = new Audio('https://www.soundjay.com/misc/sounds/magic-chime-01.mp3');
                    music.play().catch(e => console.log("Audio bloqu√©"));

                    this.addNotification("üåå Mode Cosmique activ√© ! Bienvenue dans l'Alpha.");
                    
                    // Cr√©ation d'√©toiles filantes en JS
                    for(let i=0; i<10; i++) {
                        setTimeout(() => this.spawnStar(), i * 500);
                    }
                    
                    this.eggCount = 0; // Reset
                }
            },

            spawnStar: function() {
                const star = document.createElement('div');
                star.style.cssText = `
                    position: fixed; top: ${Math.random()*100}%; left: -50px;
                    width: 50px; height: 2px; background: white; z-index: 5000;
                    box-shadow: 0 0 10px white; transition: 2s linear;
                `;
                document.body.appendChild(star);
                setTimeout(() => {
                    star.style.left = "calc(100% + 50px)";
                }, 100);
                setTimeout(() => star.remove(), 2500);
            },

            // --- 21. GESTION DES RACCOURCIS CLAVIER ---
            /**
             * Initialise les √©couteurs d'√©v√©nements pour le contr√¥le au clavier.
             */
            initKeyboardShortcuts: function() {
                document.addEventListener('keydown', (e) => {
                    // On ne fait rien si l'utilisateur √©crit dans un input ou textarea
                    if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;

                    if (this.activeVid) {
                        const v = document.getElementById('main-video');
                        switch(e.key.toLowerCase()) {
                            case 'k': // Pause / Lecture
                                v.paused ? v.play() : v.pause();
                                break;
                            case 'f': // Plein √©cran
                                if (document.fullscreenElement) document.exitFullscreen();
                                else document.getElementById('player-overlay').requestFullscreen();
                                break;
                            case 'j': // Reculer de 10s
                                v.currentTime -= 10;
                                break;
                            case 'l': // Avancer de 10s
                                v.currentTime += 10;
                                break;
                            case 'm': // Muer le son
                                v.muted = !v.muted;
                                break;
                            case 'escape': // Fermer le player
                                this.closePlayer();
                                break;
                        }
                    }
                });
                console.log("Raccourcis clavier (K, F, J, L, M) activ√©s.");
            }
        // --- 22. SYST√àME DE MEMBRES TITAN (BRONZE / ARGENT / OR) ---
            /**
             * Ouvre l'interface de souscription aux niveaux de membres.
             */
            openJoinModal: function() {
                if (!this.user) return this.openModal('modal-auth');
                
                // Injection dynamique du contenu de l'offre
                const modal = document.createElement('div');
                modal.id = 'modal-join';
                modal.className = 'modal';
                modal.style.display = 'flex';
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width:700px; animation: scaleUp 0.3s ease;">
                        <h2 style="text-align:center; color:var(--gold);">Rejoignez l'√©lite Visiona Titan</h2>
                        <p style="text-align:center; color:var(--sec-text); margin-bottom:25px;">Soutenez vos cr√©ateurs et d√©bloquez des avantages exclusifs.</p>
                        
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px;">
                            <div class="admin-box" style="border: 1px solid #cd7f32; text-align:center;">
                                <h3 style="color:#cd7f32;">BRONZE</h3>
                                <p style="font-size:20px; font-weight:bold;">1.99‚Ç¨<small>/mois</small></p>
                                <ul style="text-align:left; font-size:12px; padding-left:15px; margin:15px 0;">
                                    <li>Badge de membre</li>
                                    <li>Acc√®s aux emojis</li>
                                </ul>
                                <button onclick="app.buyMembership('Bronze')" style="width:100%; padding:8px; border-radius:5px; border:none; background:#cd7f32; color:white; font-weight:bold; cursor:pointer;">REJOINDRE</button>
                            </div>
                            <div class="admin-box" style="border: 1px solid #c0c0c0; text-align:center;">
                                <h3 style="color:#c0c0c0;">ARGENT</h3>
                                <p style="font-size:20px; font-weight:bold;">4.99‚Ç¨<small>/mois</small></p>
                                <ul style="text-align:left; font-size:12px; padding-left:15px; margin:15px 0;">
                                    <li>Badge Argent</li>
                                    <li>Priorit√© commentaires</li>
                                </ul>
                                <button onclick="app.buyMembership('Argent')" style="width:100%; padding:8px; border-radius:5px; border:none; background:#c0c0c0; color:black; font-weight:bold; cursor:pointer;">REJOINDRE</button>
                            </div>
                            <div class="admin-box" style="border: 1px solid var(--gold); text-align:center;">
                                <h3 style="color:var(--gold);">OR</h3>
                                <p style="font-size:20px; font-weight:bold;">9.99‚Ç¨<small>/mois</small></p>
                                <ul style="text-align:left; font-size:12px; padding-left:15px; margin:15px 0;">
                                    <li>Badge Or üëë</li>
                                    <li>Vid√©os en avant-premi√®re</li>
                                </ul>
                                <button onclick="app.buyMembership('Or')" style="width:100%; padding:8px; border-radius:5px; border:none; background:var(--gold); color:black; font-weight:bold; cursor:pointer;">REJOINDRE</button>
                            </div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="width:100%; margin-top:15px; background:none; border:none; color:var(--sec-text); cursor:pointer;">Peut-√™tre plus tard</button>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            buyMembership: async function(level) {
                console.log(`Tentative d'achat du grade : ${level}`);
                const u = this.data.users[this.user.name];
                u.membership = level;
                u.badge = (level === 'Or') ? 'üëë' : (level === 'Argent' ? 'ü•à' : 'ü•â');
                
                await this.saveGist();
                this.addNotification(`F√©licitations ! Vous √™tes d√©sormais membre ${level} !`);
                alert(`Bienvenue dans le club ${level} !`);
                location.reload();
            },

            // --- 23. MODULE DE REMERCIEMENTS (THANKS) ---
            /**
             * Rend la vue des contributeurs et donateurs.
             */
            renderThanks: function() {
                const container = document.getElementById('view-thanks');
                if (!container) return;
                
                const list = this.data.thanks || [];
                container.innerHTML = `
                    <div style="max-width:800px; margin:0 auto; padding:50px 20px; text-align:center;">
                        <h1 style="color:var(--gold); font-size:40px;">üíé LE PANTH√âON TITAN</h1>
                        <p style="color:var(--sec-text); margin-bottom:40px;">Ceux qui soutiennent le projet et permettent √† Visiona de rester ind√©pendant.</p>
                        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:20px;">
                            ${list.map(t => `
                                <div class="admin-box" style="border:1px solid var(--gold); background:rgba(255,193,7,0.05);">
                                    <h3 style="margin:0;">${t.name}</h3>
                                    <p style="color:var(--gold); font-size:12px; margin-top:5px;">${t.role || 'Donateur'}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            // --- 24. MOD√âRATION ADMIN AVANC√âE ---
            /**
             * Supprime un utilisateur de la base de donn√©es.
             * R√©serv√© √† l'administrateur supr√™me.
             */
            banUser: async function(username) {
                if (!confirm(`Voulez-vous vraiment bannir d√©finitivement @${username} ?`)) return;
                
                if (username === "AlphaGames30") return alert("Impossible de bannir le cr√©ateur !");
                
                // On retire l'utilisateur
                delete this.data.users[username];
                // On retire ses vid√©os
                this.data.videos = this.data.videos.filter(v => v.author !== username);
                
                await this.saveGist();
                alert(`L'utilisateur @${username} a √©t√© banni.`);
                this.renderAdmin();
            },

            resetSystem: async function() {
                if (confirm("‚ö†Ô∏è ALERTE CRITIQUE : Voulez-vous r√©initialiser TOUTES les donn√©es ?")) {
                    const pass = prompt("Entrez le code de s√©curit√© ADMIN :");
                    if (pass === "TITAN_RESET_2024") {
                        this.data = { videos: [], users: {}, posts: [], annonces: [], notifications: [], thanks: [] };
                        await this.saveGist();
                        location.reload();
                    }
                }
            },

            // --- 25. INITIALISATION DES √âCOUTEURS DOM (BINDINGS) ---
            /**
             * Connecte les √©l√©ments HTML aux fonctions JavaScript apr√®s le chargement.
             */
            bindAllActions: function() {
                console.log("Binding des actions DOM en cours...");
                
                // Upload Form
                const upBtn = document.getElementById('btn-submit-upload');
                if (upBtn) upBtn.onclick = () => this.handleUpload();

                // Live Stream
                const liveBtn = document.getElementById('btn-start-live');
                if (liveBtn) liveBtn.onclick = () => this.publishLive();

                // Recherche dynamique au clavier
                const sInput = document.getElementById('mainSearch');
                if (sInput) {
                    sInput.oninput = () => {
                        if (sInput.value.length > 10) console.log("Recherche longue d√©tect√©e...");
                    };
                }

                this.initKeyboardShortcuts();
            },

            // --- 26. V√âRIFICATION D'INT√âGRIT√â & LANCEMENT ---
            /**
             * S'assure que toutes les structures de donn√©es sont pr√©sentes.
             */
            checkIntegrity: function() {
                if (!Array.isArray(this.data.videos)) this.data.videos = [];
                if (typeof this.data.users !== 'object') this.data.users = {};
                if (!Array.isArray(this.data.posts)) this.data.posts = [];
                
                console.log("Contr√¥le d'int√©grit√© Titan : OK.");
            }
        };

        // --- POINT D'ENTR√âE FINAL DU PROGRAMME ---
        /**
         * √âv√©nement de d√©marrage global.
         */
        window.onload = async () => {
            console.time("TitanBoot");
            
            // Initialisation de l'application
            await app.init();
            
            // V√©rification des donn√©es
            app.checkIntegrity();
            
            // Branchement des √©v√©nements
            app.bindAllActions();
            
            console.timeEnd("TitanBoot");
            console.log("Visiona Titan est pr√™t √† l'emploi. Lignes de code : >1400");
        };
    </script>
</body>
</html>
