<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona V26 - Ultimate Ecosystem</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #030303; --side: #080808; --card: #121212; --accent: #7c4dff;
            --accent-glow: rgba(124, 77, 255, 0.3); --text: #ffffff; --sec: #909090;
            --border: #1f1f1f; --red: #ff4d4d; --gold: #ffc107; --glass: rgba(255,255,255,0.03);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }

        /* --- UI SCROLLBAR --- */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* --- HEADER --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            height: 75px; padding: 0 30px; background: rgba(3,3,3,0.9);
            backdrop-filter: blur(15px); position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border);
        }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 22px; cursor: pointer; }
        .logo-box { 
            width: 38px; height: 38px; background: linear-gradient(135deg, var(--accent), #00d2ff); 
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            color: white; transform: rotate(-5deg); box-shadow: 0 5px 15px var(--accent-glow);
        }

        .search-area {
            flex: 1; max-width: 600px; display: flex; margin: 0 40px;
            background: #000; border: 1px solid var(--border); border-radius: 40px; padding: 4px 6px;
        }
        .search-area input { flex: 1; background: transparent; border: none; padding: 10px 20px; color: white; outline: none; }
        .search-area button { background: var(--accent); color: white; border: none; padding: 0 25px; border-radius: 30px; font-weight: 600; cursor: pointer; }

        /* --- LAYOUT --- */
        .app-wrapper { display: flex; height: calc(100vh - 75px); }
        .sidebar {
            width: 260px; background: var(--side); padding: 20px;
            overflow-y: auto; border-right: 1px solid var(--border); flex-shrink: 0;
        }
        .main-container { flex: 1; padding: 30px; overflow-y: auto; position: relative; }

        /* --- NAVIGATION --- */
        .nav-link {
            display: flex; align-items: center; gap: 15px; padding: 12px 18px;
            border-radius: 12px; color: var(--sec); margin-bottom: 5px; font-weight: 500; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { background: var(--card); color: white; }
        .nav-link.active { background: var(--accent-soft); color: var(--accent); font-weight: 700; }
        .nav-sep { height: 1px; background: var(--border); margin: 20px 0; }
        .nav-title { font-size: 11px; color: var(--sec); font-weight: 800; margin: 0 0 10px 15px; text-transform: uppercase; letter-spacing: 1px; }

        /* --- GRIDS & CARDS --- */
        .v-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .card { cursor: pointer; border-radius: 18px; }
        .card:hover .thumb img { transform: scale(1.05); }
        .thumb { width: 100%; aspect-ratio: 16/9; border-radius: 18px; overflow: hidden; position: relative; border: 1px solid var(--border); background: #111; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .duration { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }

        .meta { display: flex; gap: 12px; margin-top: 15px; }
        .avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; background: #222; border: 1px solid var(--border); flex-shrink: 0; }
        .info h4 { margin: 0 0 4px 0; font-size: 15px; line-height: 1.4; font-weight: 700; }
        .info p { margin: 0; font-size: 13px; color: var(--sec); }

        /* --- ZAPPS (9:16) --- */
        #zapps-view { display: none; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; flex-direction: column; align-items: center; }
        .zapp-item {
            width: 360px; height: calc(100vh - 100px); background: #000;
            scroll-snap-align: center; margin-bottom: 30px; border-radius: 20px;
            position: relative; overflow: hidden; border: 1px solid var(--border);
        }
        .zapp-vid { width: 100%; height: 100%; object-fit: cover; }
        .zapp-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 25px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); }

        /* --- NOTIFICATIONS BELL --- */
        .notif-container { position: relative; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: var(--red); color: white; font-size: 9px; padding: 2px 5px; border-radius: 10px; font-weight: 900; }
        .notif-menu {
            display: none; position: absolute; top: 40px; right: 0; width: 320px;
            background: var(--card); border: 1px solid var(--border); border-radius: 15px;
            padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); z-index: 5000;
        }

        /* --- STATS DASHBOARD --- */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-box { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .stat-box b { font-size: 32px; color: var(--accent); display: block; margin-bottom: 5px; }

        /* --- PLAYER --- */
        #player-overlay { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 2000; overflow-y: auto; }
        .p-wrap { max-width: 1300px; margin: 0 auto; padding: 30px; }
        .p-vid-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 25px; overflow: hidden; border: 1px solid var(--border); }
        
        /* --- CLOCHE BUTTON --- */
        .bell-btn { background: var(--glass); border: 1px solid var(--border); padding: 10px 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .bell-menu { display: none; position: absolute; background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-top: 10px; z-index: 10; overflow: hidden; }
        .bell-option { padding: 12px 20px; font-size: 14px; cursor: pointer; }
        .bell-option:hover { background: var(--accent-soft); }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-body { background: var(--side); width: 95%; max-width: 500px; padding: 40px; border-radius: 30px; border: 1px solid var(--border); }
        input, select { width: 100%; padding: 15px; margin: 10px 0; background: #111; border: 1px solid var(--border); color: white; border-radius: 12px; }

        /* --- HEART COMPONENT --- */
        .creator-heart { display: inline-flex; align-items: center; gap: 5px; background: rgba(255,0,0,0.1); padding: 4px 8px; border-radius: 20px; font-size: 11px; margin-top: 5px; border: 1px solid var(--red); }
        .heart-pdp { width: 16px; height: 16px; border-radius: 50%; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="app.nav('home')">
            <div class="logo-box">V</div> VISIONA
        </div>
        <div class="search-area">
            <input type="text" id="searchInput" placeholder="Rechercher sur Visiona Ecosystem...">
            <button onclick="app.search()">Rechercher</button>
        </div>
        <div style="display:flex; align-items:center; gap:25px;">
            <div class="notif-container">
                <div style="cursor:pointer; font-size:20px;" onclick="app.toggleNotifs()">üîî<span class="notif-badge" id="notifCount">0</span></div>
                <div class="notif-menu" id="notifMenu">
                    <h3 style="margin-top:0;">Notifications</h3>
                    <div id="notifList" style="max-height:300px; overflow-y:auto;"></div>
                </div>
            </div>
            <div id="userMenuArea"></div>
        </div>
    </header>

    <div class="app-wrapper">
        <aside class="sidebar">
            <div class="nav-title">Menu Principal</div>
            <div class="nav-link active" id="n-home" onclick="app.nav('home')">üè† Accueil</div>
            <div class="nav-link" id="n-zapps" onclick="app.nav('zapps')">‚ö° Visiona Zapps</div>
            <div class="nav-link" id="n-lives" onclick="app.nav('lives')">üî¥ Directs</div>
            
            <div class="nav-sep"></div>
            <div class="nav-title">Ma Cha√Æne</div>
            <div class="nav-link" id="n-my" onclick="app.goMyProfile()">üë§ Studio Cr√©ateur</div>
            <div class="nav-link" onclick="app.nav('stats')">üìä Statistiques</div>
            <div class="nav-link" onclick="app.nav('community')">üì∞ Communaut√©</div>
            
            <div class="nav-sep"></div>
            <div class="nav-title">Abonnements</div>
            <div id="sidebarSubs"></div>

            <div id="adminPanel" style="display:none;">
                <div class="nav-sep"></div>
                <div class="nav-title" style="color:var(--gold);">Administration</div>
                <div class="nav-link" onclick="app.openAdmin()" style="color:var(--gold);">üîë Panel Master</div>
            </div>
        </aside>

        <main class="main-container">
            <div id="v-home">
                <h2 style="margin-bottom:30px; font-weight:900;">Recommandations</h2>
                <div id="grid-home" class="v-grid"></div>
            </div>

            <div id="zapps-view"></div>

            <div id="v-stats" style="display:none;">
                <h2 style="margin-bottom:30px; font-weight:900;">Tableau de bord de Visiona</h2>
                <div class="stats-grid">
                    <div class="stat-box"><b id="s-views">0</b>Vid√©os regard√©es</div>
                    <div class="stat-box"><b id="s-time">0h 0m</b>Temps pass√©</div>
                    <div class="stat-box"><b id="s-coms">0</b>Commentaires</div>
                    <div class="stat-box"><b id="s-subs">0</b>Abonnements</div>
                    <div class="stat-box"><b id="s-my-subs">0</b>Mes Abonn√©s</div>
                    <div class="stat-box"><b id="s-likes">0</b>Likes donn√©s</div>
                </div>
                <h3>üèÜ Vos cr√©ateurs favoris</h3>
                <div id="topCreators" class="v-grid"></div>
            </div>

            <div id="v-profile" style="display:none;"></div>
            
            <div id="v-alt" style="display:none;"></div>
        </main>
    </div>

    <div id="player-overlay">
        <div class="p-wrap">
            <button onclick="app.closePlayer()" style="background:none; border:none; color:var(--sec); cursor:pointer; font-weight:800; margin-bottom:20px;">‚Üê FERMER LE LECTEUR</button>
            <div class="p-vid-box">
                <video id="p-video" controls autoplay style="width:100%; height:100%;"></video>
            </div>
            <div style="margin-top:25px;">
                <h1 id="p-title" style="font-size:26px; font-weight:800; margin:0;"></h1>
                <p id="p-meta" style="color:var(--sec); margin-top:8px;"></p>
                
                <div style="display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:25px; border-radius:25px; border:1px solid var(--border); margin-top:30px;">
                    <div id="p-chan-info" style="display:flex; align-items:center; gap:15px; cursor:pointer;"></div>
                    <div style="display:flex; gap:12px; align-items:center; position:relative;">
                        <button id="p-sub-btn" class="search-area" style="width:auto; padding:12px 30px; background:white; color:black; font-weight:bold;"></button>
                        <div class="bell-btn" onclick="app.toggleBellMenu()">üîî <span id="currentBell">Toutes</span></div>
                        <div class="bell-menu" id="bellMenu">
                            <div class="bell-option" onclick="app.setBell('all')">üîî Toutes</div>
                            <div class="bell-option" onclick="app.setBell('custom')">ü™Ñ Personnalis√©es</div>
                            <div class="bell-option" onclick="app.setBell('none')">üîï Aucune</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:45px;">
                    <h3>Commentaires (<span id="p-com-count">0</span>)</h3>
                    <div style="display:flex; gap:15px; margin-bottom:30px;">
                        <input type="text" id="comInput" placeholder="Ajouter un commentaire..." style="margin:0;">
                        <button onclick="app.postComment()" style="background:var(--accent); color:white; border:none; border-radius:12px; padding:0 30px; font-weight:bold;">Publier</button>
                    </div>
                    <div id="p-com-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalAuth" class="modal">
        <div class="modal-body">
            <h2 style="margin-top:0;">Connexion Visiona</h2>
            <p style="color:var(--sec);">Acc√©dez √† l'√©cosyst√®me complet avec votre pseudo.</p>
            <input type="text" id="authName" placeholder="Votre Pseudo">
            <input type="password" placeholder="Mot de passe (facultatif)">
            <button class="search-area" style="width:100%; background:var(--accent); margin-top:20px; font-weight:bold;" onclick="app.login()">SE CONNECTER</button>
            <button style="background:none; border:none; color:var(--sec); width:100%; margin-top:15px; cursor:pointer;" onclick="app.closeModals()">Continuer en invit√©</button>
        </div>
    </div>

    <div id="modalProfile" class="modal">
        <div class="modal-body">
            <h2>Personnaliser ma cha√Æne</h2>
            <p style="font-size:12px; color:var(--sec);">Photo de profil (URL) :</p>
            <input type="text" id="custPdp" placeholder="Lien vers l'image...">
            <p style="font-size:12px; color:var(--sec);">Banni√®re de cha√Æne (URL) :</p>
            <input type="text" id="custBanner" placeholder="Lien vers la banni√®re...">
            <button class="search-area" style="width:100%; background:var(--accent); font-weight:bold;" onclick="app.saveProfile()">ENREGISTRER</button>
            <button style="background:none; border:none; color:var(--sec); width:100%; margin-top:15px; cursor:pointer;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <script>
        const DB = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
        const WORKER = "https://mytubeupload.edonis-imbert.workers.dev/";
        
        const app = {
            state: {
                user: JSON.parse(localStorage.getItem('v26_user')),
                vids: [], users: {}, posts: [],
                subs: JSON.parse(localStorage.getItem('v26_subs')) || {}, // {name: {tier, bell}}
                hist: JSON.parse(localStorage.getItem('v26_hist')) || [],
                stats: JSON.parse(localStorage.getItem('v26_stats')) || { views:0, likes:0, coms:0, time:0 },
                notifs: JSON.parse(localStorage.getItem('v26_notifs')) || [],
                startTime: Date.now()
            },
            activeVid: null,

            init: async function() {
                console.log("Visiona V26 Engine Loading...");
                await this.fetchData();
                this.renderUI();
                this.nav('home');
                this.startTimers();
            },

            fetchData: async function() {
                try {
                    const r = await fetch(DB + "?t=" + Date.now());
                    const j = await r.json();
                    this.state.vids = j.videos || [];
                    this.state.users = j.users || {};
                    this.state.posts = j.posts || [];
                } catch(e) { console.error("Database Error"); }
            },

            saveData: async function() {
                const payload = { videos: this.state.vids, users: this.state.users, posts: this.state.posts };
                await fetch(WORKER, {
                    method: 'PATCH',
                    body: JSON.stringify({ files: {"video.json": {content: JSON.stringify(payload, null, 2)}}})
                });
            },

            // --- NAVIGATION ---
            nav: function(page) {
                const views = ['v-home', 'zapps-view', 'v-profile', 'v-stats', 'v-alt'];
                views.forEach(v => document.getElementById(v).style.display = 'none');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

                if(page === 'home') {
                    document.getElementById('v-home').style.display = 'block';
                    document.getElementById('n-home').classList.add('active');
                    this.renderHome();
                } else if(page === 'zapps') {
                    document.getElementById('zapps-view').style.display = 'flex';
                    document.getElementById('n-zapps').classList.add('active');
                    this.renderZapps();
                } else if(page === 'stats') {
                    document.getElementById('v-stats').style.display = 'block';
                    this.renderStats();
                }
            },

            // --- RENDUS ---
            renderHome: function() {
                const grid = document.getElementById('grid-home');
                let pool = [...this.state.vids.filter(v => !v.isShort && !v.isStream)];
                pool.sort(() => Math.random() - 0.5);
                grid.innerHTML = pool.map(v => `
                    <div class="card" onclick="app.openPlayer('${v.id}')">
                        <div class="thumb">
                            <img src="${v.thumb || 'https://via.placeholder.com/400x225/111/fff?text=Visiona'}">
                            <div class="duration">${v.duration || '08:45'}</div>
                        </div>
                        <div class="meta">
                            <img src="${this.getPDP(v.author)}" class="avatar" onclick="event.stopPropagation(); app.goProfile('${v.author}')">
                            <div class="info">
                                <h4>${v.title}</h4>
                                <p>${v.author} ‚Ä¢ ${this.formatCount(v.views)} vues ‚Ä¢ ${this.timeAgo(v.timestamp)}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            renderZapps: function() {
                const container = document.getElementById('zapps-view');
                const zapps = this.state.vids.filter(v => v.isShort);
                container.innerHTML = zapps.map(z => `
                    <div class="zapp-item">
                        <video src="${z.url}" class="zapp-vid" loop autoplay muted></video>
                        <div class="zapp-overlay">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
                                <img src="${this.getPDP(z.author)}" style="width:38px; height:38px; border-radius:50%; border:2px solid white;">
                                <b>@${z.author}</b>
                                <button onclick="app.toggleSub('${z.author}')" style="background:white; color:black; border:none; padding:5px 12px; border-radius:20px; font-weight:bold; font-size:12px;">SUIVRE</button>
                            </div>
                            <p>${z.title}</p>
                        </div>
                    </div>
                `).join('');
            },

            // --- LECTEUR & SOCIAL ---
            openPlayer: function(id) {
                const v = this.state.vids.find(x => x.id == id);
                this.activeVid = v;
                
                // Stats + Historique
                this.state.stats.views++;
                this.state.hist.push({id: v.id, author: v.author, time: Date.now()});
                this.saveLocal();

                document.getElementById('player-overlay').style.display = 'block';
                document.getElementById('p-title').innerText = v.title;
                document.getElementById('p-meta').innerText = `${this.formatCount(v.views)} vues ‚Ä¢ ${this.timeAgo(v.timestamp)}`;
                document.getElementById('p-video').src = v.url;

                this.renderPlayerMeta();
                this.renderComments();
            },

            renderPlayerMeta: function() {
                const author = this.activeVid.author;
                const subData = this.state.subs[author];
                const authorData = this.state.users[author] || {};
                const subCount = this.state.vids.filter(v => v.author === author).length * 123 + (subData ? 1 : 0); // Faux calcul bas√© sur data

                document.getElementById('p-chan-info').innerHTML = `
                    <img src="${this.getPDP(author)}" style="width:50px; height:50px; border-radius:50%;">
                    <div>
                        <b style="font-size:18px;">${author}</b>
                        <p style="margin:0; font-size:12px; color:var(--sec);">${subCount} abonn√©s</p>
                    </div>
                `;

                const btn = document.getElementById('p-sub-btn');
                btn.innerText = subData ? "D√âSABONNER" : "S'ABONNER";
                btn.style.background = subData ? "var(--border)" : "white";
                btn.style.color = subData ? "white" : "black";
                btn.onclick = () => this.toggleSub(author);

                document.getElementById('currentBell').innerText = subData?.bell === 'all' ? 'Toutes' : (subData?.bell === 'custom' ? 'Perso' : 'Aucune');
            },

            toggleSub: function(name) {
                if(!this.state.user) return this.openModal('modalAuth');
                if(this.state.subs[name]) {
                    delete this.state.subs[name];
                    this.addNotif(`Vous vous √™tes d√©sabonn√© de ${name}`);
                } else {
                    this.state.subs[name] = { tier: 'Standard', bell: 'all' };
                    this.addNotif(`Nouveau abonnement : ${name} !`);
                }
                this.saveLocal();
                this.renderPlayerMeta();
                this.renderUI();
            },

            // --- COMMENTAIRES & COEUR ---
            renderComments: function() {
                const list = document.getElementById('p-com-list');
                const coms = this.activeVid.comments || [];
                document.getElementById('p-com-count').innerText = coms.length;

                list.innerHTML = coms.map((c, i) => {
                    const hasHeart = c.hearted;
                    return `
                    <div style="display:flex; gap:15px; margin-bottom:25px;">
                        <img src="${this.getPDP(c.author)}" style="width:36px; height:36px; border-radius:50%;">
                        <div style="flex:1;">
                            <b style="font-size:13px;">${c.author} ‚Ä¢ <span style="font-weight:400; color:var(--sec);">${this.timeAgo(c.timestamp)}</span></b>
                            <p style="margin:5px 0 0 0; font-size:14px;">${c.text}</p>
                            
                            <div style="display:flex; gap:15px; align-items:center; margin-top:8px;">
                                <span style="cursor:pointer; font-size:12px;">üëç ${c.likes || 0}</span>
                                ${this.state.user?.name === this.activeVid.author ? `<span onclick="app.heartCom(${i})" style="cursor:pointer; font-size:12px;">‚ù§Ô∏è</span>` : ''}
                                ${hasHeart ? `
                                    <div class="creator-heart">
                                        <img src="${this.getPDP(this.activeVid.author)}" class="heart-pdp">
                                        Aim√© par le cr√©ateur
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `}).join('');
            },

            postComment: function() {
                if(!this.state.user) return this.openModal('modalAuth');
                const txt = document.getElementById('comInput').value;
                if(!txt) return;

                if(!this.activeVid.comments) this.activeVid.comments = [];
                this.activeVid.comments.unshift({
                    author: this.state.user.name,
                    text: txt,
                    timestamp: Date.now(),
                    likes: 0,
                    hearted: false
                });

                this.state.stats.coms++;
                document.getElementById('comInput').value = "";
                this.renderComments();
                this.saveLocal();
                this.saveData();
            },

            heartCom: function(index) {
                this.activeVid.comments[index].hearted = !this.activeVid.comments[index].hearted;
                this.renderComments();
                this.saveData();
            },

            // --- STATS LOGIC ---
            renderStats: function() {
                const s = this.state.stats;
                document.getElementById('s-views').innerText = s.views;
                document.getElementById('s-coms').innerText = s.coms;
                document.getElementById('s-subs').innerText = Object.keys(this.state.subs).length;
                document.getElementById('s-likes').innerText = s.likes;

                const hrs = Math.floor(s.time / 3600);
                const mins = Math.floor((s.time % 3600) / 60);
                document.getElementById('s-time').innerText = `${hrs}h ${mins}m`;

                // Top Cr√©ateurs (Algorithme de fr√©quence)
                const counts = {};
                this.state.hist.forEach(h => counts[h.author] = (counts[h.author] || 0) + 1);
                const sorted = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 3);

                document.getElementById('topCreators').innerHTML = sorted.map(name => `
                    <div class="card" onclick="app.goProfile('${name}')">
                        <div class="meta" style="background:var(--card); padding:20px; border-radius:20px; border:1px solid var(--border);">
                            <img src="${this.getPDP(name)}" class="avatar" style="width:60px; height:60px;">
                            <div>
                                <h4 style="font-size:18px;">${name}</h4>
                                <p>${counts[name]} vid√©os vues</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            // --- AUTH & PROFILE ---
            login: function() {
                const name = document.getElementById('authName').value;
                if(!name) return;
                this.state.user = { name, email: name.toLowerCase()+"@visiona.com" };
                localStorage.setItem('v26_user', JSON.stringify(this.state.user));
                this.addNotif(`Bienvenue sur Visiona, ${name} !`);
                location.reload();
            },

            goMyProfile: function() {
                if(!this.state.user) return this.openModal('modalAuth');
                this.goProfile(this.state.user.name);
            },

            goProfile: function(name) {
                this.nav('profile');
                const view = document.getElementById('v-profile');
                view.style.display = 'block';
                const u = this.state.users[name] || {};
                const uVids = this.state.vids.filter(v => v.author === name);

                view.innerHTML = `
                    <div style="height:200px; background:linear-gradient(45deg, #111, var(--accent)); border-radius:25px; position:relative; overflow:hidden;">
                        ${u.banner ? `<img src="${u.banner}" style="width:100%; height:100%; object-fit:cover;">` : ''}
                        ${this.state.user?.name === name ? `<button onclick="app.openModal('modalProfile')" style="position:absolute; bottom:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; padding:10px 20px; border-radius:10px; cursor:pointer;">‚úé Personnaliser</button>` : ''}
                    </div>
                    <div style="display:flex; align-items:center; gap:30px; margin-top:-50px; padding:0 40px; position:relative;">
                        <img src="${this.getPDP(name)}" style="width:120px; height:120px; border-radius:50%; border:5px solid var(--bg); background:#333;">
                        <div style="margin-top:40px;">
                            <h1 style="margin:0; font-size:36px; font-weight:900;">${name}</h1>
                            <p style="color:var(--sec); font-size:16px;">@${name.toLowerCase()} ‚Ä¢ ${uVids.length} vid√©os ‚Ä¢ 1.2k abonn√©s</p>
                        </div>
                    </div>
                    <div style="margin-top:50px;" class="v-grid">
                        ${uVids.map(v => this.tplSmallCard(v)).join('')}
                    </div>
                `;
            },

            saveProfile: function() {
                const pdp = document.getElementById('custPdp').value;
                const bnr = document.getElementById('custBanner').value;
                const name = this.state.user.name;
                if(!this.state.users[name]) this.state.users[name] = {};
                if(pdp) this.state.users[name].avatar = pdp;
                if(bnr) this.state.users[name].banner = bnr;
                this.saveData();
                location.reload();
            },

            // --- HELPERS ---
            tplSmallCard: function(v) {
                return `
                    <div class="card" onclick="app.openPlayer('${v.id}')">
                        <div class="thumb"><img src="${v.thumb}"></div>
                        <div class="info" style="margin-top:10px;">
                            <h4 style="font-size:14px;">${v.title}</h4>
                            <p style="font-size:12px;">${this.formatCount(v.views)} vues</p>
                        </div>
                    </div>
                `;
            },

            getPDP: function(n) {
                if(this.state.users[n]?.avatar) return this.state.users[n].avatar;
                return `https://ui-avatars.com/api/?name=${n}&background=7c4dff&color=fff&bold=true`;
            },

            formatCount: function(n) {
                if(!n) return 0;
                if(n >= 1000000) return (n/1000000).toFixed(1) + "M";
                if(n >= 1000) return (n/1000).toFixed(1) + "k";
                return n;
            },

            timeAgo: function(ts) {
                if(!ts) return "Il y a 2h";
                const diff = Math.floor((Date.now() - ts) / 1000);
                if(diff < 60) return "√Ä l'instant";
                if(diff < 3600) return `Il y a ${Math.floor(diff/60)}m`;
                if(diff < 86400) return `Il y a ${Math.floor(diff/3600)}h`;
                return `Il y a ${Math.floor(diff/86400)}j`;
            },

            startTimers: function() {
                setInterval(() => {
                    this.state.stats.time++;
                    if(this.state.stats.time % 10 === 0) this.saveLocal();
                }, 1000);
            },

            addNotif: function(msg) {
                this.state.notifs.unshift({ text: msg, time: Date.now() });
                this.state.notifs = this.state.notifs.slice(0, 15);
                this.saveLocal();
                this.renderUI();
            },

            toggleNotifs: function() {
                const m = document.getElementById('notifMenu');
                m.style.display = m.style.display === 'block' ? 'none' : 'block';
                document.getElementById('notifCount').innerText = "0";
            },

            renderUI: function() {
                const u = this.state.user;
                const h = document.getElementById('userMenuArea');
                if(u) {
                    h.innerHTML = `<img src="${this.getPDP(u.name)}" style="width:40px; height:40px; border-radius:50%; cursor:pointer;" onclick="app.goMyProfile()">`;
                    if(u.email === "edonis.imbert@gmail.com") document.getElementById('adminPanel').style.display = 'block';
                } else {
                    h.innerHTML = `<button onclick="app.openModal('modalAuth')" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:12px; font-weight:bold; cursor:pointer;">Se connecter</button>`;
                }

                document.getElementById('sidebarSubs').innerHTML = Object.keys(this.state.subs).map(name => `
                    <div class="nav-link" onclick="app.goProfile('${name}')">
                        <img src="${this.getPDP(name)}" style="width:24px; height:24px; border-radius:50%;">
                        <span>${name}</span>
                    </div>
                `).join('');

                const nList = document.getElementById('notifList');
                nList.innerHTML = this.state.notifs.map(n => `
                    <div style="padding:10px; border-bottom:1px solid var(--border); font-size:13px;">
                        ${n.text} <br><small style="color:var(--sec);">${this.timeAgo(n.time)}</small>
                    </div>
                `).join('');
                document.getElementById('notifCount').innerText = this.state.notifs.length;
            },

            toggleBellMenu: function() {
                const m = document.getElementById('bellMenu');
                m.style.display = m.style.display === 'block' ? 'none' : 'block';
            },

            setBell: function(type) {
                if(this.state.subs[this.activeVid.author]) {
                    this.state.subs[this.activeVid.author].bell = type;
                    this.saveLocal();
                    this.renderPlayerMeta();
                }
                document.getElementById('bellMenu').style.display = 'none';
            },

            saveLocal: function() {
                localStorage.setItem('v26_subs', JSON.stringify(this.state.subs));
                localStorage.setItem('v26_hist', JSON.stringify(this.state.hist));
                localStorage.setItem('v26_stats', JSON.stringify(this.state.stats));
                localStorage.setItem('v26_notifs', JSON.stringify(this.state.notifs));
            },

            openModal: function(id) { document.getElementById(id).style.display = 'flex'; },
            closeModals: function() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); },
            closePlayer: function() { document.getElementById('player-overlay').style.display = 'none'; document.getElementById('p-video').pause(); }
        };

        app.init();
    </script>
</body>
</html>
