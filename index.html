<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona V21 - Original & Power</title>
    <style>
        :root { 
            --bg: #050505; --header: #0a0a0a; --text: #ffffff; --sec-text: #b1b1b1; 
            --accent: #6e45e2; --accent-2: #88d3ce; --red: #ff3e3e; --border: #1a1a1a;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* --- NOUVEAU LOGO VISIONA --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 25px; height: 70px; background: var(--header); position: sticky; top: 0; z-index: 2000; border-bottom: 1px solid var(--border); }
        .v-logo { display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 24px; font-weight: 900; background: linear-gradient(45deg, var(--accent), var(--accent-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .v-icon { width: 35px; height: 35px; background: linear-gradient(45deg, var(--accent), var(--accent-2)); border-radius: 10px; transform: rotate(-10deg); display: flex; align-items: center; justify-content: center; color: white; -webkit-text-fill-color: white; font-size: 20px; }

        /* --- LAYOUT 4 COLONNES --- */
        .container { display: flex; height: calc(100vh - 70px); }
        .sidebar { width: 260px; background: var(--header); padding: 20px; overflow-y: auto; flex-shrink: 0; border-right: 1px solid var(--border); }
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        .video-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; } /* Fix√© √† 4 colonnes */

        /* --- ABONNEMENTS --- */
        .sub-tier { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .tier-standard { background: #555; }
        .tier-premium { background: var(--accent); }
        .tier-vip { background: gold; color: black; }

        /* --- PROFIL ONGLET --- */
        .profile-header { background: #111; padding: 40px; border-radius: 20px; margin-bottom: 20px; }
        .tabs { display: flex; gap: 30px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .tab { padding: 15px 0; cursor: pointer; color: var(--sec-text); font-weight: 600; position: relative; }
        .tab.active { color: white; border-bottom: 3px solid var(--accent); }

        /* --- UI ELEMENTS --- */
        .nav-item { padding: 12px 15px; border-radius: 12px; cursor: pointer; margin-bottom: 8px; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .nav-item:hover { background: #1a1a1a; }
        .nav-active { background: #1a1a1a; border-left: 4px solid var(--accent); }
        
        .thumb { width: 100%; aspect-ratio: 16/9; border-radius: 12px; object-fit: cover; background: #222; transition: 0.3s; }
        .video-card:hover .thumb { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

        /* --- PLAYER & LIVE --- */
        #playerOverlay { display: none; position: fixed; inset: 0; background: #000; z-index: 5000; padding: 20px; overflow-y: auto; }
        .live-indicator { background: var(--red); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; position: absolute; top: 10px; left: 10px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; align-items: center; justify-content: center; }
        .modal-box { background: #111; padding: 30px; border-radius: 25px; width: 90%; max-width: 500px; border: 1px solid var(--border); }
        input, select { width: 100%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid #333; color: white; border-radius: 8px; }

        .btn-v { background: linear-gradient(45deg, var(--accent), var(--accent-2)); color: white; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <div class="v-logo" onclick="app.goHome()">
            <div class="v-icon">V</div> VISIONA
        </div>
        <div style="flex:1; max-width: 500px; display:flex;">
            <input type="text" id="search" placeholder="Rechercher sur Visiona..." style="margin:0; border-radius: 20px 0 0 20px;">
            <button class="btn-v" style="border-radius: 0 20px 20px 0;">üîç</button>
        </div>
        <div id="authHeader" style="display:flex; align-items:center; gap:20px;"></div>
    </header>

    <div class="container">
        <nav class="sidebar">
            <div class="nav-item nav-active" id="nHome" onclick="app.goHome()">üí† Accueil</div>
            <div class="nav-item" onclick="app.goShorts()">‚ö° Zapp</div>
            <div class="nav-item" onclick="app.goLiveTab()">üî¥ Directs</div>
            <div class="nav-item" onclick="app.goCommunity()">üì∞ Communaut√©</div>
            <hr style="border-color:var(--border)">
            <div class="nav-item" onclick="app.goMyProfile()">üë§ Ma Cha√Æne</div>
            <div class="nav-item" onclick="app.goHistory()">üïí Historique</div>
            <div class="nav-item" onclick="app.goStats()">üìä Statistiques</div>
            <hr style="border-color:var(--border)">
            <div style="font-size:12px; color:var(--sec-text); padding:10px;">MES ABONNEMENTS</div>
            <div id="sideSubs"></div>
            <div id="adminLink" style="display:none;"><hr><div class="nav-item" onclick="app.goAdmin()" style="color:var(--accent-2)">üîë Admin Panel</div></div>
        </nav>

        <main class="content">
            <div id="viewMain" class="video-grid"></div>
            <div id="viewProfile" style="display:none;"></div>
            <div id="viewZapp" style="display:none; justify-content:center; gap:20px; overflow-y:auto; height:100%;"></div>
            <div id="viewOther"></div>
        </main>
    </div>

    <div id="playerOverlay">
        <div style="max-width:1200px; margin:0 auto;">
            <button class="btn-v" onclick="app.closePlayer()">‚úï QUITTER</button>
            <div style="width:100%; aspect-ratio:16/9; background:#000; border-radius:20px; margin-top:20px; position:relative; overflow:hidden;">
                <video id="vPlayer" controls autoplay style="width:100%; height:100%;"></video>
                <canvas id="liveCanvas" style="display:none; width:100%; height:100%;"></canvas>
            </div>
            <div id="vDetails" style="margin-top:20px;">
                <h1 id="vT"></h1>
                <div id="vM" style="color:var(--sec-text);"></div>
                <div id="vAuthor" style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; background:#111; padding:20px; border-radius:15px;"></div>
            </div>
        </div>
    </div>

    <div id="modalSub" class="modal">
        <div class="modal-box">
            <h2>Choisir un niveau d'abonnement</h2>
            <button class="btn-v" style="width:100%; margin-bottom:10px; background:#444;" onclick="app.confirmSub('Standard')">Standard (Gratuit)</button>
            <button class="btn-v" style="width:100%; margin-bottom:10px;" onclick="app.confirmSub('Premium')">Premium (Soutien)</button>
            <button class="btn-v" style="width:100%; background:gold; color:black;" onclick="app.confirmSub('VIP')">VIP (L√©gende)</button>
        </div>
    </div>

    <div id="modalStream" class="modal">
        <div class="modal-box">
            <h2>Lancer un direct</h2>
            <video id="streamPreview" autoplay muted style="width:100%; border-radius:10px; background:#000;"></video>
            <input type="text" id="streamTitle" placeholder="Titre du live...">
            <button class="btn-v" style="width:100%;" onclick="app.startStreaming()">PASSER AU DIRECT</button>
        </div>
    </div>

    <script>
        const CLOUD = "https://api.cloudinary.com/v1_1/dvbsmh8qq/upload";
        const GIST = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
        const WORKER = "https://mytubeupload.edonis-imbert.workers.dev/";
        const bus = new BroadcastChannel('visiona_v21_live');

        const app = {
            data: {
                user: JSON.parse(localStorage.getItem('vt_user')),
                videos: [], users: {}, posts: [],
                subs: JSON.parse(localStorage.getItem('vt_subs')) || [], // Format: {name, tier}
                history: JSON.parse(localStorage.getItem('vt_history')) || [],
                viewLog: JSON.parse(localStorage.getItem('vt_view_log')) || {}
            },
            activeV: null, streamStream: null,

            init: async function() {
                await this.load();
                this.updateUI();
                this.goHome();
            },

            load: async function() {
                try {
                    const r = await fetch(GIST + "?t=" + Date.now());
                    const j = await r.json();
                    this.data.videos = j.videos || [];
                    this.data.users = j.users || {};
                    this.data.posts = j.posts || [];
                } catch(e) { console.error("Load Error"); }
            },

            save: async function() {
                const b = { videos: this.data.videos, users: this.data.users, posts: this.data.posts };
                await fetch(WORKER, { method: 'PATCH', body: JSON.stringify({ files: {"video.json": {content: JSON.stringify(b, null, 2)}}}) });
            },

            // --- NAVIGATION ---
            hide: function() {
                ['viewMain', 'viewProfile', 'viewZapp', 'viewOther'].forEach(id => document.getElementById(id).style.display='none');
            },

            goHome: function() {
                this.hide(); document.getElementById('viewMain').style.display='grid';
                // ALGO ALEATOIRE
                let shuffled = [...this.data.videos.filter(v => !v.isShort && !v.isStream)];
                shuffled.sort(() => Math.random() - 0.5);
                this.renderVids(shuffled, document.getElementById('viewMain'));
            },

            // --- SYSTEME DE PROFIL ---
            viewProfile: function(name) {
                this.hide(); const v = document.getElementById('viewProfile'); v.style.display='block';
                const uVids = this.data.videos.filter(x => x.author === name);
                const uPosts = this.data.posts.filter(x => x.author === name);
                
                v.innerHTML = `
                    <div class="profile-header">
                        <div style="display:flex; align-items:center; gap:25px;">
                            ${this.getAv(name, 80)}
                            <div>
                                <h1 style="margin:0;">${name}</h1>
                                <p style="color:var(--sec-text);">${uVids.length} Vid√©os ‚Ä¢ ${this.data.subs.filter(s=>s.name===name).length} Abonn√©s</p>
                            </div>
                        </div>
                    </div>
                    <div class="tabs">
                        <div class="tab active" onclick="app.setTab(this, 'v')">VID√âOS</div>
                        <div class="tab" onclick="app.setTab(this, 'z')">ZAPPS</div>
                        <div class="tab" onclick="app.setTab(this, 's')">STREAMS</div>
                        <div class="tab" onclick="app.setTab(this, 'p')">PUBLICATIONS</div>
                        <div class="tab" onclick="app.setTab(this, 'a')">√Ä PROPOS</div>
                    </div>
                    <div id="tabContent" class="video-grid"></div>
                `;
                this.setTab(v.querySelector('.tab'), 'v', name);
            },

            setTab: function(el, type, name) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                const target = document.getElementById('tabContent');
                const vids = this.data.videos.filter(v => v.author === (name || this.activeV.author));

                if(type === 'v') this.renderVids(vids.filter(v=>!v.isShort && !v.isStream), target);
                if(type === 'z') this.renderVids(vids.filter(v=>v.isShort), target);
                if(type === 's') this.renderVids(vids.filter(v=>v.isStream), target);
                if(type === 'p') target.innerHTML = this.data.posts.filter(p=>p.author===(name || this.activeV.author)).map(p=>`<div style="background:#111; padding:20px; border-radius:15px; grid-column: span 4;">${p.text}</div>`).join('');
                if(type === 'a') target.innerHTML = `<div style="grid-column: span 4;">Canal cr√©√© pour le partage de contenu Visiona.</div>`;
            },

            // --- VUES & STATS (FIX√â) ---
            openPlayer: function(id) {
                const v = this.data.videos.find(x => x.id == id);
                this.activeV = v;
                
                // Cooldown 1h strict par ID de vid√©o
                const now = Date.now();
                if(!this.data.viewLog[id] || (now - this.data.viewLog[id] > 3600000)) {
                    v.views = (v.views || 0) + 1;
                    this.data.viewLog[id] = now;
                    localStorage.setItem('vt_view_log', JSON.stringify(this.data.viewLog));
                    this.save();
                }

                document.getElementById('playerOverlay').style.display='block';
                document.getElementById('vT').innerText = v.title;
                document.getElementById('vM').innerText = `${v.views} vues ‚Ä¢ ${v.date}`;
                
                const vid = document.getElementById('vPlayer');
                if(v.isStream) {
                    vid.style.display='none'; document.getElementById('liveCanvas').style.display='block';
                    this.listenLive(v.id);
                } else {
                    vid.style.display='block'; document.getElementById('liveCanvas').style.display='none';
                    vid.src = v.url;
                }
                
                const sub = this.data.subs.find(s => s.name === v.author);
                document.getElementById('vAuthor').innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px; cursor:pointer;" onclick="app.viewProfile('${v.author}')">
                        ${this.getAv(v.author)}
                        <div><b>${v.author}</b> ${sub ? `<span class="sub-tier tier-${sub.tier.toLowerCase()}">${sub.tier}</span>` : ''}</div>
                    </div>
                    <button class="btn-v" onclick="app.openSubModal('${v.author}')">${sub ? 'ABONN√â' : 'S\'ABONNER'}</button>
                `;
            },

            // --- STREAMING REEL ---
            prepStream: async function() {
                document.getElementById('modalStream').style.display='flex';
                this.streamStream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
                document.getElementById('streamPreview').srcObject = this.streamStream;
            },

            startStreaming: async function() {
                const title = document.getElementById('streamTitle').value;
                const streamId = "live_" + Date.now();
                this.data.videos.unshift({ id: streamId, title, author: this.data.user.name, isStream: true, views: 0, date: "EN DIRECT" });
                await this.save();
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 640; canvas.height = 360;

                setInterval(() => {
                    ctx.drawImage(document.getElementById('streamPreview'), 0, 0, 640, 360);
                    bus.postMessage({ id: streamId, frame: canvas.toDataURL('image/jpeg', 0.5) });
                }, 100);

                location.reload();
            },

            listenLive: function(id) {
                bus.onmessage = (e) => {
                    if(e.data.id === id) {
                        const img = new Image();
                        img.onload = () => document.getElementById('liveCanvas').getContext('2d').drawImage(img, 0, 0, 1280, 720);
                        img.src = e.data.frame;
                    }
                };
            },

            // --- ABONNEMENT 3 NIVEAUX ---
            openSubModal: function(name) {
                this.subPending = name;
                document.getElementById('modalSub').style.display='flex';
            },

            confirmSub: function(tier) {
                this.data.subs = this.data.subs.filter(s => s.name !== this.subPending);
                this.data.subs.push({name: this.subPending, tier: tier});
                localStorage.setItem('vt_subs', JSON.stringify(this.data.subs));
                location.reload();
            },

            // --- HELPERS ---
            renderVids: function(list, el) {
                el.innerHTML = list.map(v => `
                    <div class="video-card" onclick="app.openPlayer('${v.id}')" style="cursor:pointer; position:relative;">
                        ${v.isStream ? '<div class="live-indicator">LIVE</div>' : ''}
                        <img src="${v.thumb || 'https://via.placeholder.com/300x170/111/fff?text=Visiona'}" class="thumb">
                        <div style="display:flex; gap:12px; margin-top:12px;">
                            ${this.getAv(v.author, 35)}
                            <div>
                                <div style="font-weight:bold; font-size:14px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${v.title}</div>
                                <div style="color:var(--sec-text); font-size:12px; margin-top:4px;">${v.author} ‚Ä¢ ${v.views} vues</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            getAv: function(name, size=40) {
                const u = this.data.users[name];
                const src = u?.avatar ? u.avatar : `https://ui-avatars.com/api/?name=${name}&background=6e45e2&color=fff`;
                return `<img src="${src}" style="width:${size}px; height:${size}px; border-radius:50%; object-fit:cover; background:#333;">`;
            },

            updateUI: function() {
                const h = document.getElementById('authHeader');
                if(this.data.user) {
                    h.innerHTML = `
                        <button onclick="app.prepStream()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">üé•</button>
                        ${this.getAv(this.data.user.name)}
                    `;
                    if(this.data.user.email === "edonis.imbert@gmail.com") document.getElementById('adminLink').style.display='block';
                } else {
                    h.innerHTML = `<button class="btn-v" onclick="app.login()">Connexion</button>`;
                }
                
                document.getElementById('sideSubs').innerHTML = this.data.subs.map(s => `
                    <div class="nav-item" onclick="app.viewProfile('${s.name}')">
                        ${this.getAv(s.name, 25)} <span>${s.name}</span> <span class="sub-tier tier-${s.tier.toLowerCase()}">${s.tier[0]}</span>
                    </div>
                `).join('');
            },

            login: function() {
                const p = prompt("Pseudo ?");
                if(p) {
                    this.data.user = {name: p, email: p+"@visiona.com"};
                    localStorage.setItem('vt_user', JSON.stringify(this.data.user));
                    location.reload();
                }
            },

            closePlayer: function() { document.getElementById('playerOverlay').style.display='none'; document.getElementById('vPlayer').pause(); },
            goStats: function() { alert(`Total Vid√©os: ${this.data.videos.length}\nTotal Vues: ${this.data.videos.reduce((a,b)=>a+(b.views||0),0)}`); }
        };

        app.init();
    </script>
</body>
</html>
