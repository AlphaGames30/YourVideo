<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona - AlphaGames30</title>
    <style>
        :root { --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --green: #00a854; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: Roboto, Arial, sans-serif; overflow-x: hidden; padding-bottom: 60px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; height: 56px; background: var(--header); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        .logo { font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; }
        .logo::before { content: '‚ñ∂'; color: var(--red); font-size: 24px; margin-right: 5px; }
        .search-box { display: flex; flex: 1; max-width: 600px; margin: 0 40px; }
        .search-box input { width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 8px 16px; border-radius: 40px 0 0 40px; font-size: 16px; outline: none; }
        .search-box input:focus { border-color: var(--blue); }
        .search-box button { background: #222; border: 1px solid #333; border-left: none; color: white; padding: 0 20px; border-radius: 0 40px 40px 0; cursor: pointer; }
        .user-nav { display: flex; align-items: center; gap: 15px; }
        .nav-icon { font-size: 24px; cursor: pointer; color: white; background: none; border: none; }
        .avatar-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--blue); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden; font-size: 14px; }
        .avatar-btn img { width: 100%; height: 100%; object-fit: cover; }

        /* Ajout Style Direct */
        .live-badge { background: var(--red); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; position: absolute; top: 10px; left: 10px; animation: pulseLive 1.5s infinite; z-index: 10; }
        @keyframes pulseLive { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .sidebar { position: fixed; left: 0; top: 56px; width: 240px; height: calc(100vh - 56px); background: var(--bg); padding: 12px; box-sizing: border-box; overflow-y: auto; display: none; z-index: 90; }
        .sidebar.active { display: block; }
        .nav-item { display: flex; align-items: center; padding: 10px 12px; border-radius: 10px; cursor: pointer; gap: 20px; }
        .nav-item:hover { background: var(--hover); }
        .nav-item.active { background: var(--hover); font-weight: bold; }

        .main-content { margin-left: 0; padding: 16px; transition: 0.3s; }
        .main-content.shifted { margin-left: 240px; }

        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .video-card { cursor: pointer; transition: 0.2s; }
        .video-card:hover { transform: scale(1.02); }
        .thumb { width: 100%; aspect-ratio: 16/9; background: #222; border-radius: 12px; position: relative; overflow: hidden; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .duration { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 2px 4px; border-radius: 4px; font-size: 12px; }
        .v-info { display: flex; gap: 12px; margin-top: 12px; }
        .v-avatar { width: 36px; height: 36px; border-radius: 50%; background: #333; flex-shrink: 0; overflow: hidden; }
        .v-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .v-text h3 { margin: 0; font-size: 16px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .v-text p { margin: 4px 0 0; font-size: 14px; color: var(--sec-text); }

        #player-overlay { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 1000; overflow-y: auto; }
        .p-container { max-width: 1280px; margin: 0 auto; display: grid; grid-template-columns: 1fr 350px; gap: 24px; padding: 24px; }
        .main-v-col video { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; }
        .p-meta { margin-top: 16px; }
        .p-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        .btn-group { display: flex; background: #222; border-radius: 20px; overflow: hidden; }
        .action-btn { background: none; border: none; color: white; padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: bold; border-right: 1px solid #333; }
        .action-btn:hover { background: #333; }
        .btn-sub { background: white; color: black; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-sub.subscribed { background: #222; color: white; }

        .comments-section { margin-top: 24px; border-top: 1px solid #333; padding-top: 24px; }
        .com-input-block { display: flex; gap: 12px; margin-bottom: 24px; }
        .com-item { display: flex; gap: 12px; margin-bottom: 20px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: #212121; padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        input, textarea, select { width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-bottom: 16px; box-sizing: border-box; }
        .btn-prime { background: var(--blue); color: black; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }

        #profile-view { display: none; }
        .banner { width: 100%; height: 200px; background: #333; background-size: cover; background-position: center; border-radius: 12px; }
        .p-header { display: flex; align-items: center; gap: 24px; padding: 24px; }
        .p-avatar-large { width: 128px; height: 128px; border-radius: 50%; background: var(--blue); border: 4px solid var(--bg); margin-top: -64px; overflow: hidden; }
        .p-avatar-large img { width: 100%; height: 100%; object-fit: cover; }

        /* Style Easter Egg */
        #easter-egg-overlay { display: none; position: fixed; inset: 0; background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: white; font-weight: 900; animation: discoBg 1s infinite; }
        @keyframes discoBg { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        @media (max-width: 1000px) {
            .p-container { grid-template-columns: 1fr; }
            .sidebar { width: 72px; }
            .sidebar span { display: none; }
            .main-content.shifted { margin-left: 72px; }
        }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center;">
            <button class="nav-icon" onclick="app.toggleSidebar()">‚ò∞</button>
            <div class="logo" onclick="app.goHome()" style="margin-left:16px;">Visiona</div>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Rechercher">
            <button onclick="app.search()">üîç</button>
        </div>
        <div class="user-nav" id="userNav">
            <button class="nav-icon" onclick="app.openModal('uploadModal')">‚ûï</button>
            <div class="avatar-btn" id="userAvatar" onclick="app.openModal('loginModal')">üë§</div>
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <div class="nav-item active" onclick="app.goHome()"><span>üè†</span> <span>Accueil</span></div>
        <div class="nav-item" onclick="app.showSubscribed()"><span>üîî</span> <span>Abonnements</span></div>
        <hr style="border:0; border-top:1px solid #333; margin:12px 0;">
        <div class="nav-item" onclick="app.showMyChannel()"><span>üë§</span> <span>Votre cha√Æne</span></div>
        <div class="nav-item" onclick="app.showHistory()"><span>üïí</span> <span>Historique</span></div>
    </div>

    <main class="main-content" id="mainContent">
        <div id="home-view">
            <div class="video-grid" id="videoGrid"></div>
        </div>

        <div id="profile-view">
            <div class="banner" id="pBanner"></div>
            <div class="p-header">
                <div class="p-avatar-large" id="pAvatarLarge"></div>
                <div>
                    <h1 id="pName" style="margin:0;">Nom de la cha√Æne</h1>
                    <p id="pStats" style="color:var(--sec-text); margin:8px 0;"></p>
                    <button id="pSubBtn" class="btn-sub" onclick="app.toggleSub()">S'ABONNER</button>
                    <button id="pEditBtn" class="btn-sub" style="display:none;" onclick="app.openModal('editProfileModal')">MODIFIER</button>
                </div>
            </div>
            <div class="video-grid" id="profileVideoGrid" style="padding:24px;"></div>
        </div>
    </main>

    <div id="player-overlay">
        <header>
            <div style="display:flex; align-items:center;">
                <button class="nav-icon" onclick="app.closePlayer()">‚Üê</button>
                <div class="logo">Visiona</div>
            </div>
        </header>
        <div class="p-container">
            <div class="main-v-col">
                <video id="player" controls autoplay></video>
                <div class="p-meta">
                    <h1 id="pTitle" style="font-size:20px; margin:0;">Titre de la vid√©o</h1>
                    <div class="p-actions">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div class="v-avatar" id="pChanAvatar" onclick="app.viewProfileFromPlayer()" style="cursor:pointer;"></div>
                            <div>
                                <b id="pChanName" onclick="app.viewProfileFromPlayer()" style="cursor:pointer; display:block;">Cha√Æne</b>
                                <span id="pChanSubs" style="color:var(--sec-text); font-size:12px;">0 abonn√©s</span>
                            </div>
                            <button id="pSubBtnPlayer" class="btn-sub" onclick="app.toggleSub()">S'ABONNER</button>
                        </div>
                        <div class="btn-group">
                            <button class="action-btn" onclick="app.like()">üëç <span id="pLikes">0</span></button>
                            <button class="action-btn">üëé</button>
                            <button class="action-btn">Partager</button>
                        </div>
                    </div>
                    <div style="background:#222; padding:12px; border-radius:12px; margin-top:16px;">
                        <b id="pViews">0 vues</b> ‚Ä¢ <span id="pDate">Il y a 2 jours</span>
                        <p id="pDesc" style="margin:8px 0; font-size:14px; white-space:pre-wrap;"></p>
                    </div>
                    <div class="comments-section">
                        <h3 id="pComCount">0 Commentaires</h3>
                        <div class="com-input-block">
                            <div class="v-avatar" id="myComAvatar"></div>
                            <div style="flex:1;">
                                <input type="text" id="comInput" placeholder="Ajouter un commentaire..." style="margin:0;">
                                <div style="display:flex; justify-content:flex-end; margin-top:8px;">
                                    <button class="btn-sub" style="font-size:12px; padding:8px 16px;" onclick="app.postComment()">Publier</button>
                                </div>
                            </div>
                        </div>
                        <div id="commentsList"></div>
                    </div>
                </div>
            </div>
            <div class="side-v-col" id="nextVideos"></div>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>Connexion</h2>
            <input type="text" id="loginPseudo" placeholder="Pseudo">
            <input type="email" id="loginEmail" placeholder="Email (optionnel)">
            <button class="btn-prime" onclick="app.login()">Rejoindre</button>
        </div>
    </div>

    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <h2>Mettre en ligne</h2>
            <input type="text" id="upTitle" placeholder="Titre">
            <textarea id="upDesc" placeholder="Description"></textarea>
            <input type="text" id="upUrl" placeholder="Lien direct MP4 de la vid√©o">
            <input type="text" id="upThumb" placeholder="Lien direct de la miniature (Image)">
            <select id="upCat">
                <option value="Divertissement">Divertissement</option>
                <option value="Gaming">Gaming</option>
                <option value="Musique">Musique</option>
                <option value="√âducation">√âducation</option>
            </select>
            <label style="color:var(--sec-text); display:flex; align-items:center; gap:10px; margin-bottom:16px; cursor:pointer;">
                <input type="checkbox" id="upIsLive" style="width:auto; margin:0;"> Marquer comme üî¥ <b>DIRECT / LIVE</b>
            </label>
            <button class="btn-prime" onclick="app.upload()">Publier</button>
            <button class="btn-prime" style="background:#333; color:white; margin-top:8px;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <h2>Modifier ma cha√Æne</h2>
            <textarea id="editBio" placeholder="Ma bio..."></textarea>
            <label>Photo de profil :</label>
            <input type="file" id="editAvatarFile" accept="image/*">
            <label>Banni√®re :</label>
            <input type="file" id="editBannerFile" accept="image/*">
            <div id="profileUploadStatus" style="font-size:12px; color:var(--blue); margin-bottom:10px;"></div>
            <button class="btn-prime" onclick="app.saveProfile()">Enregistrer</button>
            <button class="btn-prime" style="background:#333; color:white; margin-top:8px;" onclick="app.closeModals()">Annuler</button>
        </div>
    </div>

    <div id="easter-egg-overlay">
        <h1 style="font-size: 60px; margin: 0;">üåà VISIONA DISCO üåà</h1>
        <p style="font-size: 20px;">MODE SECRET ACTIV√â !</p>
        <button class="btn-prime" style="width:200px; margin-top: 30px;" onclick="location.reload()">RETOUR</button>
    </div>

    <script>
        const GIST_URL = "https://gist.githubusercontent.com/AlphaGames30/5248424f9cc79feb78c0560faad87c92/raw/video.json";
        const WORKER_URL = "https://mytubeupload.edonis-imbert.workers.dev/";
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dx949vjue/upload";
        const CLOUDINARY_PRESET = "unsigned_preset";

        const app = {
            data: { videos: [], users: {}, user: null },
            activeVid: null,
            currentView: 'home',
            viewingChannel: null,
            history: JSON.parse(localStorage.getItem('visiona_history')) || [],
            konami: "", // Pour l'Easter Egg

            init: async function() {
                this.loadUser();
                await this.fetchData();
                this.render();
                this.initEasterEgg();
                
                // Sidebar responsive
                if(window.innerWidth > 1000) this.toggleSidebar();
            },

            loadUser: function() {
                const saved = localStorage.getItem('visiona_user');
                if(saved) {
                    this.data.user = JSON.parse(saved);
                    this.updateUserUI();
                }
            },

            updateUserUI: function() {
                const avatar = document.getElementById('userAvatar');
                const myComAvatar = document.getElementById('myComAvatar');
                const userData = this.data.users[this.data.user.name] || {};
                
                const avatarContent = userData.avatar ? `<img src="${userData.avatar}">` : this.data.user.name[0].toUpperCase();
                avatar.innerHTML = avatarContent;
                if(myComAvatar) myComAvatar.innerHTML = avatarContent;
            },

            fetchData: async function() {
                try {
                    const r = await fetch(GIST_URL + "?nocache=" + Date.now());
                    const json = await r.json();
                    this.data.videos = json.videos || [];
                    this.data.users = json.users || {};
                    if(this.data.user) this.updateUserUI();
                } catch(e) { console.error("Erreur de chargement", e); }
            },

            saveGist: async function() {
                try {
                    await fetch(WORKER_URL, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            files: { "video.json": { content: JSON.stringify(this.data, null, 2) } }
                        })
                    });
                } catch(e) { console.error("Erreur sauvegarde", e); }
            },

            render: function(vids = this.data.videos) {
                const grid = document.getElementById('videoGrid');
                grid.innerHTML = vids.map(v => this.createVideoCard(v)).join('');
            },

            createVideoCard: function(v) {
                const authorData = this.data.users[v.author] || {};
                const avatar = authorData.avatar ? `<img src="${authorData.avatar}">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--blue);font-weight:bold;">${v.author[0]}</div>`;
                
                return `
                    <div class="video-card" onclick="app.openPlayer('${v.id}')">
                        <div class="thumb">
                            <img src="${v.thumb}" loading="lazy">
                            ${v.isLive ? '<div class="live-badge">DIRECT</div>' : `<div class="duration">${v.duration || '0:00'}</div>`}
                        </div>
                        <div class="v-info">
                            <div class="v-avatar" onclick="event.stopPropagation(); app.viewProfile('${v.author}')">${avatar}</div>
                            <div class="v-text">
                                <h3 title="${v.title}">${v.title}</h3>
                                <p onclick="event.stopPropagation(); app.viewProfile('${v.author}')">${v.author}</p>
                                <p>${v.views || 0} vues ‚Ä¢ ${v.isLive ? 'EN DIRECT' : 'Il y a 2 jours'}</p>
                            </div>
                        </div>
                    </div>
                `;
            },

            openPlayer: function(id) {
                const v = this.data.videos.find(x => x.id == id);
                if(!v) return;
                this.activeVid = v;
                
                document.getElementById('player-overlay').style.display = 'block';
                document.getElementById('player').src = v.url;
                document.getElementById('pTitle').innerText = v.title;
                document.getElementById('pDesc').innerText = v.description || "";
                document.getElementById('pLikes').innerText = v.likes || 0;
                document.getElementById('pViews').innerText = `${v.views || 0} vues`;
                
                const authorData = this.data.users[v.author] || {};
                document.getElementById('pChanName').innerText = v.author;
                document.getElementById('pChanAvatar').innerHTML = authorData.avatar ? `<img src="${authorData.avatar}">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--blue);font-weight:bold;">${v.author[0]}</div>`;
                
                const subCount = Object.values(this.data.users).filter(u => u.subs && u.subs[v.author]).length;
                document.getElementById('pChanSubs').innerText = `${subCount} abonn√©s`;

                this.updateSubBtn(v.author, 'pSubBtnPlayer');
                this.renderComments();
                this.renderNextVideos();

                v.views = (v.views || 0) + 1;
                this.addToHistory(v);
                this.saveGist();
            },

            addToHistory: function(v) {
                this.history = [v, ...this.history.filter(x => x.id !== v.id)].slice(0, 50);
                localStorage.setItem('visiona_history', JSON.stringify(this.history));
            },

            closePlayer: function() {
                document.getElementById('player-overlay').style.display = 'none';
                document.getElementById('player').pause();
                this.activeVid = null;
            },

            renderComments: function() {
                const list = document.getElementById('commentsList');
                const coms = this.activeVid.comments || [];
                document.getElementById('pComCount').innerText = `${coms.length} Commentaires`;
                list.innerHTML = coms.map(c => {
                    const uData = this.data.users[c.author] || {};
                    const avatar = uData.avatar ? `<img src="${uData.avatar}">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--blue);font-weight:bold;color:white;width:36px;height:36px;border-radius:50%;">${c.author[0]}</div>`;
                    return `
                        <div class="com-item">
                            <div class="v-avatar">${avatar}</div>
                            <div>
                                <b style="font-size:13px;">@${c.author}</b> <span style="color:var(--sec-text);font-size:12px;">il y a 1 heure</span>
                                <p style="margin:4px 0; font-size:14px;">${c.text}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            postComment: async function() {
                if(!this.data.user) return this.openModal('loginModal');
                const text = document.getElementById('comInput').value;
                if(!text) return;

                if(!this.activeVid.comments) this.activeVid.comments = [];
                this.activeVid.comments.unshift({ author: this.data.user.name, text });
                document.getElementById('comInput').value = "";
                this.renderComments();
                await this.saveGist();
            },

            like: async function() {
                if(!this.activeVid) return;
                this.activeVid.likes = (this.activeVid.likes || 0) + 1;
                document.getElementById('pLikes').innerText = this.activeVid.likes;
                await this.saveGist();
            },

            upload: async function() {
                if(!this.data.user) return this.openModal('loginModal');
                const title = document.getElementById('upTitle').value;
                const url = document.getElementById('upUrl').value;
                const thumb = document.getElementById('upThumb').value;
                const isLive = document.getElementById('upIsLive').checked;

                if(!title || !url) return alert("Le titre et l'URL sont obligatoires.");

                const newVid = {
                    id: Date.now().toString(),
                    title,
                    description: document.getElementById('upDesc').value,
                    url,
                    thumb: thumb || "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe",
                    category: document.getElementById('upCat').value,
                    author: this.data.user.name,
                    views: 0,
                    likes: 0,
                    duration: isLive ? "LIVE" : "10:00",
                    isLive: isLive,
                    comments: []
                };

                this.data.videos.unshift(newVid);
                await this.saveGist();
                location.reload();
            },

            viewProfile: function(name) {
                this.viewingChannel = name;
                this.currentView = 'profile';
                document.getElementById('home-view').style.display = 'none';
                document.getElementById('profile-view').style.display = 'block';
                this.closePlayer();

                const uData = this.data.users[name] || { name };
                document.getElementById('pName').innerText = name;
                document.getElementById('pBanner').style.backgroundImage = uData.banner ? `url(${uData.banner})` : '';
                document.getElementById('pAvatarLarge').innerHTML = uData.avatar ? `<img src="${uData.avatar}">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--blue);font-weight:bold;font-size:40px;">${name[0]}</div>`;
                
                const vids = this.data.videos.filter(v => v.author === name);
                const subCount = Object.values(this.data.users).filter(u => u.subs && u.subs[name]).length;
                document.getElementById('pStats').innerText = `@${name} ‚Ä¢ ${subCount} abonn√©s ‚Ä¢ ${vids.length} vid√©os`;
                
                const grid = document.getElementById('profileVideoGrid');
                grid.innerHTML = vids.map(v => this.createVideoCard(v)).join('');

                const isMe = this.data.user && this.data.user.name === name;
                document.getElementById('pEditBtn').style.display = isMe ? 'inline-block' : 'none';
                document.getElementById('pSubBtn').style.display = isMe ? 'none' : 'inline-block';
                this.updateSubBtn(name, 'pSubBtn');
            },

            toggleSub: async function() {
                if(!this.data.user) return this.openModal('loginModal');
                const target = this.viewingChannel || (this.activeVid ? this.activeVid.author : null);
                if(!target || target === this.data.user.name) return;

                let me = this.data.users[this.data.user.name] || { subs: {} };
                if(!me.subs) me.subs = {};

                if(me.subs[target]) delete me.subs[target];
                else me.subs[target] = true;

                this.data.users[this.data.user.name] = me;
                this.updateSubBtn(target, 'pSubBtn');
                this.updateSubBtn(target, 'pSubBtnPlayer');
                await this.saveGist();
            },

            updateSubBtn: function(name, btnId) {
                const btn = document.getElementById(btnId);
                if(!btn || !this.data.user) return;
                const me = this.data.users[this.data.user.name];
                const isSub = me && me.subs && me.subs[name];
                btn.innerText = isSub ? "ABONN√â" : "S'ABONNER";
                btn.className = isSub ? "btn-sub subscribed" : "btn-sub";
            },

            saveProfile: async function() {
                const bio = document.getElementById('editBio').value;
                const pp = document.getElementById('editAvatarFile').files[0];
                const ban = document.getElementById('editBannerFile').files[0];
                const status = document.getElementById('profileUploadStatus');
                
                let me = this.data.users[this.data.user.name] || { name: this.data.user.name };
                if(bio) me.bio = bio;

                try {
                    if(pp) {
                        status.innerText = "Upload Photo...";
                        me.avatar = await this.uploadCloudinary(pp);
                    }
                    if(ban) {
                        status.innerText = "Upload Banni√®re...";
                        me.banner = await this.uploadCloudinary(ban);
                    }
                    this.data.users[this.data.user.name] = me;
                    await this.saveGist();
                    location.reload();
                } catch(e) { alert("Erreur upload"); }
            },

            uploadCloudinary: async function(file) {
                const formData = new FormData();
                formData.append("file", file);
                formData.append("upload_preset", CLOUDINARY_PRESET);
                const r = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
                const d = await r.json();
                return d.secure_url;
            },

            login: function() {
                const name = document.getElementById('loginPseudo').value;
                if(!name) return;
                this.data.user = { name, email: document.getElementById('loginEmail').value };
                localStorage.setItem('visiona_user', JSON.stringify(this.data.user));
                location.reload();
            },

            search: function() {
                const q = document.getElementById('searchInput').value.toLowerCase();
                const filtered = this.data.videos.filter(v => v.title.toLowerCase().includes(q) || v.author.toLowerCase().includes(q));
                this.render(filtered);
                this.goHome();
            },

            goHome: function() {
                this.currentView = 'home';
                document.getElementById('home-view').style.display = 'block';
                document.getElementById('profile-view').style.display = 'none';
                this.render();
            },

            showMyChannel: function() {
                if(!this.data.user) return this.openModal('loginModal');
                this.viewProfile(this.data.user.name);
            },

            showHistory: function() {
                this.currentView = 'history';
                document.getElementById('home-view').style.display = 'block';
                document.getElementById('profile-view').style.display = 'none';
                this.render(this.history);
            },

            showSubscribed: function() {
                if(!this.data.user) return this.openModal('loginModal');
                const me = this.data.users[this.data.user.name];
                if(!me || !me.subs) return this.render([]);
                const filtered = this.data.videos.filter(v => me.subs[v.author]);
                this.render(filtered);
            },

            renderNextVideos: function() {
                const grid = document.getElementById('nextVideos');
                const vids = this.data.videos.filter(v => v.id !== this.activeVid.id).slice(0, 10);
                grid.innerHTML = vids.map(v => `
                    <div style="display:flex; gap:8px; margin-bottom:12px; cursor:pointer;" onclick="app.openPlayer('${v.id}')">
                        <img src="${v.thumb}" style="width:120px; aspect-ratio:16/9; border-radius:8px; object-fit:cover;">
                        <div>
                            <b style="font-size:14px; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${v.title}</b>
                            <p style="font-size:12px; color:var(--sec-text); margin:4px 0;">${v.author}</p>
                            <p style="font-size:12px; color:var(--sec-text);">${v.views} vues</p>
                        </div>
                    </div>
                `).join('');
            },

            toggleSidebar: function() {
                const sb = document.getElementById('sidebar');
                const mc = document.getElementById('mainContent');
                sb.classList.toggle('active');
                mc.classList.toggle('shifted');
            },

            // AJOUT EASTER EGG
            initEasterEgg: function() {
                window.addEventListener('keydown', (e) => {
                    this.konami += e.key.toLowerCase();
                    if(this.konami.includes("disco")) {
                        document.getElementById('easter-egg-overlay').style.display = 'flex';
                        this.konami = "";
                    }
                    if(this.konami.length > 10) this.konami = "";
                });
            },

            openModal: id => document.getElementById(id).style.display = 'flex',
            closeModals: () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'),
            viewProfileFromPlayer: function() { if(this.activeVid) this.viewProfile(this.activeVid.author); }
        };

        app.init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visiona - AlphaGames30 </title>
    <style>
        /* TOUT TON STYLE D'ORIGINE EST GARD√â ICI */
        :root { --bg: #0f0f0f; --header: #0f0f0f; --text: #ffffff; --sec-text: #aaaaaa; --hover: #272727; --blue: #3ea6ff; --red: #ff0000; --green: #00a854; --gold: #ffc107; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: Roboto, Arial, sans-serif; overflow-x: hidden; padding-bottom: 60px; }
        
        /* AJOUT STYLE TIKTOK / ZAPP */
        .tiktok-container { display: none; height: calc(100vh - 56px); overflow-y: scroll; scroll-snap-type: y mandatory; }
        .tiktok-slide { height: 100%; scroll-snap-align: start; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        .tiktok-video { height: 100%; width: auto; max-width: 100%; }
        .tiktok-ui { position: absolute; right: 20px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .heart-btn { font-size: 30px; cursor: pointer; transition: 0.3s; }
        .heart-btn.active { color: var(--red); transform: scale(1.2); }

        /* AJOUT STYLE LIVE CHAT */
        .live-container { display: flex; gap: 10px; height: 100%; }
        .live-chat { width: 300px; background: #1a1a1a; border-radius: 12px; display: flex; flex-direction: column; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; }
        
        /* STYLE PANEL ADMIN */
        .admin-box { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--red); }
        
        /* RESTE DU STYLE (INDEX 13) */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; height: 56px; background: var(--header); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        .logo { font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; }
        .logo::before { content: '‚ñ∂'; color: var(--red); font-size: 24px; margin-right: 5px; }
        /* ... (Gard√© intact tel quel) */
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="app.goHome()">Visiona</div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Rechercher">
            <button onclick="app.search()">üîç</button>
        </div>
        <div class="user-nav" id="userNav">
            <button class="nav-icon" onclick="app.openModal('uploadModal')">‚ûï</button>
            <div class="avatar-btn" id="userAvatar" onclick="app.openModal('loginModal')">üë§</div>
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <div class="nav-item active" onclick="app.goHome()">üè† Accueil</div>
        <div class="nav-item" onclick="app.goZapp()">‚ö° Zapp (Tiktok)</div>
        <div class="nav-item" onclick="app.showSubscribed()">üîî Abonnements</div>
        <div class="nav-item" onclick="app.showStats()">üìä Mes Stats</div>
        <div class="nav-item" onclick="app.showCredits()">üíé Cr√©dits</div>
        <hr style="border:0; border-top:1px solid #333; margin:12px 0;">
        <div id="adminMenu" style="display:none;" class="nav-item" onclick="app.showAdminPanel()">üõ°Ô∏è Admin Panel</div>
    </div>

    <main class="main-content" id="mainContent">
        <div id="home-view">
            <div class="video-grid" id="videoGrid"></div>
        </div>

        <div id="zapp-view" class="tiktok-container"></div>

        <div id="stats-view" style="display:none; padding:20px;">
            <h2>üìä Mes Statistiques Globales</h2>
            <div id="statsGrid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;"></div>
        </div>

        <div id="admin-view" style="display:none; padding:20px;">
            <h2 style="color:var(--red);">üõ°Ô∏è Administration Syst√®me</h2>
            <div id="adminTools"></div>
        </div>

        <div id="credits-view" style="display:none; padding:20px;">
            <h2>üíé Contributeurs du Projet</h2>
            <div id="creditsList"></div>
        </div>
    </main>

    <div id="liveModal" class="modal">
        <div class="modal-content" style="max-width:900px;">
            <h2>üî¥ Diffusion en Direct</h2>
            <div class="live-container">
                <video id="livePreview" controls autoplay style="flex:1; background:#000;"></video>
                <div class="live-chat">
                    <div class="chat-msgs" id="chatMsgs"></div>
                    <input type="text" id="chatInput" placeholder="Chatter...">
                </div>
            </div>
            <button class="btn-prime" onclick="app.startStreaming()">LANCER LE DIRECT</button>
            <button class="btn-prime" style="background:#333; margin-top:5px;" onclick="app.closeModals()">Quitter</button>
        </div>
    </div>

    <script>
        const app = {
            data: { 
                videos: [], users: {}, user: null, 
                credits: ["AlphaGames30 - Lead Dev"],
                banned: [] 
            },
            
            init: async function() {
                this.loadUser();
                await this.fetchData();
                this.updateStats(); // Init des stats
                this.render();
                
                // V√©rif Admin
                if(this.data.user && this.data.user.email === "ton-email@admin.com") {
                    document.getElementById('adminMenu').style.display = "block";
                }
            },

            // --- 1. SYST√àME DE LIKES & VUES (COOLDOWN) ---
            viewVideo: function(id) {
                const now = Date.now();
                const lastView = localStorage.getItem('last_view_' + id);
                
                // Cooldown de 1 heure pour les vues
                if(!lastView || (now - lastView > 3600000)) {
                    const v = this.data.videos.find(x => x.id == id);
                    if(v) v.views = (v.views || 0) + 1;
                    localStorage.setItem('last_view_' + id, now);
                    this.saveGist();
                }
                this.openPlayer(id);
            },

            toggleLike: function(id) {
                if(!this.data.user) return this.openModal('loginModal');
                const v = this.data.videos.find(x => x.id == id);
                if(!v.likedBy) v.likedBy = [];
                
                const idx = v.likedBy.indexOf(this.data.user.name);
                if(idx === -1) {
                    v.likedBy.push(this.data.user.name);
                    v.likes = (v.likes || 0) + 1;
                } else {
                    v.likedBy.splice(idx, 1);
                    v.likes = Math.max(0, v.likes - 1);
                }
                this.saveGist();
                this.renderPlayerLikes();
            },

            // --- 2. COEUR DU CR√âATEUR ---
            heartComment: function(videoId, commentIdx) {
                const v = this.data.videos.find(x => x.id == videoId);
                if(this.data.user && v.author === this.data.user.name) {
                    v.comments[commentIdx].heart = true;
                    this.saveGist();
                    this.renderComments();
                }
            },

            // --- 3. SYST√àME ZAPP (TIKTOK) ---
            goZapp: function() {
                this.hideViews();
                const view = document.getElementById('zapp-view');
                view.style.display = 'block';
                const shorts = this.data.videos.filter(v => v.isShort || v.duration === "LIVE");
                
                view.innerHTML = shorts.map(v => `
                    <div class="tiktok-slide">
                        <video class="tiktok-video" src="${v.url}" loop autoplay muted></video>
                        <div class="tiktok-ui">
                            <div class="heart-btn" onclick="app.toggleLike('${v.id}')">‚ù§Ô∏è</div>
                            <div style="font-size:12px;">${v.likes || 0}</div>
                            <div class="v-avatar" onclick="app.viewProfile('${v.author}')">
                                <img src="${this.data.users[v.author]?.avatar || ''}">
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            // --- 4. PANEL ADMIN ---
            showAdminPanel: function() {
                this.hideViews();
                const div = document.getElementById('admin-view');
                div.style.display = 'block';
                
                document.getElementById('adminTools').innerHTML = `
                    <div class="admin-box">
                        <h3>Utilisateurs</h3>
                        ${Object.keys(this.data.users).map(u => `
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span>${u} (${this.data.users[u].email})</span>
                                <button onclick="app.banUser('${u}')" style="background:red; color:white;">BAN</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            // --- 5. STATS R√âELLES ---
            showStats: function() {
                this.hideViews();
                document.getElementById('stats-view').style.display = 'block';
                const s = this.data.user;
                const myVids = this.data.videos.filter(v => v.author === s.name);
                const totalViews = myVids.reduce((acc, v) => acc + (v.views || 0), 0);
                
                document.getElementById('statsGrid').innerHTML = `
                    <div class="admin-box"><h4>Vues re√ßues</h4><p>${totalViews}</p></div>
                    <div class="admin-box"><h4>Vid√©os publi√©es</h4><p>${myVids.length}</p></div>
                    <div class="admin-box"><h4>Abonn√©s</h4><p>${this.getFollowerCount(s.name)}</p></div>
                `;
            },

            // --- 6. LIVE DIRECT ---
            startStreaming: async function() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    document.getElementById('livePreview').srcObject = stream;
                    // Ici on simulerait l'envoi vers un serveur RTMP/WebRTC
                    alert("Le flux est maintenant envoy√© vers Visiona Live !");
                } catch(e) { alert("Cam√©ra non trouv√©e"); }
            },

            // Fonctions utilitaires gard√©es intactes
            hideViews: function() {
                ['home-view', 'zapp-view', 'stats-view', 'admin-view', 'credits-view', 'profile-view'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.style.display = 'none';
                });
            },

            getFollowerCount: function(name) {
                return Object.values(this.data.users).filter(u => u.subs && u.subs[name]).length;
            },

            // Reste des fonctions (fetchData, saveGist, render...) 
            // TOUT LE CODE DE L'INDEX 13 EST PR√âSERV√â ICI EN DESSOUS
            // ... [CODE INDEX 13 CONTINU√â] ...
        };

        app.init();
    </script>
</body>
</html>
